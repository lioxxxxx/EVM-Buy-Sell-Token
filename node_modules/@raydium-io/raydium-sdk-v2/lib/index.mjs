var vc=Object.defineProperty,_c=Object.defineProperties;var Fc=Object.getOwnPropertyDescriptors;var jo=Object.getOwnPropertySymbols;var Hs=Object.prototype.hasOwnProperty,Zs=Object.prototype.propertyIsEnumerable;var js=(o,e,t)=>e in o?vc(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t,C=(o,e)=>{for(var t in e||(e={}))Hs.call(e,t)&&js(o,t,e[t]);if(jo)for(var t of jo(e))Zs.call(e,t)&&js(o,t,e[t]);return o},E=(o,e)=>_c(o,Fc(e));var Oe=(o,e)=>{var t={};for(var n in o)Hs.call(o,n)&&e.indexOf(n)<0&&(t[n]=o[n]);if(o!=null&&jo)for(var n of jo(o))e.indexOf(n)<0&&Zs.call(o,n)&&(t[n]=o[n]);return t};import Wa from"axios";import{get as oi,set as $s}from"lodash";var Vc=(r=>(r[r.Error=0]="Error",r[r.Warning=1]="Warning",r[r.Info=2]="Info",r[r.Debug=3]="Debug",r))(Vc||{}),ri=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},ii={},Js={};function ce(o){let e=oi(ii,o);if(!e){let t=oi(Js,o);e=new ri({name:o,logLevel:t}),$s(ii,o,e)}return e}function xf(o,e){$s(Js,o,e);let t=oi(ii,o);t&&(t.level=e)}import{PublicKey as Zl}from"@solana/web3.js";import $l from"bn.js";import jl from"big.js";import nn from"bn.js";import Te from"bn.js";var Nn=9e15,tn=1e9,si="0123456789abcdef",Zo="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",$o="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",ai={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-Nn,maxE:Nn,crypto:!1},oa,Et,oe=!0,er="[DecimalError] ",en=er+"Invalid argument: ",ra=er+"Precision limit exceeded",ia=er+"crypto unavailable",sa="[object Decimal]",$e=Math.floor,Fe=Math.pow,Ec=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,Dc=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,Wc=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,aa=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,It=1e7,te=7,qc=9007199254740991,Uc=Zo.length-1,ui=$o.length-1,_={toStringTag:sa};_.absoluteValue=_.abs=function(){var o=new this.constructor(this);return o.s<0&&(o.s=1),$(o)};_.ceil=function(){return $(new this.constructor(this),this.e+1,2)};_.clampedTo=_.clamp=function(o,e){var t,n=this,r=n.constructor;if(o=new r(o),e=new r(e),!o.s||!e.s)return new r(NaN);if(o.gt(e))throw Error(en+e);return t=n.cmp(o),t<0?o:n.cmp(e)>0?e:new r(n)};_.comparedTo=_.cmp=function(o){var e,t,n,r,i=this,s=i.d,a=(o=new i.constructor(o)).d,u=i.s,c=o.s;if(!s||!a)return!u||!c?NaN:u!==c?u:s===a?0:!s^u<0?1:-1;if(!s[0]||!a[0])return s[0]?u:a[0]?-c:0;if(u!==c)return u;if(i.e!==o.e)return i.e>o.e^u<0?1:-1;for(n=s.length,r=a.length,e=0,t=n<r?n:r;e<t;++e)if(s[e]!==a[e])return s[e]>a[e]^u<0?1:-1;return n===r?0:n>r^u<0?1:-1};_.cosine=_.cos=function(){var o,e,t=this,n=t.constructor;return t.d?t.d[0]?(o=n.precision,e=n.rounding,n.precision=o+Math.max(t.e,t.sd())+te,n.rounding=1,t=Gc(n,da(n,t)),n.precision=o,n.rounding=e,$(Et==2||Et==3?t.neg():t,o,e,!0)):new n(1):new n(NaN)};_.cubeRoot=_.cbrt=function(){var o,e,t,n,r,i,s,a,u,c,l=this,m=l.constructor;if(!l.isFinite()||l.isZero())return new m(l);for(oe=!1,i=l.s*Fe(l.s*l,1/3),!i||Math.abs(i)==1/0?(t=ze(l.d),o=l.e,(i=(o-t.length+1)%3)&&(t+=i==1||i==-2?"0":"00"),i=Fe(t,1/3),o=$e((o+1)/3)-(o%3==(o<0?-1:2)),i==1/0?t="5e"+o:(t=i.toExponential(),t=t.slice(0,t.indexOf("e")+1)+o),n=new m(t),n.s=l.s):n=new m(i.toString()),s=(o=m.precision)+3;;)if(a=n,u=a.times(a).times(a),c=u.plus(l),n=ke(c.plus(l).times(a),c.plus(u),s+2,1),ze(a.d).slice(0,s)===(t=ze(n.d)).slice(0,s))if(t=t.slice(s-3,s+1),t=="9999"||!r&&t=="4999"){if(!r&&($(a,o+1,0),a.times(a).times(a).eq(l))){n=a;break}s+=4,r=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&($(n,o+1,1),e=!n.times(n).times(n).eq(l));break}return oe=!0,$(n,o,m.rounding,e)};_.decimalPlaces=_.dp=function(){var o,e=this.d,t=NaN;if(e){if(o=e.length-1,t=(o-$e(this.e/te))*te,o=e[o],o)for(;o%10==0;o/=10)t--;t<0&&(t=0)}return t};_.dividedBy=_.div=function(o){return ke(this,new this.constructor(o))};_.dividedToIntegerBy=_.divToInt=function(o){var e=this,t=e.constructor;return $(ke(e,new t(o),0,1,1),t.precision,t.rounding)};_.equals=_.eq=function(o){return this.cmp(o)===0};_.floor=function(){return $(new this.constructor(this),this.e+1,3)};_.greaterThan=_.gt=function(o){return this.cmp(o)>0};_.greaterThanOrEqualTo=_.gte=function(o){var e=this.cmp(o);return e==1||e===0};_.hyperbolicCosine=_.cosh=function(){var o,e,t,n,r,i=this,s=i.constructor,a=new s(1);if(!i.isFinite())return new s(i.s?1/0:NaN);if(i.isZero())return a;t=s.precision,n=s.rounding,s.precision=t+Math.max(i.e,i.sd())+4,s.rounding=1,r=i.d.length,r<32?(o=Math.ceil(r/3),e=(1/nr(4,o)).toString()):(o=16,e="2.3283064365386962890625e-10"),i=Mn(s,1,i.times(e),new s(1),!0);for(var u,c=o,l=new s(8);c--;)u=i.times(i),i=a.minus(u.times(l.minus(u.times(l))));return $(i,s.precision=t,s.rounding=n,!0)};_.hyperbolicSine=_.sinh=function(){var o,e,t,n,r=this,i=r.constructor;if(!r.isFinite()||r.isZero())return new i(r);if(e=i.precision,t=i.rounding,i.precision=e+Math.max(r.e,r.sd())+4,i.rounding=1,n=r.d.length,n<3)r=Mn(i,2,r,r,!0);else{o=1.4*Math.sqrt(n),o=o>16?16:o|0,r=r.times(1/nr(5,o)),r=Mn(i,2,r,r,!0);for(var s,a=new i(5),u=new i(16),c=new i(20);o--;)s=r.times(r),r=r.times(a.plus(s.times(u.times(s).plus(c))))}return i.precision=e,i.rounding=t,$(r,e,t,!0)};_.hyperbolicTangent=_.tanh=function(){var o,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+7,n.rounding=1,ke(t.sinh(),t.cosh(),n.precision=o,n.rounding=e)):new n(t.s)};_.inverseCosine=_.acos=function(){var o,e=this,t=e.constructor,n=e.abs().cmp(1),r=t.precision,i=t.rounding;return n!==-1?n===0?e.isNeg()?Tt(t,r,i):new t(0):new t(NaN):e.isZero()?Tt(t,r+4,i).times(.5):(t.precision=r+6,t.rounding=1,e=e.asin(),o=Tt(t,r+4,i).times(.5),t.precision=r,t.rounding=i,o.minus(e))};_.inverseHyperbolicCosine=_.acosh=function(){var o,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(o=n.precision,e=n.rounding,n.precision=o+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,oe=!1,t=t.times(t).minus(1).sqrt().plus(t),oe=!0,n.precision=o,n.rounding=e,t.ln()):new n(t)};_.inverseHyperbolicSine=_.asinh=function(){var o,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,oe=!1,t=t.times(t).plus(1).sqrt().plus(t),oe=!0,n.precision=o,n.rounding=e,t.ln())};_.inverseHyperbolicTangent=_.atanh=function(){var o,e,t,n,r=this,i=r.constructor;return r.isFinite()?r.e>=0?new i(r.abs().eq(1)?r.s/0:r.isZero()?r:NaN):(o=i.precision,e=i.rounding,n=r.sd(),Math.max(n,o)<2*-r.e-1?$(new i(r),o,e,!0):(i.precision=t=n-r.e,r=ke(r.plus(1),new i(1).minus(r),t+o,1),i.precision=o+4,i.rounding=1,r=r.ln(),i.precision=o,i.rounding=e,r.times(.5))):new i(NaN)};_.inverseSine=_.asin=function(){var o,e,t,n,r=this,i=r.constructor;return r.isZero()?new i(r):(e=r.abs().cmp(1),t=i.precision,n=i.rounding,e!==-1?e===0?(o=Tt(i,t+4,n).times(.5),o.s=r.s,o):new i(NaN):(i.precision=t+6,i.rounding=1,r=r.div(new i(1).minus(r.times(r)).sqrt().plus(1)).atan(),i.precision=t,i.rounding=n,r.times(2)))};_.inverseTangent=_.atan=function(){var o,e,t,n,r,i,s,a,u,c=this,l=c.constructor,m=l.precision,d=l.rounding;if(c.isFinite()){if(c.isZero())return new l(c);if(c.abs().eq(1)&&m+4<=ui)return s=Tt(l,m+4,d).times(.25),s.s=c.s,s}else{if(!c.s)return new l(NaN);if(m+4<=ui)return s=Tt(l,m+4,d).times(.5),s.s=c.s,s}for(l.precision=a=m+10,l.rounding=1,t=Math.min(28,a/te+2|0),o=t;o;--o)c=c.div(c.times(c).plus(1).sqrt().plus(1));for(oe=!1,e=Math.ceil(a/te),n=1,u=c.times(c),s=new l(c),r=c;o!==-1;)if(r=r.times(u),i=s.minus(r.div(n+=2)),r=r.times(u),s=i.plus(r.div(n+=2)),s.d[e]!==void 0)for(o=e;s.d[o]===i.d[o]&&o--;);return t&&(s=s.times(2<<t-1)),oe=!0,$(s,l.precision=m,l.rounding=d,!0)};_.isFinite=function(){return!!this.d};_.isInteger=_.isInt=function(){return!!this.d&&$e(this.e/te)>this.d.length-2};_.isNaN=function(){return!this.s};_.isNegative=_.isNeg=function(){return this.s<0};_.isPositive=_.isPos=function(){return this.s>0};_.isZero=function(){return!!this.d&&this.d[0]===0};_.lessThan=_.lt=function(o){return this.cmp(o)<0};_.lessThanOrEqualTo=_.lte=function(o){return this.cmp(o)<1};_.logarithm=_.log=function(o){var e,t,n,r,i,s,a,u,c=this,l=c.constructor,m=l.precision,d=l.rounding,p=5;if(o==null)o=new l(10),e=!0;else{if(o=new l(o),t=o.d,o.s<0||!t||!t[0]||o.eq(1))return new l(NaN);e=o.eq(10)}if(t=c.d,c.s<0||!t||!t[0]||c.eq(1))return new l(t&&!t[0]?-1/0:c.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)i=!0;else{for(r=t[0];r%10===0;)r/=10;i=r!==1}if(oe=!1,a=m+p,s=Jt(c,a),n=e?Jo(l,a+10):Jt(o,a),u=ke(s,n,a,1),$n(u.d,r=m,d))do if(a+=10,s=Jt(c,a),n=e?Jo(l,a+10):Jt(o,a),u=ke(s,n,a,1),!i){+ze(u.d).slice(r+1,r+15)+1==1e14&&(u=$(u,m+1,0));break}while($n(u.d,r+=10,d));return oe=!0,$(u,m,d)};_.minus=_.sub=function(o){var e,t,n,r,i,s,a,u,c,l,m,d,p=this,y=p.constructor;if(o=new y(o),!p.d||!o.d)return!p.s||!o.s?o=new y(NaN):p.d?o.s=-o.s:o=new y(o.d||p.s!==o.s?p:NaN),o;if(p.s!=o.s)return o.s=-o.s,p.plus(o);if(c=p.d,d=o.d,a=y.precision,u=y.rounding,!c[0]||!d[0]){if(d[0])o.s=-o.s;else if(c[0])o=new y(p);else return new y(u===3?-0:0);return oe?$(o,a,u):o}if(t=$e(o.e/te),l=$e(p.e/te),c=c.slice(),i=l-t,i){for(m=i<0,m?(e=c,i=-i,s=d.length):(e=d,t=l,s=c.length),n=Math.max(Math.ceil(a/te),s)+2,i>n&&(i=n,e.length=1),e.reverse(),n=i;n--;)e.push(0);e.reverse()}else{for(n=c.length,s=d.length,m=n<s,m&&(s=n),n=0;n<s;n++)if(c[n]!=d[n]){m=c[n]<d[n];break}i=0}for(m&&(e=c,c=d,d=e,o.s=-o.s),s=c.length,n=d.length-s;n>0;--n)c[s++]=0;for(n=d.length;n>i;){if(c[--n]<d[n]){for(r=n;r&&c[--r]===0;)c[r]=It-1;--c[r],c[n]+=It}c[n]-=d[n]}for(;c[--s]===0;)c.pop();for(;c[0]===0;c.shift())--t;return c[0]?(o.d=c,o.e=tr(c,t),oe?$(o,a,u):o):new y(u===3?-0:0)};_.modulo=_.mod=function(o){var e,t=this,n=t.constructor;return o=new n(o),!t.d||!o.s||o.d&&!o.d[0]?new n(NaN):!o.d||t.d&&!t.d[0]?$(new n(t),n.precision,n.rounding):(oe=!1,n.modulo==9?(e=ke(t,o.abs(),0,3,1),e.s*=o.s):e=ke(t,o,0,n.modulo,1),e=e.times(o),oe=!0,t.minus(e))};_.naturalExponential=_.exp=function(){return ci(this)};_.naturalLogarithm=_.ln=function(){return Jt(this)};_.negated=_.neg=function(){var o=new this.constructor(this);return o.s=-o.s,$(o)};_.plus=_.add=function(o){var e,t,n,r,i,s,a,u,c,l,m=this,d=m.constructor;if(o=new d(o),!m.d||!o.d)return!m.s||!o.s?o=new d(NaN):m.d||(o=new d(o.d||m.s===o.s?m:NaN)),o;if(m.s!=o.s)return o.s=-o.s,m.minus(o);if(c=m.d,l=o.d,a=d.precision,u=d.rounding,!c[0]||!l[0])return l[0]||(o=new d(m)),oe?$(o,a,u):o;if(i=$e(m.e/te),n=$e(o.e/te),c=c.slice(),r=i-n,r){for(r<0?(t=c,r=-r,s=l.length):(t=l,n=i,s=c.length),i=Math.ceil(a/te),s=i>s?i+1:s+1,r>s&&(r=s,t.length=1),t.reverse();r--;)t.push(0);t.reverse()}for(s=c.length,r=l.length,s-r<0&&(r=s,t=l,l=c,c=t),e=0;r;)e=(c[--r]=c[r]+l[r]+e)/It|0,c[r]%=It;for(e&&(c.unshift(e),++n),s=c.length;c[--s]==0;)c.pop();return o.d=c,o.e=tr(c,n),oe?$(o,a,u):o};_.precision=_.sd=function(o){var e,t=this;if(o!==void 0&&o!==!!o&&o!==1&&o!==0)throw Error(en+o);return t.d?(e=ua(t.d),o&&t.e+1>e&&(e=t.e+1)):e=NaN,e};_.round=function(){var o=this,e=o.constructor;return $(new e(o),o.e+1,e.rounding)};_.sine=_.sin=function(){var o,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+Math.max(t.e,t.sd())+te,n.rounding=1,t=zc(n,da(n,t)),n.precision=o,n.rounding=e,$(Et>2?t.neg():t,o,e,!0)):new n(NaN)};_.squareRoot=_.sqrt=function(){var o,e,t,n,r,i,s=this,a=s.d,u=s.e,c=s.s,l=s.constructor;if(c!==1||!a||!a[0])return new l(!c||c<0&&(!a||a[0])?NaN:a?s:1/0);for(oe=!1,c=Math.sqrt(+s),c==0||c==1/0?(e=ze(a),(e.length+u)%2==0&&(e+="0"),c=Math.sqrt(e),u=$e((u+1)/2)-(u<0||u%2),c==1/0?e="5e"+u:(e=c.toExponential(),e=e.slice(0,e.indexOf("e")+1)+u),n=new l(e)):n=new l(c.toString()),t=(u=l.precision)+3;;)if(i=n,n=i.plus(ke(s,i,t+2,1)).times(.5),ze(i.d).slice(0,t)===(e=ze(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!r&&e=="4999"){if(!r&&($(i,u+1,0),i.times(i).eq(s))){n=i;break}t+=4,r=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&($(n,u+1,1),o=!n.times(n).eq(s));break}return oe=!0,$(n,u,l.rounding,o)};_.tangent=_.tan=function(){var o,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+10,n.rounding=1,t=t.sin(),t.s=1,t=ke(t,new n(1).minus(t.times(t)).sqrt(),o+10,0),n.precision=o,n.rounding=e,$(Et==2||Et==4?t.neg():t,o,e,!0)):new n(NaN)};_.times=_.mul=function(o){var e,t,n,r,i,s,a,u,c,l=this,m=l.constructor,d=l.d,p=(o=new m(o)).d;if(o.s*=l.s,!d||!d[0]||!p||!p[0])return new m(!o.s||d&&!d[0]&&!p||p&&!p[0]&&!d?NaN:!d||!p?o.s/0:o.s*0);for(t=$e(l.e/te)+$e(o.e/te),u=d.length,c=p.length,u<c&&(i=d,d=p,p=i,s=u,u=c,c=s),i=[],s=u+c,n=s;n--;)i.push(0);for(n=c;--n>=0;){for(e=0,r=u+n;r>n;)a=i[r]+p[n]*d[r-n-1]+e,i[r--]=a%It|0,e=a/It|0;i[r]=(i[r]+e)%It|0}for(;!i[--s];)i.pop();return e?++t:i.shift(),o.d=i,o.e=tr(i,t),oe?$(o,m.precision,m.rounding):o};_.toBinary=function(o,e){return mi(this,2,o,e)};_.toDecimalPlaces=_.toDP=function(o,e){var t=this,n=t.constructor;return t=new n(t),o===void 0?t:(at(o,0,tn),e===void 0?e=n.rounding:at(e,0,8),$(t,o+t.e+1,e))};_.toExponential=function(o,e){var t,n=this,r=n.constructor;return o===void 0?t=Nt(n,!0):(at(o,0,tn),e===void 0?e=r.rounding:at(e,0,8),n=$(new r(n),o+1,e),t=Nt(n,!0,o+1)),n.isNeg()&&!n.isZero()?"-"+t:t};_.toFixed=function(o,e){var t,n,r=this,i=r.constructor;return o===void 0?t=Nt(r):(at(o,0,tn),e===void 0?e=i.rounding:at(e,0,8),n=$(new i(r),o+r.e+1,e),t=Nt(n,!1,o+n.e+1)),r.isNeg()&&!r.isZero()?"-"+t:t};_.toFraction=function(o){var e,t,n,r,i,s,a,u,c,l,m,d,p=this,y=p.d,f=p.constructor;if(!y)return new f(p);if(c=t=new f(1),n=u=new f(0),e=new f(n),i=e.e=ua(y)-p.e-1,s=i%te,e.d[0]=Fe(10,s<0?te+s:s),o==null)o=i>0?e:c;else{if(a=new f(o),!a.isInt()||a.lt(c))throw Error(en+a);o=a.gt(e)?i>0?e:c:a}for(oe=!1,a=new f(ze(y)),l=f.precision,f.precision=i=y.length*te*2;m=ke(a,e,0,1,1),r=t.plus(m.times(n)),r.cmp(o)!=1;)t=n,n=r,r=c,c=u.plus(m.times(r)),u=r,r=e,e=a.minus(m.times(r)),a=r;return r=ke(o.minus(t),n,0,1,1),u=u.plus(r.times(c)),t=t.plus(r.times(n)),u.s=c.s=p.s,d=ke(c,n,i,1).minus(p).abs().cmp(ke(u,t,i,1).minus(p).abs())<1?[c,n]:[u,t],f.precision=l,oe=!0,d};_.toHexadecimal=_.toHex=function(o,e){return mi(this,16,o,e)};_.toNearest=function(o,e){var t=this,n=t.constructor;if(t=new n(t),o==null){if(!t.d)return t;o=new n(1),e=n.rounding}else{if(o=new n(o),e===void 0?e=n.rounding:at(e,0,8),!t.d)return o.s?t:o;if(!o.d)return o.s&&(o.s=t.s),o}return o.d[0]?(oe=!1,t=ke(t,o,0,e,1).times(o),oe=!0,$(t)):(o.s=t.s,t=o),t};_.toNumber=function(){return+this};_.toOctal=function(o,e){return mi(this,8,o,e)};_.toPower=_.pow=function(o){var e,t,n,r,i,s,a=this,u=a.constructor,c=+(o=new u(o));if(!a.d||!o.d||!a.d[0]||!o.d[0])return new u(Fe(+a,c));if(a=new u(a),a.eq(1))return a;if(n=u.precision,i=u.rounding,o.eq(1))return $(a,n,i);if(e=$e(o.e/te),e>=o.d.length-1&&(t=c<0?-c:c)<=qc)return r=ca(u,a,t,n),o.s<0?new u(1).div(r):$(r,n,i);if(s=a.s,s<0){if(e<o.d.length-1)return new u(NaN);if((o.d[e]&1)==0&&(s=1),a.e==0&&a.d[0]==1&&a.d.length==1)return a.s=s,a}return t=Fe(+a,c),e=t==0||!isFinite(t)?$e(c*(Math.log("0."+ze(a.d))/Math.LN10+a.e+1)):new u(t+"").e,e>u.maxE+1||e<u.minE-1?new u(e>0?s/0:0):(oe=!1,u.rounding=a.s=1,t=Math.min(12,(e+"").length),r=ci(o.times(Jt(a,n+t)),n),r.d&&(r=$(r,n+5,1),$n(r.d,n,i)&&(e=n+10,r=$(ci(o.times(Jt(a,e+t)),e),e+5,1),+ze(r.d).slice(n+1,n+15)+1==1e14&&(r=$(r,n+1,0)))),r.s=s,oe=!0,u.rounding=i,$(r,n,i))};_.toPrecision=function(o,e){var t,n=this,r=n.constructor;return o===void 0?t=Nt(n,n.e<=r.toExpNeg||n.e>=r.toExpPos):(at(o,1,tn),e===void 0?e=r.rounding:at(e,0,8),n=$(new r(n),o,e),t=Nt(n,o<=n.e||n.e<=r.toExpNeg,o)),n.isNeg()&&!n.isZero()?"-"+t:t};_.toSignificantDigits=_.toSD=function(o,e){var t=this,n=t.constructor;return o===void 0?(o=n.precision,e=n.rounding):(at(o,1,tn),e===void 0?e=n.rounding:at(e,0,8)),$(new n(t),o,e)};_.toString=function(){var o=this,e=o.constructor,t=Nt(o,o.e<=e.toExpNeg||o.e>=e.toExpPos);return o.isNeg()&&!o.isZero()?"-"+t:t};_.truncated=_.trunc=function(){return $(new this.constructor(this),this.e+1,1)};_.valueOf=_.toJSON=function(){var o=this,e=o.constructor,t=Nt(o,o.e<=e.toExpNeg||o.e>=e.toExpPos);return o.isNeg()?"-"+t:t};function ze(o){var e,t,n,r=o.length-1,i="",s=o[0];if(r>0){for(i+=s,e=1;e<r;e++)n=o[e]+"",t=te-n.length,t&&(i+=$t(t)),i+=n;s=o[e],n=s+"",t=te-n.length,t&&(i+=$t(t))}else if(s===0)return"0";for(;s%10===0;)s/=10;return i+s}function at(o,e,t){if(o!==~~o||o<e||o>t)throw Error(en+o)}function $n(o,e,t,n){var r,i,s,a;for(i=o[0];i>=10;i/=10)--e;return--e<0?(e+=te,r=0):(r=Math.ceil((e+1)/te),e%=te),i=Fe(10,te-e),a=o[r]%i|0,n==null?e<3?(e==0?a=a/100|0:e==1&&(a=a/10|0),s=t<4&&a==99999||t>3&&a==49999||a==5e4||a==0):s=(t<4&&a+1==i||t>3&&a+1==i/2)&&(o[r+1]/i/100|0)==Fe(10,e-2)-1||(a==i/2||a==0)&&(o[r+1]/i/100|0)==0:e<4?(e==0?a=a/1e3|0:e==1?a=a/100|0:e==2&&(a=a/10|0),s=(n||t<4)&&a==9999||!n&&t>3&&a==4999):s=((n||t<4)&&a+1==i||!n&&t>3&&a+1==i/2)&&(o[r+1]/i/1e3|0)==Fe(10,e-3)-1,s}function Ho(o,e,t){for(var n,r=[0],i,s=0,a=o.length;s<a;){for(i=r.length;i--;)r[i]*=e;for(r[0]+=si.indexOf(o.charAt(s++)),n=0;n<r.length;n++)r[n]>t-1&&(r[n+1]===void 0&&(r[n+1]=0),r[n+1]+=r[n]/t|0,r[n]%=t)}return r.reverse()}function Gc(o,e){var t,n,r;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),r=(1/nr(4,t)).toString()):(t=16,r="2.3283064365386962890625e-10"),o.precision+=t,e=Mn(o,1,e.times(r),new o(1));for(var i=t;i--;){var s=e.times(e);e=s.times(s).minus(s).times(8).plus(1)}return o.precision-=t,e}var ke=function(){function o(n,r,i){var s,a=0,u=n.length;for(n=n.slice();u--;)s=n[u]*r+a,n[u]=s%i|0,a=s/i|0;return a&&n.unshift(a),n}function e(n,r,i,s){var a,u;if(i!=s)u=i>s?1:-1;else for(a=u=0;a<i;a++)if(n[a]!=r[a]){u=n[a]>r[a]?1:-1;break}return u}function t(n,r,i,s){for(var a=0;i--;)n[i]-=a,a=n[i]<r[i]?1:0,n[i]=a*s+n[i]-r[i];for(;!n[0]&&n.length>1;)n.shift()}return function(n,r,i,s,a,u){var c,l,m,d,p,y,f,b,g,w,A,k,I,T,S,x,R,B,M,D,F=n.constructor,Z=n.s==r.s?1:-1,G=n.d,q=r.d;if(!G||!G[0]||!q||!q[0])return new F(!n.s||!r.s||(G?q&&G[0]==q[0]:!q)?NaN:G&&G[0]==0||!q?Z*0:Z/0);for(u?(p=1,l=n.e-r.e):(u=It,p=te,l=$e(n.e/p)-$e(r.e/p)),M=q.length,R=G.length,g=new F(Z),w=g.d=[],m=0;q[m]==(G[m]||0);m++);if(q[m]>(G[m]||0)&&l--,i==null?(T=i=F.precision,s=F.rounding):a?T=i+(n.e-r.e)+1:T=i,T<0)w.push(1),y=!0;else{if(T=T/p+2|0,m=0,M==1){for(d=0,q=q[0],T++;(m<R||d)&&T--;m++)S=d*u+(G[m]||0),w[m]=S/q|0,d=S%q|0;y=d||m<R}else{for(d=u/(q[0]+1)|0,d>1&&(q=o(q,d,u),G=o(G,d,u),M=q.length,R=G.length),x=M,A=G.slice(0,M),k=A.length;k<M;)A[k++]=0;D=q.slice(),D.unshift(0),B=q[0],q[1]>=u/2&&++B;do d=0,c=e(q,A,M,k),c<0?(I=A[0],M!=k&&(I=I*u+(A[1]||0)),d=I/B|0,d>1?(d>=u&&(d=u-1),f=o(q,d,u),b=f.length,k=A.length,c=e(f,A,b,k),c==1&&(d--,t(f,M<b?D:q,b,u))):(d==0&&(c=d=1),f=q.slice()),b=f.length,b<k&&f.unshift(0),t(A,f,k,u),c==-1&&(k=A.length,c=e(q,A,M,k),c<1&&(d++,t(A,M<k?D:q,k,u))),k=A.length):c===0&&(d++,A=[0]),w[m++]=d,c&&A[0]?A[k++]=G[x]||0:(A=[G[x]],k=1);while((x++<R||A[0]!==void 0)&&T--);y=A[0]!==void 0}w[0]||w.shift()}if(p==1)g.e=l,oa=y;else{for(m=1,d=w[0];d>=10;d/=10)m++;g.e=m+l*p-1,$(g,a?i+g.e+1:i,s,y)}return g}}();function $(o,e,t,n){var r,i,s,a,u,c,l,m,d,p=o.constructor;e:if(e!=null){if(m=o.d,!m)return o;for(r=1,a=m[0];a>=10;a/=10)r++;if(i=e-r,i<0)i+=te,s=e,l=m[d=0],u=l/Fe(10,r-s-1)%10|0;else if(d=Math.ceil((i+1)/te),a=m.length,d>=a)if(n){for(;a++<=d;)m.push(0);l=u=0,r=1,i%=te,s=i-te+1}else break e;else{for(l=a=m[d],r=1;a>=10;a/=10)r++;i%=te,s=i-te+r,u=s<0?0:l/Fe(10,r-s-1)%10|0}if(n=n||e<0||m[d+1]!==void 0||(s<0?l:l%Fe(10,r-s-1)),c=t<4?(u||n)&&(t==0||t==(o.s<0?3:2)):u>5||u==5&&(t==4||n||t==6&&(i>0?s>0?l/Fe(10,r-s):0:m[d-1])%10&1||t==(o.s<0?8:7)),e<1||!m[0])return m.length=0,c?(e-=o.e+1,m[0]=Fe(10,(te-e%te)%te),o.e=-e||0):m[0]=o.e=0,o;if(i==0?(m.length=d,a=1,d--):(m.length=d+1,a=Fe(10,te-i),m[d]=s>0?(l/Fe(10,r-s)%Fe(10,s)|0)*a:0),c)for(;;)if(d==0){for(i=1,s=m[0];s>=10;s/=10)i++;for(s=m[0]+=a,a=1;s>=10;s/=10)a++;i!=a&&(o.e++,m[0]==It&&(m[0]=1));break}else{if(m[d]+=a,m[d]!=It)break;m[d--]=0,a=1}for(i=m.length;m[--i]===0;)m.pop()}return oe&&(o.e>p.maxE?(o.d=null,o.e=NaN):o.e<p.minE&&(o.e=0,o.d=[0])),o}function Nt(o,e,t){if(!o.isFinite())return ma(o);var n,r=o.e,i=ze(o.d),s=i.length;return e?(t&&(n=t-s)>0?i=i.charAt(0)+"."+i.slice(1)+$t(n):s>1&&(i=i.charAt(0)+"."+i.slice(1)),i=i+(o.e<0?"e":"e+")+o.e):r<0?(i="0."+$t(-r-1)+i,t&&(n=t-s)>0&&(i+=$t(n))):r>=s?(i+=$t(r+1-s),t&&(n=t-r-1)>0&&(i=i+"."+$t(n))):((n=r+1)<s&&(i=i.slice(0,n)+"."+i.slice(n)),t&&(n=t-s)>0&&(r+1===s&&(i+="."),i+=$t(n))),i}function tr(o,e){var t=o[0];for(e*=te;t>=10;t/=10)e++;return e}function Jo(o,e,t){if(e>Uc)throw oe=!0,t&&(o.precision=t),Error(ra);return $(new o(Zo),e,1,!0)}function Tt(o,e,t){if(e>ui)throw Error(ra);return $(new o($o),e,t,!0)}function ua(o){var e=o.length-1,t=e*te+1;if(e=o[e],e){for(;e%10==0;e/=10)t--;for(e=o[0];e>=10;e/=10)t++}return t}function $t(o){for(var e="";o--;)e+="0";return e}function ca(o,e,t,n){var r,i=new o(1),s=Math.ceil(n/te+4);for(oe=!1;;){if(t%2&&(i=i.times(e),ta(i.d,s)&&(r=!0)),t=$e(t/2),t===0){t=i.d.length-1,r&&i.d[t]===0&&++i.d[t];break}e=e.times(e),ta(e.d,s)}return oe=!0,i}function ea(o){return o.d[o.d.length-1]&1}function la(o,e,t){for(var n,r=new o(e[0]),i=0;++i<e.length;)if(n=new o(e[i]),n.s)r[t](n)&&(r=n);else{r=n;break}return r}function ci(o,e){var t,n,r,i,s,a,u,c=0,l=0,m=0,d=o.constructor,p=d.rounding,y=d.precision;if(!o.d||!o.d[0]||o.e>17)return new d(o.d?o.d[0]?o.s<0?0:1/0:1:o.s?o.s<0?0:o:0/0);for(e==null?(oe=!1,u=y):u=e,a=new d(.03125);o.e>-2;)o=o.times(a),m+=5;for(n=Math.log(Fe(2,m))/Math.LN10*2+5|0,u+=n,t=i=s=new d(1),d.precision=u;;){if(i=$(i.times(o),u,1),t=t.times(++l),a=s.plus(ke(i,t,u,1)),ze(a.d).slice(0,u)===ze(s.d).slice(0,u)){for(r=m;r--;)s=$(s.times(s),u,1);if(e==null)if(c<3&&$n(s.d,u-n,p,c))d.precision=u+=10,t=i=a=new d(1),l=0,c++;else return $(s,d.precision=y,p,oe=!0);else return d.precision=y,s}s=a}}function Jt(o,e){var t,n,r,i,s,a,u,c,l,m,d,p=1,y=10,f=o,b=f.d,g=f.constructor,w=g.rounding,A=g.precision;if(f.s<0||!b||!b[0]||!f.e&&b[0]==1&&b.length==1)return new g(b&&!b[0]?-1/0:f.s!=1?NaN:b?0:f);if(e==null?(oe=!1,l=A):l=e,g.precision=l+=y,t=ze(b),n=t.charAt(0),Math.abs(i=f.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)f=f.times(o),t=ze(f.d),n=t.charAt(0),p++;i=f.e,n>1?(f=new g("0."+t),i++):f=new g(n+"."+t.slice(1))}else return c=Jo(g,l+2,A).times(i+""),f=Jt(new g(n+"."+t.slice(1)),l-y).plus(c),g.precision=A,e==null?$(f,A,w,oe=!0):f;for(m=f,u=s=f=ke(f.minus(1),f.plus(1),l,1),d=$(f.times(f),l,1),r=3;;){if(s=$(s.times(d),l,1),c=u.plus(ke(s,new g(r),l,1)),ze(c.d).slice(0,l)===ze(u.d).slice(0,l))if(u=u.times(2),i!==0&&(u=u.plus(Jo(g,l+2,A).times(i+""))),u=ke(u,new g(p),l,1),e==null)if($n(u.d,l-y,w,a))g.precision=l+=y,c=s=f=ke(m.minus(1),m.plus(1),l,1),d=$(f.times(f),l,1),r=a=1;else return $(u,g.precision=A,w,oe=!0);else return g.precision=A,u;u=c,r+=2}}function ma(o){return String(o.s*o.s/0)}function li(o,e){var t,n,r;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(r=e.length;e.charCodeAt(r-1)===48;--r);if(e=e.slice(n,r),e){if(r-=n,o.e=t=t-n-1,o.d=[],n=(t+1)%te,t<0&&(n+=te),n<r){for(n&&o.d.push(+e.slice(0,n)),r-=te;n<r;)o.d.push(+e.slice(n,n+=te));e=e.slice(n),n=te-e.length}else n-=r;for(;n--;)e+="0";o.d.push(+e),oe&&(o.e>o.constructor.maxE?(o.d=null,o.e=NaN):o.e<o.constructor.minE&&(o.e=0,o.d=[0]))}else o.e=0,o.d=[0];return o}function Xc(o,e){var t,n,r,i,s,a,u,c,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),aa.test(e))return li(o,e)}else if(e==="Infinity"||e==="NaN")return+e||(o.s=NaN),o.e=NaN,o.d=null,o;if(Dc.test(e))t=16,e=e.toLowerCase();else if(Ec.test(e))t=2;else if(Wc.test(e))t=8;else throw Error(en+e);for(i=e.search(/p/i),i>0?(u=+e.slice(i+1),e=e.substring(2,i)):e=e.slice(2),i=e.indexOf("."),s=i>=0,n=o.constructor,s&&(e=e.replace(".",""),a=e.length,i=a-i,r=ca(n,new n(t),i,i*2)),c=Ho(e,t,It),l=c.length-1,i=l;c[i]===0;--i)c.pop();return i<0?new n(o.s*0):(o.e=tr(c,l),o.d=c,oe=!1,s&&(o=ke(o,r,a*4)),u&&(o=o.times(Math.abs(u)<54?Fe(2,u):Jn.pow(2,u))),oe=!0,o)}function zc(o,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:Mn(o,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/nr(5,t)),e=Mn(o,2,e,e);for(var r,i=new o(5),s=new o(16),a=new o(20);t--;)r=e.times(e),e=e.times(i.plus(r.times(s.times(r).minus(a))));return e}function Mn(o,e,t,n,r){var i,s,a,u,c=1,l=o.precision,m=Math.ceil(l/te);for(oe=!1,u=t.times(t),a=new o(n);;){if(s=ke(a.times(u),new o(e++*e++),l,1),a=r?n.plus(s):n.minus(s),n=ke(s.times(u),new o(e++*e++),l,1),s=a.plus(n),s.d[m]!==void 0){for(i=m;s.d[i]===a.d[i]&&i--;);if(i==-1)break}i=a,a=n,n=s,s=i,c++}return oe=!0,s.d.length=m+1,s}function nr(o,e){for(var t=o;--e;)t*=o;return t}function da(o,e){var t,n=e.s<0,r=Tt(o,o.precision,1),i=r.times(.5);if(e=e.abs(),e.lte(i))return Et=n?4:1,e;if(t=e.divToInt(r),t.isZero())Et=n?3:2;else{if(e=e.minus(t.times(r)),e.lte(i))return Et=ea(t)?n?2:3:n?4:1,e;Et=ea(t)?n?1:4:n?3:2}return e.minus(r).abs()}function mi(o,e,t,n){var r,i,s,a,u,c,l,m,d,p=o.constructor,y=t!==void 0;if(y?(at(t,1,tn),n===void 0?n=p.rounding:at(n,0,8)):(t=p.precision,n=p.rounding),!o.isFinite())l=ma(o);else{for(l=Nt(o),s=l.indexOf("."),y?(r=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):r=e,s>=0&&(l=l.replace(".",""),d=new p(1),d.e=l.length-s,d.d=Ho(Nt(d),10,r),d.e=d.d.length),m=Ho(l,10,r),i=u=m.length;m[--u]==0;)m.pop();if(!m[0])l=y?"0p+0":"0";else{if(s<0?i--:(o=new p(o),o.d=m,o.e=i,o=ke(o,d,t,n,0,r),m=o.d,i=o.e,c=oa),s=m[t],a=r/2,c=c||m[t+1]!==void 0,c=n<4?(s!==void 0||c)&&(n===0||n===(o.s<0?3:2)):s>a||s===a&&(n===4||c||n===6&&m[t-1]&1||n===(o.s<0?8:7)),m.length=t,c)for(;++m[--t]>r-1;)m[t]=0,t||(++i,m.unshift(1));for(u=m.length;!m[u-1];--u);for(s=0,l="";s<u;s++)l+=si.charAt(m[s]);if(y){if(u>1)if(e==16||e==8){for(s=e==16?4:3,--u;u%s;u++)l+="0";for(m=Ho(l,r,e),u=m.length;!m[u-1];--u);for(s=1,l="1.";s<u;s++)l+=si.charAt(m[s])}else l=l.charAt(0)+"."+l.slice(1);l=l+(i<0?"p":"p+")+i}else if(i<0){for(;++i;)l="0"+l;l="0."+l}else if(++i>u)for(i-=u;i--;)l+="0";else i<u&&(l=l.slice(0,i)+"."+l.slice(i))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return o.s<0?"-"+l:l}function ta(o,e){if(o.length>e)return o.length=e,!0}function Qc(o){return new this(o).abs()}function Yc(o){return new this(o).acos()}function jc(o){return new this(o).acosh()}function Hc(o,e){return new this(o).plus(e)}function Zc(o){return new this(o).asin()}function $c(o){return new this(o).asinh()}function Jc(o){return new this(o).atan()}function el(o){return new this(o).atanh()}function tl(o,e){o=new this(o),e=new this(e);var t,n=this.precision,r=this.rounding,i=n+4;return!o.s||!e.s?t=new this(NaN):!o.d&&!e.d?(t=Tt(this,i,1).times(e.s>0?.25:.75),t.s=o.s):!e.d||o.isZero()?(t=e.s<0?Tt(this,n,r):new this(0),t.s=o.s):!o.d||e.isZero()?(t=Tt(this,i,1).times(.5),t.s=o.s):e.s<0?(this.precision=i,this.rounding=1,t=this.atan(ke(o,e,i,1)),e=Tt(this,i,1),this.precision=n,this.rounding=r,t=o.s<0?t.minus(e):t.plus(e)):t=this.atan(ke(o,e,i,1)),t}function nl(o){return new this(o).cbrt()}function ol(o){return $(o=new this(o),o.e+1,2)}function rl(o,e,t){return new this(o).clamp(e,t)}function il(o){if(!o||typeof o!="object")throw Error(er+"Object expected");var e,t,n,r=o.defaults===!0,i=["precision",1,tn,"rounding",0,8,"toExpNeg",-Nn,0,"toExpPos",0,Nn,"maxE",0,Nn,"minE",-Nn,0,"modulo",0,9];for(e=0;e<i.length;e+=3)if(t=i[e],r&&(this[t]=ai[t]),(n=o[t])!==void 0)if($e(n)===n&&n>=i[e+1]&&n<=i[e+2])this[t]=n;else throw Error(en+t+": "+n);if(t="crypto",r&&(this[t]=ai[t]),(n=o[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(ia);else this[t]=!1;else throw Error(en+t+": "+n);return this}function sl(o){return new this(o).cos()}function al(o){return new this(o).cosh()}function pa(o){var e,t,n;function r(i){var s,a,u,c=this;if(!(c instanceof r))return new r(i);if(c.constructor=r,na(i)){c.s=i.s,oe?!i.d||i.e>r.maxE?(c.e=NaN,c.d=null):i.e<r.minE?(c.e=0,c.d=[0]):(c.e=i.e,c.d=i.d.slice()):(c.e=i.e,c.d=i.d?i.d.slice():i.d);return}if(u=typeof i,u==="number"){if(i===0){c.s=1/i<0?-1:1,c.e=0,c.d=[0];return}if(i<0?(i=-i,c.s=-1):c.s=1,i===~~i&&i<1e7){for(s=0,a=i;a>=10;a/=10)s++;oe?s>r.maxE?(c.e=NaN,c.d=null):s<r.minE?(c.e=0,c.d=[0]):(c.e=s,c.d=[i]):(c.e=s,c.d=[i]);return}else if(i*0!==0){i||(c.s=NaN),c.e=NaN,c.d=null;return}return li(c,i.toString())}else if(u!=="string")throw Error(en+i);return(a=i.charCodeAt(0))===45?(i=i.slice(1),c.s=-1):(a===43&&(i=i.slice(1)),c.s=1),aa.test(i)?li(c,i):Xc(c,i)}if(r.prototype=_,r.ROUND_UP=0,r.ROUND_DOWN=1,r.ROUND_CEIL=2,r.ROUND_FLOOR=3,r.ROUND_HALF_UP=4,r.ROUND_HALF_DOWN=5,r.ROUND_HALF_EVEN=6,r.ROUND_HALF_CEIL=7,r.ROUND_HALF_FLOOR=8,r.EUCLID=9,r.config=r.set=il,r.clone=pa,r.isDecimal=na,r.abs=Qc,r.acos=Yc,r.acosh=jc,r.add=Hc,r.asin=Zc,r.asinh=$c,r.atan=Jc,r.atanh=el,r.atan2=tl,r.cbrt=nl,r.ceil=ol,r.clamp=rl,r.cos=sl,r.cosh=al,r.div=ul,r.exp=cl,r.floor=ll,r.hypot=ml,r.ln=dl,r.log=pl,r.log10=yl,r.log2=fl,r.max=bl,r.min=gl,r.mod=Al,r.mul=wl,r.pow=Pl,r.random=hl,r.round=kl,r.sign=Tl,r.sin=Il,r.sinh=Bl,r.sqrt=xl,r.sub=Sl,r.sum=Kl,r.tan=Cl,r.tanh=Rl,r.trunc=Ol,o===void 0&&(o={}),o&&o.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)o.hasOwnProperty(t=n[e++])||(o[t]=this[t]);return r.config(o),r}function ul(o,e){return new this(o).div(e)}function cl(o){return new this(o).exp()}function ll(o){return $(o=new this(o),o.e+1,3)}function ml(){var o,e,t=new this(0);for(oe=!1,o=0;o<arguments.length;)if(e=new this(arguments[o++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return oe=!0,new this(1/0);t=e}return oe=!0,t.sqrt()}function na(o){return o instanceof Jn||o&&o.toStringTag===sa||!1}function dl(o){return new this(o).ln()}function pl(o,e){return new this(o).log(e)}function fl(o){return new this(o).log(2)}function yl(o){return new this(o).log(10)}function bl(){return la(this,arguments,"lt")}function gl(){return la(this,arguments,"gt")}function Al(o,e){return new this(o).mod(e)}function wl(o,e){return new this(o).mul(e)}function Pl(o,e){return new this(o).pow(e)}function hl(o){var e,t,n,r,i=0,s=new this(1),a=[];if(o===void 0?o=this.precision:at(o,1,tn),n=Math.ceil(o/te),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));i<n;)r=e[i],r>=429e7?e[i]=crypto.getRandomValues(new Uint32Array(1))[0]:a[i++]=r%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);i<n;)r=e[i]+(e[i+1]<<8)+(e[i+2]<<16)+((e[i+3]&127)<<24),r>=214e7?crypto.randomBytes(4).copy(e,i):(a.push(r%1e7),i+=4);i=n/4}else throw Error(ia);else for(;i<n;)a[i++]=Math.random()*1e7|0;for(n=a[--i],o%=te,n&&o&&(r=Fe(10,te-o),a[i]=(n/r|0)*r);a[i]===0;i--)a.pop();if(i<0)t=0,a=[0];else{for(t=-1;a[0]===0;t-=te)a.shift();for(n=1,r=a[0];r>=10;r/=10)n++;n<te&&(t-=te-n)}return s.e=t,s.d=a,s}function kl(o){return $(o=new this(o),o.e+1,this.rounding)}function Tl(o){return o=new this(o),o.d?o.d[0]?o.s:0*o.s:o.s||NaN}function Il(o){return new this(o).sin()}function Bl(o){return new this(o).sinh()}function xl(o){return new this(o).sqrt()}function Sl(o,e){return new this(o).sub(e)}function Kl(){var o=0,e=arguments,t=new this(e[o]);for(oe=!1;t.s&&++o<e.length;)t=t.plus(e[o]);return oe=!0,$(t,this.precision,this.rounding)}function Cl(o){return new this(o).tan()}function Rl(o){return new this(o).tanh()}function Ol(o){return $(o=new this(o),o.e+1,1)}_[Symbol.for("nodejs.util.inspect.custom")]=_.toString;_[Symbol.toStringTag]="Decimal";var Jn=_.constructor=pa(ai);Zo=new Jn(Zo);$o=new Jn($o);var O=Jn;import{PublicKey as bi}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ll}from"@solana/spl-token";import{PublicKey as xe,SystemProgram as fa,SYSVAR_RENT_PUBKEY as Nl}from"@solana/web3.js";function P({pubkey:o,isSigner:e=!1,isWritable:t=!0}){return{pubkey:o,isWritable:t,isSigner:e}}var di=[P({pubkey:Ll,isWritable:!1}),P({pubkey:fa.programId,isWritable:!1}),P({pubkey:Nl,isWritable:!1})];function pi({publicKey:o,transformSol:e}){let t=fi(o.toString());if(t instanceof xe)return e&&t.equals(Ve)?j:t;if(e&&t.toString()===Ve.toBase58())return j;if(typeof t=="string"){if(t===xe.default.toBase58())return xe.default;try{return new xe(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function fi(o){try{return new xe(o)}catch{return o}}var or=new xe("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),rr=new xe("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),ut=new xe("SysvarRent111111111111111111111111111111111"),yi=new xe("SysvarC1ock11111111111111111111111111111111"),vn=new xe("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),ir=new xe("Sysvar1nstructions1111111111111111111111111"),sr=fa.programId,Lf=new xe("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Nf=new xe("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),Mf=new xe("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),vf=new xe("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),_f=new xe("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),Ff=new xe("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),Vf=new xe("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),Ef=new xe("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),Df=new xe("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),Wf=new xe("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),qf=new xe("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),j=new xe("So11111111111111111111111111111111111111112"),Ve=xe.default;function pt(o){return pi({publicKey:o,transformSol:!0})}import{PublicKey as Ml}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ya}from"@solana/spl-token";var Mt={chainId:101,address:Ml.default.toBase58(),programId:ya.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},Ee={chainId:101,address:"So11111111111111111111111111111111111111112",programId:ya.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};var gi=class{constructor({mint:e,decimals:t,symbol:n,name:r,skipMint:i=!1,isToken2022:s=!1}){if(e===Ve.toBase58()||e instanceof bi&&Ve.equals(e)){this.decimals=Ee.decimals,this.symbol=Ee.symbol,this.name=Ee.name,this.mint=new bi(Ee.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=r||e.toString().substring(0,6),this.mint=i?bi.default:pi({publicKey:e}),this.isToken2022=s}equals(e){return this===e?!0:this.mint.equals(e.mint)}},ye=gi;ye.WSOL=new gi(E(C({},Ee),{mint:Ee.address}));import ur from"big.js";import Fl from"bn.js";import Vl from"decimal.js-light";import vl from"toformat";var _l=vl,eo=_l;var ar=ce("module/fraction"),Ai=eo(ur),to=eo(Vl),El={[0]:to.ROUND_DOWN,[1]:to.ROUND_HALF_UP,[2]:to.ROUND_UP},Dl={[0]:ur.roundDown,[1]:ur.roundHalfUp,[2]:ur.roundUp},re=class{constructor(e,t=new Fl(1)){this.numerator=Y(e),this.denominator=Y(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new re(this.denominator,this.numerator)}add(e){let t=e instanceof re?e:new re(Y(e));return this.denominator.eq(t.denominator)?new re(this.numerator.add(t.numerator),this.denominator):new re(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof re?e:new re(Y(e));return this.denominator.eq(t.denominator)?new re(this.numerator.sub(t.numerator),this.denominator):new re(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof re?e:new re(Y(e));return new re(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof re?e:new re(Y(e));return new re(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||ar.logWithError(`${e} is not an integer.`),e<=0&&ar.logWithError(`${e} is not positive.`),to.set({precision:e+1,rounding:El[n]});let r=new to(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return r.toFormat(r.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||ar.logWithError(`${e} is not an integer.`),e<0&&ar.logWithError(`${e} is negative.`),Ai.DP=e,Ai.RM=Dl[n]||1,new Ai(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var Wl=ce("Raydium_price"),Ue=class extends re{constructor(t){let{baseToken:n,quoteToken:r,numerator:i,denominator:s}=t;super(i,s);this.baseToken=n,this.quoteToken=r,this.scalar=new re(Pi(n.decimals),Pi(r.decimals))}get raw(){return new re(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new Ue({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&Wl.logWithError("mul token not equals");let n=super.mul(t);return new Ue({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(t=this.quoteToken.decimals,n,r){return this.adjusted.toSignificant(t,n,r)}toFixed(t=this.quoteToken.decimals,n,r){return this.adjusted.toFixed(t,n,r)}};var hi=class{constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},no=hi;no.SOL=new hi(Mt);function gy(o,e){return o instanceof ye&&e instanceof ye?o.equals(e):o instanceof ye||e instanceof ye?!1:o===e}import ql from"bn.js";var ba=new re(new ql(100)),Me=class extends re{toSignificant(e=5,t,n){return this.mul(ba).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(ba).toFixed(e,t,n)}};function Le(o){if(o instanceof Me)return new re(o.numerator,o.denominator);if(o instanceof Ue)return o.adjusted;if(o instanceof fe)try{return Le(o.toExact())}catch{return new re(De)}if(o instanceof re)return o;let e=String(o),t=dn(e);return new re(t.numerator,t.denominator)}function By(o){var n;if(o instanceof Me)return{fr:new re(o.numerator,o.denominator)};if(o instanceof Ue)return{fr:o.adjusted};if(o instanceof fe)return{fr:Le(o.toExact()),decimals:o.token.decimals};if(o instanceof re)return{fr:o};let e=String(o),t=dn(e);return{fr:new re(t.numerator,t.denominator),decimals:(n=t.dec)==null?void 0:n.length}}function xy(o,e){if(o==null||e==null)return!1;let t=Le(o),n=Le(e);return t.sub(n).numerator,t.sub(n).numerator.lt(De)}function Ul(o,e){if(o==null||e==null)return!1;let t=Le(o),n=Le(e);return t.sub(n).numerator.gt(De)}function Sy(o,e){if(o==null||e==null)return!1;let t=Le(o),n=Le(e);return t.sub(n).numerator.lte(De)}function Ky(o,e){if(o==null||e==null)return!1;let t=Le(o),n=Le(e);return t.sub(n).numerator.gte(De)}function Gl(o,e){if(o==null||e==null)return!1;let t=Le(o),n=Le(e);return t.sub(n).numerator.eq(De)}function Cy(o,e){if(o==null||e==null)return;let t=Le(o),n=Le(e);try{return t.div(n)}catch{return t}}function Ry(o,e){if(o==null||e==null)return;let t=Le(o),n=Le(e);return t.sub(n)}function Oy(o){return o==null?!1:!Gl(o,0)}function Ly(o,e){return Ul(e,o)?e:o}function ki(o,e){if(o==null||e==null)return;let t=Le(o),n=Le(e);return t.mul(n)}function Ny(o,e){if(o==null||e==null)return;let t=Le(o),n=Le(e);return t.add(n)}var wi=(n=>(n[n.ROUND_DOWN=0]="ROUND_DOWN",n[n.ROUND_HALF_UP=1]="ROUND_HALF_UP",n[n.ROUND_UP=2]="ROUND_UP",n))(wi||{}),De=new Te(0),Pa=new Te(1),zy=new Te(2),Qy=new Te(3),Yy=new Te(5),pn=new Te(10),jy=new Te(100),Hy=new Te(1e3),Zy=new Te(1e4),ga=9007199254740991;function Y(o){let e=ce("Raydium_parseBigNumberish");if(o instanceof Te)return o;if(typeof o=="string"){if(o.match(/^-?[0-9]+$/))return new Te(o);e.logWithError(`invalid BigNumberish string: ${o}`)}return typeof o=="number"?(o%1&&e.logWithError(`BigNumberish number underflow: ${o}`),(o>=ga||o<=-ga)&&e.logWithError(`BigNumberish number overflow: ${o}`),new Te(String(o))):typeof o=="bigint"?new Te(o.toString()):(e.error(`invalid BigNumberish value: ${o}`),new Te(0))}function Pi(o){return pn.pow(Y(o))}function dn(o){var a;if(o===void 0)return{denominator:"1",numerator:"0"};if(o instanceof Te)return{numerator:o.toString(),denominator:"1"};if(o instanceof re)return{denominator:o.denominator.toString(),numerator:o.numerator.toString()};let e=String(o),[,t="",n="",r=""]=(a=e.replace(",","").match(/(-?)(\d*)\.?(\d*)/))!=null?a:[],i="1"+"0".repeat(r.length),s=t+(n==="0"?"":n)+r||"0";return{denominator:i,numerator:s,sign:t,int:n,dec:r}}function cr(o,e){let t=o.divmod(e);return t.mod.isZero()?t.div:t.div.isNeg()?t.div.isubn(1):t.div.iaddn(1)}function Xl(o){var n;let[,e="",t=""]=(n=o.toFixed(2).match(/(-?)(\d*)\.?(\d*)/))!=null?n:[];return`${e}${t}`}function zl(o,e=0){return o instanceof Te?o:new Te(Xl(ha(o).mul(pn.pow(new Te(String(e))))))}function ha(o){if(o instanceof Me)return new re(o.numerator,o.denominator);if(o instanceof Ue)return o.adjusted;if(o instanceof fe)try{return ha(o.toExact())}catch{return new re(De)}if(o instanceof re)return o;let e=String(o),t=dn(e);return new re(t.numerator,t.denominator)}function $y(o,e){let{numerator:t,denominator:n}=dn(o);return new Me(new Te(t),new Te(n).mul(e!=null&&e.alreadyDecimaled?new Te(100):new Te(1)))}function Jy(o){let{token:e,numberPrice:t,decimalDone:n}=o,r=new ye({mint:"",decimals:6,symbol:"usd",name:"usd",skipMint:!0}),{numerator:i,denominator:s}=dn(t),a=n?new Te(i).mul(pn.pow(new Te(e.decimals))):i,u=new Te(s).mul(pn.pow(new Te(r.decimals)));return new Ue({baseToken:r,denominator:u.toString(),quoteToken:new ye(E(C({},e),{skipMint:!0,mint:""})),numerator:a.toString()})}function Aa(o){let e=new no({decimals:6,symbol:"usd",name:"usd"}),t=zl(ki(o,10**e.decimals));return new fn(e,t)}function eb(o,e){return Aa(!e||!o?0:ki(o,e))}function Ql(o){if(o==null)return;let{numerator:e,denominator:t}=dn(o.toString());return new re(e,t)}function Yl(o){return o instanceof O}function wa(o){return Yl(o)?Ql(o):Array.isArray(o)?o.map(e=>wa(e)):Ti(o)?Object.fromEntries(Object.entries(o).map(([e,t])=>[e,wa(t)])):o}var Hl=ce("Raydium_amount"),lr=eo(jl);function ka(o,e){let t="0",n="0";if(o.includes(".")){let r=o.split(".");r.length===2?([t,n]=r,n=n.padEnd(e,"0")):Hl.logWithError(`invalid number string, num: ${o}`)}else t=o;return[t,n.slice(0,e)||n]}var fe=class extends re{constructor(t,n,r=!0,i){let s=new nn(0),a=pn.pow(new nn(t.decimals));if(r)s=Y(n);else{let u=new nn(0),c=new nn(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,m]=ka(n.toString(),t.decimals);u=Y(l),c=Y(m)}u=u.mul(a),s=u.add(c)}super(s,a);this.logger=ce(i||"TokenAmount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new fe(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new fe(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,n,r=0){return super.toSignificant(t,n,r)}toFixed(t=this.token.decimals,n,r=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,r)}toExact(t={groupSeparator:""}){return lr.DP=this.token.decimals,new lr(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}},fn=class extends re{constructor(t,n,r=!0,i){let s=new nn(0),a=pn.pow(new nn(t.decimals));if(r)s=Y(n);else{let u=new nn(0),c=new nn(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,m]=ka(n.toString(),t.decimals);u=Y(l),c=Y(m)}u=u.mul(a),s=u.add(c)}super(s,a);this.logger=ce(i||"TokenAmount"),this.currency=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.currency.equals(t.currency)||this.logger.logWithError("gt currency not equals"),this.raw.gt(t.raw)}lt(t){return this.currency.equals(t.currency)||this.logger.logWithError("lt currency not equals"),this.raw.lt(t.raw)}add(t){return this.currency.equals(t.currency)||this.logger.logWithError("add currency not equals"),new fn(this.currency,this.raw.add(t.raw))}sub(t){return this.currency.equals(t.currency)||this.logger.logWithError("sub currency not equals"),new fn(this.currency,this.raw.sub(t.raw))}toSignificant(t=this.currency.decimals,n,r=0){return super.toSignificant(t,n,r)}toFixed(t=this.currency.decimals,n,r=0){return t>this.currency.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,r)}toExact(t={groupSeparator:""}){return lr.DP=this.currency.decimals,new lr(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};async function Ta(o){new Promise(e=>setTimeout(e,o))}function Ib(){return new Date().getTime()}function Ti(o){return typeof o=="object"&&o!==null&&![ye,fe,Zl,re,$l,Ue,Me].some(e=>typeof e=="object"&&o instanceof e)}function Ie(o){return typeof o=="string"?fi(o):Array.isArray(o)?o.map(e=>Ie(e)):Ti(o)?Object.fromEntries(Object.entries(o).map(([e,t])=>[e,Ie(t)])):o}import{PublicKey as io,sendAndConfirmTransaction as Ki,Transaction as so,TransactionMessage as ao,VersionedTransaction as uo}from"@solana/web3.js";import am from"axios";var yn=(t=>(t[t.V0=0]="V0",t[t.LEGACY=1]="LEGACY",t))(yn||{}),V={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut"};import{PublicKey as Ba,ComputeBudgetProgram as Ia,Transaction as dr,TransactionMessage as Jl,Keypair as xa,VersionedTransaction as Ii}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as em}from"@solana/spl-token";var Dt=ce("Raydium_txUtil"),Sa=1644;function pr(o){let e=[],t=[];return o.microLamports&&(e.push(Ia.setComputeUnitPrice({microLamports:o.microLamports})),t.push(V.SetComputeUnitPrice)),o.units&&(e.push(Ia.setComputeUnitLimit({units:o.units})),t.push(V.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function _n(o,e){var n,r;let t=e!=null?e:"confirmed";try{return((r=await((n=o.getLatestBlockhash)==null?void 0:n.call(o,{commitment:t})))==null?void 0:r.blockhash)||(await o.getRecentBlockhash(t)).blockhash}catch{return(await o.getRecentBlockhash(t)).blockhash}}function fr(o,e){o.length<1&&Dt.logWithError(`no instructions provided: ${o.toString()}`),e.length<1&&Dt.logWithError(`no signers provided:, ${e.toString()}`);let t=new dr;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...o);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<Sa}catch{return!1}}async function Ka(o,e,t,n=!0){let r=new Ba("RaydiumSimuLateTransaction11111111111111111"),i=[],s=new dr;s.feePayer=r;for(let c of e)fr([...s.instructions,c],[r])||(i.push(s),s=new dr,s.feePayer=r),s.add(c);s.instructions.length>0&&i.push(s);let a=[];try{if(a=await tm(o,i,n),a.find(c=>c.err!==null))throw Error("rpc simulateTransaction error")}catch(c){c instanceof Error&&Dt.logWithError("failed to simulate for instructions","RPC_ERROR",{message:c.message})}let u=[];for(let c of a)if(Dt.debug("simulate result:",c),c.logs){let l=c.logs.filter(m=>m&&m.includes(t));Dt.debug("filteredLog:",u),l.length||Dt.logWithError("simulate log not match keyword","keyword",t),u.push(...l)}return u}function Ca(o,e){let t=o.match(/{["\w:,]+}/g);return!t||t.length!==1?Dt.logWithError(`simulate log fail to match json, keyword: ${e}`):t[0]}function Wt(o,e){let n=new RegExp(`"${e}":(\\d+)`,"g").exec(o);return!n||n.length!==2?Dt.logWithError(`simulate log fail to match key", key: ${e}`):n[1]}function ue(o,e){let[t,n]=Ba.findProgramAddressSync(o,e);return{publicKey:t,nonce:n}}async function tm(o,e,t){let n=[];if(t){let r=await o.getLatestBlockhash(),i=[];for(let c of e){c.recentBlockhash=r.blockhash,c.lastValidBlockHeight=r.lastValidBlockHeight;let m=c._compile().serialize(),p=c._serialize(m).toString("base64");i.push(p)}let s=i.map(c=>{let l=o._buildArgs([c],void 0,"base64");return{methodName:"simulateTransaction",args:l}}),a=[],u=20;for(let c=0;c<Math.ceil(s.length/u);c++)a.push(s.slice(c*u,(c+1)*u));n=await(await Promise.all(a.map(async c=>(await o._rpcBatchRequest(c)).map(l=>l.result.value)))).flat()}else try{n=await Promise.all(e.map(async r=>await(await o.simulateTransaction(r)).value))}catch(r){r instanceof Error&&Dt.logWithError("failed to get info for multiple accounts","RPC_ERROR",{message:r.message})}return n}function oo({instructions:o,payer:e,signers:t}){return fr(o,[e,...t])}function ro({instructions:o,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=xa.generate().publicKey.toString()}){let i=new Jl({payerKey:e,recentBlockhash:n,instructions:o}).compileToV0Message(Object.values(t!=null?t:{}));try{return Buffer.from(new Ii(i).serialize()).toString("base64").length<Sa}catch{return!1}}var mr={time:0,data:void 0};async function _b(o){if(!mr.data||(Date.now()-mr.time)/1e3>30){let e=await o.getEpochInfo();return mr={time:Date.now(),data:e},e}else return mr.data}var Ra=o=>Buffer.isBuffer(o)?o:o instanceof Uint8Array?Buffer.from(o.buffer,o.byteOffset,o.byteLength):Buffer.from(o);function bn(o){let e=[];return o.forEach(t=>{t instanceof dr&&(t.recentBlockhash||(t.recentBlockhash=em.toBase58()),t.feePayer||(t.feePayer=xa.generate().publicKey));let n=t.serialize({requireAllSignatures:!1,verifySignatures:!1});t instanceof Ii&&(n=Ra(n));let r=n.toString("base64");e.push(r)}),console.log("simulate tx string:",e),e}function Fb(o){let e=o.serialize({requireAllSignatures:!1,verifySignatures:!1});return o instanceof Ii&&(e=Ra(e)),e.toString("base64")}import{PublicKey as La,AddressLookupTableAccount as yr}from"@solana/web3.js";import{PublicKey as Oa}from"@solana/web3.js";import{MINT_SIZE as nm,TOKEN_PROGRAM_ID as om,getTransferFeeConfig as rm,unpackMint as im}from"@solana/spl-token";var Bi=ce("Raydium_accountInfo_util");async function Bt(o,e,t){let{batchRequest:n,commitment:r="confirmed",chunkCount:i=100}=C({batchRequest:!1},t),s=xi(e,i),a=new Array(s.length).fill([]);if(n){let u=s.map(m=>{let d=o._buildArgs([m.map(p=>p.toBase58())],r,"base64");return{methodName:"getMultipleAccounts",args:d}}),c=xi(u,10);a=(await(await Promise.all(c.map(async m=>await o._rpcBatchRequest(m)))).flat()).map(m=>(m.error&&Bi.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${m.error.message}`),m.result.value.map(d=>{if(d){let{data:p,executable:y,lamports:f,owner:b,rentEpoch:g}=d;return p.length!==2&&p[1]!=="base64"&&Bi.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(p[0],"base64"),executable:y,lamports:f,owner:new Oa(b),rentEpoch:g}}return null})))}else try{a=await Promise.all(s.map(u=>o.getMultipleAccountsInfo(u,r)))}catch(u){u instanceof Error&&Bi.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${u.message}`)}return a.flat()}async function We(o,e,t){let n=await Bt(o,e.map(r=>r.pubkey),t);return e.map((r,i)=>E(C({},r),{accountInfo:n[i]}))}var sm=(n=>(n[n.Uninitialized=0]="Uninitialized",n[n.Mint=1]="Mint",n[n.Account=2]="Account",n))(sm||{}),zb=1;async function Fn({connection:o,mints:e,config:t}){var i,s,a;if(e.length===0)return{};let n=await We(o,e.map(u=>({pubkey:pt(u)})),t),r={};for(let u of n){if(!u.accountInfo||u.accountInfo.data.length<nm){console.log("invalid mint account",u.pubkey.toBase58());continue}let c=im(u.pubkey,u.accountInfo,(i=u.accountInfo)==null?void 0:i.owner);r[u.pubkey.toString()]=E(C({},c),{programId:((s=u.accountInfo)==null?void 0:s.owner)||om,feeConfig:(a=rm(c))!=null?a:void 0})}return r[Oa.default.toBase58()]=r[j.toBase58()],r}async function Si({connection:o,address:e}){let t=await Bt(o,[...new Set(e.map(r=>r.toString()))].map(r=>new La(r))),n={};for(let r=0;r<e.length;r++){let i=t[r],s=e[r];if(!i)continue;let a=new yr({key:s,state:yr.deserialize(i.data)});n[s.toString()]=a,br[s.toString()]=a}return n}var br={"2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17":new yr({key:new La("2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17"),state:yr.deserialize(Buffer.from("AQAAAP//////////d49+DAAAAAAAAQZMWvw7GUNJdaccNBVnb57OKakxL2BHLYvhRwVILRsgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMGRm/lIRcy/+ytunLDm+e8jOW7xfcSayxDmzpAAAAABt324ddloZPZy+FGzut5rBy0he1fWzeROoz1hX7/AKkG3fbh7nWP3hhCXbzkbM3athr8TYO5DSf+vfko2KGL/AVKU1D4XciC1hSlVnJ4iilt3x6rq9CmBniISTL07vagBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvDQdRqCgtphMF/imcN7mY5YRx2xE1A3MQ+L4QRaYK9u4GRfZP3LsAd00a+IkCpA22UNQMKdq5BFbJuwuOLqc8zxCTDlqxBG8J0HcxtfogQHDK06ukzfaXiNDKAob1MqBHS9lJxDYCwz8gd5DtFqNSTKG5l1zxIaKpDP/sffi2is1H9aKveyXSu5StXElYRl9SD5As0DHE4N0GLnf84/siiKXVyp4Ez121kLcUui/jLLFZEz/BwZK3Ilf9B9OcsEAeDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu9N9LMnrw/JNO0hqMVB4rk/2ou4AB1loQ7FZoPwut2o4KZB+0p9xnbrQKw038qjpHar+PyDwvxBRcu5hpHw3dguezeWv+IwvgW5icu8EGkhGa9AkFPPJT7VMSFb8xowveU=","base64"))})};var gr=class{constructor(e){this.instructions=[];this.endInstructions=[];this.lookupTableAddress=[];this.signers=[];this.instructionTypes=[];this.endInstructionTypes=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster,this.blockhashCommitment=e.blockhashCommitment,this.api=e.api}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){var n;let e=(await am.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=(n=e==null?void 0:e[15])!=null?n:{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=pr(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:r=[],endInstructionTypes:i=[],lookupTableAddress:s=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...r),this.endInstructionTypes.push(...i),this.lookupTableAddress.push(...s.filter(a=>a!==io.default.toString())),this}async versionBuild({txVersion:e,extInfo:t}){return e===0?await this.buildV0(C({},t||{})):this.build(t)}build(e){var n;let t=new so;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,((n=this.owner)==null?void 0:n.signer)&&!this.signers.some(r=>r.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer),{builder:this,transaction:t,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async r=>{var c;let{recentBlockHash:i,skipPreflight:s=!0,sendAndConfirm:a}=r||{},u=i!=null?i:await _n(this.connection,this.blockhashCommitment);if(t.recentBlockhash=u,this.signers.length&&t.sign(...this.signers),bn([t]),(c=this.owner)!=null&&c.isKeyPair)return{txId:a?await Ki(this.connection,t,this.signers.find(m=>m.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:s}):await this.connection.sendRawTransaction(t.serialize(),{skipPreflight:s}),signedTx:t};if(this.signAllTransactions){let l=await this.signAllTransactions([t]);return{txId:await this.connection.sendRawTransaction(l[0].serialize(),{skipPreflight:s}),signedTx:l[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){var c;let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:r}=this.build(n),i=t.filter(l=>l.transaction.instructions.length>0),s=[r,...i.map(l=>l.transaction)],a=[this.signers,...i.map(l=>l.signers)],u=[...this.instructionTypes,...i.map(l=>l.instructionTypes).flat()];return(c=this.owner)!=null&&c.signer&&a.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),{builder:this,transactions:s,signers:a,instructionTypes:u,execute:async l=>{var b;let{sequentially:m,onTxUpdate:d,recentBlockHash:p,skipPreflight:y=!0}=l||{},f=p!=null?p:await _n(this.connection,this.blockhashCommitment);if((b=this.owner)!=null&&b.isKeyPair){if(m){let g=[];for(let w of s){let A=await Ki(this.connection,w,this.signers.find(k=>k.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:y});g.push(A)}return{txIds:g,signedTxs:s}}return{txIds:await await Promise.all(s.map(async g=>(g.recentBlockhash=f,await this.connection.sendRawTransaction(g.serialize(),{skipPreflight:y})))),signedTxs:s}}if(this.signAllTransactions){let g=s.map((A,k)=>(A.recentBlockhash=f,a[k].length&&A.sign(...a[k]),A));bn(g);let w=await this.signAllTransactions(g);if(m){let A=0,k=[],I=async()=>{if(!w[A])return;let T=await this.connection.sendRawTransaction(w[A].serialize(),{skipPreflight:y});k.push({txId:T,status:"sent",signedTx:w[A]}),d==null||d([...k]),A++,this.connection.onSignature(T,S=>{let x=k.findIndex(R=>R.txId===T);x>-1&&(k[x].status=S.err?"error":"success"),d==null||d([...k]),S.err||I()},"processed"),this.connection.getSignatureStatus(T)};return await I(),{txIds:k.map(T=>T.txId),signedTxs:w}}else{let A=[];for(let k=0;k<w.length;k+=1){let I=await this.connection.sendRawTransaction(w[k].serialize(),{skipPreflight:y});A.push(I)}return{txIds:A,signedTxs:w}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e){var f;let y=e||{},{lookupTableCache:t={},lookupTableAddress:n=[],forerunCreate:r,recentBlockhash:i}=y,s=Oe(y,["lookupTableCache","lookupTableAddress","forerunCreate","recentBlockhash"]),a=C(C({},this.cluster==="devnet"?{}:br),t),u=Array.from(new Set([...n,...this.lookupTableAddress])),c=[];for(let b of u)a[b]===void 0&&c.push(new io(b));let l=await Si({connection:this.connection,address:c});for(let[b,g]of Object.entries(l))a[b]=g;let m=r?io.default.toBase58():i!=null?i:await _n(this.connection,this.blockhashCommitment),d=new ao({payerKey:this.feePayer,recentBlockhash:m,instructions:[...this.allInstructions]}).compileToV0Message(Object.values(a));((f=this.owner)==null?void 0:f.signer)&&!this.signers.some(b=>b.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer);let p=new uo(d);return p.sign(this.signers),{builder:this,transaction:p,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async b=>{var A;let{skipPreflight:g=!0,sendAndConfirm:w}=b||{};if(bn([p]),(A=this.owner)!=null&&A.isKeyPair){let k=await this.connection.sendTransaction(p,{skipPreflight:g});if(w){let{lastValidBlockHeight:I,blockhash:T}=await this.connection.getLatestBlockhash({commitment:this.blockhashCommitment});await this.connection.confirmTransaction({blockhash:T,lastValidBlockHeight:I,signature:k},"confirmed")}return{txId:k,signedTx:p}}if(this.signAllTransactions){let k=await this.signAllTransactions([p]);return{txId:await this.connection.sendTransaction(k[0],{skipPreflight:g}),signedTx:k[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}async buildV0MultiTx(e){var c;let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:r}=await this.buildV0(n),i=t.filter(l=>l.builder.instructions.length>0),s=[r,...i.map(l=>l.transaction)],a=[this.signers,...i.map(l=>l.signers)],u=[...this.instructionTypes,...i.map(l=>l.instructionTypes).flat()];return(c=this.owner)!=null&&c.signer&&a.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),s.forEach(async(l,m)=>{l.sign(a[m])}),{builder:this,transactions:s,signers:a,instructionTypes:u,buildProps:n,execute:async l=>{var f;let{sequentially:m,onTxUpdate:d,recentBlockHash:p,skipPreflight:y=!0}=l||{};if(p&&s.forEach(b=>b.message.recentBlockhash=p),bn(s),(f=this.owner)!=null&&f.isKeyPair){if(m){let b=[];for(let g of s){let w=await this.connection.sendTransaction(g,{skipPreflight:y}),{lastValidBlockHeight:A,blockhash:k}=await this.connection.getLatestBlockhash({commitment:this.blockhashCommitment});await this.connection.confirmTransaction({blockhash:k,lastValidBlockHeight:A,signature:w},"confirmed"),b.push(w)}return{txIds:b,signedTxs:s}}return{txIds:await Promise.all(s.map(async b=>await this.connection.sendTransaction(b,{skipPreflight:y}))),signedTxs:s}}if(this.signAllTransactions){let b=await this.signAllTransactions(s);if(m){let g=0,w=[],A=async()=>{if(!b[g])return;let k=await this.connection.sendTransaction(b[g],{skipPreflight:y});w.push({txId:k,status:"sent",signedTx:b[g]}),d==null||d([...w]),g++,this.connection.onSignature(k,I=>{let T=w.findIndex(S=>S.txId===k);T>-1&&(w[T].status=I.err?"error":"success"),d==null||d([...w]),I.err||A()},"processed"),this.connection.getSignatureStatus(k)};return A(),{txIds:[],signedTxs:b}}else{let g=[];for(let w=0;w<b.length;w+=1){let A=await this.connection.sendTransaction(b[w],{skipPreflight:y});g.push(A)}return{txIds:g,signedTxs:b}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){var l;let c=e||{},{computeBudgetConfig:t}=c,n=Oe(c,["computeBudgetConfig"]),r=t?pr(t):{instructions:[],instructionTypes:[]},i=this.signers.reduce((m,d)=>E(C({},m),{[d.publicKey.toBase58()]:d}),{}),s=[],a=[],u=[];if(this.allInstructions.forEach(m=>{let d=[...u,m],p=t?[...r.instructions,...d]:d,f=[...new Set(d.map(b=>b.keys.filter(g=>g.isSigner).map(g=>g.pubkey.toString())).flat()).values()].map(b=>new io(b));if(u.length<12&&oo({instructions:p,payer:this.feePayer,signers:f})||oo({instructions:d,payer:this.feePayer,signers:f}))u.push(m);else{if(u.length===0)throw Error("item ins too big");oo({instructions:t?[...r.instructions,...u]:[...u],payer:this.feePayer,signers:f})?s.push(new so().add(...r.instructions,...u)):s.push(new so().add(...u)),a.push(Array.from(new Set(u.map(b=>b.keys.filter(g=>g.isSigner).map(g=>g.pubkey.toString())).flat())).map(b=>i[b]).filter(b=>b!==void 0)),u=[m]}}),u.length>0){let d=[...new Set(u.map(p=>p.keys.filter(y=>y.isSigner).map(y=>y.pubkey.toString())).flat()).values()].map(p=>i[p]).filter(p=>p!==void 0);oo({instructions:t?[...r.instructions,...u]:[...u],payer:this.feePayer,signers:d.map(p=>p.publicKey)})?s.push(new so().add(...r.instructions,...u)):s.push(new so().add(...u)),a.push(d)}return s.forEach(m=>m.feePayer=this.feePayer),(l=this.owner)!=null&&l.signer&&a.forEach(m=>{m.some(d=>d.publicKey.equals(this.owner.publicKey))||m.push(this.owner.signer)}),{builder:this,transactions:s,signers:a,instructionTypes:this.instructionTypes,execute:async m=>{var g;let{sequentially:d,onTxUpdate:p,recentBlockHash:y,skipPreflight:f=!0}=m||{},b=y!=null?y:await _n(this.connection,this.blockhashCommitment);if(s.forEach(async(w,A)=>{w.recentBlockhash=b,a[A].length&&w.sign(...a[A])}),bn(s),(g=this.owner)!=null&&g.isKeyPair){if(d){let w=[];for(let A of s){let k=await Ki(this.connection,A,this.signers.find(I=>I.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:f});w.push(k)}return{txIds:w,signedTxs:s}}return{txIds:await Promise.all(s.map(async w=>await this.connection.sendRawTransaction(w.serialize(),{skipPreflight:f}))),signedTxs:s}}if(this.signAllTransactions){let w=await this.signAllTransactions(s);if(d){let A=0,k=[],I=async()=>{if(!w[A])return;let T=await this.connection.sendRawTransaction(w[A].serialize(),{skipPreflight:f});k.push({txId:T,status:"sent",signedTx:w[A]}),p==null||p([...k]),A++,this.connection.onSignature(T,S=>{let x=k.findIndex(R=>R.txId===T);x>-1&&(k[x].status=S.err?"error":"success"),p==null||p([...k]),S.err||I()},"processed"),this.connection.getSignatureStatus(T)};return await I(),{txIds:k.map(T=>T.txId),signedTxs:w}}else{let A=[];for(let k=0;k<w.length;k+=1){let I=await this.connection.sendRawTransaction(w[k].serialize(),{skipPreflight:f});A.push(I)}return{txIds:A,signedTxs:w}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuildV0(e){var g;let b=e||{},{computeBudgetConfig:t,lookupTableCache:n={},lookupTableAddress:r=[]}=b,i=Oe(b,["computeBudgetConfig","lookupTableCache","lookupTableAddress"]),s=C(C({},this.cluster==="devnet"?{}:br),n),a=Array.from(new Set([...this.lookupTableAddress,...r])),u=[];for(let w of a)s[w]===void 0&&u.push(new io(w));let c=await Si({connection:this.connection,address:u});for(let[w,A]of Object.entries(c))s[w]=A;let l=t?pr(t):{instructions:[],instructionTypes:[]},m=await _n(this.connection,this.blockhashCommitment),d=this.signers.reduce((w,A)=>E(C({},w),{[A.publicKey.toBase58()]:A}),{}),p=[],y=[],f=[];if(this.allInstructions.forEach(w=>{let A=[...f,w],k=t?[...l.instructions,...A]:A;if(f.length<12&&ro({instructions:k,payer:this.feePayer,lookupTableAddressAccount:s})||ro({instructions:A,payer:this.feePayer,lookupTableAddressAccount:s}))f.push(w);else{if(f.length===0)throw Error("item ins too big");let I={};for(let T of[...new Set(a)])s[T]!==void 0&&(I[T]=s[T]);if(t&&ro({instructions:[...l.instructions,...f],payer:this.feePayer,lookupTableAddressAccount:s,recentBlockhash:m})){let T=new ao({payerKey:this.feePayer,recentBlockhash:m,instructions:[...l.instructions,...f]}).compileToV0Message(Object.values(s));p.push(new uo(T))}else{let T=new ao({payerKey:this.feePayer,recentBlockhash:m,instructions:[...f]}).compileToV0Message(Object.values(s));p.push(new uo(T))}y.push(Array.from(new Set(f.map(T=>T.keys.filter(S=>S.isSigner).map(S=>S.pubkey.toString())).flat())).map(T=>d[T]).filter(T=>T!==void 0)),f=[w]}}),f.length>0){let A=[...new Set(f.map(k=>k.keys.filter(I=>I.isSigner).map(I=>I.pubkey.toString())).flat()).values()].map(k=>d[k]).filter(k=>k!==void 0);if(t&&ro({instructions:[...l.instructions,...f],payer:this.feePayer,lookupTableAddressAccount:s,recentBlockhash:m})){let k=new ao({payerKey:this.feePayer,recentBlockhash:m,instructions:[...l.instructions,...f]}).compileToV0Message(Object.values(s));p.push(new uo(k))}else{let k=new ao({payerKey:this.feePayer,recentBlockhash:m,instructions:[...f]}).compileToV0Message(Object.values(s));p.push(new uo(k))}y.push(A)}return(g=this.owner)!=null&&g.signer&&y.forEach(w=>{w.some(A=>A.publicKey.equals(this.owner.publicKey))||w.push(this.owner.signer)}),{builder:this,transactions:p,buildProps:e,signers:y,instructionTypes:this.instructionTypes,execute:async w=>{var S;let{sequentially:A,onTxUpdate:k,recentBlockHash:I,skipPreflight:T=!0}=w||{};if(p.map(async(x,R)=>{y[R].length&&x.sign(y[R]),I&&(x.message.recentBlockhash=I)}),bn(p),(S=this.owner)!=null&&S.isKeyPair){if(A){let x=[];for(let R of p){let B=await this.connection.sendTransaction(R,{skipPreflight:T}),{lastValidBlockHeight:M,blockhash:D}=await this.connection.getLatestBlockhash({commitment:this.blockhashCommitment});await this.connection.confirmTransaction({blockhash:D,lastValidBlockHeight:M,signature:B},"confirmed"),x.push(B)}return{txIds:x,signedTxs:p}}return{txIds:await Promise.all(p.map(async x=>await this.connection.sendTransaction(x,{skipPreflight:T}))),signedTxs:p}}if(this.signAllTransactions){let x=await this.signAllTransactions(p);if(A){let R=0,B=[],M=async()=>{if(!x[R])return;let D=await this.connection.sendTransaction(x[R],{skipPreflight:T});B.push({txId:D,status:"sent",signedTx:x[R]}),k==null||k([...B]),R++,this.connection.onSignature(D,F=>{let Z=B.findIndex(G=>G.txId===D);Z>-1&&(B[Z].status=F.err?"error":"success"),k==null||k([...B]),F.err||M()},"processed"),this.connection.getSignatureStatus(D)};return M(),{txIds:[],signedTxs:x}}else{let R=[];for(let B=0;B<x.length;B+=1){let M=await this.connection.sendTransaction(x[B],{skipPreflight:T});R.push(M)}return{txIds:R,signedTxs:x}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:i||{}}}};var xt=class{constructor(e){this._owner=e}get publicKey(){return xt.isKeyPair(this._owner)?this._owner.publicKey:this._owner}get signer(){return xt.isKeyPair(this._owner)?this._owner:void 0}get isKeyPair(){return xt.isKeyPair(this._owner)}get isPublicKey(){return xt.isPublicKey(this._owner)}static isKeyPair(e){return e.secretKey!==void 0}static isPublicKey(e){return!xt.isKeyPair(e)}};function xi(o,e=1,t=[]){let n=[...o];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}function lg(o,...e){return o.filter(t=>e.every(n=>n.includes(t)))}function mg(o,...e){return o.filter(t=>e.every(n=>!n.includes(t)))}function dg(o){return[...new Set(o)]}var Na=o=>typeof o=="number",Ma=o=>o?new Date(o):new Date,um=o=>Ma(o).getTime();function va(o,e,t){let n=Na(e)?e*((t==null?void 0:t.unit)==="s"?1e3:1):e;return new Date(o).getTime()<=n}function _a(o,e,t){let n=Na(e)?e*((t==null?void 0:t.unit)==="s"?1e3:1):e;return new Date(o).getTime()>n}function fg(o,e){let n=um(o)+(e.days?e.days*24*60*60*1e3:0)+(e.hours?e.hours*60*60*1e3:0)+(e.minutes?e.minutes*60*1e3:0)+(e.seconds?e.seconds*1e3:0)+(e.milliseconds?e.milliseconds:0);return Ma(n)}import{PublicKey as de}from"@solana/web3.js";var Ci=new de("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),Ri=new de("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),Vn=new de("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),cm=new de("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),lm=new de("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),Ar=new de("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),Oi=new de("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),mm=new de("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),Fa=new de("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Li=new de("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),dm=new de("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),gg=new de("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),pm=new de("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),fm=new de("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),ym=new de("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),bm=new de("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),Ni=new de("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),gm=new de("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),Am=new de("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),wm=new de("CPMDWBwJDtYax9qW7AyRuVC19Cc4L4Vcy4n2BHAbHkCW"),Pm=new de("7rQ1QFNosMkUCuh7Z7fPbTHvh73b68sQYdirycEzJVuw"),hm=new de("G11FKBRaAkHAKuLCgLM6K6NUc9rTjPAznRCjZifrTQe2"),co={IDO_PROGRAM_ID_V1:pm,IDO_PROGRAM_ID_V2:fm,IDO_PROGRAM_ID_V3:ym,IDO_PROGRAM_ID_V4:bm},Ag={AMM_V4:Oi,AMM_STABLE:mm,CLMM_PROGRAM_ID:Li,FARM_PROGRAM_ID_V3:Ci,FARM_PROGRAM_ID_V5:Ri,FARM_PROGRAM_ID_V6:Vn,OPEN_BOOK_PROGRAM:lm,SERUM_PROGRAM_ID_V3:Ar,UTIL1216:cm,Router:dm,CREATE_CPMM_POOL_PROGRAM:Ni,CREATE_CPMM_POOL_AUTH:gm,CREATE_CPMM_POOL_FEE_ACC:Am},wg={SERUM_MARKET:de.default,OPENBOOK_MARKET:new de("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),UTIL1216:de.default,FarmV3:new de("85BFyr98MbCUU9MVTEgzx1nbhWACbJqLzho6zd6DZcWL"),FarmV5:new de("EcLzTrNg9V7qhcdyXDe2qjtPkiGzDM2UbdRaeaadU5r2"),FarmV6:new de("Farm2hJLcqPtPg8M4rR6DMrsRNc5TPm5Cs4bVQrMe2T7"),AmmV4:new de("HWy1jotHpo6UqeQxx49dpYYdQB8wj9Qk9MdxwjLvDHB8"),AmmStable:new de("DDg4VmQaJV9ogWce7LpcjBA9bv22wRp5uaTPa5pGjijF"),CLMM:new de("devi51mZmdwUJGU9hjN27vEz64Gps7uUefqxg27EAtH"),Router:new de("BVChZ3XFEwTMUk1o9i3HAf91H6mFxSwa5X2wFAWhYPhU"),CREATE_CPMM_POOL_PROGRAM:wm,CREATE_CPMM_POOL_AUTH:Pm,CREATE_CPMM_POOL_FEE_ACC:hm,FEE_DESTINATION_ID:new de("3XMrhbv989VxAMi3DErLV9eJht1pHppW5LbKxe9fkEFR")};import{PublicKey as km}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Tm}from"@solana/spl-token";function we(o,e,t){return ue([o.toBuffer(),(t!=null?t:Tm).toBuffer(),e.toBuffer()],new km("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import ve from"bn.js";var vt=1e4;function xg(o,e,t,n){if(e===void 0)return{amount:o,fee:void 0,expirationTime:void 0};let r=t.epoch<e.newerTransferFee.epoch?e.olderTransferFee:e.newerTransferFee,i=new ve(r.maximumFee.toString()),s=t.epoch<e.newerTransferFee.epoch?(Number(e.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(r.transferFeeBasisPoints===vt){let a=new ve(r.maximumFee.toString());return{amount:o.add(a),fee:a,expirationTime:s}}else{let a=St(o.mul(new ve(vt)),new ve(vt-r.transferFeeBasisPoints)),u=new ve(r.maximumFee.toString()),c=a.sub(o).gt(u)?o.add(u):a,l=St(c.mul(new ve(r.transferFeeBasisPoints)),new ve(vt)),m=l.gt(i)?i:l;return{amount:c,fee:m,expirationTime:s}}else{let a=St(o.mul(new ve(r.transferFeeBasisPoints)),new ve(vt)),u=a.gt(i)?i:a;return{amount:o,fee:u,expirationTime:s}}}function be(o,e,t,n){if(e===void 0)return{amount:o,fee:void 0,expirationTime:void 0};let r=E(C({},e),{olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}}),i=t.epoch<r.newerTransferFee.epoch?r.olderTransferFee:r.newerTransferFee,s=new ve(i.maximumFee.toString()),a=t.epoch<r.newerTransferFee.epoch?(Number(r.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(i.transferFeeBasisPoints===vt){let u=new ve(i.maximumFee.toString());return{amount:o.add(u),fee:u,expirationTime:a}}else{let u=St(o.mul(new ve(vt)),new ve(vt-i.transferFeeBasisPoints)),c=new ve(i.maximumFee.toString()),l=u.sub(o).gt(c)?o.add(c):u,m=St(l.mul(new ve(i.transferFeeBasisPoints)),new ve(vt)),d=m.gt(s)?s:m;return{amount:l,fee:d,expirationTime:a}}else{let u=St(o.mul(new ve(i.transferFeeBasisPoints)),new ve(vt)),c=u.gt(s)?s:u;return{amount:o,fee:c,expirationTime:a}}}function Kt(o,e){return o===void 0?e:e===void 0?o:Math.min(o,e)}function St(o,e){let{div:t,mod:n}=o.divmod(e);return n.gt(new ve(0))?t.add(new ve(1)):t}var Va=(t=>(t.ALL="all",t.Strict="strict",t))(Va||{}),Ea=(s=>(s.All="all",s.Standard="standard",s.Concentrated="concentrated",s.AllFarm="allFarm",s.StandardFarm="standardFarm",s.ConcentratedFarm="concentratedFarm",s))(Ea||{});var Ne={BASE_HOST:"https://api-v3.raydium.io",OWNER_BASE_HOST:"https://owner-v1.raydium.io",SERVICE_BASE_HOST:"https://service.raydium.io",MONITOR_BASE_HOST:"https://monitor.raydium.io",SEND_TRANSACTION:"/send-transaction",FARM_ARP:"/main/farm/info",FARM_ARP_LINE:"/main/farm-apr-tv",CLMM_CONFIG:"/main/clmm-config",CPMM_CONFIG:"/main/cpmm-config",VERSION:"/main/version",CHECK_AVAILABILITY:"/v3/main/AvailabilityCheckAPI",RPCS:"/main/rpcs",INFO:"/main/info",STAKE_POOLS:"/main/stake-pools",CHAIN_TIME:"/main/chain-time",TOKEN_LIST:"/mint/list",MINT_INFO_ID:"/mint/ids",JUP_TOKEN_LIST:"https://tokens.jup.ag/tokens?tags=lst,community",POOL_LIST:"/pools/info/list",POOL_SEARCH_BY_ID:"/pools/info/ids",POOL_SEARCH_MINT:"/pools/info/mint",POOL_SEARCH_LP:"/pools/info/lps",POOL_KEY_BY_ID:"/pools/key/ids",POOL_LIQUIDITY_LINE:"/pools/line/liquidity",POOL_POSITION_LINE:"/pools/line/position",FARM_INFO:"/farms/info/ids",FARM_LP_INFO:"/farms/info/lp",FARM_KEYS:"/farms/key/ids",OWNER_CREATED_FARM:"/create-pool/{owner}",OWNER_IDO:"/main/ido/{owner}",OWNER_STAKE_FARMS:"/position/stake/{owner}",IDO_KEYS:"/ido/key/ids",SWAP_HOST:"https://transaction-v1.raydium.io",SWAP_COMPUTE:"/compute/",SWAP_TX:"/transaction/",MINT_PRICE:"/mint/price",MIGRATE_CONFIG:"/main/migrate-lp",PRIORITY_FEE:"/main/auto-fee",JITO:"https://mainnet.block-engine.jito.wtf",JITO_TRANSACTION:"/api/v1/transactions",JITO_BUNDLE:"/api/v1/bundles"},zg=C({},Ne);var Da="ray_tab_hash",Mi="ray_req_hash",Im=()=>{if(typeof window===void 0)return"";let o=sessionStorage.getItem(Da);return o||(o=`ray-${Date.now()}`,sessionStorage.setItem(Da,o)),o},wr=async n=>{var r=n,{logCount:o=1e3,removeLastLog:e}=r,t=Oe(r,["logCount","removeLastLog"]);if(typeof window===void 0)return new Promise(s=>s());let i=JSON.parse(localStorage.getItem(Mi)||"[]").slice(0,o-1);e&&i.pop(),new Blob([JSON.stringify(t.data)]).size>1024&&(t.data=JSON.stringify(t.data).substring(0,200)+"..."),i.unshift(E(C({},t),{time:Date.now(),session:Im()}));try{localStorage.setItem(Mi,JSON.stringify(i))}catch{if(e){let s=!1,a=JSON.stringify(t.data).substring(0,100);for(i[0].data=a+(a.length>100?"...":"");!s;){i.pop();let u=JSON.stringify(t.data).substring(0,100);i[0].data=u+(u.length>100?"...":"");try{localStorage.setItem(Mi,JSON.stringify(i)),s=!0}catch{s=!1}}return new Promise(u=>u())}return wr(E(C({},t),{logCount:o,removeLastLog:!0}))}};var En=ce("Raydium_Api"),vi=new Map;async function pA(o,e,t=1e3){let n;for(;n==null;)try{En.debug(`Request ${o} through endlessRetry`),n=await e()}catch(r){En.error(`Request ${o} failed, retry after ${t} ms`,r),await Ta(t)}return n}var Pr=class{constructor({cluster:e,timeout:t,logRequests:n,logCount:r,urlConfigs:i}){this.cluster=e,this.urlConfigs=i||{},this.logCount=r||1e3,this.api=Wa.create({baseURL:this.urlConfigs.BASE_HOST||Ne.BASE_HOST,timeout:t}),this.api.interceptors.request.use(s=>{let{method:a,baseURL:u,url:c}=s;return En.debug(`${a==null?void 0:a.toUpperCase()} ${u}${c}`),s},s=>(En.error("Request failed"),Promise.reject(s))),this.api.interceptors.response.use(s=>{let{config:a,data:u,status:c}=s,{method:l,baseURL:m,url:d}=a;return n&&wr({status:c,url:`${m}${d}`,params:a.params,data:u,logCount:this.logCount}),En.debug(`${l==null?void 0:l.toUpperCase()} ${m}${d}  ${c}`),u},s=>{let{config:a,response:u={}}=s,{status:c}=u,{method:l,baseURL:m,url:d}=a;return n&&wr({status:c,url:`${m}${d}`,params:a.params,data:s.message,logCount:this.logCount}),En.error(`${l.toUpperCase()} ${m}${d} ${c||s.message}`),Promise.reject(s)})}async getClmmConfigs(){return(await this.api.get(this.urlConfigs.CLMM_CONFIG||Ne.CLMM_CONFIG)).data}async getCpmmConfigs(){return(await this.api.get(this.urlConfigs.CPMM_CONFIG||Ne.CPMM_CONFIG)).data}async getClmmPoolLines(e){return(await this.api.get(`${this.urlConfigs.POOL_LIQUIDITY_LINE||Ne.POOL_LIQUIDITY_LINE}?pool_id=${e}`)).data}async getBlockSlotCountForSecond(e){if(!e)return 2;let n=(await Wa.post(e,{id:"getRecentPerformanceSamples",jsonrpc:"2.0",method:"getRecentPerformanceSamples",params:[4]})).result.map(r=>r.numSlots);return n.reduce((r,i)=>r+i,0)/n.length/60}async getChainTimeOffset(){return(await this.api.get(this.urlConfigs.CHAIN_TIME||Ne.CHAIN_TIME)).data}async getRpcs(){return this.api.get(this.urlConfigs.RPCS||Ne.RPCS)}async getTokenList(){return(await this.api.get(this.urlConfigs.TOKEN_LIST||Ne.TOKEN_LIST)).data}async getJupTokenList(){return this.api.get("",{baseURL:this.urlConfigs.JUP_TOKEN_LIST||Ne.JUP_TOKEN_LIST})}async getTokenInfo(e){return(await this.api.get((this.urlConfigs.MINT_INFO_ID||Ne.MINT_INFO_ID)+`?mints=${e.map(n=>n.toString()).join(",")}`)).data}async getPoolList(e={}){let{type:t="all",sort:n="liquidity",order:r="desc",page:i=0,pageSize:s=100}=e;return(await this.api.get((this.urlConfigs.POOL_LIST||Ne.POOL_LIST)+`?poolType=${t}&poolSortField=${n}&sortType=${r}&page=${i}&pageSize=${s}`)).data}async fetchPoolById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.POOL_SEARCH_BY_ID||Ne.POOL_SEARCH_BY_ID)+`?ids=${t}`)).data}async fetchPoolKeysById(e){let{idList:t}=e,n=[],r=t.filter(s=>vi.has(s)?(n.push(vi.get(s)),!1):!0),i=[];return r.length&&(i=(await this.api.get((this.urlConfigs.POOL_KEY_BY_ID||Ne.POOL_KEY_BY_ID)+`?ids=${r.join(",")}`)).data.filter(Boolean),i.forEach(a=>{vi.set(a.id,a)})),n.concat(i)}async fetchPoolByMints(e){let{mint1:t,mint2:n,type:r="all",sort:i="default",order:s="desc",page:a=1}=e,[u,c]=[t&&pt(t).toBase58(),n&&n!=="undefined"?pt(n).toBase58():""],[l,m]=c&&u>c?[c,u]:[u,c];return(await this.api.get((this.urlConfigs.POOL_SEARCH_MINT||Ne.POOL_SEARCH_MINT)+`?mint1=${l}&mint2=${m}&poolType=${r}&poolSortField=${i}&sortType=${s}&pageSize=100&page=${a}`)).data}async fetchFarmInfoById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_INFO||Ne.FARM_INFO)+`?ids=${t}`)).data}async fetchFarmKeysById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_KEYS||Ne.FARM_KEYS)+`?ids=${t}`)).data}async fetchAvailabilityStatus(){return(await this.api.get(this.urlConfigs.CHECK_AVAILABILITY||Ne.CHECK_AVAILABILITY)).data}async sendTxToJito(e,t){let n=t?this.urlConfigs.JITO_BUNDLE||Ne.JITO_BUNDLE:this.urlConfigs.JITO_TRANSACTION||Ne.JITO_TRANSACTION;return(await this.api.post(n,{jsonrpc:"2.0",id:1,method:t?"sendBundle":"sendTransaction",params:e},{baseURL:this.urlConfigs.JITO||Ne.JITO})).data}};import{merge as Tf}from"lodash";var hr="please provide owner in load() initialization or you can set by calling raydium.setOwner(owner)",qa="please provide connection in load() initialization or set it by raydium.setConnection(connection)";import{createAssociatedTokenAccountInstruction as ji,TOKEN_PROGRAM_ID as an,AccountLayout as qn,TOKEN_2022_PROGRAM_ID as Md}from"@solana/spl-token";import{PublicKey as Sr,SystemProgram as vd}from"@solana/web3.js";var _i=(...o)=>o.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Ke=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=ce(t)}createTxBuilder(e){return this.scope.checkOwner(),new gr({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,blockhashCommitment:this.scope.blockhashCommitment,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(_i(e))}logInfo(...e){this.logger.info(_i(e))}logAndCreateError(...e){let t=_i(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{createInitializeAccountInstruction as Kd,createCloseAccountInstruction as Cd,createTransferInstruction as Rd,TOKEN_PROGRAM_ID as Wn}from"@solana/spl-token";import{PublicKey as Od,SystemProgram as Ld}from"@solana/web3.js";import Nd from"bn.js";import{PublicKey as ru,Keypair as Id}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Bd}from"@solana/spl-token";import xd from"bn.js";import{PublicKey as bd}from"@solana/web3.js";import ja,{isBN as Ha}from"bn.js";import{bits as Bm,BitStructure as xm,blob as Sm,Blob as Km,cstr as Cm,f32 as Rm,f32be as Om,f64 as Lm,f64be as Nm,greedy as Mm,Layout as vm,ns64 as _m,ns64be as Fm,nu64 as Vm,nu64be as Em,offset as Dm,s16 as Wm,s16be as qm,s24 as Um,s24be as Gm,s32 as Xm,s32be as zm,s40 as Qm,s40be as Ym,s48 as jm,s48be as Hm,s8 as Zm,seq as $m,struct as xA,Structure as Jm,u16 as ed,u16be as td,u24 as nd,u24be as od,u32 as rd,u32be as id,u40 as sd,u40be as ad,u48 as ud,u48be as cd,u8 as ld,UInt as md,union as dd,Union as pd,unionLayoutDiscriminator as fd,utf8 as yd}from"@solana/buffer-layout";var lo=vm,Ua=Jm,Ga=pd,SA=xm,Fi=md,Xa=Km,KA=Mm,kr=ld,qt=ed,CA=nd,mo=rd,RA=sd,OA=ud,za=Vm,LA=td,NA=od,MA=id,vA=ad,_A=cd,FA=Em,VA=Zm,EA=Wm,DA=Um,Qe=Xm,WA=Qm,qA=jm,UA=_m,GA=qm,XA=Gm,zA=zm,QA=Ym,YA=Hm,jA=Fm,HA=Rm,ZA=Om,$A=Lm,JA=Nm;var Qa=$m,Ya=dd,ew=fd,ge=Sm,tw=Cm,nw=yd,Vi=Bm,Ei=Dm;var gn=class extends lo{constructor(t,n,r){super(t,r);this.blob=ge(t),this.signed=n}decode(t,n=0){let r=new ja(this.blob.decode(t,n),10,"le");return this.signed?r.fromTwos(this.span*8).clone():r}encode(t,n,r=0){return typeof t=="number"&&(t=new ja(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),n,r)}},Tr=class extends lo{constructor(t){super(8,t);this._lower=Vi(mo(),!1),this._upper=Vi(mo(),!1)}addBoolean(t){this._lower.fields.length<32?this._lower.addBoolean(t):this._upper.addBoolean(t)}decode(t,n=0){let r=this._lower.decode(t,n),i=this._upper.decode(t,n+this._lower.span);return C(C({},r),i)}encode(t,n,r=0){return this._lower.encode(t,n,r)+this._upper.encode(t,n,r+this._lower.span)}};function W(o){return new Fi(1,o)}function Ye(o){return new Fi(4,o)}function h(o){return new gn(8,!1,o)}function J(o){return new gn(16,!1,o)}function Za(o){return new gn(1,!0,o)}function Dn(o){return new gn(8,!0,o)}function $a(o){return new gn(16,!0,o)}var Ut=class extends lo{constructor(t,n,r,i){super(t.span,i);this.layout=t,this.decoder=n,this.encoder=r}decode(t,n){return this.decoder(this.layout.decode(t,n))}encode(t,n,r){return this.layout.encode(this.encoder(t),n,r)}getSpan(t,n){return this.layout.getSpan(t,n)}};function K(o){return new Ut(ge(32),e=>new bd(e),e=>e.toBuffer(),o)}var Di=class extends lo{constructor(t,n){super(-1,n);this.layout=t,this.discriminator=kr()}encode(t,n,r=0){return t==null?this.discriminator.encode(0,n,r):(this.discriminator.encode(1,n,r),this.layout.encode(t,n,r+1)+1)}decode(t,n=0){let r=this.discriminator.decode(t,n);if(r===0)return null;if(r===1)return this.layout.decode(t,n+1);throw new Error("Invalid option "+this.property)}getSpan(t,n=0){let r=this.discriminator.decode(t,n);if(r===0)return 1;if(r===1)return this.layout.getSpan(t,n+1)+1;throw new Error("Invalid option "+this.property)}};function aw(o,e){return new Di(o,e)}function je(o){return new Ut(kr(),gd,Ad,o)}function gd(o){if(o===0)return!1;if(o===1)return!0;throw new Error("Invalid bool: "+o)}function Ad(o){return o?1:0}function uw(o,e){let t=mo("length"),n=v([t,X(o,Ei(t,-t.span),"values")]);return new Ut(n,({values:r})=>r,r=>({values:r}),e)}function cw(o,e,t){let n=v([h("tag"),e.replicate("data")]);function r({tag:i,data:s}){if(!i.eq(o))throw new Error("Invalid tag, expected: "+o.toString("hex")+", got: "+i.toString("hex"));return s}return new Ut(n,r,i=>({tag:o,data:i}),t)}function wd(o){let e=mo("length"),t=v([e,ge(Ei(e,-e.span),"data")]);return new Ut(t,({data:n})=>n,n=>({data:n}),o)}function lw(o){return new Ut(wd(),e=>e.toString("utf-8"),e=>Buffer.from(e,"utf-8"),o)}function mw(o,e){let t=Ya(kr(),e);return o.forEach((n,r)=>t.addVariant(r,n,n.property)),t}function dw(o,e,t){let n=v([X(o,e,"values")]);return new Ut(n,({values:r})=>r,r=>({values:r}),t)}var Wi=class extends Ua{decode(e,t){return super.decode(e,t)}};function v(o,e,t){return new Wi(o,e,t)}var qi=class extends Ga{encodeInstruction(e){let t=Math.max(...Object.values(this.registry).map(r=>r.span)),n=Buffer.alloc(t);return n.slice(0,this.encode(e,n))}decodeInstruction(e){return this.decode(e)}};function pw(o,e,t){return new qi(o,e,t)}var Ui=class extends Xa{decode(e,t){let n=super.decode(e,t);if(!n.every(r=>r===0))throw new Error("nonzero padding bytes");return n}};function fw(o){return new Ui(o)}function X(o,e,t){let n,r=typeof e=="number"?e:Ha(e)?e.toNumber():new Proxy(e,{get(i,s){if(!n){let a=Reflect.get(i,"count");n=Ha(a)?a.toNumber():a,Reflect.set(i,"count",n)}return Reflect.get(i,s)},set(i,s,a){return s==="count"&&(n=a),Reflect.set(i,s,a)}});return Qa(o,r,t)}var on=v([K("mint"),K("owner"),h("amount"),Ye("delegateOption"),K("delegate"),W("state"),Ye("isNativeOption"),h("isNative"),h("delegatedAmount"),Ye("closeAuthorityOption"),K("closeAuthority")]);function Pd(o){return o instanceof Uint8Array||o!=null&&typeof o=="object"&&o.constructor.name==="Uint8Array"}function Gi(o,...e){if(!Pd(o))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(o.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${o.length}`)}function Xi(o,e=!0){if(o.destroyed)throw new Error("Hash instance has been destroyed");if(e&&o.finished)throw new Error("Hash#digest() has already been called")}function Ja(o,e){Gi(o);let t=e.outputLen;if(o.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var Br=o=>new DataView(o.buffer,o.byteOffset,o.byteLength),Ct=(o,e)=>o<<32-e|o>>>e;var hw=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function hd(o){if(typeof o!="string")throw new Error(`utf8ToBytes expected string, got ${typeof o}`);return new Uint8Array(new TextEncoder().encode(o))}function zi(o){return typeof o=="string"&&(o=hd(o)),Gi(o),o}var Ir=class{clone(){return this._cloneInto()}},kw={}.toString;function eu(o){let e=n=>o().update(zi(n)).digest(),t=o();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>o(),e}function kd(o,e,t,n){if(typeof o.setBigUint64=="function")return o.setBigUint64(e,t,n);let r=BigInt(32),i=BigInt(4294967295),s=Number(t>>r&i),a=Number(t&i),u=n?4:0,c=n?0:4;o.setUint32(e+u,s,n),o.setUint32(e+c,a,n)}var tu=(o,e,t)=>o&e^~o&t,nu=(o,e,t)=>o&e^o&t^e&t,xr=class extends Ir{constructor(e,t,n,r){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=r,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=Br(this.buffer)}update(e){Xi(this);let{view:t,buffer:n,blockLen:r}=this;e=zi(e);let i=e.length;for(let s=0;s<i;){let a=Math.min(r-this.pos,i-s);if(a===r){let u=Br(e);for(;r<=i-s;s+=r)this.process(u,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===r&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Xi(this),Ja(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:r,isLE:i}=this,{pos:s}=this;t[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>r-s&&(this.process(n,0),s=0);for(let m=s;m<r;m++)t[m]=0;kd(n,r-8,BigInt(this.length*8),i),this.process(n,0);let a=Br(e),u=this.outputLen;if(u%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let c=u/4,l=this.get();if(c>l.length)throw new Error("_sha2: outputLen bigger than state");for(let m=0;m<c;m++)a.setUint32(4*m,l[m],i)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:r,finished:i,destroyed:s,pos:a}=this;return e.length=r,e.pos=a,e.finished=i,e.destroyed=s,r%t&&e.buffer.set(n),e}};var Td=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),rn=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),sn=new Uint32Array(64),Qi=class extends xr{constructor(){super(64,32,8,!1),this.A=rn[0]|0,this.B=rn[1]|0,this.C=rn[2]|0,this.D=rn[3]|0,this.E=rn[4]|0,this.F=rn[5]|0,this.G=rn[6]|0,this.H=rn[7]|0}get(){let{A:e,B:t,C:n,D:r,E:i,F:s,G:a,H:u}=this;return[e,t,n,r,i,s,a,u]}set(e,t,n,r,i,s,a,u){this.A=e|0,this.B=t|0,this.C=n|0,this.D=r|0,this.E=i|0,this.F=s|0,this.G=a|0,this.H=u|0}process(e,t){for(let m=0;m<16;m++,t+=4)sn[m]=e.getUint32(t,!1);for(let m=16;m<64;m++){let d=sn[m-15],p=sn[m-2],y=Ct(d,7)^Ct(d,18)^d>>>3,f=Ct(p,17)^Ct(p,19)^p>>>10;sn[m]=f+sn[m-7]+y+sn[m-16]|0}let{A:n,B:r,C:i,D:s,E:a,F:u,G:c,H:l}=this;for(let m=0;m<64;m++){let d=Ct(a,6)^Ct(a,11)^Ct(a,25),p=l+d+tu(a,u,c)+Td[m]+sn[m]|0,f=(Ct(n,2)^Ct(n,13)^Ct(n,22))+nu(n,r,i)|0;l=c,c=u,u=a,a=s+p|0,s=i,i=r,r=n,n=p+f|0}n=n+this.A|0,r=r+this.B|0,i=i+this.C|0,s=s+this.D|0,a=a+this.E|0,u=u+this.F|0,c=c+this.G|0,l=l+this.H|0,this.set(n,r,i,s,a,u,c,l)}roundClean(){sn.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var ou=eu(()=>new Qi);var Ew=ce("Raydium_Util");function iu({owner:o,solAccountResp:e,tokenAccountResp:t}){let n=[],r=[];for(let{pubkey:i,account:s}of t.value){let a=on.decode(s.data),{mint:u,amount:c}=a;n.push({publicKey:i,mint:u,amount:c,isAssociated:we(o,u,s.owner).publicKey.equals(i),isNative:!1,programId:s.owner}),r.push({pubkey:i,accountInfo:a,programId:s.owner})}return e&&n.push({mint:ru.default,amount:new xd(e.lamports),isNative:!0,programId:e.owner}),{tokenAccounts:n,tokenAccountRawInfos:r}}function ct({fromPublicKey:o,programId:e=Bd}){let t=Id.generate().publicKey.toBase58().slice(0,32);return{publicKey:Sd(o,t,e),seed:t}}function Sd(o,e,t){let n=Buffer.concat([o.toBuffer(),Buffer.from(e),t.toBuffer()]),r=ou(n);return new ru(r)}function Yi(o){let{mint:e,tokenAccount:t,owner:n,programId:r=Wn}=o;return Kd(t,e,n,r)}function _t(o){let{tokenAccount:e,payer:t,multiSigners:n=[],owner:r,programId:i=Wn}=o;return Cd(e,t,r,n,i)}async function Gt(o){let{connection:e,amount:t,commitment:n,payer:r,owner:i,skipCloseAccount:s}=o,a=await e.getMinimumBalanceForRentExemption(on.span,n),u=Y(t).add(new Nd(a)),c=ct({fromPublicKey:r,programId:Wn});return{addresses:{newAccount:c.publicKey},signers:[],instructions:[Ld.createAccountWithSeed({fromPubkey:r,basePubkey:r,seed:c.seed,newAccountPubkey:c.publicKey,lamports:u.toNumber(),space:on.span,programId:Wn}),Yi({mint:new Od(Ee.address),tokenAccount:c.publicKey,owner:i,programId:Wn})],instructionTypes:[V.CreateAccount,V.InitAccount],endInstructionTypes:s?[]:[V.CloseAccount],endInstructions:s?[]:[_t({tokenAccount:c.publicKey,payer:r,owner:i})]}}function po({source:o,destination:e,owner:t,amount:n,multiSigners:r=[],tokenProgram:i=Wn}){return Rd(o,e,t,BigInt(String(n)),r,i)}var fo=class extends Ke{constructor(t){super(t);this._tokenAccounts=[];this._tokenAccountRawInfos=[];this._accountListener=[];this._clientOwnedToken=!1;this._accountFetchTime=0;let{tokenAccounts:n,tokenAccountRawInfos:r}=t;this._tokenAccounts=n||[],this._tokenAccountRawInfos=r||[],this._clientOwnedToken=!!(n||r)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}updateTokenAccount({tokenAccounts:t,tokenAccountRawInfos:n}){return t&&(this._tokenAccounts=t),n&&(this._tokenAccountRawInfos=n),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(t){return this._accountListener.push(t),this}removeAccountChangeListener(t){return this._accountListener=this._accountListener.filter(n=>n!==t),this}getAssociatedTokenAccount(t,n){return we(this.scope.ownerPubKey,t,n).publicKey}resetTokenAccounts(){this._clientOwnedToken||(this._tokenAccounts=[],this._tokenAccountRawInfos=[])}async fetchWalletTokenAccounts(t){if(this._clientOwnedToken||!(t!=null&&t.forceUpdate)&&this._tokenAccounts.length&&Date.now()-this._accountFetchTime<1e3*60*3)return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let r=C(C({},{}),t),[i,s,a]=await Promise.all([this.scope.connection.getAccountInfo(this.scope.ownerPubKey,r.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:an},r.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:Md},r.commitment)]),{tokenAccounts:u,tokenAccountRawInfos:c}=iu({owner:this.scope.ownerPubKey,solAccountResp:i,tokenAccountResp:{context:s.context,value:[...s.value,...a.value]}});return this._tokenAccounts=u,this._tokenAccountRawInfos=c,this._accountFetchTime=Date.now(),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>this.fetchWalletTokenAccounts({forceUpdate:!0}),t==null?void 0:t.commitment),{tokenAccounts:u,tokenAccountRawInfos:c}}async getCreatedTokenAccount({mint:t,programId:n=an,associatedOnly:r=!0}){await this.fetchWalletTokenAccounts();let i=this._tokenAccounts.filter(({mint:a})=>a==null?void 0:a.equals(t)).sort((a,u)=>a.amount.lt(u.amount)?1:-1),s=this.getAssociatedTokenAccount(t,n);for(let a of i){let{publicKey:u}=a;if(u&&(!r||r&&s.equals(u)))return u}}async getOrCreateTokenAccount(t){var y,f,b,g;await this.fetchWalletTokenAccounts();let{mint:n,createInfo:r,associatedOnly:i,owner:s,notUseTokenAccount:a=!1,skipCloseAccount:u=!1,checkCreateATAOwner:c=!1}=t,l=new Sr(t.tokenProgram||an),m=this.getAssociatedTokenAccount(n,new Sr(l)),d=(a?[]:this.tokenAccountRawInfos).filter(w=>w.accountInfo.mint.equals(n)&&(!i||w.pubkey.equals(m))).sort((w,A)=>w.accountInfo.amount.lt(A.accountInfo.amount)?1:-1);if(r===void 0||d.length>0)return d.length>0?{account:d[0].pubkey}:{};let p={instructions:[],endInstructions:[],signers:[],instructionTypes:[],endInstructionTypes:[]};if(i){let w=ji(s,m,s,n,l);if(c){let A=await this.scope.connection.getAccountInfo(m);if(A===null)(y=p.instructions)==null||y.push(w),p.instructionTypes.push(V.CreateATA);else if(!(A.owner.equals(l)&&qn.decode(A.data).mint.equals(n)&&qn.decode(A.data).owner.equals(s)))throw Error(`create ata check error -> mint: ${n.toString()}, ata: ${m.toString()}`)}else p.instructions.push(w),p.instructionTypes.push(V.CreateATA);if(n.equals(j)&&r.amount){let A=await Gt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:r.payer||this.scope.ownerPubKey,amount:(f=r.amount)!=null?f:0,skipCloseAccount:u});p.instructions.push(...A.instructions||[]),p.endInstructions.push(...A.endInstructions||[]),p.instructionTypes.push(...A.instructionTypes||[]),p.endInstructionTypes.push(...A.endInstructionTypes||[]),r.amount&&(p.instructions.push(po({source:A.addresses.newAccount,destination:m,owner:this.scope.ownerPubKey,amount:r.amount,tokenProgram:an})),p.instructionTypes.push(V.TransferAmount))}return u||(p.endInstructions.push(_t({owner:s,payer:r.payer||s,tokenAccount:m,programId:l})),p.endInstructionTypes.push(V.CloseAccount)),{account:m,instructionParams:p}}else{let w=ct({fromPublicKey:s,programId:l}),A=await this.scope.connection.getMinimumBalanceForRentExemption(qn.span),k=vd.createAccountWithSeed({fromPubkey:s,basePubkey:s,seed:w.seed,newAccountPubkey:w.publicKey,lamports:A+Number((g=(b=r.amount)==null?void 0:b.toString())!=null?g:0),space:qn.span,programId:l});return p.instructions.push(k,Yi({mint:n,tokenAccount:w.publicKey,owner:this.scope.ownerPubKey,programId:l})),p.instructionTypes.push(V.CreateAccount),p.instructionTypes.push(V.InitAccount),u||(p.endInstructions.push(_t({owner:s,payer:r.payer||s,tokenAccount:w.publicKey,programId:l})),p.endInstructionTypes.push(V.CloseAccount)),{account:w.publicKey,instructionParams:p}}}async checkOrCreateAta({mint:t,programId:n=an,autoUnwrapWSOLToSOL:r}){var u;await this.fetchWalletTokenAccounts();let i=(u=this.scope.account.tokenAccounts.find(({mint:c})=>(c==null?void 0:c.toBase58())===t.toBase58()))==null?void 0:u.publicKey,s=this.scope.ownerPubKey,a={};if(!i){let c=this.getAssociatedTokenAccount(t,n),l=await ji(s,c,s,t,n);a.instructions=[l],a.instructionTypes=[V.CreateATA],i=c}return r&&j.toBase58()===t.toBase58()&&(a.endInstructions=[_t({owner:s,payer:s,tokenAccount:i,programId:n})],a.endInstructionTypes=[V.CloseAccount]),{pubKey:i,newInstructions:a}}async handleTokenAccount(t){let{side:n,amount:r,mint:i,programId:s=an,tokenAccount:a,payer:u=this.scope.ownerPubKey,bypassAssociatedCheck:c,skipCloseAccount:l,checkCreateATAOwner:m}=t,d=this.getAssociatedTokenAccount(i,s);if(new Sr(j).equals(i)){let p=await Gt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:u,amount:r,skipCloseAccount:l});return C({tokenAccount:p.addresses.newAccount},p)}else if(!a||n==="out"&&!d.equals(a)&&!c){let p=[],y=ji(this.scope.ownerPubKey,d,this.scope.ownerPubKey,i,s);if(m){let f=await this.scope.connection.getAccountInfo(d);if(f===null)p.push(y);else if(!(f.owner.equals(an)&&qn.decode(f.data).mint.equals(i)&&qn.decode(f.data).owner.equals(this.scope.ownerPubKey)))throw Error(`create ata check error -> mint: ${i.toString()}, ata: ${d.toString()}`)}else p.push(y);return{tokenAccount:d,instructions:p,instructionTypes:[V.CreateATA]}}return{tokenAccount:a}}async processTokenAccount(t){let{mint:n,programId:r=an,amount:i,useSOLBalance:s,handleTokenAccount:a}=t,u,c=this.createTxBuilder();if(n.equals(new Sr(j))&&s){let l=await this.handleTokenAccount({side:"in",amount:i||0,mint:n,bypassAssociatedCheck:!0,programId:r}),{tokenAccount:d}=l,p=Oe(l,["tokenAccount"]);u=d,c.addInstruction(p)}else if(u=await this.getCreatedTokenAccount({mint:n,associatedOnly:!1,programId:r}),!u&&a){let m=await this.scope.account.handleTokenAccount({side:"in",amount:0,mint:n,bypassAssociatedCheck:!0,programId:r}),{tokenAccount:d}=m,p=Oe(m,["tokenAccount"]);u=d,c.addInstruction(p)}return C({tokenAccount:u},c.AllTxData)}};import{createAssociatedTokenAccountInstruction as np}from"@solana/spl-token";import{PublicKey as Ae,SystemProgram as op}from"@solana/web3.js";import{PublicKey as du}from"@solana/web3.js";var Hi=v([W("instruction")]),Zi=v([W("instruction")]),_d=v([h("rewardState"),h("rewardOpenTime"),h("rewardEndTime"),h("rewardLastUpdateTime"),h("totalReward"),h("totalRewardEmissioned"),h("rewardClaimed"),h("rewardPerSecond"),J("accRewardPerShare"),K("rewardVault"),K("rewardMint"),K("rewardSender"),h("rewardType"),X(h(),15,"padding")]),Fd=v([h("state"),h("nonce"),K("lpVault"),K("rewardVault"),K(),K(),h(),h(),h("totalReward"),J("perShareReward"),h("lastSlot"),h("perSlotReward")]),Vd=v([h("state"),h("nonce"),K("lpVault"),K("rewardVaultA"),h("totalRewardA"),J("perShareRewardA"),h("perSlotRewardA"),W("option"),K("rewardVaultB"),ge(7),h("totalRewardB"),J("perShareRewardB"),h("perSlotRewardB"),h("lastSlot"),K()]),Ed=v([h(),h("state"),h("nonce"),h("validRewardTokenNum"),J("rewardMultiplier"),h("rewardPeriodMax"),h("rewardPeriodMin"),h("rewardPeriodExtend"),K("lpMint"),K("lpVault"),X(_d,5,"rewardInfos"),K("creator"),K(),X(h(),32,"padding")]),su=new Proxy(Fd,{get(o,e,t){return e==="decode"?(...n)=>{let r=o.decode(...n);return E(C({},r),{version:3,rewardInfos:[{rewardVault:r.rewardVault,totalReward:r.totalReward,perSlotReward:r.perSlotReward,perShareReward:r.perShareReward}]})}:Reflect.get(o,e,t)}}),au=new Proxy(Vd,{get(o,e,t){return e==="decode"?(...n)=>{let r=o.decode(...n);return E(C({},r),{version:5,rewardInfos:[{rewardVault:r.rewardVaultA,totalReward:r.totalRewardA,perSlotReward:r.perSlotRewardA,perShareReward:r.perShareRewardA},{rewardVault:r.rewardVaultB,totalReward:r.totalRewardB,perSlotReward:r.perSlotRewardB,perShareReward:r.perShareRewardB}]})}:Reflect.get(o,e,t)}}),yo=new Proxy(Ed,{get(o,e,t){return e==="decode"?(...n)=>{let r=o.decode(...n);return E(C({},r),{version:6,rewardInfos:r.rewardInfos.map(i=>{var s;return E(C({},i),{rewardType:((s=Object.entries(un).find(a=>String(a[1])===i.rewardType.toString()))!=null?s:["Standard SPL"])[0]})})})}:Reflect.get(o,e,t)}}),Dd=v([h("isSet"),h("rewardPerSecond"),h("rewardOpenTime"),h("rewardEndTime"),h("rewardType")]),$i=v([W("instruction"),h("nonce"),X(Dd,5,"rewardTimeInfo")]),Ji=v([W("instruction"),h("rewardReopenTime"),h("rewardEndTime"),h("rewardPerSecond")]),es=v([W("instruction"),h("isSet"),h("rewardPerSecond"),h("rewardOpenTime"),h("rewardEndTime"),h("rewardType")]),gP=v([h("state"),K("id"),K("owner"),h("deposited"),X(h(),1,"rewardDebts")]),bo=v([h("state"),K("id"),K("owner"),h("deposited"),X(J(),1,"rewardDebts"),h(""),h("voteLockedBalance"),X(h(),15)]),AP=v([h("state"),K("id"),K("owner"),h("deposited"),X(h(),2,"rewardDebts")]),uu=v([h("state"),K("id"),K("owner"),h("deposited"),X(J(),2,"rewardDebts"),X(h(),17)]),cu=v([h(),h("state"),K("id"),K("owner"),h("deposited"),X(J(),5,"rewardDebts"),X(h(),16)]),rt=v([W("instruction"),h("amount")]),Wd=v([K("mint"),K("grantAuthority"),h("baselineVoteWeightScaledFactor"),h("maxExtraLockupVoteWeightScaledFactor"),h("lockupSaturationSecs"),Za("digitShift"),X(W(),7,"reserved1"),X(h(),7,"reserved2")]),lu=v([ge(8),K("governanceProgramId"),K("realm"),K("realmGoverningTokenMint"),K("realmAuthority"),X(W(),32,"reserved1"),X(Wd,4,"votingMints"),Dn("timeOffset"),W("bump"),X(W(),7,"reserved2"),X(h(),11,"reserved3")]),qd=v([Dn("startTime"),Dn("endTime"),W("kind"),X(W(),15,"reserved")]),Ud=v([X(qd,1,"lockup"),h("amountDeposited_native"),h("amountInitiallyLockedNative"),je("isUsed"),je("allowClawback"),W("votingMintConfigIdx"),X(W(),29,"reserved")]),mu=v([ge(8),K("voterAuthority"),K("registrar"),X(Ud,32,"deposits"),W("voterBump"),W("voterWweightRecordBump"),X(W(),94,"reserved")]);var xP=ce("Raydium_farm_config"),pu=new du("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),fu=new du("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1"),yu={3:su,5:au,6:yo},bu={3:bo,5:uu,6:cu},ts=o=>[3,5,6].indexOf(o)!==-1,ns=o=>{var s;let{version:e,rewardInfos:t,rewardTokenAccountsPublicKeys:n}=o,r=`rewardInfo:${JSON.stringify(t)}, rewardAccount:${JSON.stringify(n)}`,i={3:()=>{if(t.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${r}`},5:()=>{if(t.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${r}`},6:()=>{if(!n.length||t.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${r}`}};return(s=i[e])==null?void 0:s.call(i)},un={"Standard SPL":0,"Option tokens":1},gt={[Ci.toString()]:3,[Ri.toString()]:5,[Vn.toString()]:6};import{PublicKey as ae,SystemProgram as An,SYSVAR_RENT_PUBKEY as zd,SYSVAR_CLOCK_PUBKEY as wo,TransactionInstruction as Ge}from"@solana/web3.js";import{createAssociatedTokenAccountInstruction as Qd,TOKEN_PROGRAM_ID as ft,ASSOCIATED_TOKEN_PROGRAM_ID as Yd}from"@solana/spl-token";import Kr from"bn.js";function os(o,e,t){return ue([e.toBuffer(),Buffer.from("registrar","utf8"),t.toBuffer()],o)}function rs(o,e){return ue([e.toBuffer(),Buffer.from("voting_mint_seed","utf8")],o)}function is(o,e){return ue([e.toBuffer()],o)}function ss(o,e,t){return ue([e.toBuffer(),Buffer.from("voter","utf8"),t.toBuffer()],o)}function as(o,e,t){return ue([e.toBuffer(),Buffer.from("voter-weight-record","utf8"),t.toBuffer()],o)}function us(o,e,t,n){return ue([Buffer.from("governance","utf8"),e.toBuffer(),t.toBuffer(),n.toBuffer()],o)}import lt from"bn.js";var go=ce("Raydium.farm.util");function Ao({programId:o,poolId:e,mint:t,type:n}){let{publicKey:r}=ue([e.toBuffer(),t.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],o);return r}function Je({programId:o,poolId:e,owner:t,version:n}){let{publicKey:r}=ue([e.toBuffer(),t.toBuffer(),Buffer.from(n===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],o);return r}var gu=({programId:o,poolId:e})=>ue([e.toBuffer()],o);function Au(o){return{isSet:new lt(1),rewardPerSecond:Y(o.perSecond),rewardOpenTime:Y(o.openTime),rewardEndTime:Y(o.endTime),rewardType:Y(un[o.rewardType])}}function cs(o){return Y(o.endTime).sub(Y(o.openTime)).mul(Y(o.perSecond))}function Un(o){let e=bu[o];return e||go.logWithError("invalid version",o),e}function Gd(o){let e=yu[o];return e||go.logWithError("invalid version",o),e}function Xd(o,e,t,n){if(o.version===3||o.version===5){if(o.lastSlot.gte(new lt(t)))return o;let r=new lt(t).sub(o.lastSlot);o.lastSlot=new lt(t);for(let i of o.rewardInfos){if(e.amount.eq(new lt(0)))continue;let s=i.perSlotReward.mul(r);i.perShareReward=i.perShareReward.add(s.mul(new lt(10).pow(new lt(o.version===3?9:15))).div(e.amount)),i.totalReward=i.totalReward.add(s)}}else if(o.version===6)for(let r of o.rewardInfos){if(r.rewardState.eq(new lt(0)))continue;let i=lt.min(new lt(n),r.rewardEndTime);if(r.rewardOpenTime.gte(i))continue;let a=i.sub(r.rewardLastUpdateTime).mul(r.rewardPerSecond),u=r.totalReward.sub(r.totalRewardEmissioned);u.lt(a)?(a=u,r.rewardLastUpdateTime=r.rewardLastUpdateTime.add(u.div(r.rewardPerSecond))):r.rewardLastUpdateTime=i,!e.amount.eq(new lt(0))&&(r.accRewardPerShare=r.accRewardPerShare.add(a.mul(o.rewardMultiplier).div(e.amount)),r.totalRewardEmissioned=r.totalRewardEmissioned.add(a))}return o}async function UP({connection:o,farmPools:e,owner:t,config:n,chainTime:r}){let i=!1,s=!1,a=new lt(10),u=[];for(let d of e){let p=Ie(d);p.version===6?s=!0:i=!0,u.push({pubkey:p.id,version:p.version,key:"state",poolId:p.id},{pubkey:p.lpVault,version:p.version,key:"lpVault",poolId:p.id}),t&&u.push({pubkey:Je({programId:p.programId,poolId:p.id,owner:t,version:d.version}),version:p.version,key:"ledger",poolId:p.id})}let c={},l=await We(o,u,n);for(let{pubkey:d,version:p,key:y,poolId:f,accountInfo:b}of l){let g=f.toBase58();if(c[g]=C({},c[g]),y==="state"){let w=Gd(p);(!b||!b.data||b.data.length!==w.span)&&go.logWithError(`invalid farm state account info, pools.id, ${d}`),c[g].state=w.decode(b.data)}else if(y==="lpVault")(!b||!b.data||b.data.length!==on.span)&&go.logWithError(`invalid farm lp vault account info, pools.lpVault, ${d}`),c[g].lpVault=on.decode(b.data);else if(y==="ledger"){let w=Un(p);b&&b.data&&(b.data.length!==w.span&&go.logWithError(`invalid farm ledger account info, ledger, ${d}`),c[g].ledger=w.decode(b.data))}}let m=s||i?await o.getSlot():0;for(let d of Object.keys(c))c[d]!==void 0&&(c[d].state=Xd(c[d].state,c[d].lpVault,m,r));for(let[d,{state:p,ledger:y}]of Object.entries(c))if(y){let f=p.version===6?p.rewardMultiplier:p.rewardInfos.length===1?a.pow(new lt(9)):a.pow(new lt(15)),b=p.rewardInfos.map((g,w)=>{let A=y.rewardDebts[w];return y.deposited.mul(p.version===6?g.accRewardPerShare:g.perShareReward).div(f).sub(A)});c[d].wrapped=E(C({},c[d].wrapped),{pendingRewards:b})}return c}function GP(o,e=Date.now()){if(o.version===6){let t=o.state.rewardInfos;if(t.every(({rewardOpenTime:n})=>va(e,n.toNumber(),{unit:"s"})))return"upcoming pool";if(t.every(({rewardEndTime:n})=>_a(e,n.toNumber(),{unit:"s"})))return"closed pool"}else{let t=o.state.rewardInfos.map(({perSlotReward:n})=>n);if(t.length===2){if(String(t[0])==="0"&&String(t[1])!=="0")return"normal fusion pool";if(String(t[0])!=="0"&&String(t[1])!=="0")return"dual fusion pool";if(String(t[0])==="0"&&String(t[1])==="0")return"closed pool"}else if(t.length===1&&String(t[0])==="0")return"closed pool"}}async function ls(o,e,t,n){let r=await o.getAccountInfo(e);if(r===null)throw Error("registrar info check error");let s=lu.decode(r.data).votingMints.findIndex(l=>l.mint.equals(n));if(s===-1)throw Error("find voter mint error");let a=await o.getAccountInfo(t);if(a===null)return{index:s,isInit:!1};let c=mu.decode(a.data).deposits.findIndex(l=>l.isUsed&&l.votingMintConfigIdx===s);return c===-1?{index:s,isInit:!1}:{index:c,isInit:!0}}var jd=ce("Raydium_farm_instruction"),Po={voterStakeRegistryCreateVoter:Buffer.from([6,24,245,52,243,255,148,25]),voterStakeRegistryCreateDepositEntry:Buffer.from([185,131,167,186,159,125,19,67]),voterStakeRegistryDeposit:Buffer.from([242,35,198,137,82,225,242,182]),voterStakeRegistryWithdraw:Buffer.from([183,18,70,156,148,109,161,34]),voterStakeRegistryUpdateVoterWeightRecord:Buffer.from([45,185,3,36,109,190,115,169])};function ho(o){let{version:e,id:t,ledger:n,programId:r,owner:i}=o,s={3:9,5:10}[e];s||jd.logWithError(`invalid farm pool version: ${e}`);let a=Buffer.alloc(Hi.span);Hi.encode({instruction:s},a);let u=[P({pubkey:t}),P({pubkey:n}),P({pubkey:i,isWritable:!1}),P({pubkey:An.programId,isWritable:!1}),P({pubkey:zd,isWritable:!1})];return{instruction:new Ge({programId:r,keys:u,data:a}),instructionType:V.FarmV3CreateLedger}}function wu(o){var n;let e=Buffer.alloc($i.span);$i.encode({instruction:0,nonce:new Kr(o.nonce),rewardTimeInfo:o.rewardInfoConfig},e);let t=[...di,P({pubkey:o.farmId}),P({pubkey:o.farmAuthority,isWritable:!1}),P({pubkey:o.lpVault}),P({pubkey:o.lpMint,isWritable:!1}),P({pubkey:o.lockVault}),P({pubkey:o.lockMint,isWritable:!1}),P({pubkey:(n=o.lockUserAccount)!=null?n:Ve}),P({pubkey:o.owner,isWritable:!1,isSigner:!0})];for(let r of o.rewardInfo)t.push(P({pubkey:r.rewardMint,isWritable:!1}),P({pubkey:r.rewardVault}),P({pubkey:r.userRewardToken}));return{instruction:new Ge({programId:o.programId,keys:t,data:e}),instructionType:V.FarmV6Create}}function Pu(o){let e=Buffer.alloc(Zi.span);Zi.encode({instruction:5},e);let t=[P({pubkey:ft,isWritable:!1}),P({pubkey:o.id}),P({pubkey:o.authority,isWritable:!1}),P({pubkey:o.lpVault,isWritable:!1}),P({pubkey:o.rewardVault}),P({pubkey:o.userRewardToken}),P({pubkey:o.owner,isWritable:!1,isSigner:!0})];return{instruction:new Ge({programId:o.programId,keys:t,data:e}),instructionType:V.FarmV6CreatorWithdraw}}function Hd(o,e,t,n,r,i,s,a,u,c,l,m,d){let p=v([W("depositEntryIndex"),h("amount")]),y=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:ft,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:ir,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({depositEntryIndex:m,amount:d},f);let b=Buffer.from([...Po.voterStakeRegistryDeposit,...f]);return new Ge({keys:y,programId:o,data:b})}function Zd(o,e,t,n){let r=v([]),i=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:An.programId,isSigner:!1,isWritable:!1}],s=Buffer.alloc(r.span);r.encode({},s);let a=Buffer.from([...Po.voterStakeRegistryUpdateVoterWeightRecord,...s]);return new Ge({keys:i,programId:o,data:a})}function $d(o,e,t,n,r,i,s,a,u,c,l,m,d,p,y){let f=v([W("depositEntryIndex"),h("amount")]),b=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:ft,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:ir,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);f.encode({depositEntryIndex:p,amount:y},g);let w=Buffer.from([...Po.voterStakeRegistryWithdraw,...g]);return new Ge({keys:b,programId:o,data:w})}function Jd(o,e,t,n,r,i){let s=v([W("ins")]),a=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:An.programId,isSigner:!1,isWritable:!1}],u=Buffer.alloc(s.span);return s.encode({ins:23},u),new Ge({keys:a,programId:o,data:u})}function ep(o,e,t,n,r,i,s,a){let u=v([W("voterBump"),W("voterWeightRecordBump")]),c=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:An.programId,isSigner:!1,isWritable:!1},{pubkey:ut,isSigner:!1,isWritable:!1},{pubkey:ir,isSigner:!1,isWritable:!1}],l=Buffer.alloc(u.span);u.encode({voterBump:s,voterWeightRecordBump:a},l);let m=Buffer.from([...Po.voterStakeRegistryCreateVoter,...l]);return new Ge({keys:c,programId:o,data:m})}function tp(o,e,t,n,r,i,s,a,u,c,l,m){let d=v([W("depositEntryIndex"),W("kind"),W("option"),h("startTs"),Ye("periods"),je("allowClawback")]),p=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:An.programId,isSigner:!1,isWritable:!1},{pubkey:ft,isSigner:!1,isWritable:!1},{pubkey:Yd,isSigner:!1,isWritable:!1},{pubkey:ut,isSigner:!1,isWritable:!1}],y=Buffer.alloc(d.span);d.encode({depositEntryIndex:a,kind:u,option:c===void 0?0:1,startTs:c,periods:l,allowClawback:m},y);let f=Buffer.from([...Po.voterStakeRegistryCreateDepositEntry,...y]);return new Ge({keys:p,programId:o,data:f})}async function ah({connection:o,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:r,communityTokenMint:i,owner:s,poolId:a,tokenProgram:u}){let c=os(n,r,i).publicKey,l=Je({programId:e,poolId:a,owner:s,version:3}),m=await o.getAccountInfo(l);if(m===null)throw Error("user is not staker");let d=bo.decode(m.data),p=d.deposited.sub(d.voteLockedBalance);if(console.log("amount",p.toString()),p.eq(new Kr(0)))throw Error("user do not has new stake amount");let y=rs(e,a).publicKey,f=is(e,a).publicKey,{publicKey:b,nonce:g}=ss(n,c,s),w=we(b,y,u).publicKey,{publicKey:A,nonce:k}=as(n,c,s),I=us(t,r,i,s).publicKey,T=[],S=we(s,y,u).publicKey;if(await o.getAccountInfo(S)===null&&T.push(Qd(s,S,s,y)),await o.getAccountInfo(b)===null){let D=Jd(t,r,s,i,s,I);T.push(D,ep(n,c,b,A,s,s,g,k))}let{index:B,isInit:M}=await ls(o,c,b,y);return M||T.push(tp(n,c,b,w,s,s,y,B,0,void 0,0,!1)),T.push(Hd(n,c,b,w,S,s,l,a,y,f,e,B,p),Zd(n,c,b,A)),T}async function uh({connection:o,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:r,communityTokenMint:i,owner:s,poolId:a,tokenProgram:u}){let c=os(n,r,i).publicKey,l=Je({programId:e,poolId:a,owner:s,version:3}),m=await o.getAccountInfo(l);if(m===null)throw Error("user is not staker");let d=bo.decode(m.data);if(d.voteLockedBalance.eq(new Kr(0)))throw Error("user has vote locked balance = 0");let p=rs(e,a).publicKey,y=is(e,a).publicKey,{publicKey:f}=ss(n,c,s),b=we(f,p,u).publicKey,{publicKey:g}=as(n,c,s),w=us(t,r,i,s).publicKey,A=[],{index:k,isInit:I}=await ls(o,c,f,p);if(!I)throw Error("deposit entry index check error");return A.push($d(n,c,f,s,w,g,b,we(s,p,u).publicKey,l,a,p,y,e,k,d.voteLockedBalance)),A}function ms({payer:o,rewardVault:e,userRewardTokenPub:t,farmKeys:n,rewardInfo:r}){let i=Buffer.alloc(Ji.span);Ji.encode({instruction:3,rewardReopenTime:Y(r.openTime),rewardEndTime:Y(r.endTime),rewardPerSecond:Y(r.perSecond)},i);let s=[P({pubkey:ft,isWritable:!1}),P({pubkey:n.id}),P({pubkey:n.lpVault,isWritable:!1}),P({pubkey:e}),P({pubkey:t}),P({pubkey:o,isWritable:!1,isSigner:!0})];return new Ge({programId:n.programId,keys:s,data:i})}function ds({payer:o,userRewardTokenPub:e,farmKeys:t,rewardVault:n,rewardInfo:r}){let i=Buffer.alloc(es.span);es.encode({instruction:4,isSet:new Kr(1),rewardPerSecond:Y(r.perSecond),rewardOpenTime:Y(r.openTime),rewardEndTime:Y(r.endTime),rewardType:Y(un[r.rewardType])},i);let s=[...di,P({pubkey:t.id}),P({pubkey:t.authority,isWritable:!1}),P({pubkey:r.mint,isWritable:!1}),P({pubkey:n}),P({pubkey:e}),P({pubkey:o,isWritable:!1,isSigner:!0})];return new Ge({programId:t.programId,keys:s,data:i})}function ch(o){let{farmInfo:e,farmKeys:t,version:n,lpAccount:r,rewardAccounts:i,owner:s,instruction:a,amount:u,deposit:c}=o,[l,m]=[new ae(e.programId),new ae(e.id)],d=Je({programId:l,poolId:m,owner:s,version:n}),p=Buffer.alloc(rt.span);rt.encode({instruction:a,amount:u},p);let y=n===6?[P({pubkey:ft,isWritable:!1}),...c?[P({pubkey:An.programId,isWritable:!1})]:[],P({pubkey:m}),P({pubkey:new ae(t.authority),isWritable:!1}),P({pubkey:new ae(t.lpVault)}),P({pubkey:d}),P({pubkey:s,isWritable:!1,isSigner:!0}),P({pubkey:r})]:[P({pubkey:m}),P({pubkey:new ae(t.authority),isWritable:!1}),P({pubkey:d}),P({pubkey:s,isWritable:!1,isSigner:!0}),P({pubkey:r}),P({pubkey:new ae(t.lpVault)}),P({pubkey:i[0]}),P({pubkey:new ae(t.rewardInfos[0].vault)}),P({pubkey:wo,isWritable:!1}),P({pubkey:ft,isWritable:!1})];if(n===5)for(let f=1;f<t.rewardInfos.length;f++)y.push(P({pubkey:i[f]})),y.push(P({pubkey:new ae(t.rewardInfos[f].vault)}));if(n===6)for(let f=0;f<t.rewardInfos.length;f++)y.push(P({pubkey:new ae(t.rewardInfos[f].vault)})),y.push(P({pubkey:i[f]}));return new Ge({programId:l,keys:y,data:p})}function ko(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:r,owner:i,amount:s}=o,[a,u]=[new ae(e.programId),new ae(e.id)],c=Je({programId:a,poolId:u,owner:i,version:6}),l=Buffer.alloc(rt.span);rt.encode({instruction:2,amount:Y(s)},l);let m=[P({pubkey:ft,isWritable:!1}),P({pubkey:u}),P({pubkey:new ae(t.authority),isWritable:!1}),P({pubkey:new ae(t.lpVault)}),P({pubkey:c}),P({pubkey:i,isWritable:!1,isSigner:!0}),P({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(P({pubkey:new ae(t.rewardInfos[d].vault)})),m.push(P({pubkey:r[d]}));return new Ge({programId:a,keys:m,data:l})}function To(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:r,owner:i,amount:s,userAuxiliaryLedgers:a}=o,[u,c]=[new ae(e.programId),new ae(e.id)],l=Je({programId:u,poolId:c,owner:i,version:5}),m=Buffer.alloc(rt.span);rt.encode({instruction:12,amount:Y(s)},m);let d=[P({pubkey:c}),P({pubkey:new ae(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:i,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new ae(t.lpVault)}),P({pubkey:r[0]}),P({pubkey:new ae(t.rewardInfos[0].vault)}),P({pubkey:wo,isWritable:!1}),P({pubkey:ft,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(P({pubkey:r[p]})),d.push(P({pubkey:new ae(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(P({pubkey:p}));return new Ge({programId:u,keys:d,data:m})}function Io(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:r,owner:i,amount:s,userAuxiliaryLedgers:a}=o,[u,c]=[new ae(e.programId),new ae(e.id)],l=Je({programId:u,poolId:c,owner:i,version:3}),m=Buffer.alloc(rt.span);rt.encode({instruction:11,amount:Y(s)},m);let d=[P({pubkey:c}),P({pubkey:new ae(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:i,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new ae(t.lpVault)}),P({pubkey:r[0]}),P({pubkey:new ae(t.rewardInfos[0].vault)}),P({pubkey:wo,isWritable:!1}),P({pubkey:ft,isWritable:!1})];if(a)for(let p of a)d.push(P({pubkey:p}));return new Ge({programId:u,keys:d,data:m})}function hu(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:r,owner:i,amount:s,userAuxiliaryLedgers:a}=o,[u,c]=[new ae(e.programId),new ae(e.id)],l=Je({programId:u,poolId:c,owner:i,version:3}),m=Buffer.alloc(rt.span);rt.encode({instruction:10,amount:Y(s)},m);let d=[P({pubkey:c}),P({pubkey:new ae(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:i,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new ae(t.lpVault)}),P({pubkey:r[0]}),P({pubkey:new ae(t.rewardInfos[0].vault)}),P({pubkey:wo,isWritable:!1}),P({pubkey:ft,isWritable:!1})];if(a)for(let p of a)d.push(P({pubkey:p}));return new Ge({programId:u,keys:d,data:m})}function ku(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:r,owner:i,amount:s,userAuxiliaryLedgers:a}=o,[u,c]=[new ae(e.programId),new ae(e.id)],l=Je({programId:u,poolId:c,owner:i,version:5}),m=Buffer.alloc(rt.span);rt.encode({instruction:11,amount:Y(s)},m);let d=[P({pubkey:c}),P({pubkey:new ae(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:i,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new ae(t.lpVault)}),P({pubkey:r[0]}),P({pubkey:new ae(t.rewardInfos[0].vault)}),P({pubkey:wo,isWritable:!1}),P({pubkey:ft,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(P({pubkey:r[p]})),d.push(P({pubkey:new ae(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(P({pubkey:p}));return new Ge({programId:u,keys:d,data:m})}function Tu(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:r,owner:i,amount:s}=o,[a,u]=[new ae(e.programId),new ae(e.id)],c=Je({programId:a,poolId:u,owner:i,version:6}),l=Buffer.alloc(rt.span);rt.encode({instruction:1,amount:Y(s)},l);let m=[P({pubkey:ft,isWritable:!1}),P({pubkey:An.programId,isWritable:!1}),P({pubkey:u}),P({pubkey:new ae(t.authority),isWritable:!1}),P({pubkey:new ae(t.lpVault)}),P({pubkey:c}),P({pubkey:i,isWritable:!1,isSigner:!0}),P({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(P({pubkey:new ae(t.rewardInfos[d].vault)})),m.push(P({pubkey:r[d]}));return new Ge({programId:a,keys:m,data:l})}var Bo=class extends Ke{async _getUserRewardInfo({payer:e,rewardInfo:t}){if(t.mint.equals(Ve)){let n=await Gt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:e,amount:cs(E(C({},t),{openTime:t.openTime.toString(),endTime:t.endTime.toString()}))});return{rewardPubKey:n.addresses.newAccount,newInstruction:n}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:t.mint,associatedOnly:!1})}}async create({poolInfo:e,rewardInfos:t,payer:n,programId:r=Vn,txVersion:i}){this.checkDisabled(),this.scope.checkOwner();let a={lpMint:new Ae(e.lpMint.address),lockInfo:{lockMint:pu,lockVault:fu},version:6,rewardInfos:t,programId:r},u=this.createTxBuilder(),c=n!=null?n:this.scope.ownerPubKey,l=ct({fromPublicKey:c,programId:a.programId}),m=await this.scope.connection.getMinimumBalanceForRentExemption(yo.span);u.addInstruction({instructions:[op.createAccountWithSeed({fromPubkey:c,basePubkey:c,seed:l.seed,newAccountPubkey:l.publicKey,lamports:m,space:yo.span,programId:a.programId})]});let{publicKey:d,nonce:p}=gu({programId:new Ae(a.programId),poolId:l.publicKey}),y=Ao({programId:a.programId,poolId:l.publicKey,mint:a.lpMint,type:"lpVault"}),f=[],b=[];for(let I of a.rewardInfos){I.openTime>=I.endTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",I.openTime.toString()),isNaN(un[I.rewardType])&&this.logAndCreateError("rewardType error",I.rewardType),Number(I.perSecond)<=0&&this.logAndCreateError("rewardPerSecond error",I.perSecond),f.push(Au(I));let{rewardPubKey:T,newInstruction:S}=await this._getUserRewardInfo({rewardInfo:I,payer:c});S&&u.addInstruction(S),T||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let x=I.mint.equals(Ve)?new Ae(Ee.address):I.mint;b.push({rewardMint:x,rewardVault:Ao({programId:a.programId,poolId:l.publicKey,mint:x,type:"rewardVault"}),userRewardToken:T})}let{account:g,instructionParams:w}=await this.scope.account.getOrCreateTokenAccount({mint:new Ae(a.lockInfo.lockMint),owner:this.scope.ownerPubKey,skipCloseAccount:!1,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:!1});w&&u.addInstruction(w),g||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let{instruction:A,instructionType:k}=wu({farmId:l.publicKey,owner:this.scope.ownerPubKey,farmAuthority:d,lpVault:y,lpMint:a.lpMint,lockVault:a.lockInfo.lockVault,lockMint:a.lockInfo.lockMint,lockUserAccount:g,programId:a.programId,rewardInfo:b,rewardInfoConfig:f,nonce:p});return u.addInstruction({instructions:[A],instructionTypes:[k]}).versionBuild({txVersion:i,extInfo:{farmId:l.publicKey,farmAuthority:d,lpVault:y,lockUserAccount:g,nonce:p}})}async restartReward({farmInfo:e,payer:t,newRewardInfo:n,txVersion:r}){var b;let i=gt[e.programId];i!==6&&this.logAndCreateError("invalid farm version ",i);let s=Ie((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),a={id:s.id,rewardInfos:e.rewardInfos,lpVault:s.lpVault,programId:s.programId};n.openTime>=n.endTime&&this.logAndCreateError("start time error","newRewardInfo",n);let u=t||this.scope.ownerPubKey,c=n.mint.equals(Ve)?new Ae(Ee.address):n.mint,l=a.rewardInfos.findIndex(g=>new Ae(g.mint.address).equals(c)),m=s.rewardInfos[l];m||this.logAndCreateError("configuration does not exist","rewardMint",c);let d=(b=m.vault)!=null?b:Ve,p=this.createTxBuilder(),{rewardPubKey:y,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:n,payer:u});return f&&p.addInstruction(f),y||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts),p.addInstruction({instructions:[ms({payer:this.scope.ownerPubKey,rewardVault:d,userRewardTokenPub:y,farmKeys:a,rewardInfo:n})],instructionTypes:[V.FarmV6Restart]}).versionBuild({txVersion:r})}async restartRewards({farmInfo:e,payer:t,newRewardInfos:n,txVersion:r}){var l;let i=gt[e.programId];i!==6&&this.logAndCreateError("invalid farm version ",i);let s=Ie((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),a={id:s.id,rewardInfos:e.rewardInfos,lpVault:s.lpVault,programId:s.programId};n.forEach(m=>{m.openTime>=m.endTime&&this.logAndCreateError("start time error","newRewardInfo",m)});let u=t||this.scope.ownerPubKey,c=this.createTxBuilder();for(let m of n){let d=m.mint.equals(Ve)?new Ae(Ee.address):m.mint,p=a.rewardInfos.findIndex(A=>new Ae(A.mint.address).equals(d)),y=s.rewardInfos[p];y||this.logAndCreateError("configuration does not exist","rewardMint",d);let f=(l=y.vault)!=null?l:Ve,{rewardPubKey:b,newInstruction:g}=await this._getUserRewardInfo({rewardInfo:m,payer:u});g&&c.addInstruction(g),b||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let w=ms({payer:this.scope.ownerPubKey,rewardVault:f,userRewardTokenPub:b,farmKeys:a,rewardInfo:m});c.addInstruction({instructions:[w],instructionTypes:[V.FarmV6Restart]})}return c.versionBuild({txVersion:r})}async addNewRewardToken(e){let{txVersion:t,farmInfo:n,newRewardInfo:r,payer:i}=e,s=gt[n.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Ie((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=i!=null?i:this.scope.ownerPubKey,c=this.createTxBuilder(),l=r.mint.equals(Ve)?new Ae(Ee.address):r.mint,m=Ao({programId:new Ae(n.programId),poolId:new Ae(n.id),mint:l,type:"rewardVault"}),{rewardPubKey:d,newInstruction:p}=await this._getUserRewardInfo({rewardInfo:r,payer:u});return p&&c.addInstruction(p),d||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts),r.mint=l,c.addInstruction({instructions:[ds({payer:this.scope.ownerPubKey,userRewardTokenPub:d,farmKeys:a,rewardVault:m,rewardInfo:r})],instructionTypes:[V.FarmV6CreatorAddReward]}).versionBuild({txVersion:t})}async addNewRewardsToken(e){let{txVersion:t,farmInfo:n,newRewardInfos:r,payer:i}=e,s=gt[n.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Ie((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=i!=null?i:this.scope.ownerPubKey,c=this.createTxBuilder();for(let l of r){let m=l.mint.equals(Ve)?new Ae(Ee.address):l.mint,d=Ao({programId:new Ae(n.programId),poolId:new Ae(n.id),mint:m,type:"rewardVault"}),{rewardPubKey:p,newInstruction:y}=await this._getUserRewardInfo({rewardInfo:l,payer:u});y&&c.addInstruction(y),p||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let f=ds({payer:this.scope.ownerPubKey,userRewardTokenPub:p,farmKeys:a,rewardVault:d,rewardInfo:E(C({},l),{mint:m})});c.addInstruction({instructions:[f],instructionTypes:[V.FarmV6CreatorAddReward]})}return c.versionBuild({txVersion:t})}async deposit(e){let{txVersion:t,farmInfo:n,amount:r,feePayer:i,useSOLBalance:s,associatedOnly:a=!0,checkCreateATAOwner:u=!1,userAuxiliaryLedgers:c,computeBudgetConfig:l}=e;this.scope.availability.addFarm===!1&&this.logAndCreateError("farm deposit feature disabled in your region");let{rewardInfos:m,programId:d}=n,p=gt[d];ts(p)||this.logAndCreateError("invalid farm program:",n.programId);let[y,f]=[new Ae(n.programId),new Ae(n.id)],b=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],g=Je({programId:y,poolId:f,owner:this.scope.ownerPubKey,version:p}),w=this.createTxBuilder();w.addCustomComputeBudget(l);let A={};for(let F of this.scope.account.tokenAccounts)if(a){let Z=we(this.scope.ownerPubKey,F.mint,F.programId).publicKey;F.publicKey&&Z.equals(F.publicKey)&&(A[F.mint.toString()]=F.publicKey)}else A[F.mint.toString()]=F.publicKey;let k=b.lpMint,I=A[k.address];I||this.logAndCreateError("you don't have any lp","lp zero",A);let T=[];for(let F of m){let Z=s&&F.mint.address===j.toString(),G=A[F.mint.address];if(!G){let{account:q,instructionParams:ot}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:F.mint.programId,mint:new Ae(F.mint.address),notUseTokenAccount:Z,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!Z,associatedOnly:Z?!1:a,checkCreateATAOwner:u});G=q,ot&&w.addInstruction(ot)}A[F.mint.address]=G,T.push(G)}let S,x=await this.scope.connection.getAccountInfo(g);if(x&&(S=Un(p).decode(x.data)),n.programId!==Vn.toString()&&!S){let{instruction:F,instructionType:Z}=ho({id:f,programId:y,version:p,ledger:g,owner:this.scope.ownerPubKey});w.addInstruction({instructions:[F],instructionTypes:[Z]})}let R=ns({version:p,rewardInfos:m,rewardTokenAccountsPublicKeys:T});R&&this.logAndCreateError(R);let B={amount:Y(r),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:b,lpAccount:I,rewardAccounts:T,userAuxiliaryLedgers:c==null?void 0:c.map(F=>new Ae(F))},M=p===6?Tu(B):p===5?ku(B):hu(B),D={3:V.FarmV3Deposit,5:V.FarmV5Deposit,6:V.FarmV6Deposit};return w.addInstruction({instructions:[M],instructionTypes:[D[p]]}).versionBuild({txVersion:t})}async withdraw(e){let{txVersion:t,farmInfo:n,amount:r,deposited:i,useSOLBalance:s,feePayer:a,associatedOnly:u=!0,checkCreateATAOwner:c=!1,userAuxiliaryLedgers:l,computeBudgetConfig:m}=e,{rewardInfos:d}=n;this.scope.availability.removeFarm===!1&&this.logAndCreateError("farm withdraw feature disabled in your region");let p=gt[n.programId];ts(p)||this.logAndCreateError("invalid farm program:",n.programId);let y=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],f=this.createTxBuilder();f.addCustomComputeBudget(m);let b={};for(let R of this.scope.account.tokenAccounts)if(u){let B=we(this.scope.ownerPubKey,R.mint).publicKey;R.publicKey&&B.equals(R.publicKey)&&(b[R.mint.toString()]=R.publicKey)}else b[R.mint.toString()]=R.publicKey;if(i)i.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else{let R=Je({programId:new Ae(n.programId),poolId:new Ae(n.id),owner:this.scope.ownerPubKey,version:p}),B=await this.scope.connection.getAccountInfo(R);if(B)Un(p).decode(B.data).deposited.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else if(p!==6&&(l||[]).length>0){let{instruction:M,instructionType:D}=ho({id:new Ae(y.id),programId:new Ae(y.programId),version:p,ledger:R,owner:this.scope.ownerPubKey});f.addInstruction({instructions:[M],instructionTypes:[D]})}else this.logAndCreateError("no lp data",{farmId:n.id,version:p,ledgerData:B})}let g=y.lpMint.address,w=s&&g===j.toString(),A=b[g.toString()];if(!A){let{account:R,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.lpMint.programId,mint:new Ae(g),notUseTokenAccount:w,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:w?!1:u,checkCreateATAOwner:c});A=R,B&&f.addInstruction(B)}b[g.toString()]=A;let k=[];for(let R of d){let B=s&&R.mint.address===j.toString(),M=b[R.mint.address];if(!M){let{account:D,instructionParams:F}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:R.mint.programId,mint:new Ae(R.mint.address),notUseTokenAccount:B,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!B,associatedOnly:B?!1:u,checkCreateATAOwner:c});M=D,F&&f.addInstruction(F)}b[R.mint.address]=M,k.push(M)}let I=ns({version:p,rewardInfos:d,rewardTokenAccountsPublicKeys:k});I&&this.logAndCreateError(I);let T={amount:Y(r),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:y,lpAccount:A,rewardAccounts:k,userAuxiliaryLedgers:l==null?void 0:l.map(R=>new Ae(R))},S=p===6?ko(T):p===5?To(T):Io(T),x={3:V.FarmV3Withdraw,5:V.FarmV5Withdraw,6:V.FarmV6Withdraw};return f.addInstruction({instructions:[S],instructionTypes:[x[p]]}).versionBuild({txVersion:t})}async withdrawFarmReward({farmInfo:e,withdrawMint:t,txVersion:n}){var p;this.scope.checkOwner();let r=Ie((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),i=gt[e.programId];i!==6&&this.logAndCreateError("invalid farm version",i);let s=e.rewardInfos.findIndex(y=>y.mint.address===Ve.toString()?new Ae(Ee.address):t),a=r.rewardInfos[s];a||this.logAndCreateError("withdraw mint error","rewardInfos",e);let u=(p=a==null?void 0:a.vault)!=null?p:Ve,c=this.createTxBuilder(),l;if(t.equals(Ve)){let y=await Gt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:cs(E(C({},a),{openTime:a.openTime,endTime:a.endTime,perSecond:new O(a.perSecond).mul(10**a.mint.decimals).toString()}))});l=y.addresses.newAccount,c.addInstruction(y)}else{let y=await this.scope.account.getCreatedTokenAccount({mint:t});y===null?(l=await this.scope.account.getAssociatedTokenAccount(t),c.addInstruction({instructions:[np(this.scope.ownerPubKey,l,this.scope.ownerPubKey,t)],instructionTypes:[V.CreateATA]})):l=y}let{instruction:m,instructionType:d}=Pu({programId:r.programId,id:r.id,authority:r.authority,lpVault:r.lpVault,rewardVault:u,userRewardToken:l,owner:this.scope.ownerPubKey});return c.addInstruction({instructions:[m],instructionTypes:[d]}).versionBuild({txVersion:n})}async harvestAllRewards(e){let{farmInfoList:t,useSOLBalance:n,feePayer:r,associatedOnly:i=!0,checkCreateATAOwner:s=!1,userAuxiliaryLedgers:a,txVersion:u,computeBudgetConfig:c}=e,l=this.createTxBuilder(),m={};for(let y of this.scope.account.tokenAccounts)if(i){let f=we(this.scope.ownerPubKey,y.mint).publicKey;y.publicKey&&f.equals(y.publicKey)&&(m[y.mint.toString()]=y.publicKey)}else m[y.mint.toString()]=y.publicKey;let p=(await this.scope.api.fetchFarmKeysById({ids:Object.values(t).map(y=>y.id).join(",")})).reduce((y,f)=>E(C({},y),{[f.id]:f}),{});for(let y of Object.values(t)){let{programId:f,lpMint:b,rewardInfos:g,id:w}=y,A=gt[f],k=b.address,I=n&&k===j.toString(),T=m[k];if(!T){let{account:D,instructionParams:F}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:b.programId,mint:new Ae(k),notUseTokenAccount:I,createInfo:{payer:r||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:I?!1:i,checkCreateATAOwner:s});T=D,F&&l.addInstruction(F)}m[k.toString()]=T;let S=[];for(let D of g){let F=n&&D.mint.address===j.toString(),Z=m[D.mint.address];if(!Z){let{account:G,instructionParams:q}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:D.mint.programId,mint:new Ae(D.mint.address),notUseTokenAccount:F,createInfo:{payer:r||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!F,associatedOnly:F?!1:i,checkCreateATAOwner:s});Z=G,q&&l.addInstruction(q)}m[D.mint.address]=Z,S.push(Z)}let x=p[w],R={amount:De,owner:this.scope.ownerPubKey,farmInfo:y,farmKeys:x,lpAccount:T,rewardAccounts:S,userAuxiliaryLedgers:a==null?void 0:a.map(D=>new Ae(D))},B=A===6?ko(R):A===5?To(R):Io(R),M={3:V.FarmV3Withdraw,5:V.FarmV5Withdraw,6:V.FarmV6Withdraw};l.addInstruction({instructions:[B],instructionTypes:[M[A]]})}return u===1?l.sizeCheckBuild({computeBudgetConfig:c}):l.sizeCheckBuildV0({computeBudgetConfig:c})}};import{PublicKey as tt}from"@solana/web3.js";import{AccountLayout as Xp,NATIVE_MINT as ac,TOKEN_PROGRAM_ID as Qn}from"@solana/spl-token";var Lh=v([Ye("mintAuthorityOption"),K("mintAuthority"),h("supply"),W("decimals"),W("isInitialized"),Ye("freezeAuthorityOption"),K("freezeAuthority")]);import{PublicKey as rp}from"@solana/web3.js";import{MintLayout as Iu,TOKEN_PROGRAM_ID as ip}from"@solana/spl-token";var qh=async({connection:o,mint:e})=>{let t=await o.getAccountInfo(new rp(e));return!t||t.data.length!==Iu.span?void 0:Iu.decode(t.data)},Uh=({mint:o,decimals:e,programId:t=ip,logoURI:n="",priority:r=3})=>{let i=o.toBase58().substring(0,6);return{address:o.toBase58(),decimals:e,symbol:i,logoURI:n,extensions:{},chainId:101,programId:t.toString(),name:i,tags:[],priority:r}},Cr=o=>new ye({mint:o.address,decimals:o.decimals,symbol:o.symbol,name:o.name}),xo=r=>{var i=r,{amount:o,isRaw:e,name:t}=i,n=Oe(i,["amount","isRaw","name"]);return new fe(new ye({mint:pt(n.address).toBase58(),decimals:n.decimals,symbol:n.symbol,name:t}),o,e,t)};function Gh(o){return o.address===Mt.address?Ee:o}function Xh(o){return o.address===Ee.address?Mt:o}var it=r=>{var i=r,{address:o,programId:e,decimals:t}=i,n=Oe(i,["address","programId","decimals"]);return C({chainId:101,address:pt(o).toBase58(),programId:e,logoURI:"",symbol:"",name:"",decimals:t,tags:[],extensions:n.extensions||{}},n)},cn=o=>o?E(C({},o),{transferFeeConfigAuthority:o.transferFeeConfigAuthority.toBase58(),withdrawWithheldAuthority:o.withdrawWithheldAuthority.toBase58(),withheldAmount:o.withheldAmount.toString(),olderTransferFee:E(C({},o.olderTransferFee),{epoch:o.olderTransferFee.epoch.toString(),maximumFee:o.olderTransferFee.maximumFee.toString()}),newerTransferFee:E(C({},o.newerTransferFee),{epoch:o.newerTransferFee.epoch.toString(),maximumFee:o.newerTransferFee.maximumFee.toString()})}):void 0;import{TOKEN_PROGRAM_ID as zn,ASSOCIATED_TOKEN_PROGRAM_ID as wp}from"@solana/spl-token";import{PublicKey as Pe,TransactionInstruction as Xt,SystemProgram as Lu,SYSVAR_RENT_PUBKEY as Pp}from"@solana/web3.js";var ps=v([W("instruction"),h("amountIn"),h("minAmountOut")]),fs=v([W("instruction"),h("maxAmountIn"),h("amountOut")]),ok=v([W("instruction"),W("nonce")]),ys=v([W("instruction"),W("nonce"),h("startTime")]),So=v([h("status"),h("nonce"),h("maxOrder"),h("depth"),h("baseDecimal"),h("quoteDecimal"),h("state"),h("resetFlag"),h("minSize"),h("volMaxCutRatio"),h("amountWaveRatio"),h("baseLotSize"),h("quoteLotSize"),h("minPriceMultiplier"),h("maxPriceMultiplier"),h("systemDecimalValue"),h("minSeparateNumerator"),h("minSeparateDenominator"),h("tradeFeeNumerator"),h("tradeFeeDenominator"),h("pnlNumerator"),h("pnlDenominator"),h("swapFeeNumerator"),h("swapFeeDenominator"),h("baseNeedTakePnl"),h("quoteNeedTakePnl"),h("quoteTotalPnl"),h("baseTotalPnl"),h("poolOpenTime"),h("punishPcAmount"),h("punishCoinAmount"),h("orderbookToInitTime"),J("swapBaseInAmount"),J("swapQuoteOutAmount"),h("swapBase2QuoteFee"),J("swapQuoteInAmount"),J("swapBaseOutAmount"),h("swapQuote2BaseFee"),K("baseVault"),K("quoteVault"),K("baseMint"),K("quoteMint"),K("lpMint"),K("openOrders"),K("marketId"),K("marketProgramId"),K("targetOrders"),K("withdrawQueue"),K("lpVault"),K("owner"),h("lpReserve"),X(h(),3,"padding")]),sp=v([h("accountType"),h("status"),h("nonce"),h("maxOrder"),h("depth"),h("baseDecimal"),h("quoteDecimal"),h("state"),h("resetFlag"),h("minSize"),h("volMaxCutRatio"),h("amountWaveRatio"),h("baseLotSize"),h("quoteLotSize"),h("minPriceMultiplier"),h("maxPriceMultiplier"),h("systemDecimalsValue"),h("abortTradeFactor"),h("priceTickMultiplier"),h("priceTick"),h("minSeparateNumerator"),h("minSeparateDenominator"),h("tradeFeeNumerator"),h("tradeFeeDenominator"),h("pnlNumerator"),h("pnlDenominator"),h("swapFeeNumerator"),h("swapFeeDenominator"),h("baseNeedTakePnl"),h("quoteNeedTakePnl"),h("quoteTotalPnl"),h("baseTotalPnl"),h("poolOpenTime"),h("punishPcAmount"),h("punishCoinAmount"),h("orderbookToInitTime"),J("swapBaseInAmount"),J("swapQuoteOutAmount"),J("swapQuoteInAmount"),J("swapBaseOutAmount"),h("swapQuote2BaseFee"),h("swapBase2QuoteFee"),K("baseVault"),K("quoteVault"),K("baseMint"),K("quoteMint"),K("lpMint"),K("modelDataAccount"),K("openOrders"),K("marketId"),K("marketProgramId"),K("targetOrders"),K("owner"),X(h(),64,"padding")]),bs=v([W("instruction"),h("baseAmountIn"),h("quoteAmountIn"),h("fixedSide")]),gs=v([W("instruction"),h("amountIn")]),rk={4:So,5:sp},Bu=v([h("fee")]);import{PublicKey as ap}from"@solana/web3.js";var Xn=new ap("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Pn=5e4,up=v([h("x"),h("y"),h("price")]),cp=v([h("accountType"),h("status"),h("multiplier"),h("validDataCount"),X(up,Pn,"DataElement")]);function lp(o,e){return[0,Pn-2]}function mp(o){return[0,Pn-2]}function dp(o){return[0,Pn-2]}function pp(o,e,t){let[n,r]=lp(e,t),i=n,s=r,a=0,u=e*o.multiplier/t;for(;i<=s;){if(a=Math.floor((s+i)/2),a===0||a>=Pn-2)return[a,a,!1];let c=o.DataElement[a].x*o.multiplier/o.DataElement[a].y,l=o.DataElement[a-1].x*o.multiplier/o.DataElement[a-1].y,m=o.DataElement[a+1].x*o.multiplier/o.DataElement[a+1].y;if(u===c)return[a,a,!0];if(u===l)return[a-1,a-1,!0];if(u===m)return[a+1,a+1,!0];if(u<l)s=a-1;else{if(u>l&&u<c)return[a-1,a,!0];if(u>c&&u<m)return[a,a+1,!0];i=a+1}}return[a,a,!1]}function As(o,e,t){let[n,r,i]=pp(o,e,t);if(!i)return 0;if(n===r){let s=o.DataElement[n].x;return e*o.multiplier/s}else{let s=o.DataElement[n].x,a=o.DataElement[n].y,u=o.DataElement[r].x,c=o.DataElement[r].y,l=t*(u*a-s*c),m=s*l,d=(u-s)*(e*a-s*t)*c,p=m+d;return e*o.multiplier*l/p}}function wn(o,e,t){return e*o.multiplier/t}function xu(o,e,t){return e*t/o.multiplier}function fp(o,e){let[t,n]=mp(e),r=t,i=n,s=0,a=e;for(;r<i;){if(s=Math.floor((i+r)/2),s<=0||s>Pn-2)return[s,s,!1];let u=o.DataElement[s].x,c=o.DataElement[s-1].x,l=o.DataElement[s+1].x;if(a===u)return[s,s,!0];if(a===c)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<c)i=s-1;else{if(a>c&&a<u)return[s-1,s,!0];if(a>u&&a<l)return[s,s+1,!0];r=s+1}}return[s,s,!1]}function yp(o,e){let[t,n]=dp(e),r=t,i=n,s=0,a=e;for(;r<=i;){if(s=Math.floor((i+r)/2),s<=0||s>=Pn-2)return[s,s,!1];let u=o.DataElement[s].y,c=o.DataElement[s-1].y,l=o.DataElement[s+1].y;if(a===u)return[s,s,!0];if(a===c)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<l)r=s+1;else{if(a<c&&a>u)return[s-1,s,!0];if(a<u&&a>l)return[s,s+1,!0];i=s-1}}return[s,s,!1]}function Su(o,e,t,n){let r=n?e+t:e-t,[i,s,a]=fp(o,r);if(!a)return[0,0,!1,a];if(i===s)return[o.DataElement[s].price,o.DataElement[s].y,!1,a];{let u=o.DataElement[i].x,c=o.DataElement[s].x,l=o.DataElement[i].price,m=o.DataElement[s].price,d=o.DataElement[i].y,p=o.DataElement[s].y;if(e>=u&&e<=c)return n?[m,p,!0,a]:[l,d,!0,a];{let y,f;return n?(y=l+(m-l)*(e-u)/(c-u),f=d-(r-u)*o.multiplier/m):(y=l+(m-l)*(e-u)/(c-u),f=p+(c-r)*o.multiplier/l),[y,f,!1,a]}}}function bp(o,e,t,n){let r=n?e-t:e+t,[i,s,a]=yp(o,r);if(!a)return[0,0,!1,a];if(i===s)return[o.DataElement[s].price,o.DataElement[s].x,!1,a];{let u=o.DataElement[i].x,c=o.DataElement[s].x,l=o.DataElement[i].price,m=o.DataElement[s].price,d=o.DataElement[i].y,p=o.DataElement[s].y;if(e>=p&&e<=d)return n?[m,c,!0,a]:[l,u,!0,a];{let y,f;return n?(y=l+(m-l)*(d-e)/(d-p),f=u+m*(d-r)/o.multiplier):(y=l+(m-l)*(d-e)/(d-p),f=c-l*(r-p)/o.multiplier),[y,f,!1,a]}}}function gp(o,e){let t=Su(o,e,0,!1);return t[3]?t[0]:0}function Ku(o,e,t,n){let r=As(o,e,t),i=wn(o,e,r),s=wn(o,t,r),a=wn(o,n,r),u=!0,[c,l,m,d]=Su(o,i,a,u);if(!d)return 0;if(m)return n*o.multiplier/c;{let p=s-l;return xu(o,p,r)}}function Cu(o,e,t,n){let r=As(o,e,t),i=wn(o,e,r),s=wn(o,t,r),a=wn(o,n,r),u=!1,[c,l,m,d]=bp(o,s,a,u);if(!d)return 0;if(m)return n*c/o.multiplier;{let p=i-l;return xu(o,p,r)}}function Ap(o){let e=cp.decode(o);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(t=>({x:t.x.toNumber(),y:t.y.toNumber(),price:t.price.toNumber()}))}}function Ru(o,e,t,n){let r=gp(o,wn(o,e,As(o,e,t)))/o.multiplier;return n?r:1/r}var Gn=class{constructor({connection:e}){this._layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};this.connection=e}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(Xn);e&&(this._layoutData=Ap(e==null?void 0:e.data))}}};var Ou=ce("Raydium_liquidity_instruction");function Nu(o){let{poolInfo:e,poolKeys:t,userKeys:n,baseAmountIn:r,quoteAmountIn:i,fixedSide:s}=o,a=Buffer.alloc(bs.span);bs.encode({instruction:3,baseAmountIn:Y(r),quoteAmountIn:Y(i),fixedSide:s==="base"?De:Pa},a);let u=[P({pubkey:zn,isWritable:!1}),P({pubkey:new Pe(e.id)}),P({pubkey:new Pe(t.authority),isWritable:!1}),P({pubkey:new Pe(t.openOrders),isWritable:!1}),P({pubkey:new Pe(t.targetOrders)}),P({pubkey:new Pe(e.lpMint.address)}),P({pubkey:new Pe(t.vault.A)}),P({pubkey:new Pe(t.vault.B)})];return e.pooltype.includes("StablePool")&&u.push(P({pubkey:Xn})),u.push(P({pubkey:new Pe(e.marketId),isWritable:!1}),P({pubkey:n.baseTokenAccount}),P({pubkey:n.quoteTokenAccount}),P({pubkey:n.lpTokenAccount}),P({pubkey:n.owner,isWritable:!1,isSigner:!0}),P({pubkey:new Pe(t.marketEventQueue),isWritable:!1})),new Xt({programId:new Pe(e.programId),keys:u,data:a})}function ws(o){let{poolInfo:e,poolKeys:t,userKeys:n,amountIn:r}=o,i=Ie(t),s=4;if(e.pooltype.includes("StablePool")&&(s=5),s===4||s===5){let a=Buffer.alloc(gs.span);gs.encode({instruction:4,amountIn:Y(r)},a);let u=[P({pubkey:zn,isWritable:!1}),P({pubkey:i.id}),P({pubkey:i.authority,isWritable:!1}),P({pubkey:i.openOrders}),P({pubkey:i.targetOrders}),P({pubkey:i.mintLp.address}),P({pubkey:i.vault.A}),P({pubkey:i.vault.B})];return s===5?u.push(P({pubkey:Xn})):(u.push(P({pubkey:i.id})),u.push(P({pubkey:i.id}))),u.push(P({pubkey:i.marketProgramId,isWritable:!1}),P({pubkey:i.marketId}),P({pubkey:i.marketBaseVault}),P({pubkey:i.marketQuoteVault}),P({pubkey:i.marketAuthority,isWritable:!1}),P({pubkey:n.lpTokenAccount}),P({pubkey:n.baseTokenAccount}),P({pubkey:n.quoteTokenAccount}),P({pubkey:n.owner,isWritable:!1,isSigner:!0}),P({pubkey:i.marketEventQueue}),P({pubkey:i.marketBids}),P({pubkey:i.marketAsks})),new Xt({programId:i.programId,keys:u,data:a})}return new Xt({programId:i.programId,keys:[]})}function Mu({programId:o,ammId:e,ammAuthority:t,ammOpenOrders:n,lpMint:r,coinMint:i,pcMint:s,coinVault:a,pcVault:u,withdrawQueue:c,ammTargetOrders:l,poolTempLp:m,marketProgramId:d,marketId:p,userWallet:y,userCoinVault:f,userPcVault:b,userLpVault:g,nonce:w,openTime:A,coinAmount:k,pcAmount:I,ammConfigId:T,feeDestinationId:S}){let x=v([W("instruction"),W("nonce"),h("openTime"),h("pcAmount"),h("coinAmount")]),R=[{pubkey:zn,isSigner:!1,isWritable:!1},{pubkey:wp,isSigner:!1,isWritable:!1},{pubkey:Lu.programId,isSigner:!1,isWritable:!1},{pubkey:ut,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:T,isSigner:!1,isWritable:!1},{pubkey:S,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!0,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0}],B=Buffer.alloc(x.span);return x.encode({instruction:1,nonce:w,openTime:A,coinAmount:k,pcAmount:I},B),{instruction:new Xt({keys:R,programId:o,data:B}),instructionType:V.AmmV4CreatePool}}function Pk(o){let e=v([W("instruction"),W("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[P({pubkey:new Pe(o.id),isWritable:!1}),P({pubkey:new Pe(o.authority),isWritable:!1}),P({pubkey:new Pe(o.openOrders),isWritable:!1}),P({pubkey:new Pe(o.vault.A),isWritable:!1}),P({pubkey:new Pe(o.vault.B),isWritable:!1}),P({pubkey:new Pe(o.mintLp.address),isWritable:!1}),P({pubkey:new Pe(o.marketId),isWritable:!1}),P({pubkey:new Pe(o.marketEventQueue),isWritable:!1})];return new Xt({programId:new Pe(o.programId),keys:n,data:t})}function hp({poolKeys:o,userKeys:e,amountIn:t,minAmountOut:n},r){let i=Ie(o),s=Buffer.alloc(ps.span);ps.encode({instruction:9,amountIn:Y(t),minAmountOut:Y(n)},s);let a=[P({pubkey:zn,isWritable:!1}),P({pubkey:i.id}),P({pubkey:i.authority,isWritable:!1}),P({pubkey:i.openOrders})];return r===4&&a.push(P({pubkey:i.targetOrders})),a.push(P({pubkey:i.vault.A}),P({pubkey:i.vault.B})),r===5&&a.push(P({pubkey:Xn})),a.push(P({pubkey:i.marketProgramId,isWritable:!1}),P({pubkey:i.marketId}),P({pubkey:i.marketBids}),P({pubkey:i.marketAsks}),P({pubkey:i.marketEventQueue}),P({pubkey:i.marketBaseVault}),P({pubkey:i.marketQuoteVault}),P({pubkey:i.marketAuthority,isWritable:!1}),P({pubkey:e.tokenAccountIn}),P({pubkey:e.tokenAccountOut}),P({pubkey:e.owner,isWritable:!1})),new Xt({programId:i.programId,keys:a,data:s})}function kp({poolKeys:o,userKeys:e,maxAmountIn:t,amountOut:n},r){let i=Ie(o),s=Buffer.alloc(fs.span);fs.encode({instruction:11,maxAmountIn:Y(t),amountOut:Y(n)},s);let a=[P({pubkey:zn,isWritable:!1}),P({pubkey:i.id}),P({pubkey:i.authority,isWritable:!1}),P({pubkey:i.openOrders}),P({pubkey:i.targetOrders}),P({pubkey:i.vault.A}),P({pubkey:i.vault.B})];return r===5&&a.push(P({pubkey:Xn})),a.push(P({pubkey:i.marketProgramId,isWritable:!1}),P({pubkey:i.marketId}),P({pubkey:i.marketBids}),P({pubkey:i.marketAsks}),P({pubkey:i.marketEventQueue}),P({pubkey:i.marketBaseVault}),P({pubkey:i.marketQuoteVault}),P({pubkey:i.marketAuthority,isWritable:!1}),P({pubkey:e.tokenAccountIn}),P({pubkey:e.tokenAccountOut}),P({pubkey:e.owner,isWritable:!1,isSigner:!0})),new Xt({programId:i.programId,keys:a,data:s})}function Rr(o){let{poolKeys:e,version:t,userKeys:n,amountIn:r,amountOut:i,fixedSide:s}=o;if(t===4||t===5){let a={poolKeys:e,userKeys:n};if(s==="in")return hp(E(C({},a),{amountIn:r,minAmountOut:i}),t);if(s==="out")return kp(E(C({},a),{maxAmountIn:r,amountOut:i}),t);Ou.logWithError("invalid params","params",o)}throw Ou.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}function hk({poolKeys:o,userKeys:e,startTime:t}){let n=Buffer.alloc(ys.span);ys.encode({instruction:0,nonce:5,startTime:Y(t)},n);let r=Ie(o),i=[P({pubkey:zn,isWritable:!1}),P({pubkey:Lu.programId,isWritable:!1}),P({pubkey:Pp,isWritable:!1}),P({pubkey:r.id}),P({pubkey:r.authority,isWritable:!1}),P({pubkey:r.openOrders}),P({pubkey:r.mintLp.address}),P({pubkey:r.mintA.address,isWritable:!1}),P({pubkey:r.mintB.address,isWritable:!1}),P({pubkey:r.vault.A,isWritable:!1}),P({pubkey:r.vault.B,isWritable:!1}),P({pubkey:r.id}),P({pubkey:r.targetOrders}),P({pubkey:e.lpTokenAccount}),P({pubkey:r.id,isWritable:!1}),P({pubkey:r.marketProgramId,isWritable:!1}),P({pubkey:r.marketId,isWritable:!1}),P({pubkey:e.payer,isSigner:!0})];return new Xt({programId:r.programId,keys:i,data:n})}function vu({poolKeys:o}){let e=v([W("instruction"),W("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[P({pubkey:new Pe(o.id),isWritable:!1}),P({pubkey:new Pe(o.authority),isWritable:!1}),P({pubkey:new Pe(o.openOrders),isWritable:!1}),P({pubkey:new Pe(o.vault.A),isWritable:!1}),P({pubkey:new Pe(o.vault.B),isWritable:!1}),P({pubkey:new Pe(o.mintLp.address),isWritable:!1}),P({pubkey:new Pe(o.marketId),isWritable:!1}),P({pubkey:new Pe(o.marketEventQueue),isWritable:!1})];return{instruction:new Xt({programId:new Pe(o.programId),keys:n,data:t})}}import{ASSOCIATED_TOKEN_PROGRAM_ID as tc,TOKEN_2022_PROGRAM_ID as ln,TOKEN_PROGRAM_ID as He}from"@solana/spl-token";import{Keypair as Ss,PublicKey as U,SystemProgram as Mo,TransactionInstruction as Ot}from"@solana/web3.js";import nc from"bn.js";import Mp from"bn.js";function _u(o){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,o,!1),new Uint8Array(e)}function Tk(o){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,o,!1),new Uint8Array(e)}function Ik(o){let e=new ArrayBuffer(4);return new DataView(e).setUint32(0,o,!1),new Uint8Array(e)}function Or(o){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,o,!1),new Uint8Array(e)}function Ps(o,e){let t=0;for(let n=o-1;n>=0&&!e.testn(n);n--)t++;return t}function hs(o,e){let t=0;for(let n=0;n<o&&!e.testn(n);n++)t++;return t}function Ko(o,e){for(let t=0;t<o;t++)if(e.testn(t))return!1;return!0}function Fu(o,e){return Ko(o,e)?null:Ps(o,e)}function Vu(o,e){return Ko(o,e)?null:hs(o,e)}var Tp=Buffer.from("amm_config","utf8"),Ip=Buffer.from("pool","utf8"),Bp=Buffer.from("pool_vault","utf8"),xp=Buffer.from("pool_reward_vault","utf8"),Eu=Buffer.from("position","utf8"),Sp=Buffer.from("tick_array","utf8"),Kp=Buffer.from("operation","utf8"),Cp=Buffer.from("pool_tick_array_bitmap_extension","utf8"),Rp=Buffer.from("observation","utf8");function Kk(o,e){return ue([Tp,_u(e)],o)}function Du(o,e,t,n){return ue([Ip,e.toBuffer(),t.toBuffer(),n.toBuffer()],o)}function ks(o,e,t){return ue([Bp,e.toBuffer(),t.toBuffer()],o)}function Wu(o,e,t){return ue([xp,e.toBuffer(),t.toBuffer()],o)}function he(o,e,t){return ue([Sp,e.toBuffer(),Or(t)],o)}function hn(o,e,t,n){return ue([Eu,e.toBuffer(),Or(t),Or(n)],o)}function At(o,e){return ue([Eu,e.toBuffer()],o)}function Lr(o){return ue([Buffer.from("metadata","utf8"),vn.toBuffer(),o.toBuffer()],vn)}function Co(o){return ue([Kp],o)}function mt(o,e){return ue([Cp,e.toBuffer()],o)}function qu(o,e){return ue([Rp,e.toBuffer()],o)}import wt from"bn.js";var pe=new wt(0),yt=new wt(1),zt=new wt(-1),bt=new wt(1).shln(64),Nr=new wt(1).shln(128),Ts=bt.sub(yt),Ro=64,Uu=Nr.subn(1),et=-443636,st=-et,Pt=new wt("4295048016"),ht=new wt("79226673521066979257578248091"),Mr=new wt("4295048017"),vr=new wt("79226673521066979257578248090"),Gu=16,Xu="59543866431248",zu="184467440737095516",Qu="15793534762490258745",_r=new wt(10).pow(new wt(6)),Op=(n=>(n[n.rate_500=500]="rate_500",n[n.rate_3000=3e3]="rate_3000",n[n.rate_10000=1e4]="rate_10000",n))(Op||{}),Ok={[500]:10,[3e3]:60,[1e4]:200},Lk={version:6,liquidity:pe,tickCurrent:0,feeGrowthGlobalX64A:pe,feeGrowthGlobalX64B:pe,protocolFeesTokenA:pe,protocolFeesTokenB:pe,swapInAmountTokenA:pe,swapOutAmountTokenB:pe,swapInAmountTokenB:pe,swapOutAmountTokenA:pe,tickArrayBitmap:[],rewardInfos:[],day:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},week:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},month:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},tvl:0},Yu={tvl:0,volumeQuote:0,mintAmountA:0,mintAmountB:0,rewardDefaultInfos:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,day:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},week:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},month:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},pooltype:[]},Nk=new wt("18446744073700000000");var Lp=15,me=class{static async getTickArrays(e,t,n,r,i,s,a){let u=[],c=H.getTickArrayStartIndexByTick(r,i),l=H.getInitializedTickArrayInRange(s,a,i,c,Math.floor(Lp/2));for(let p=0;p<l.length;p++){let{publicKey:y}=he(t,n,l[p]);u.push(y)}let m=(await Bt(e,u)).map(p=>p!==null?Oo.decode(p.data):null),d={};for(let p=0;p<u.length;p++){let y=m[p];y!==null&&(d[y.startTickIndex]=E(C({},y),{address:u[p]}))}return d}static nextInitializedTick(e,t,n,r,i,s){let{initializedTick:a,tickArrayAddress:u,tickArrayStartTickIndex:c}=this.nextInitializedTickInOneArray(e,t,n,r,i,s);for(;a==null||a.liquidityGross.lten(0);){if(c=H.getNextTickArrayStartIndex(c,i,s),this.checkIsValidStartIndex(c,i))throw new Error("No enough initialized tickArray");let l=n[c];if(l===void 0)continue;let{nextTick:m,tickArrayAddress:d,tickArrayStartTickIndex:p}=this.firstInitializedTickInOneArray(e,t,l,s);[a,u,c]=[m,d,p]}if(a==null)throw new Error("No invaild tickArray cache");return{nextTick:a,tickArrayAddress:u,tickArrayStartTickIndex:c}}static nextInitializedTickArray(e,t,n,r,i){let s=Math.floor(e/me.tickCount(t)),a=n?H.searchLowBitFromStart(r,i,s-1,1,t):H.searchHightBitFromStart(r,i,s+1,1,t);return a.length>0?{isExist:!0,nextStartIndex:a[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,r){let i;if(r){let a=qe-1;for(;a>=0;){let u=n.ticks[a];if(u.liquidityGross.gtn(0)){i=u;break}a=a-1}}else{let a=0;for(;a<qe;){let u=n.ticks[a];if(u.liquidityGross.gtn(0)){i=u;break}a=a+1}}let{publicKey:s}=he(e,t,n.startTickIndex);return{nextTick:i,tickArrayAddress:s,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,r,i,s){let a=H.getTickArrayStartIndexByTick(r,i),u=Math.floor((r-a)/i),c=n[a];if(c==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:a};let l;if(s)for(;u>=0;){let d=c.ticks[u];if(d.liquidityGross.gtn(0)){l=d;break}u=u-1}else for(u=u+1;u<qe;){let d=c.ticks[u];if(d.liquidityGross.gtn(0)){l=d;break}u=u+1}let{publicKey:m}=he(e,t,a);return{initializedTick:l,tickArrayAddress:m,tickArrayStartTickIndex:c.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(H.checkIsOutOfBoundary(e)){if(e>st)return!1;let n=H.getTickArrayStartIndexByTick(et,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return qe*e}};import se from"bn.js";import{PublicKey as Rt}from"@solana/web3.js";import Be from"bn.js";var Is=14,Qt=class{static maxTickInTickarrayBitmap(e){return e*qe*kn}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),r=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(r+=1);let i=n*r;return e<0?{minValue:-i,maxValue:-i+n}:{minValue:i,maxValue:i+n}}static nextInitializedTickArrayStartIndex(e,t,n,r){if(!me.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let i=this.maxTickInTickarrayBitmap(n),s=r?t-me.tickCount(n):t+me.tickCount(n);if(s<-i||s>=i)return{isInit:!1,tickIndex:t};let a=n*qe,u=s/a+512;s<0&&s%a!=0&&u--;let c=Math.abs(u);if(r){let l=e.shln(1024-c-1),m=Fu(1024,l);if(m!==null){let d=(c-m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:-i}}else{let l=e.shrn(c),m=Vu(1024,l);if(m!==null){let d=(c+m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:i-me.tickCount(n)}}}},Lo=class{static getBitmapOffset(e,t){if(!me.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=Qt.maxTickInTickarrayBitmap(t),r=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&r--,r}static getBitmap(e,t,n){let r=this.getBitmapOffset(e,t);return e<0?{offset:r,tickarrayBitmap:n.negativeTickArrayBitmap[r]}:{offset:r,tickarrayBitmap:n.positiveTickArrayBitmap[r]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:r}=this.extensionTickBoundary(t);if(e>=r&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=Qt.maxTickInTickarrayBitmap(e),n=-t;if(st<=t)throw Error(`extensionTickBoundary check error: ${st}, ${t}`);if(n<=et)throw Error(`extensionTickBoundary check error: ${n}, ${et}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:r}=this.getBitmap(e,t,n),i=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:H.mergeTickArrayBitmap(r).testn(i),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,r){let i=me.tickCount(t),s=n?e-i:e+i,{tickarrayBitmap:a}=this.getBitmap(s,t,r);return this.nextInitializedTickArrayInBitmap(a,s,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,r){let{minValue:i,maxValue:s}=Qt.getBitmapTickBoundary(t,n),a=this.tickArrayOffsetInBitmap(t,n);if(r){let u=H.mergeTickArrayBitmap(e).shln(kn-1-a),c=Ko(512,u)?null:Ps(512,u);if(c!==null){let l=t-c*me.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:i}}else{let u=H.mergeTickArrayBitmap(e).shrn(a),c=Ko(512,u)?null:hs(512,u);if(c!==null){let l=t+c*me.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-me.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%Qt.maxTickInTickarrayBitmap(t),r=Math.floor(n/me.tickCount(t));return e<0&&n!=0&&(r=kn-r),r}};import Ft from"bn.js";var No=class{static getfeeGrowthInside(e,t,n){let r=new Ft(0),i=new Ft(0);e.tickCurrent>=t.tick?(r=t.feeGrowthOutsideX64A,i=t.feeGrowthOutsideX64B):(r=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),i=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let s=new Ft(0),a=new Ft(0);e.tickCurrent<n.tick?(s=n.feeGrowthOutsideX64A,a=n.feeGrowthOutsideX64B):(s=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),a=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let u=ne.wrappingSubU128(ne.wrappingSubU128(e.feeGrowthGlobalX64A,r),s),c=ne.wrappingSubU128(ne.wrappingSubU128(e.feeGrowthGlobalX64B,i),a);return{feeGrowthInsideX64A:u,feeGrowthInsideBX64:c}}static GetPositionFees(e,t,n,r){let{feeGrowthInsideX64A:i,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,r),a=ne.mulDivFloor(ne.wrappingSubU128(i,t.feeGrowthInsideLastX64A),t.liquidity,bt),u=t.tokenFeesOwedA.add(a),c=ne.mulDivFloor(ne.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,bt),l=t.tokenFeesOwedB.add(c);return{tokenFeeAmountA:u,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,r){let{feeGrowthInsideX64A:i,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,r),a=ne.mulDivFloor(ne.wrappingSubU128(i,t.feeGrowthInsideLastX64A),t.liquidity,bt),u=t.tokenFeesOwedA.add(a),c=ne.mulDivFloor(ne.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,bt),l=t.tokenFeesOwedB.add(c);return{tokenFeeAmountA:u,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,r){let i=[],s=this.getRewardGrowthInsideV2(e.tickCurrent,n,r,e.rewardInfos);for(let a=0;a<s.length;a++){let u=s[a],c=t.rewardInfos[a],l=ne.wrappingSubU128(u,c.growthInsideLastX64),m=ne.mulDivFloor(l,t.liquidity,bt),d=c.rewardAmountOwed.add(m);i.push(d)}return i}static GetPositionRewards(e,t,n,r){let i=[],s=this.getRewardGrowthInside(e.tickCurrent,n,r,e.rewardInfos);for(let a=0;a<s.length;a++){let u=s[a],c=t.rewardInfos[a],l=ne.wrappingSubU128(u,c.growthInsideLastX64),m=ne.mulDivFloor(l,t.liquidity,bt),d=c.rewardAmountOwed.add(m);i.push(d)}return i}static getRewardGrowthInside(e,t,n,r){let i=[];for(let s=0;s<r.length;s++){let a=new Ft(0);t.liquidityGross.eqn(0)?a=r[s].rewardGrowthGlobalX64:e<t.tick?a=r[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let u=new Ft(0);n.liquidityGross.eqn(0)||(e<n.tick?u=n.rewardGrowthsOutsideX64[s]:u=r[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),i.push(ne.wrappingSubU128(ne.wrappingSubU128(r[s].rewardGrowthGlobalX64,a),u))}return i}static getRewardGrowthInsideV2(e,t,n,r){let i=[];for(let s=0;s<r.length;s++){let a=new Ft(0);t.liquidityGross.eqn(0)?a=r[s].rewardGrowthGlobalX64:e<t.tick?a=r[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let u=new Ft(0);n.liquidityGross.eqn(0)||(e<n.tick?u=n.rewardGrowthsOutsideX64[s]:u=r[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),i.push(ne.wrappingSubU128(ne.wrappingSubU128(r[s].rewardGrowthGlobalX64,a),u))}return i}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:r,add:i,epochInfo:s}){var b,g,w,A;let a=ee.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),u=ee.getSqrtPriceX64FromTick(t.tickLower),c=ee.getSqrtPriceX64FromTick(t.tickUpper),l=i?1+r:1-r,m=le.getAmountsFromLiquidity(a,u,c,n,i),[d,p]=[be(m.amountA,(b=e.mintA.extensions)==null?void 0:b.feeConfig,s,!0),be(m.amountB,(g=e.mintB.extensions)==null?void 0:g.feeConfig,s,!0)],[y,f]=[be(new Ft(new O(m.amountA.toString()).mul(l).toFixed(0)),(w=e.mintA.extensions)==null?void 0:w.feeConfig,s,!0),be(new Ft(new O(m.amountB.toString()).mul(l).toFixed(0)),(A=e.mintB.extensions)==null?void 0:A.feeConfig,s,!0)];return{liquidity:n,amountA:d,amountB:p,amountSlippageA:y,amountSlippageB:f,expirationTime:Kt(d.expirationTime,p.expirationTime)}}};import{TOKEN_2022_PROGRAM_ID as ju}from"@solana/spl-token";var Ce=class{static getOutputAmountAndRemainAccounts(e,t,n,r,i,s=!1){let a=n.toBase58()===e.mintA.address,u=[],{isExist:c,startIndex:l,nextAccountMeta:m}=this.getFirstInitializedTickArray(e,a);if(!c||l===void 0||!m)throw new Error("Invalid tick array");u.push(m);let{allTrade:d,amountCalculated:p,accounts:y,sqrtPriceX64:f,feeAmount:b}=Tn.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,a,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,r,l,i,s);return u.push(...y),{allTrade:d,expectedAmountOut:p.mul(zt),remainingAccounts:u,executionPrice:f,feeAmount:b}}static getInputAmountAndRemainAccounts(e,t,n,r,i){let s=n.toBase58()===e.mintB.address,a=[],{isExist:u,startIndex:c,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!u||c===void 0||!l)throw new Error("Invalid tick array");try{let f=this.preInitializedTickArrayStartIndex(e,s);if(f.isExist){let{publicKey:b}=he(e.programId,e.id,f.nextStartIndex);a.push(b)}}catch{}a.push(l);let{amountCalculated:m,accounts:d,sqrtPriceX64:p,feeAmount:y}=Tn.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,r.mul(zt),c,i);return a.push(...d),{expectedAmountIn:m,remainingAccounts:a,executionPrice:p,feeAmount:y}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:r}=Ce.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?Lo.checkTickArrayIsInit(me.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):H.checkTickArrayIsInitialized(H.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:a}=he(e.programId,e.id,r);return{isExist:!0,startIndex:r,nextAccountMeta:a}}let{isExist:i,nextStartIndex:s}=this.nextInitializedTickArrayStartIndex(e,me.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(i){let{publicKey:a}=he(e.programId,e.id,s);return{isExist:!0,startIndex:s,nextAccountMeta:a}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/me.tickCount(e.tickSpacing)),r=t?H.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):H.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return r.length>0?{isExist:!0,nextStartIndex:r[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=me.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:r,tickIndex:i}=Qt.nextInitializedTickArrayStartIndex(H.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(r)return{isExist:!0,nextStartIndex:i};t=i;let{isInit:s,tickIndex:a}=Lo.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(s)return{isExist:!0,nextStartIndex:a};if(t=a,t<et||t>st)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:r,rewardInfos:i}){var a,u,c;let s=[];for(let l=0;l<i.length;l++){let m=i[l],d=(c=(a=t.rewardDefaultInfos[l])==null?void 0:a.mint.programId)!=null?c:(u=await e.getAccountInfo(m.tokenMint))==null?void 0:u.owner;if(d===void 0)throw Error("get new reward mint info error");let p=E(C({},m),{perSecond:ne.x64ToDecimal(m.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new Rt(d)});if(p.tokenMint.equals(Rt.default))continue;if(n<=p.openTime.toNumber()||r.eq(pe)){s.push(p);continue}let y=new Be(Math.min(p.endTime.toNumber(),n)),f=y.sub(p.lastUpdateTime),b=ne.mulDivFloor(f,p.emissionsPerSecondX64,r),g=p.rewardGrowthGlobalX64.add(b),w=ne.mulDivFloor(f,p.emissionsPerSecondX64,bt),A=p.rewardTotalEmissioned.add(w);s.push(E(C({},p),{rewardGrowthGlobalX64:g,rewardTotalEmissioned:A,lastUpdateTime:y}))}return s}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:r}=this.tickRange(e);for(let i of t){let s=H.getTickArrayStartIndexByTick(i,e);if(s>=n||s<r)return!0}return!1}static tickRange(e){let t=Qt.maxTickInTickarrayBitmap(e),n=-t;return t>st&&(t=me.getArrayStartIndex(st,e)+me.tickCount(e)),n<et&&(n=me.getArrayStartIndex(et,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!me.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/me.tickCount(t)*kn}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let r=await We(e,t.map(s=>({pubkey:s})),{batchRequest:n}),i={};for(let s of r)s.accountInfo!==null&&(i[s.pubkey.toString()]=Zu.decode(s.accountInfo.data));return i}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let r={},i=[];for(let u of t){let c=H.getTickArrayStartIndexByTick(u.tickCurrent,u.tickSpacing),l=H.getInitializedTickArrayInRange(u.tickArrayBitmap,u.exBitmapInfo,u.tickSpacing,c,7);for(let m of l){let{publicKey:d}=he(u.programId,u.id,m);i.push({pubkey:d}),r[d.toString()]=u.id}}let s=await We(e,i,{batchRequest:n}),a={};for(let u of s){if(!u.accountInfo)continue;let c=r[u.pubkey.toString()];if(!c)continue;a[c.toString()]===void 0&&(a[c.toString()]={});let l=Oo.decode(u.accountInfo.data);a[c.toString()][l.startTickIndex]=E(C({},l),{address:u.pubkey})}return a}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:r=!1,updateOwnerRewardAndFee:i=!0}){var a;let s=[];for(let u=0;u<e.length;u++){let c=e[u];c!==null&&(s.find(l=>l.equals(c.state.programId))||s.push(c.state.programId))}if(n){let u=n.tokenAccounts.map(d=>d.accountInfo.mint),c=[];for(let d of u)for(let p of s)c.push(At(p,d).publicKey);let l=await Bt(t,c,{batchRequest:r}),m={};for(let d of l){if(d===null)continue;let p=Fr.decode(d.data),y=p.poolId.toString(),f=e.find(x=>x.state.id.toBase58()===y);if(f===void 0)continue;let b=f.state,g=H._getTickPriceLegacy({poolInfo:b,tick:p.tickLower,baseIn:!0}),w=H._getTickPriceLegacy({poolInfo:b,tick:p.tickUpper,baseIn:!0}),{amountA:A,amountB:k}=le.getAmountsFromLiquidity(b.sqrtPriceX64,g.tickSqrtPriceX64,w.tickSqrtPriceX64,p.liquidity,!1),I=1/(1-Math.sqrt(Math.sqrt(g.price.div(w.price).toNumber())));f.positionAccount=[...(a=f.positionAccount)!=null?a:[],{poolId:p.poolId,nftMint:p.nftMint,priceLower:g.price,priceUpper:w.price,amountA:A,amountB:k,tickLower:p.tickLower,tickUpper:p.tickUpper,liquidity:p.liquidity,feeGrowthInsideLastX64A:p.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:p.feeGrowthInsideLastX64B,tokenFeesOwedA:p.tokenFeesOwedA,tokenFeesOwedB:p.tokenFeesOwedB,rewardInfos:p.rewardInfos.map(x=>E(C({},x),{pendingReward:new Be(0)})),leverage:I,tokenFeeAmountA:new Be(0),tokenFeeAmountB:new Be(0)}];let T=await H.getTickArrayAddressByTick(f.state.programId,p.poolId,p.tickLower,f.state.tickSpacing),S=await H.getTickArrayAddressByTick(f.state.programId,p.poolId,p.tickUpper,f.state.tickSpacing);m[`${f.state.programId.toString()}-${p.poolId.toString()}-${p.tickLower}`]=T,m[`${f.state.programId.toString()}-${p.poolId.toString()}-${p.tickUpper}`]=S}if(i){let d=Object.values(m),p=await Bt(t,d,{batchRequest:r}),y={};for(let f=0;f<d.length;f++){let b=p[f];if(b===null)continue;let g=d[f].toString();y[g]=Oo.decode(b.data)}for(let{state:f,positionAccount:b}of e)if(!!b)for(let g of b){let w=`${f.programId.toString()}-${f.id.toString()}-${g.tickLower}`,A=`${f.programId.toString()}-${f.id.toString()}-${g.tickUpper}`,k=y[m[w].toString()],I=y[m[A].toString()],T=k.ticks[H.getTickOffsetInArray(g.tickLower,f.tickSpacing)],S=I.ticks[H.getTickOffsetInArray(g.tickUpper,f.tickSpacing)],{tokenFeeAmountA:x,tokenFeeAmountB:R}=await No.GetPositionFees(f,g,T,S),B=await No.GetPositionRewards(f,g,T,S);g.tokenFeeAmountA=x.gte(new Be(0))?x:new Be(0),g.tokenFeeAmountB=R.gte(new Be(0))?R:new Be(0);for(let M=0;M<B.length;M++)g.rewardInfos[M].pendingReward=B[M].gte(new Be(0))?B[M]:new Be(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:r,amountIn:i,slippage:s,priceLimit:a=new O(0),catchLiquidityInsufficient:u=!1}){var D;let c,l=n.toBase58()===e.mintA.address,[m,d]=l?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];a.equals(new O(0))?c=l?Pt.add(new Be(1)):ht.sub(new Be(1)):c=ee.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let p=be(i,m,r,!1),{allTrade:y,expectedAmountOut:f,remainingAccounts:b,executionPrice:g,feeAmount:w}=Ce.getOutputAmountAndRemainAccounts(e,t,n,p.amount.sub((D=p.fee)!=null?D:pe),c,u),A=be(f,d,r,!1),k=ee.sqrtPriceX64ToPrice(g,e.mintA.decimals,e.mintB.decimals),I=l?k:new O(1).div(k),T=f.mul(new Be(Math.floor((1-s)*1e10))).div(new Be(1e10)),S=be(T,d,r,!1),x=l?e.currentPrice:new O(1).div(e.currentPrice),R=new O(I).sub(x).abs(),B=x,M=new Me(new O(R).mul(10**15).toFixed(0),new O(B).mul(10**15).toFixed(0));return{allTrade:y,realAmountIn:p,amountOut:A,minAmountOut:S,expirationTime:Kt(p.expirationTime,A.expirationTime),currentPrice:e.currentPrice,executionPrice:I,priceImpact:M,fee:w,remainingAccounts:b,executionPriceX64:g}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:r,slippage:i,epochInfo:s,catchLiquidityInsufficient:a=!1}){let u=r.address===e.mintB.address,[c,l]=u?[e.mintA,e.mintB]:[e.mintB,e.mintA],[m,d]=[new ye(E(C({},c),{mint:c.address,isToken2022:c.programId===ju.toBase58()})),new ye(E(C({},l),{mint:l.address,isToken2022:l.programId===ju.toBase58()}))],{allTrade:p,realAmountIn:y,amountOut:f,minAmountOut:b,expirationTime:g,currentPrice:w,executionPrice:A,priceImpact:k,fee:I,remainingAccounts:T,executionPriceX64:S}=Ce.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new Rt(c.address),amountIn:n,slippage:i,epochInfo:s,catchLiquidityInsufficient:a}),x=E(C({},y),{amount:new fe(m,y.amount),fee:y.fee===void 0?void 0:new fe(m,y.fee)}),R=E(C({},f),{amount:new fe(d,f.amount),fee:f.fee===void 0?void 0:new fe(d,f.fee)}),B=E(C({},b),{amount:new fe(d,b.amount),fee:b.fee===void 0?void 0:new fe(d,b.fee)}),M=new Ue({baseToken:m,denominator:new Be(10).pow(new Be(20+m.decimals)),quoteToken:d,numerator:w.mul(new O(10**(20+d.decimals))).toFixed(0)}),D=new Ue({baseToken:m,denominator:new Be(10).pow(new Be(20+m.decimals)),quoteToken:d,numerator:A.mul(new O(10**(20+d.decimals))).toFixed(0)}),F=new fe(m,I);return{allTrade:p,realAmountIn:x,amountOut:R,minAmountOut:B,expirationTime:g,currentPrice:M,executionPrice:D,priceImpact:k,fee:F,remainingAccounts:T,executionPriceX64:S}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:r,amountOut:i,slippage:s,priceLimit:a=new O(0)}){var B;let u=n.toBase58()===e.mintA.address,c={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},l;a.equals(new O(0))?l=u?ht.sub(new Be(1)):Pt.add(new Be(1)):l=ee.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let m=be(i,c[n.toString()],r,!0),{expectedAmountIn:d,remainingAccounts:p,executionPrice:y,feeAmount:f}=Ce.getInputAmountAndRemainAccounts(e,t,n,m.amount.sub((B=m.fee)!=null?B:pe),l),b=u?e.mintB.address:e.mintA.address,g=be(d,c[b],r,!1),w=ee.sqrtPriceX64ToPrice(y,e.mintA.decimals,e.mintB.decimals),A=u?w:new O(1).div(w),k=d.mul(new Be(Math.floor((1+s)*1e10))).div(new Be(1e10)),I=be(k,c[b],r,!0),T=u?e.currentPrice:new O(1).div(e.currentPrice),S=new O(A).sub(T).abs(),x=T,R=new Me(new O(S).mul(10**15).toFixed(0),new O(x).mul(10**15).toFixed(0));return{amountIn:g,maxAmountIn:I,realAmountOut:m,expirationTime:Kt(g.expirationTime,m.expirationTime),currentPrice:e.currentPrice,executionPrice:A,priceImpact:R,fee:f,remainingAccounts:p}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:r}){var y,f,b;let i=e[t],s=H.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),a=H.getTickPrice({poolInfo:e,tick:r,baseIn:!0}).price.toNumber(),u=Math.max(s,i.priceMin),l=Math.min(a,i.priceMax)-u,m=a-s,d=i.priceMax-i.priceMin,p;return l<=0?p=0:m===l?p=d/l:d===l?p=l/m:p=l/d*(l/m),{feeApr:i.feeApr*p,rewardsApr:[((y=i.rewardApr[0])!=null?y:0)*p,((f=i.rewardApr[1])!=null?f:0)*p,((b=i.rewardApr[2])!=null?b:0)*p],apr:i.apr*p}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:r,liquidity:i,positionTickLowerIndex:s,positionTickUpperIndex:a,chainTime:u}){let c=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],m=r[pt(e.mintA.address).toString()],d=r[pt(e.mintB.address).toString()],p=e.mintA.decimals,y=e.mintB.decimals;if(!l||!m||!d)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let f=ee.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),b=ee.getSqrtPriceX64FromTick(s),g=ee.getSqrtPriceX64FromTick(a),{amountSlippageA:w,amountSlippageB:A}=le.getAmountsFromLiquidityWithSlippage(f,b,g,t,!1,!1,0),{amountSlippageA:k,amountSlippageB:I}=le.getAmountsFromLiquidityWithSlippage(f,b,g,i,!1,!1,0),T=new O(w.toString()).div(new O(10).pow(p)).mul(m.value).add(new O(A.toString()).div(new O(10).pow(y)).mul(d.value)),S=new O(k.toString()).div(new O(10).pow(p)).mul(m.value).add(new O(I.toString()).div(new O(10).pow(y)).mul(d.value)),x=new O(1).div(T.add(S)),B=new O(l.volumeFee).mul(365).div(c).mul(x).mul(100).toNumber(),M=3600*24*365,D=e.rewardDefaultInfos.map(F=>{var q,ot;let Z=F.mint.decimals,G=r[F.mint.address];return u<((q=F.startTime)!=null?q:0)||u>((ot=F.endTime)!=null?ot:0)||!F.perSecond||!G||Z===void 0?0:new O(G.value).mul(new O(F.perSecond).mul(M)).div(new O(10).pow(Z)).mul(x).mul(100).toNumber()});return{feeApr:B,rewardsApr:D,apr:B+D.reduce((F,Z)=>F+Z,0)}}static getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:r,amount:i,slippage:s,add:a,epochInfo:u,amountHasFee:c}){var g,w;let l=ee.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),m=ee.getSqrtPriceX64FromTick(n),d=ee.getSqrtPriceX64FromTick(r),p=a?1-s:1+s,y=be(i,(g=e[t?"mintA":"mintB"].extensions)==null?void 0:g.feeConfig,u,!c),f=new Be(new O(y.amount.sub((w=y.fee)!=null?w:pe).toString()).mul(p).toFixed(0)),b;if(l.lte(m))b=t?le.getLiquidityFromTokenAmountA(m,d,f,!a):new Be(0);else if(l.lte(d)){let A=le.getLiquidityFromTokenAmountA(l,d,f,!a),k=le.getLiquidityFromTokenAmountB(m,l,f);b=t?A:k}else b=t?new Be(0):le.getLiquidityFromTokenAmountB(m,d,f);return Ce.getAmountsFromLiquidity({epochInfo:u,poolInfo:e,tickLower:n,tickUpper:r,liquidity:b,slippage:s,add:a})}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:r,liquidity:i,slippage:s,add:a}){var b,g,w,A;let u=ee.getSqrtPriceX64FromTick(n),c=ee.getSqrtPriceX64FromTick(r),l=a?1+s:1-s,m=le.getAmountsFromLiquidity(ee.priceToSqrtPriceX64(new O(t.price),t.mintA.decimals,t.mintB.decimals),u,c,i,a),[d,p]=[be(m.amountA,(b=t.mintA.extensions)==null?void 0:b.feeConfig,e,!0),be(m.amountB,(g=t.mintB.extensions)==null?void 0:g.feeConfig,e,!0)],[y,f]=[be(m.amountA.muln(l),(w=t.mintA.extensions)==null?void 0:w.feeConfig,e,!0),be(m.amountB.muln(l),(A=t.mintB.extensions)==null?void 0:A.feeConfig,e,!0)];return{liquidity:i,amountA:d,amountB:p,amountSlippageA:y,amountSlippageB:f,expirationTime:Kt(d.expirationTime,p.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let r=t.filter(u=>!n[u.id]).map(u=>new Rt(u.id));(await Bt(e,r)).forEach((u,c)=>{!u||(n[r[c].toBase58()]=In.decode(u.data))});let s=t.map(u=>mt(new Rt(u.programId),new Rt(u.id)).publicKey),a=await Ce.fetchExBitmaps({connection:e,exBitmapAddress:s,batchRequest:!1});return t.reduce((u,c)=>E(C({},u),{[c.id]:E(C({},n[c.id]),{id:new Rt(c.id),version:6,programId:new Rt(c.programId),mintA:c.mintA,mintB:c.mintB,ammConfig:E(C({},c.config),{id:new Rt(c.config.id),fundOwner:""}),currentPrice:new O(c.price),exBitmapInfo:a[mt(new Rt(c.programId),new Rt(c.id)).publicKey.toBase58()],startTime:n[c.id].startTime.toNumber()})}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};function AT({poolInfo:o,tickLower:e,tickUpper:t,amountA:n,amountB:r,slippage:i,add:s,epochInfo:a,amountHasFee:u}){var A,k,I,T;let[c,l,m,d]=e<t?[e,t,n,r]:[t,e,r,n],p=ee.priceToSqrtPriceX64(new O(o.price),o.mintA.decimals,o.mintB.decimals),y=ee.getSqrtPriceX64FromTick(c),f=ee.getSqrtPriceX64FromTick(l),[b,g]=[be(m,(A=o.mintA.extensions)==null?void 0:A.feeConfig,a,!u),be(d,(k=o.mintB.extensions)==null?void 0:k.feeConfig,a,!u)],w=le.getLiquidityFromTokenAmounts(p,y,f,b.amount.sub((I=b.fee)!=null?I:pe),g.amount.sub((T=g.fee)!=null?T:pe));return le.getAmountsOutFromLiquidity({poolInfo:o,tickLower:e,tickUpper:t,liquidity:w,slippage:i,add:s,epochInfo:a,amountAddFee:!u})}var Bs={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};function Hu(o){return E(C({},o),{type:"Concentrated",programId:o.programId.toString(),id:o.id.toString(),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Clmm",price:o.currentPrice.toNumber(),mintAmountA:0,mintAmountB:0,feeRate:o.ammConfig.tradeFeeRate,openTime:o.startTime.toString(),tvl:0,day:Bs,week:Bs,month:Bs,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,config:E(C({},o.ammConfig),{id:o.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]})})}var ne=class{static mulDivRoundingUp(e,t,n){let r=e.mul(t),i=r.div(n);return r.mod(n).eq(pe)||(i=i.add(yt)),i}static mulDivFloor(e,t,n){if(n.eq(pe))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(pe))throw new Error("division by 0");return e.mul(t).add(n.sub(yt)).div(n)}static x64ToDecimal(e,t){return new O(e.toString()).div(O.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new se(e.mul(O.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(Nr).sub(t).mod(Nr)}};function Xe(o,e){return xs(o.mul(e),64,256)}function Np(o,e,t){let n=o.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function xs(o,e,t){let n=o.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var ee=class{static sqrtPriceX64ToPrice(e,t,n){return ne.x64ToDecimal(e).pow(2).mul(O.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return ne.decimalToX64(e.mul(O.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,r){if(!e.gt(pe))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(pe))throw new Error("liquidity must greater than 0");return r?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,r){if(!e.gt(pe))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(pe))throw new Error("liquidity must greater than 0");return r?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,r){if(n.eq(pe))return e;let i=t.shln(Ro);if(r){let s=i,a=i.add(n.mul(e));return a.gte(s)?ne.mulDivCeil(s,e,a):ne.mulDivRoundingUp(s,yt,s.div(e).add(n))}else{let s=n.mul(e);if(!i.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let a=i.sub(s);return ne.mulDivCeil(i,e,a)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,r){let i=n.shln(Ro);if(r)return e.add(i.div(t));{let s=ne.mulDivRoundingUp(i,yt,t);if(!e.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(s)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<et||e>st)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new se("18445821805675395072"):new se("18446744073709551616");return(t&2)!=0&&(n=Xe(n,new se("18444899583751176192"))),(t&4)!=0&&(n=Xe(n,new se("18443055278223355904"))),(t&8)!=0&&(n=Xe(n,new se("18439367220385607680"))),(t&16)!=0&&(n=Xe(n,new se("18431993317065453568"))),(t&32)!=0&&(n=Xe(n,new se("18417254355718170624"))),(t&64)!=0&&(n=Xe(n,new se("18387811781193609216"))),(t&128)!=0&&(n=Xe(n,new se("18329067761203558400"))),(t&256)!=0&&(n=Xe(n,new se("18212142134806163456"))),(t&512)!=0&&(n=Xe(n,new se("17980523815641700352"))),(t&1024)!=0&&(n=Xe(n,new se("17526086738831433728"))),(t&2048)!=0&&(n=Xe(n,new se("16651378430235570176"))),(t&4096)!=0&&(n=Xe(n,new se("15030750278694412288"))),(t&8192)!=0&&(n=Xe(n,new se("12247334978884435968"))),(t&16384)!=0&&(n=Xe(n,new se("8131365268886854656"))),(t&32768)!=0&&(n=Xe(n,new se("3584323654725218816"))),(t&65536)!=0&&(n=Xe(n,new se("696457651848324352"))),(t&131072)!=0&&(n=Xe(n,new se("26294789957507116"))),(t&262144)!=0&&(n=Xe(n,new se("37481735321082"))),e>0&&(n=Uu.div(n)),n}static getTickFromPrice(e,t,n){return ee.getTickFromSqrtPriceX64(ee.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(ht)||e.lt(Pt))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new se(t-64),r=Np(n,32,128),i=new se("8000000000000000","hex"),s=0,a=new se(0),u=t>=64?e.shrn(t-63):e.shln(63-t);for(;i.gt(new se(0))&&s<Gu;){u=u.mul(u);let y=u.shrn(127);u=u.shrn(63+y.toNumber()),a=a.add(i.mul(y)),i=i.shrn(1),s+=1}let c=a.shrn(32),m=r.add(c).mul(new se(Xu)),d=xs(m.sub(new se(zu)),64,128).toNumber(),p=xs(m.add(new se(Qu)),64,128).toNumber();return d==p?d:ee.getSqrtPriceX64FromTick(p).lte(e)?p:d}},Bn=class{static getTickWithPriceAndTickspacing(e,t,n,r){let s=ee.getTickFromSqrtPriceX64(ee.priceToSqrtPriceX64(e,n,r))/t;return s<0?s=Math.floor(s):s=Math.ceil(s),s*t}static roundPriceWithTickspacing(e,t,n,r){let i=Bn.getTickWithPriceAndTickspacing(e,t,n,r),s=ee.getSqrtPriceX64FromTick(i);return ee.sqrtPriceX64ToPrice(s,n,r)}},le=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,r){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(pe))throw new Error("sqrtPriceX64A must greater than 0");let i=n.ushln(Ro),s=t.sub(e);return r?ne.mulDivRoundingUp(ne.mulDivCeil(i,s,t),yt,e):ne.mulDivFloor(i,s,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,r){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(pe))throw new Error("sqrtPriceX64A must greater than 0");return r?ne.mulDivCeil(n,t.sub(e),bt):ne.mulDivFloor(n,t.sub(e),bt)}static getLiquidityFromTokenAmountA(e,t,n,r){e.gt(t)&&([e,t]=[t,e]);let i=n.mul(e).mul(t),s=t.sub(e),a=i.div(s);return r?ne.mulDivRoundingUp(a,yt,Ts):a.shrn(Ro)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),ne.mulDivFloor(n,Ts,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,r,i){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return le.getLiquidityFromTokenAmountA(t,n,r,!1);if(e.lt(n)){let s=le.getLiquidityFromTokenAmountA(e,n,r,!1),a=le.getLiquidityFromTokenAmountB(t,e,i);return s.lt(a)?s:a}else return le.getLiquidityFromTokenAmountB(t,n,i)}static getAmountsFromLiquidity(e,t,n,r,i){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:le.getTokenAmountAFromLiquidity(t,n,r,i),amountB:new se(0)};if(e.lt(n)){let s=le.getTokenAmountAFromLiquidity(e,n,r,i),a=le.getTokenAmountBFromLiquidity(t,e,r,i);return{amountA:s,amountB:a}}else return{amountA:new se(0),amountB:le.getTokenAmountBFromLiquidity(t,n,r,i)}}static getAmountsFromLiquidityWithSlippage(e,t,n,r,i,s,a){let{amountA:u,amountB:c}=le.getAmountsFromLiquidity(e,t,n,r,s),l=i?1+a:1-a,m=new se(new O(u.toString()).mul(l).toFixed(0)),d=new se(new O(c.toString()).mul(l).toFixed(0));return{amountSlippageA:m,amountSlippageB:d}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:r,slippage:i,add:s,epochInfo:a,amountAddFee:u}){var w,A,k,I;let c=ee.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),l=ee.getSqrtPriceX64FromTick(t),m=ee.getSqrtPriceX64FromTick(n),d=s?1+i:1-i,p=le.getAmountsFromLiquidity(c,l,m,r,s),[y,f]=[be(p.amountA,(w=e.mintA.extensions)==null?void 0:w.feeConfig,a,u),be(p.amountB,(A=e.mintB.extensions)==null?void 0:A.feeConfig,a,u)],[b,g]=[be(new se(new O(p.amountA.toString()).mul(d).toFixed(0)),(k=e.mintA.extensions)==null?void 0:k.feeConfig,a,u),be(new se(new O(p.amountB.toString()).mul(d).toFixed(0)),(I=e.mintB.extensions)==null?void 0:I.feeConfig,a,u)];return{liquidity:r,amountA:y,amountB:f,amountSlippageA:b,amountSlippageB:g,expirationTime:Kt(y.expirationTime,f.expirationTime)}}},Tn=class{static swapCompute(e,t,n,r,i,s,a,u,c,l,m,d,p,y,f=!1){if(d.eq(pe))throw new Error("amountSpecified must not be 0");if(y||(y=s?Pt.add(yt):ht.sub(yt)),s){if(y.lt(Pt))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(y.gte(m))throw new Error("sqrtPriceX64 must smaller than current")}else{if(y.gt(ht))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(y.lte(m))throw new Error("sqrtPriceX64 must greater than current")}let b=d.gt(pe),g={amountSpecifiedRemaining:d,amountCalculated:pe,sqrtPriceX64:m,tick:c>p?Math.min(p+me.tickCount(l)-1,c):p,accounts:[],liquidity:u,feeAmount:new se(0)},w=p,A=n[p],k=0,I=!s&&A.startTickIndex===g.tick;for(;!g.amountSpecifiedRemaining.eq(pe)&&!g.sqrtPriceX64.eq(y);){k>10;let T={};T.sqrtPriceStartX64=g.sqrtPriceX64;let S=H.nextInitTick(A,g.tick,l,s,I),x=S||null,R=null;if(!(x!=null&&x.liquidityGross.gtn(0))){let M=Ce.nextInitializedTickArrayStartIndex({tickCurrent:g.tick,tickSpacing:l,tickArrayBitmap:r,exBitmapInfo:i},w,s);if(!M.isExist){if(f)return{allTrade:!1,amountSpecifiedRemaining:g.amountSpecifiedRemaining,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts};throw Error("swapCompute LiquidityInsufficient")}w=M.nextStartIndex;let{publicKey:D}=he(e,t,w);R=D,A=n[w];try{x=H.firstInitializedTick(A,s)}catch{throw Error("not found next tick info")}}T.tickNext=x.tick,T.initialized=x.liquidityGross.gtn(0),p!==w&&R&&(g.accounts.push(R),p=w),T.tickNext<et?T.tickNext=et:T.tickNext>st&&(T.tickNext=st),T.sqrtPriceNextX64=ee.getSqrtPriceX64FromTick(T.tickNext);let B;if(s&&T.sqrtPriceNextX64.lt(y)||!s&&T.sqrtPriceNextX64.gt(y)?B=y:B=T.sqrtPriceNextX64,[g.sqrtPriceX64,T.amountIn,T.amountOut,T.feeAmount]=Tn.swapStepCompute(g.sqrtPriceX64,B,g.liquidity,g.amountSpecifiedRemaining,a),g.feeAmount=g.feeAmount.add(T.feeAmount),b?(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.sub(T.amountIn.add(T.feeAmount)),g.amountCalculated=g.amountCalculated.sub(T.amountOut)):(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.add(T.amountOut),g.amountCalculated=g.amountCalculated.add(T.amountIn.add(T.feeAmount))),g.sqrtPriceX64.eq(T.sqrtPriceNextX64)){if(T.initialized){let M=x.liquidityNet;s&&(M=M.mul(zt)),g.liquidity=le.addDelta(g.liquidity,M)}I=T.tickNext!=g.tick&&!s&&A.startTickIndex===T.tickNext,g.tick=s?T.tickNext-1:T.tickNext}else if(g.sqrtPriceX64!=T.sqrtPriceStartX64){let M=ee.getTickFromSqrtPriceX64(g.sqrtPriceX64);I=M!=g.tick&&!s&&A.startTickIndex===M,g.tick=M}++k}try{let{nextStartIndex:T,isExist:S}=me.nextInitializedTickArray(g.tick,l,s,r,i);S&&p!==T&&(g.accounts.push(he(e,t,T).publicKey),p=T)}catch{}return{allTrade:!0,amountSpecifiedRemaining:pe,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts}}static swapStepCompute(e,t,n,r,i){let s={sqrtPriceX64Next:new se(0),amountIn:new se(0),amountOut:new se(0),feeAmount:new se(0)},a=e.gte(t),u=r.gte(pe);if(u){let l=ne.mulDivFloor(r,_r.sub(new se(i.toString())),_r);s.amountIn=a?le.getTokenAmountAFromLiquidity(t,e,n,!0):le.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(s.amountIn)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=ee.getNextSqrtPriceX64FromInput(e,n,l,a)}else s.amountOut=a?le.getTokenAmountBFromLiquidity(t,e,n,!1):le.getTokenAmountAFromLiquidity(e,t,n,!1),r.mul(zt).gte(s.amountOut)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=ee.getNextSqrtPriceX64FromOutput(e,n,r.mul(zt),a);let c=t.eq(s.sqrtPriceX64Next);return a?(c&&u||(s.amountIn=le.getTokenAmountAFromLiquidity(s.sqrtPriceX64Next,e,n,!0)),c&&!u||(s.amountOut=le.getTokenAmountBFromLiquidity(s.sqrtPriceX64Next,e,n,!1))):(s.amountIn=c&&u?s.amountIn:le.getTokenAmountBFromLiquidity(e,s.sqrtPriceX64Next,n,!0),s.amountOut=c&&!u?s.amountOut:le.getTokenAmountAFromLiquidity(e,s.sqrtPriceX64Next,n,!1)),!u&&s.amountOut.gt(r.mul(zt))&&(s.amountOut=r.mul(zt)),u&&!s.sqrtPriceX64Next.eq(t)?s.feeAmount=r.sub(s.amountIn):s.feeAmount=ne.mulDivCeil(s.amountIn,new se(i),_r.sub(new se(i))),[s.sqrtPriceX64Next,s.amountIn,s.amountOut,s.feeAmount]}};var qe=60,kn=512,H=class{static getTickArrayAddressByTick(e,t,n,r){let i=H.getTickArrayStartIndexByTick(n,r),{publicKey:s}=he(e,t,i);return s}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=H.getTickArrayStartIndexByTick(e,t),r=Math.floor((e-n)/t);if(r<0||r>=qe)throw new Error("tick offset in array overflow");return r}static getTickArrayBitIndex(e,t){let n=me.tickCount(t),r=e/n;return e<0&&e%n!=0?r=Math.ceil(r)-1:r=Math.floor(r),r}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*me.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*qe,r=Math.floor(e/n)+512;return Math.abs(r)}static checkTickArrayIsInitialized(e,t,n){let r=n*qe,i=Math.floor(t/r)+512,s=Math.abs(i);return{isInitialized:e.testn(s),startIndex:(s-512)*r}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*qe:e+t*qe}static mergeTickArrayBitmap(e){let t=new Mp(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,r,i){let s=Math.floor(r/(n*qe));return[...H.searchLowBitFromStart(e,t,s-1,i,n),...H.searchHightBitFromStart(e,t,s,i,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return H.searchHightBitFromStart(e,t,0,kn,n)}static getAllInitializedTickArrayInfo(e,t,n,r,i){let s=[],a=H.getAllInitializedTickArrayStartIndex(n,r,i);for(let u of a){let{publicKey:c}=he(e,t,u);s.push({tickArrayStartIndex:u,tickArrayAddress:c})}return s}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,r,i){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(c=>H.mergeTickArrayBitmap(c)),a=[];for(;n>=-7680;){let c=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[c].testn(l)&&a.push(n),n--,a.length===r)break}let u=me.tickCount(i);return a.map(c=>c*u)}static searchHightBitFromStart(e,t,n,r,i){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(c=>H.mergeTickArrayBitmap(c)),a=[];for(;n<7680;){let c=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[c].testn(l)&&a.push(n),n++,a.length===r)break}let u=me.tickCount(i);return a.map(c=>c*u)}static checkIsOutOfBoundary(e){return e<et||e>st}static nextInitTick(e,t,n,r,i){if(me.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let a=Math.floor((t-e.startTickIndex)/n);if(r)for(;a>=0;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a-1}else for(i||(a=a+1);a<qe;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a+1}return null}static firstInitializedTick(e,t){if(t){let n=qe-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<qe;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let r=ee.getSqrtPriceX64FromTick(t),i=ee.sqrtPriceX64ToPrice(r,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:i,tickSqrtPriceX64:r}:{tick:t,price:new O(1).div(i),tickSqrtPriceX64:r}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let r=n?t:new O(1).div(t),i=Bn.getTickWithPriceAndTickspacing(r,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=ee.getSqrtPriceX64FromTick(i),a=ee.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:i,price:a}:{tick:i,price:new O(1).div(a)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let r=ee.getSqrtPriceX64FromTick(t),i=ee.sqrtPriceX64ToPrice(r,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:i,tickSqrtPriceX64:r}:{tick:t,price:new O(1).div(i),tickSqrtPriceX64:r}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let r=n?t:new O(1).div(t),i=Bn.getTickWithPriceAndTickspacing(r,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=ee.getSqrtPriceX64FromTick(i),a=ee.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:i,price:a}:{tick:i,price:new O(1).div(a)}}};var $u=v([ge(8),W("bump"),qt("index"),K(""),Ye("protocolFeeRate"),Ye("tradeFeeRate"),qt("tickSpacing"),X(h(),8,"")]),vp=v([Ye("blockTimestamp"),Dn("tickCumulative"),X(h(),4)]),Ju=v([ge(8),je("initialized"),h("recentEpoch"),qt("observationIndex"),K("poolId"),X(vp,100,"observations"),X(h(),4)]),_p=v([W("rewardState"),h("openTime"),h("endTime"),h("lastUpdateTime"),J("emissionsPerSecondX64"),h("rewardTotalEmissioned"),h("rewardClaimed"),K("tokenMint"),K("tokenVault"),K("creator"),J("rewardGrowthGlobalX64")]),In=v([ge(8),W("bump"),K("ammConfig"),K("creator"),K("mintA"),K("mintB"),K("vaultA"),K("vaultB"),K("observationId"),W("mintDecimalsA"),W("mintDecimalsB"),qt("tickSpacing"),J("liquidity"),J("sqrtPriceX64"),Qe("tickCurrent"),Ye(),J("feeGrowthGlobalX64A"),J("feeGrowthGlobalX64B"),h("protocolFeesTokenA"),h("protocolFeesTokenB"),J("swapInAmountTokenA"),J("swapOutAmountTokenB"),J("swapInAmountTokenB"),J("swapOutAmountTokenA"),W("status"),X(W(),7,""),X(_p,3,"rewardInfos"),X(h(),16,"tickArrayBitmap"),h("totalFeesTokenA"),h("totalFeesClaimedTokenA"),h("totalFeesTokenB"),h("totalFeesClaimedTokenB"),h("fundFeesTokenA"),h("fundFeesTokenB"),h("startTime"),X(h(),15*4-3,"padding")]),Fp=v([J("growthInsideLastX64"),h("rewardAmountOwed")]),Fr=v([ge(8),W("bump"),K("nftMint"),K("poolId"),Qe("tickLower"),Qe("tickUpper"),J("liquidity"),J("feeGrowthInsideLastX64A"),J("feeGrowthInsideLastX64B"),h("tokenFeesOwedA"),h("tokenFeesOwedB"),X(Fp,3,"rewardInfos"),X(h(),8,"")]),qT=v([ge(8),W("bump"),K("poolId"),Qe("tickLowerIndex"),Qe("tickUpperIndex"),J("liquidity"),J("feeGrowthInsideLastX64A"),J("feeGrowthInsideLastX64B"),h("tokenFeesOwedA"),h("tokenFeesOwedB"),X(J(),3,"rewardGrowthInside"),X(h(),8,"")]),Vp=v([Qe("tick"),$a("liquidityNet"),J("liquidityGross"),J("feeGrowthOutsideX64A"),J("feeGrowthOutsideX64B"),X(J(),3,"rewardGrowthsOutsideX64"),X(Ye(),13,"")]),Oo=v([ge(8),K("poolId"),Qe("startTickIndex"),X(Vp,qe,"ticks"),W("initializedTickCount"),X(W(),115,"")]),ec=v([ge(329),X(K(),100,"whitelistMints")]),Zu=v([ge(8),K("poolId"),X(X(h(),8),Is,"positiveTickArrayBitmap"),X(X(h(),8),Is,"negativeTickArrayBitmap")]);Ju.span;var oc=ce("Raydium_Clmm"),Lt={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},Se=class{static createPoolInstruction(e,t,n,r,i,s,a,u,c,l,m,d,p,y){let f=v([J("sqrtPriceX64"),h("startTime")]),b=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:Mo.programId,isSigner:!1,isWritable:!1},{pubkey:ut,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);f.encode({sqrtPriceX64:p,startTime:y},g);let w=Buffer.from([...Lt.createPool,...g]);return new Ot({keys:b,programId:e,data:w})}static async createPoolInstructions(e){let{programId:t,owner:n,mintA:r,mintB:i,ammConfigId:s,initialPriceX64:a,startTime:u}=e,[c,l]=[new U(r.address),new U(i.address)],{publicKey:m}=Du(t,s,c,l),{publicKey:d}=qu(t,m),{publicKey:p}=ks(t,m,c),{publicKey:y}=ks(t,m,l),f=[this.createPoolInstruction(t,m,n,s,d,c,p,new U(r.programId||He),l,y,new U(i.programId||He),mt(t,m).publicKey,a,u)];return{signers:[],instructions:f,instructionTypes:[V.CreateAccount,V.ClmmCreatePool],address:{poolId:m,observationId:d,mintAVault:p,mintBVault:y},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,r,i,s,a,u,c,l,m,d,p,y,f,b,g,w,A,k,I,T,S,x,R,B){let M=v([Qe("tickLowerIndex"),Qe("tickUpperIndex"),Qe("tickArrayLowerStartIndex"),Qe("tickArrayUpperStartIndex"),J("liquidity"),h("amountMaxA"),h("amountMaxB"),je("withMetadata"),W("optionBaseFlag"),je("baseFlag")]),D=[...B?[{pubkey:B,isSigner:!1,isWritable:!0}]:[]],F=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:ut,isSigner:!1,isWritable:!1},{pubkey:Mo.programId,isSigner:!1,isWritable:!1},{pubkey:He,isSigner:!1,isWritable:!1},{pubkey:tc,isSigner:!1,isWritable:!1},{pubkey:vn,isSigner:!1,isWritable:!1},{pubkey:ln,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...D],Z=Buffer.alloc(M.span);M.encode({tickLowerIndex:w,tickUpperIndex:A,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:I,liquidity:T,amountMaxA:S,amountMaxB:x,withMetadata:R==="create",baseFlag:!1,optionBaseFlag:0},Z);let G=Buffer.from([...Lt.openPosition,...Z]);return new Ot({keys:F,programId:e,data:G})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:r,tickUpper:i,liquidity:s,amountMaxA:a,amountMaxB:u,withMetadata:c,getEphemeralSigners:l}){let m=[],[d,p]=[new U(e.programId),new U(e.id)],y;if(l)y=new U((await l(1))[0]);else{let x=Ss.generate();m.push(x),y=x.publicKey}let f=H.getTickArrayStartIndexByTick(r,e.config.tickSpacing),b=H.getTickArrayStartIndexByTick(i,e.config.tickSpacing),{publicKey:g}=he(d,p,f),{publicKey:w}=he(d,p,b),{publicKey:A}=we(n.wallet,y,He),{publicKey:k}=Lr(y),{publicKey:I}=At(d,y),{publicKey:T}=hn(d,p,r,i),S=this.openPositionFromLiquidityInstruction(d,n.feePayer,p,n.wallet,y,A,k,T,g,w,I,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),r,i,f,b,s,a,u,c);return{signers:m,instructions:[S],instructionTypes:[V.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:y,tickArrayLower:g,tickArrayUpper:w,positionNftAccount:A,metadataAccount:k,personalPosition:I,protocolPosition:T}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:r,tickUpper:i,base:s,baseAmount:a,otherAmountMax:u,withMetadata:c,getEphemeralSigners:l}){let m=[],[d,p]=[new U(e.programId),new U(e.id)],y;if(l)y=new U((await l(1))[0]);else{let x=Ss.generate();m.push(x),y=x.publicKey}let f=H.getTickArrayStartIndexByTick(r,e.config.tickSpacing),b=H.getTickArrayStartIndexByTick(i,e.config.tickSpacing),{publicKey:g}=he(d,p,f),{publicKey:w}=he(d,p,b),{publicKey:A}=we(n.wallet,y,He),{publicKey:k}=Lr(y),{publicKey:I}=At(d,y),{publicKey:T}=hn(d,p,r,i),S=this.openPositionFromBaseInstruction(d,n.feePayer,p,n.wallet,y,A,k,T,g,w,I,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),r,i,f,b,c,s,a,u,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[f,b])?mt(d,p).publicKey:void 0);return{address:{nftMint:y,tickArrayLower:g,tickArrayUpper:w,positionNftAccount:A,metadataAccount:k,personalPosition:I,protocolPosition:T},instructions:[S],signers:m,instructionTypes:[V.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,r,i,s,a,u,c,l,m,d,p,y,f,b,g,w,A,k,I,T,S,x,R,B){let M=v([Qe("tickLowerIndex"),Qe("tickUpperIndex"),Qe("tickArrayLowerStartIndex"),Qe("tickArrayUpperStartIndex"),J("liquidity"),h("amountMaxA"),h("amountMaxB"),je("withMetadata"),W("optionBaseFlag"),je("baseFlag")]),D=[...B?[{pubkey:B,isSigner:!1,isWritable:!0}]:[]],F=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:ut,isSigner:!1,isWritable:!1},{pubkey:Mo.programId,isSigner:!1,isWritable:!1},{pubkey:He,isSigner:!1,isWritable:!1},{pubkey:tc,isSigner:!1,isWritable:!1},{pubkey:vn,isSigner:!1,isWritable:!1},{pubkey:ln,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...D],Z=Buffer.alloc(M.span);M.encode({tickLowerIndex:w,tickUpperIndex:A,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:I,liquidity:new nc(0),amountMaxA:S==="MintA"?x:R,amountMaxB:S==="MintA"?R:x,withMetadata:T==="create",baseFlag:S==="MintA",optionBaseFlag:1},Z);let G=Buffer.from([...Lt.openPosition,...Z]);return new Ot({keys:F,programId:e,data:G})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:r,tickUpper:i,liquidity:s,amountMaxA:a,amountMaxB:u,withMetadata:c,getEphemeralSigners:l}){let m,d=[];if(l)m=new U((await l(1))[0]);else{let x=Ss.generate();d.push(x),m=x.publicKey}let[p,y]=[new U(e.programId),new U(e.id)],f=H.getTickArrayStartIndexByTick(r,e.config.tickSpacing),b=H.getTickArrayStartIndexByTick(i,e.config.tickSpacing),{publicKey:g}=he(p,y,f),{publicKey:w}=he(p,y,b),{publicKey:A}=we(n.wallet,m,He),{publicKey:k}=Lr(m),{publicKey:I}=At(p,m),{publicKey:T}=hn(p,y,r,i),S=this.openPositionFromLiquidityInstruction(p,n.wallet,y,n.wallet,m,A,k,T,g,w,I,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(t.mintA.address),new U(t.mintB.address),r,i,f,b,s,a,u,c,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[f,b])?mt(p,y).publicKey:void 0);return{address:{nftMint:m,tickArrayLower:g,tickArrayUpper:w,positionNftAccount:A,metadataAccount:k,personalPosition:I,protocolPosition:T},instructions:[S],signers:d,instructionTypes:[V.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,r,i){let s=v([]),a=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:Mo.programId,isSigner:!1,isWritable:!1},{pubkey:He,isSigner:!1,isWritable:!1}],u=Buffer.alloc(s.span);s.encode({},u);let c=Buffer.from([...Lt.closePosition,...u]);return new Ot({keys:a,programId:e,data:c})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:r}){let i=new U(e.programId),{publicKey:s}=we(n.wallet,r.nftMint,He),{publicKey:a}=At(i,r.nftMint),u=[];return u.push(this.closePositionInstruction(i,n.wallet,r.nftMint,s,a)),{address:{positionNftAccount:s,personalPosition:a},signers:[],instructions:u,instructionTypes:[V.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,r,i,s,a,u,c,l,m,d,p,y,f,b,g,w){let A=v([J("liquidity"),h("amountMaxA"),h("amountMaxB"),W("optionBaseFlag"),je("baseFlag")]),k=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[]],I=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:He,isSigner:!1,isWritable:!1},{pubkey:ln,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...k],T=Buffer.alloc(A.span);A.encode({liquidity:f,amountMaxA:b,amountMaxB:g,optionBaseFlag:0,baseFlag:!1},T);let S=Buffer.from([...Lt.increaseLiquidity,...T]);return new Ot({keys:I,programId:e,data:S})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:r,liquidity:i,amountMaxA:s,amountMaxB:a}){let[u,c]=[new U(e.programId),new U(e.id)],l=H.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=H.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:d}=he(u,c,l),{publicKey:p}=he(u,c,m),{publicKey:y}=we(r.wallet,n.nftMint,He),{publicKey:f}=At(u,n.nftMint),{publicKey:b}=hn(u,c,n.tickLower,n.tickUpper),g=this.increasePositionFromLiquidityInstruction(u,r.wallet,y,f,c,b,d,p,r.tokenAccountA,r.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),i,s,a,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[l,m])?mt(u,c).publicKey:void 0);return{address:{tickArrayLower:d,tickArrayUpper:p,positionNftAccount:y,personalPosition:f,protocolPosition:b},signers:[],instructions:[g],instructionTypes:[V.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:r,base:i,baseAmount:s,otherAmountMax:a}){let[u,c]=[new U(e.programId),new U(e.id)],l=H.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=H.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:d}=he(u,c,l),{publicKey:p}=he(u,c,m),{publicKey:y}=we(r.wallet,n.nftMint,He),{publicKey:f}=At(u,n.nftMint),{publicKey:b}=hn(u,c,n.tickLower,n.tickUpper);return{address:{tickArrayLower:d,tickArrayUpper:p,positionNftAccount:y,personalPosition:f,protocolPosition:b},instructions:[this.increasePositionFromBaseInstruction(u,r.wallet,y,f,c,b,d,p,r.tokenAccountA,r.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),i,s,a,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[l,m])?mt(u,c).publicKey:void 0)],signers:[],instructionTypes:[V.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,r,i,s,a,u,c,l,m,d,p,y,f,b,g,w){let A=v([J("liquidity"),h("amountMaxA"),h("amountMaxB"),W("optionBaseFlag"),je("baseFlag")]),k=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[]],I=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:He,isSigner:!1,isWritable:!1},{pubkey:ln,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...k],T=Buffer.alloc(A.span);A.encode({liquidity:new nc(0),amountMaxA:f==="MintA"?b:g,amountMaxB:f==="MintA"?g:b,baseFlag:f==="MintA",optionBaseFlag:1},T);let S=Buffer.from([...Lt.increaseLiquidity,...T]);return new Ot({keys:I,programId:e,data:S})}static decreaseLiquidityInstruction(e,t,n,r,i,s,a,u,c,l,m,d,p,y,f,b,g,w,A){let k=v([J("liquidity"),h("amountMinA"),h("amountMinB")]),I=[...A?[{pubkey:A,isSigner:!1,isWritable:!0}]:[],...f.map(R=>[{pubkey:R.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:R.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:R.rewardMint,isSigner:!1,isWritable:!1}]).flat()],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:He,isSigner:!1,isWritable:!1},{pubkey:ln,isSigner:!1,isWritable:!1},{pubkey:or,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...I],S=Buffer.alloc(k.span);k.encode({liquidity:b,amountMinA:g,amountMinB:w},S);let x=Buffer.from([...Lt.decreaseLiquidity,...S]);return new Ot({keys:T,programId:e,data:x})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:r,liquidity:i,amountMinA:s,amountMinB:a,programId:u}){let[c,l]=[new U(e.programId),new U(e.id)],m=H.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=H.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=he(c,l,m),{publicKey:y}=he(c,l,d),{publicKey:f}=we(r.wallet,n.nftMint,u),{publicKey:b}=At(c,n.nftMint),{publicKey:g}=hn(c,l,n.tickLower,n.tickUpper),w=[];for(let k=0;k<e.rewardDefaultInfos.length;k++)w.push({poolRewardVault:new U(t.rewardInfos[k].vault),ownerRewardVault:r.rewardAccounts[k],rewardMint:new U(e.rewardDefaultInfos[k].mint.address)});let A=[];return A.push(this.decreaseLiquidityInstruction(c,r.wallet,f,b,l,g,p,y,r.tokenAccountA,r.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),w,i,s,a,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,d])?mt(c,l).publicKey:void 0)),{address:{tickArrayLower:p,tickArrayUpper:y,positionNftAccount:f,personalPosition:b,protocolPosition:g},signers:[],instructions:A,instructionTypes:[V.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,r,i,s,a,u,c,l,m,d,p,y,f,b,g){let w=v([h("amount"),h("otherAmountThreshold"),J("sqrtPriceLimitX64"),je("isBaseInput")]),A=[...g?[{pubkey:g,isSigner:!1,isWritable:!0}]:[],...m.map(S=>({pubkey:S,isSigner:!1,isWritable:!0}))],k=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:He,isSigner:!1,isWritable:!1},{pubkey:ln,isSigner:!1,isWritable:!1},{pubkey:or,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},...A],I=Buffer.alloc(w.span);w.encode({amount:p,otherAmountThreshold:y,sqrtPriceLimitX64:f,isBaseInput:b},I);let T=Buffer.from([...Lt.swap,...I]);return new Ot({keys:k,programId:e,data:T})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:r,inputMint:i,amountIn:s,amountOutMin:a,sqrtPriceLimitX64:u,remainingAccounts:c}){let[l,m]=[new U(e.programId),new U(e.id)],[d,p]=[new U(t.vault.A),new U(t.vault.B)],[y,f]=[new U(e.mintA.address),new U(e.mintB.address)],b=e.mintA.address===i.toString(),g=[this.swapInstruction(l,r.wallet,m,new U(e.config.id),b?r.tokenAccountA:r.tokenAccountB,b?r.tokenAccountB:r.tokenAccountA,b?d:p,b?p:d,b?y:f,b?f:y,c,n,s,a,u,!0,mt(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[V.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static makeSwapBaseOutInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:r,outputMint:i,amountOut:s,amountInMax:a,sqrtPriceLimitX64:u,remainingAccounts:c}){let[l,m]=[new U(e.programId),new U(e.id)],[d,p]=[new U(t.vault.A),new U(t.vault.B)],[y,f]=[new U(e.mintA.address),new U(e.mintB.address)],b=e.mintA.address===i.toBase58(),g=[this.swapInstruction(l,r.wallet,m,new U(e.config.id),b?r.tokenAccountB:r.tokenAccountA,b?r.tokenAccountA:r.tokenAccountB,b?p:d,b?d:p,b?f:y,b?y:f,c,n,s,a,u,!1,mt(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[V.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,r,i,s,a,u,c,l,m,d){let p=v([h("openTime"),h("endTime"),J("emissionsPerSecondX64")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:Mo.programId,isSigner:!1,isWritable:!1},{pubkey:ut,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({openTime:Y(l),endTime:Y(m),emissionsPerSecondX64:d},f);let b=Buffer.from([...Lt.initReward,...f]);return new Ot({keys:y,programId:e,data:b})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:r}){let[i,s]=[new U(e.programId),new U(e.id)],a=Wu(i,s,r.mint).publicKey,u=Co(i).publicKey,c=[this.initRewardInstruction(i,n.wallet,s,u,new U(e.config.id),n.tokenAccount,r.programId,r.mint,a,r.openTime,r.endTime,r.emissionsPerSecondX64)];return{address:{poolRewardVault:a,operationId:u},signers:[],instructions:c,instructionTypes:[V.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,r,i,s,a,u,c,l,m,d){let p=v([W("rewardIndex"),J("emissionsPerSecondX64"),h("openTime"),h("endTime")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:He,isSigner:!1,isWritable:!1},{pubkey:ln,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0}],f=Buffer.alloc(p.span);p.encode({rewardIndex:c,emissionsPerSecondX64:d,openTime:Y(l),endTime:Y(m)},f);let b=Buffer.from([...Lt.setRewardEmissions,...f]);return new Ot({keys:y,programId:e,data:b})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:r}){let[i,s]=[new U(e.programId),new U(e.id)],a,u,c;for(let d=0;d<e.rewardDefaultInfos.length;d++)e.rewardDefaultInfos[d].mint.address===r.mint.toString()&&(a=d,u=new U(t.rewardInfos[d].vault),c=new U(t.rewardInfos[d].mint.address));(a===void 0||u===void 0)&&oc.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let l=Co(i).publicKey,m=[this.setRewardInstruction(i,n.wallet,s,l,new U(e.config.id),n.tokenAccount,u,c,a,r.openTime,r.endTime,r.emissionsPerSecondX64)];return{address:{rewardVault:u,operationId:l},signers:[],instructions:m,instructionTypes:[V.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,r,i,s,a){let u=v([W("rewardIndex")]),c=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:He,isSigner:!1,isWritable:!1},{pubkey:ln,isSigner:!1,isWritable:!1},{pubkey:or,isSigner:!1,isWritable:!1}],l=Buffer.alloc(u.span);u.encode({rewardIndex:a},l);let m=Buffer.from([...Lt.collectReward,...l]);return new Ot({keys:c,programId:e,data:m})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:r}){let[i,s]=[new U(e.programId),new U(e.id)],a,u;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===r.toString()&&(a=l,u=new U(t.rewardInfos[l].vault));(a===void 0||u===void 0)&&oc.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let c=[this.collectRewardInstruction(i,n.wallet,s,n.tokenAccount,u,r,a)];return{address:{rewardVault:u},signers:[],instructions:c,instructionTypes:[V.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}};import{PublicKey as qp}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Up}from"@solana/spl-token";import{PublicKey as Dp}from"@solana/web3.js";import rc from"bn.js";var Ks=new rc(25),Vr=new rc(1e4),Ep={4:3,5:3};var Wp=ce("Raydium_liquidity_serum");function ic({programId:o,marketId:e}){let t=[e.toBuffer()],n=0,r;for(;n<100;){try{let i=t.concat(Buffer.from([n]),Buffer.alloc(7));r=Dp.createProgramAddressSync(i,o)}catch(i){if(i instanceof TypeError)throw i;n++;continue}return{publicKey:r,nonce:n}}throw Wp.logWithError("unable to find a viable program address nonce","params",{programId:o,marketId:e}),new Error("unable to find a viable program address nonce")}import vo from"bn.js";function Er({programId:o}){let{publicKey:e}=ue([Buffer.from("amm_config_account_seed","utf-8")],o);return e}function xn({name:o,programId:e,marketId:t}){let{publicKey:n}=ue([e.toBuffer(),t.toBuffer(),Buffer.from(o,"utf-8")],e);return n}function Gp({programId:o,marketId:e}){let{publicKey:t}=ue([o.toBuffer(),e.toBuffer(),Buffer.from("open_order_associated_seed","utf-8")],o);return t}function Os({programId:o}){return ue([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],o)}function sc({version:o,marketVersion:e,marketId:t,baseMint:n,quoteMint:r,baseDecimals:i,quoteDecimals:s,programId:a,marketProgramId:u}){let c=xn({name:"amm_associated_seed",programId:a,marketId:t}),l=xn({name:"lp_mint_associated_seed",programId:a,marketId:t}),{publicKey:m,nonce:d}=Os({programId:a}),p=xn({name:"coin_vault_associated_seed",programId:a,marketId:t}),y=xn({name:"pc_vault_associated_seed",programId:a,marketId:t}),f=xn({name:"temp_lp_token_associated_seed",programId:a,marketId:t}),b=Gp({programId:a,marketId:t}),g=xn({name:"target_associated_seed",programId:a,marketId:t}),w=xn({name:"withdraw_associated_seed",programId:a,marketId:t}),{publicKey:A}=ic({programId:u,marketId:t});return{id:c,baseMint:n,quoteMint:r,lpMint:l,baseDecimals:i,quoteDecimals:s,lpDecimals:i,version:o,programId:a,authority:m,nonce:d,baseVault:p,quoteVault:y,lpVault:f,openOrders:b,targetOrders:g,withdrawQueue:w,marketVersion:e,marketProgramId:u,marketId:t,marketAuthority:A,lookupTableAccount:qp.default,configId:Er({programId:a})}}var Cs;async function wI({connection:o,poolKeysList:e,config:t}){Cs||(Cs=new Gn({connection:o}),await Cs.initStableModelLayout());let n=e.map(s=>vu({poolKeys:s}));return(await Ka(o,n.map(s=>s.instruction),"GetPoolData")).map(s=>{let a=Ca(s,"GetPoolData"),u=new vo(Wt(a,"status")),c=Number(Wt(a,"coin_decimals")),l=Number(Wt(a,"pc_decimals")),m=Number(Wt(a,"lp_decimals")),d=new vo(Wt(a,"pool_coin_amount")),p=new vo(Wt(a,"pool_pc_amount")),y=new vo(Wt(a,"pool_lp_supply")),f="0";try{f=Wt(a,"pool_open_time")}catch{}return{status:u,baseDecimals:c,quoteDecimals:l,lpDecimals:m,baseReserve:d,quoteReserve:p,lpSupply:y,startTime:new vo(f)}})}var Rs={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]},Dr=o=>{let e={},t=Up.toBase58();return Object.keys(o).map(n=>{let r=o[n],[i,s]=[r.baseMint.toBase58(),r.quoteMint.toBase58()];e[n]={id:n,version:4,status:r.status.toNumber(),programId:r.programId.toBase58(),mintA:it({address:i,programId:t,decimals:r.baseDecimal.toNumber()}),mintB:it({address:s,programId:t,decimals:r.quoteDecimal.toNumber()}),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:r.poolPrice.toNumber(),mintAmountA:new O(r.mintAAmount.toString()).div(10**r.baseDecimal.toNumber()).toNumber(),mintAmountB:new O(r.mintBAmount.toString()).div(10**r.quoteDecimal.toNumber()).toNumber(),baseReserve:r.baseReserve,quoteReserve:r.quoteReserve,feeRate:new O(r.tradeFeeNumerator.toString()).div(r.tradeFeeDenominator.toString()).toNumber(),openTime:r.poolOpenTime.toString(),tvl:0,day:Rs,week:Rs,month:Rs,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,type:"Standard",marketId:r.marketId.toBase58(),configId:Er({programId:r.programId}).toBase58(),lpPrice:0,lpAmount:0,lpMint:it({address:r.lpMint.toBase58(),programId:t,decimals:Math.min(r.baseDecimal.toNumber(),r.quoteDecimal.toNumber())})}}),e};import Ze from"bn.js";var _o=class extends Ke{constructor(t){super(t);this.stableLayout=new Gn({connection:this.scope.connection})}async initLayout(){await this.stableLayout.initStableModelLayout()}async load(){this.checkDisabled()}computePairAmount({poolInfo:t,amount:n,slippage:r,baseIn:i}){let s=new Ze(new O(n).mul(10**t[i?"mintA":"mintB"].decimals).toFixed(0)),a=Cr(t[i?"mintB":"mintA"]),[u,c]=[new Ze(new O(t.mintAmountA).mul(10**t.mintA.decimals).toString()),new Ze(new O(t.mintAmountB).mul(10**t.mintB.decimals).toString())],l=new Ze(new O(t.lpAmount).mul(10**t.lpMint.decimals).toFixed(0,O.ROUND_DOWN));this.logDebug("baseReserve:",u.toString(),"quoteReserve:",c.toString()),this.logDebug("tokenIn:",i?t.mintA.symbol:t.mintB.symbol,"amountIn:",s.toString(),"anotherToken:",i?t.mintB.symbol:t.mintA.symbol,"slippage:",`${r.toSignificant()}%`,"baseReserve",u.toString(),"quoteReserve",c.toString());let m=i?"base":"quote";this.logDebug("input side:",m);let d=De;s.isZero()||(d=m==="base"?cr(s.mul(c),u):cr(s.mul(u),c)),this.logDebug("amountRaw:",d.toString(),"lpAmount:",l.toString());let p=cr(s.mul(l),m==="base"?u:c);this.logDebug("liquidity:",p.toString());let f=new Me(new Ze(1)).add(r).mul(d).quotient,b=new fe(a,d),g=new fe(a,f);return this.logDebug("anotherAmount:",b.toFixed(),"maxAnotherAmount:",g.toFixed()),{anotherAmount:b,maxAnotherAmount:g,liquidity:p}}async getAmmPoolKeys(t){return(await this.scope.api.fetchPoolKeysById({idList:[t]}))[0]}async addLiquidity(t){let{poolInfo:n,poolKeys:r,amountInA:i,amountInB:s,fixedSide:a,config:u,txVersion:c,computeBudgetConfig:l}=t;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),this.logDebug("amountInA:",i,"amountInB:",s),(i.isZero()||s.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:i.toFixed(),amountInB:s.toFixed()});let{account:m}=this.scope,{bypassAssociatedCheck:d,checkCreateATAOwner:p}=C({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},u),[y,f]=[i.token,s.token],b=await m.getCreatedTokenAccount({mint:y.mint,associatedOnly:!1}),g=await m.getCreatedTokenAccount({mint:f.mint,associatedOnly:!1});!b&&!g&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",m.tokenAccounts);let w=await m.getCreatedTokenAccount({mint:new tt(n.lpMint.address)}),A=[y,f],k=[b,g],I=[i.raw,s.raw],T=i.token.mint.toBase58()===n.mintA.address?"base":"quote",S="base";["quote","base"].includes(T)||this.logAndCreateError("invalid fixedSide","fixedSide",a),T==="quote"?(A.reverse(),k.reverse(),I.reverse(),S=a==="a"?"quote":"base"):T==="base"&&(S=a==="a"?"base":"quote");let[x,R]=A,[B,M]=k,[D,F]=I,Z=r!=null?r:await this.getAmmPoolKeys(n.id),G=this.createTxBuilder(),Vt=await m.handleTokenAccount({side:"in",amount:D,mint:x.mint,tokenAccount:B,bypassAssociatedCheck:d,checkCreateATAOwner:p}),{tokenAccount:q}=Vt,ot=Oe(Vt,["tokenAccount"]);G.addInstruction(ot);let Ln=await m.handleTokenAccount({side:"in",amount:F,mint:R.mint,tokenAccount:M,bypassAssociatedCheck:d,checkCreateATAOwner:p}),{tokenAccount:Rn}=Ln,mn=Oe(Ln,["tokenAccount"]);G.addInstruction(mn);let Yo=await m.handleTokenAccount({side:"out",amount:0,mint:new tt(n.lpMint.address),tokenAccount:w,bypassAssociatedCheck:d,checkCreateATAOwner:p}),{tokenAccount:Ht}=Yo,On=Oe(Yo,["tokenAccount"]);return G.addInstruction(On),G.addInstruction({instructions:[Nu({poolInfo:n,poolKeys:Z,userKeys:{baseTokenAccount:q,quoteTokenAccount:Rn,lpTokenAccount:Ht,owner:this.scope.ownerPubKey},baseAmountIn:D,quoteAmountIn:F,fixedSide:S})],instructionTypes:[n.pooltype.includes("StablePool")?V.AmmV5AddLiquidity:V.AmmV4AddLiquidity],lookupTableAddress:Z.lookupTableAccount?[Z.lookupTableAccount]:[]}),G.addCustomComputeBudget(l),c===0&&await G.buildV0(),G.build()}async removeLiquidity(t){this.scope.availability.removeStandardPosition===!1&&this.logAndCreateError("remove liquidity feature disabled in your region");let{poolInfo:n,poolKeys:r,amountIn:i,config:s,txVersion:a,computeBudgetConfig:u}=t,c=r!=null?r:await this.getAmmPoolKeys(n.id),[l,m,d]=[new tt(n.mintA.address),new tt(n.mintB.address),new tt(n.lpMint.address)];this.logDebug("amountIn:",i),i.isZero()&&this.logAndCreateError("amount must greater than zero","amountIn",i.toString());let{account:p}=this.scope,y=await p.getCreatedTokenAccount({mint:d,associatedOnly:!1});y||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",p.tokenAccounts);let f=await p.getCreatedTokenAccount({mint:l}),b=await p.getCreatedTokenAccount({mint:m}),g=this.createTxBuilder(),{bypassAssociatedCheck:w,checkCreateATAOwner:A}=C({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},s),x=await p.handleTokenAccount({side:"out",amount:0,mint:l,tokenAccount:f,bypassAssociatedCheck:w,checkCreateATAOwner:A}),{tokenAccount:k}=x,I=Oe(x,["tokenAccount"]);g.addInstruction(I);let R=await p.handleTokenAccount({side:"out",amount:0,mint:m,tokenAccount:b,bypassAssociatedCheck:w,checkCreateATAOwner:A}),{tokenAccount:T}=R,S=Oe(R,["tokenAccount"]);return g.addInstruction(S),g.addInstruction({instructions:[ws({poolInfo:n,poolKeys:c,userKeys:{lpTokenAccount:y,baseTokenAccount:k,quoteTokenAccount:T,owner:this.scope.ownerPubKey},amountIn:i})],lookupTableAddress:c.lookupTableAccount?[c.lookupTableAccount]:[],instructionTypes:[n.pooltype.includes("StablePool")?V.AmmV5RemoveLiquidity:V.AmmV4RemoveLiquidity]}),g.addCustomComputeBudget(u),a===0?await g.buildV0():g.build()}async removeAllLpAndCreateClmmPosition({poolInfo:t,clmmPoolInfo:n,removeLpAmount:r,createPositionInfo:i,farmInfo:s,userFarmLpAmount:a,base:u,computeBudgetConfig:c,payer:l,userAuxiliaryLedgers:m,tokenProgram:d=Qn,checkCreateATAOwner:p=!0,getEphemeralSigners:y,txVersion:f}){if((this.scope.availability.removeStandardPosition===!1||this.scope.availability.createConcentratedPosition===!1)&&this.logAndCreateError("remove liquidity or create position feature disabled in your region"),!(t.mintA.address===n.mintA.address||t.mintA.address===n.mintB.address)||!(t.mintB.address===n.mintA.address||t.mintB.address===n.mintB.address))throw Error("mint check error");let b=this.createTxBuilder();b.addCustomComputeBudget(c);let g={};for(let q of this.scope.account.tokenAccountRawInfos)(g[q.accountInfo.mint.toString()]===void 0||we(this.scope.ownerPubKey,q.accountInfo.mint,Qn).publicKey.equals(q.pubkey))&&(g[q.accountInfo.mint.toString()]=q.pubkey);let w=g[t.lpMint.address];if(w===void 0)throw Error("find lp account error in trade accounts");let A=r.add(a!=null?a:new Ze(0)),k=t.mintA.address===ye.WSOL.mint.toString(),I=t.mintB.address===ye.WSOL.mint.toString(),{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Qn,mint:new tt(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:k?{payer:this.scope.ownerPubKey}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:!0,checkCreateATAOwner:p});if(b.addInstruction(S||{}),T===void 0)throw new Error("base token account not found");let{account:x,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Qn,mint:new tt(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:I?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:!0,checkCreateATAOwner:p});if(b.addInstruction(R||{}),x===void 0)throw new Error("quote token account not found");if(g[t.mintA.address]=T,g[t.mintB.address]=x,s!==void 0&&!(a!=null&&a.isZero())){let q=gt[s.programId],ot=Je({programId:new tt(s.programId),poolId:new tt(s.id),owner:this.scope.ownerPubKey,version:q}),Rn,mn=await this.scope.connection.getAccountInfo(ot);if(mn&&(Rn=Un(q).decode(mn.data)),q!==6&&!Rn){let{instruction:Zt,instructionType:ni}=ho({id:new tt(s.id),programId:new tt(s.programId),version:q,ledger:ot,owner:this.scope.ownerPubKey});b.addInstruction({instructions:[Zt],instructionTypes:[ni]})}let Ht=[];for(let Zt of s.rewardInfos){let ni=Zt.mint.address===ye.WSOL.mint.toString();if(g[Zt.mint.address])Ht.push(g[Zt.mint.address]);else{let{account:Qs,instructionParams:Ys}=await this.scope.account.getOrCreateTokenAccount({mint:new tt(Zt.mint.address),tokenProgram:d,owner:this.scope.ownerPubKey,skipCloseAccount:!ni,createInfo:{payer:l||this.scope.ownerPubKey},associatedOnly:!0,checkCreateATAOwner:p});Qs||this.logAndCreateError("farm reward account not found:",Zt.mint.address),Ys&&b.addInstruction(Ys),Ht.push(Qs)}}let On=(await this.scope.api.fetchFarmKeysById({ids:s.id}))[0],Vt={userAuxiliaryLedgers:m,amount:a,owner:this.scope.ownerPubKey,farmInfo:s,farmKeys:On,lpAccount:w,rewardAccounts:Ht},Ln=gt[s.programId],Yo=Ln===6?ko(Vt):Ln===5?To(Vt):Io(Vt),Mc={3:V.FarmV3Withdraw,5:V.FarmV5Withdraw,6:V.FarmV6Withdraw};b.addInstruction({instructions:[Yo],instructionTypes:[Mc[Ln]]})}let B=await this.getAmmPoolKeys(t.id),M=ws({poolInfo:t,poolKeys:B,userKeys:{lpTokenAccount:w,baseTokenAccount:T,quoteTokenAccount:x,owner:this.scope.ownerPubKey},amountIn:A});b.addInstruction({instructions:[M],instructionTypes:[t.pooltype.includes("StablePool")?V.AmmV5RemoveLiquidity:V.AmmV4RemoveLiquidity],lookupTableAddress:B.lookupTableAccount?[B.lookupTableAccount]:[]});let[D,F]=t.mintA.address===n.mintA.address?[T,x]:[x,T],Z=await this.scope.clmm.getClmmPoolKeys(t.id),G=await Se.openPositionFromBaseInstructions(E(C({poolInfo:n,poolKeys:Z,ownerInfo:{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:D,tokenAccountB:F},withMetadata:"create"},i),{base:u,getEphemeralSigners:y}));return b.addInstruction({instructions:[...G.instructions],signers:G.signers,instructionTypes:[...G.instructionTypes],lookupTableAddress:Z.lookupTableAccount?[Z.lookupTableAccount]:[]}),f===0?b.sizeCheckBuildV0():b.sizeCheckBuild()}async createPoolV4({programId:t,marketInfo:n,baseMintInfo:r,quoteMintInfo:i,baseAmount:s,quoteAmount:a,startTime:u,ownerInfo:c,associatedOnly:l=!1,checkCreateATAOwner:m=!1,tokenProgram:d,txVersion:p,feeDestinationId:y,computeBudgetConfig:f}){var D;let b=c.feePayer||((D=this.scope.owner)==null?void 0:D.publicKey),g=c.useSOLBalance&&r.mint.equals(ac),w=c.useSOLBalance&&i.mint.equals(ac),A=this.createTxBuilder(),{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({mint:r.mint,owner:this.scope.ownerPubKey,createInfo:g?{payer:b,amount:s}:void 0,notUseTokenAccount:g,skipCloseAccount:!g,associatedOnly:g?!1:l,checkCreateATAOwner:m});A.addInstruction(I||{});let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:i.mint,owner:this.scope.ownerPubKey,createInfo:w?{payer:b,amount:a}:void 0,notUseTokenAccount:w,skipCloseAccount:!w,associatedOnly:w?!1:l,checkCreateATAOwner:m});if(A.addInstruction(S||{}),k===void 0||T===void 0)throw Error("you don't has some token account");let x=sc({version:4,marketVersion:3,marketId:n.marketId,baseMint:r.mint,quoteMint:i.mint,baseDecimals:r.decimals,quoteDecimals:i.decimals,programId:t,marketProgramId:n.programId}),R={programId:t,ammId:x.id,ammAuthority:x.authority,ammOpenOrders:x.openOrders,lpMint:x.lpMint,coinMint:x.baseMint,pcMint:x.quoteMint,coinVault:x.baseVault,pcVault:x.quoteVault,withdrawQueue:x.withdrawQueue,ammTargetOrders:x.targetOrders,poolTempLp:x.lpVault,marketProgramId:x.marketProgramId,marketId:x.marketId,ammConfigId:x.configId,feeDestinationId:y},{instruction:B,instructionType:M}=Mu(E(C({},R),{userWallet:this.scope.ownerPubKey,userCoinVault:k,userPcVault:T,userLpVault:we(this.scope.ownerPubKey,x.lpMint,d).publicKey,nonce:x.nonce,openTime:u,coinAmount:s,pcAmount:a}));return A.addInstruction({instructions:[B],instructionTypes:[M]}),A.addCustomComputeBudget(f),A.versionBuild({txVersion:p,extInfo:{address:R}})}async getCreatePoolFee({programId:t}){let n=Er({programId:t}),r=await this.scope.connection.getAccountInfo(n,{dataSlice:{offset:536,length:8}});if(r===null)throw Error("get config account error");return Bu.decode(r.data).fee}computeAmountOut({poolInfo:t,amountIn:n,mintIn:r,mintOut:i,slippage:s}){let[a,u]=[r.toString(),i.toString()];if(a!==t.mintA.address&&a!==t.mintB.address)throw new Error("toke not match");if(u!==t.mintA.address&&u!==t.mintB.address)throw new Error("toke not match");let{baseReserve:c,quoteReserve:l}=t,m=[c,l],d=[t.mintA.decimals,t.mintB.decimals],p=a==t.mintA.address?"base":"quote";p==="quote"&&(m.reverse(),d.reverse());let[y,f]=m,[b,g]=d,w=t.version===4,A;if(w)A=new O(f.toString()).div(10**g).div(new O(y.toString()).div(10**b));else{let F=Ru(this.stableLayout.stableModelData,c.toNumber(),l.toNumber(),!1);p==="quote"?A=new O(1e6).div(F*1e6):A=new O(F*1e6).div(1e6)}let k=n,I=new Ze(0),T=new Ze(0);if(!k.isZero())if(w){T=St(k.mul(Ks),Vr);let F=k.sub(T),Z=y.add(F);I=f.mul(F).div(Z)}else{T=k.mul(new Ze(2)).div(new Ze(1e4));let F=k.sub(T);p==="quote"?I=new Ze(Ku(this.stableLayout.stableModelData,l.toNumber(),c.toNumber(),F.toNumber())):I=new Ze(Cu(this.stableLayout.stableModelData,l.toNumber(),c.toNumber(),F.toNumber()))}let S=new Ze(new O(I.toString()).mul(1-s).toFixed(0)),x=I,R=S,B=new O(I.toString()).div(new O(k.sub(T).toString()).toFixed(0));!k.isZero()&&!I.isZero()&&(B=new O(I.toString()).div(10**g).div(new O(k.sub(T).toString()).div(10**b)));let M=A.sub(B).div(A).mul(100);return{amountOut:x,minAmountOut:R,currentPrice:A,executionPrice:B,priceImpact:M,fee:T}}computeAmountIn({poolInfo:t,amountOut:n,mintIn:r,mintOut:i,slippage:s}){let{baseReserve:a,quoteReserve:u}=t;r.toString()!==t.mintA.address&&r.toString()!==t.mintB.address&&this.logAndCreateError("mintIn does not match pool"),i.toString()!==t.mintA.address&&i.toString()!==t.mintB.address&&this.logAndCreateError("mintOut does not match pool"),this.logDebug("baseReserve:",a.toString()),this.logDebug("quoteReserve:",u.toString());let c=r.toString()===t.mintA.address,[l,m]=c?[t.mintA,t.mintB]:[t.mintB,t.mintA];this.logDebug("currencyOut:",m.symbol||m.address),this.logDebug("amountOut:",new O(n.toString()).div(10**m.decimals).toDecimalPlaces(m.decimals).toString(),l.symbol||l.address),this.logDebug("slippage:",`${s*100}%`);let d=[a,u],p=c?"quote":"base";p==="base"&&d.reverse(),this.logDebug("output side:",p);let[y,f]=d,b=new O(f.toString()).div(10**t[c?"mintB":"mintA"].decimals).div(new O(y.toString()).div(10**t[c?"mintA":"mintB"].decimals));this.logDebug("currentPrice:",`1 ${l.symbol||l.address} \u2248 ${b.toString()} ${m.symbol||m.address}`),this.logDebug("currentPrice invert:",`1 ${m.symbol||m.address} \u2248 ${new O(1).div(b).toString()} ${l.symbol||l.address}`);let g=new Ze(0),w=n;if(!w.isZero()){w.gt(f)&&(w=f.sub(new Ze(1)));let R=f.sub(w);g=y.mul(w).div(R).mul(Vr).div(Vr.sub(Ks))}let A=new Ze(new O(g.toString()).mul(1+s).toFixed(0)),k=g,I=A;this.logDebug("amountIn:",new O(k.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString()),this.logDebug("maxAmountIn:",new O(I.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString());let T=null;!g.isZero()&&!w.isZero()&&(T=new O(w.toString()).div(10**m.decimals).div(new O(g.toString()).div(10**l.decimals)),this.logDebug("executionPrice:",`1 ${m.symbol||m.address} \u2248 ${T.toDecimalPlaces(Math.max(t.mintA.decimals,t.mintB.decimals)).toString()} ${l.symbol||l.address}`),this.logDebug("executionPrice invert:",`1 ${m.symbol||m.address} \u2248 ${new O(1).div(T).toDecimalPlaces(Math.max(t.mintA.decimals,t.mintB.decimals)).toString()} ${l.symbol||l.address}`));let S=b.mul(k.toString()),x=S.sub(n.toString()).abs().div(S);return this.logDebug("priceImpact:",`${x.toString()}%`),{amountIn:k,maxAmountIn:I,currentPrice:b,executionPrice:T,priceImpact:x}}async swap({poolInfo:t,poolKeys:n,amountIn:r,amountOut:i,inputMint:s,fixedSide:a,txVersion:u,config:c,computeBudgetConfig:l}){let m=this.createTxBuilder(),{associatedOnly:d=!0,inputUseSolBalance:p=!0,outputUseSolBalance:y=!0}=c||{},[f,b]=s===t.mintA.address?[t.mintA,t.mintB]:[t.mintB,t.mintA],g=p&&f.address===j.toBase58(),w=y&&b.address===j.toBase58(),{account:A,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Qn,mint:new tt(f.address),owner:this.scope.ownerPubKey,createInfo:g?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!g,notUseTokenAccount:g,associatedOnly:d});m.addInstruction(k||{}),A||this.logAndCreateError("input token account not found",{token:f.symbol||f.address,tokenAccountIn:A,inputTokenUseSolBalance:g,associatedOnly:d});let{account:I,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Qn,mint:new tt(b.address),owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:w?!1:d});m.addInstruction(T||{}),I===void 0&&this.logAndCreateError("output token account not found",{token:b.symbol||b.address,tokenAccountOut:I,outputTokenUseSolBalance:w,associatedOnly:d});let S=n||await this.getAmmPoolKeys(t.id),x=4;return t.pooltype.includes("StablePool")&&(x=5),m.addInstruction({instructions:[Rr({version:x,poolKeys:S,userKeys:{tokenAccountIn:A,tokenAccountOut:I,owner:this.scope.ownerPubKey},amountIn:r,amountOut:i,fixedSide:a})],instructionTypes:[x===4?V.AmmV4SwapBaseIn:V.AmmV5SwapBaseIn]}),m.addCustomComputeBudget(l),m.versionBuild({txVersion:u})}async getRpcPoolInfo(t){return(await this.getRpcPoolInfos([t]))[t]}async getRpcPoolInfos(t,n){let r=await We(this.scope.connection,t.map(l=>({pubkey:new tt(l)})),n),i={},s=[];for(let l=0;l<t.length;l++){let m=r[l];if(m===null||!m.accountInfo)throw Error("fetch pool info error: "+String(t[l]));let d=So.decode(m.accountInfo.data);i[String(t[l])]=E(C({},d),{programId:m.accountInfo.owner}),s.push(d.baseVault,d.quoteVault)}let a={},u=await We(this.scope.connection,s.map(l=>({pubkey:new tt(l)})),n);for(let l=0;l<s.length;l++){let m=u[l].accountInfo;if(m===null)throw Error("fetch vault info error: "+s[l]);a[String(s[l])]=new Ze(Xp.decode(m.data).amount.toString())}let c={};for(let[l,m]of Object.entries(i)){let d=a[m.baseVault.toString()].sub(m.baseNeedTakePnl),p=a[m.quoteVault.toString()].sub(m.quoteNeedTakePnl);c[l]=E(C({},m),{baseReserve:d,mintAAmount:a[m.baseVault.toString()],mintBAmount:a[m.quoteVault.toString()],quoteReserve:p,poolPrice:new O(p.toString()).div(new O(10).pow(m.quoteDecimal.toString())).div(new O(d.toString()).div(new O(10).pow(m.baseDecimal.toString())))})}return c}async getPoolInfoFromRpc({poolId:t}){let n=await this.getRpcPoolInfo(t),r=Dr({[t]:n}),i=r[t],s=await this.scope.tradeV2.computePoolToPoolKeys({pools:[r[t]],ammRpcData:{[t]:n}});return{poolRpcData:n,poolInfo:i,poolKeys:s[0]}}};import{PublicKey as ie}from"@solana/web3.js";import dt from"bn.js";import{AccountLayout as uc,TOKEN_PROGRAM_ID as cc}from"@solana/spl-token";var Fo=class extends Ke{constructor(e){super(e)}async getClmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async createPool(e){var A;let{programId:t,owner:n=((A=this.scope.owner)==null?void 0:A.publicKey)||ie.default,mint1:r,mint2:i,ammConfig:s,initialPrice:a,startTime:u,computeBudgetConfig:c,forerunCreate:l,getObserveState:m,txVersion:d}=e,p=this.createTxBuilder(),[y,f,b]=new dt(new ie(r.address).toBuffer()).gt(new dt(new ie(i.address).toBuffer()))?[i,r,new O(1).div(a)]:[r,i,a],g=ee.priceToSqrtPriceX64(b,y.decimals,f.decimals),w=await Se.createPoolInstructions({connection:this.scope.connection,programId:t,owner:n,mintA:y,mintB:f,ammConfigId:s.id,initialPriceX64:g,startTime:u,forerunCreate:!m&&l});return p.addInstruction(w),p.addCustomComputeBudget(c),p.versionBuild({txVersion:d,extInfo:{address:E(C({},w.address),{programId:t.toString(),id:w.address.poolId.toString(),mintA:y,mintB:f,openTime:u.toString(),vault:{A:w.address.mintAVault.toString(),B:w.address.mintBVault.toString()},rewardInfos:[],config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}}),mockPoolInfo:C({type:"Concentrated",rewardDefaultPoolInfos:"Clmm",id:w.address.poolId.toString(),mintA:y,mintB:f,feeRate:s.tradeFeeRate,openTime:u.toString(),programId:t.toString(),price:b.toNumber(),config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}},Yu),forerunCreate:l}})}async openPositionFromBase({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:r,tickUpper:i,base:s,baseAmount:a,otherAmountMax:u,associatedOnly:c=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",getEphemeralSigners:d,computeBudgetConfig:p,txVersion:y}){this.scope.availability.addConcentratedPosition===!1&&this.logAndCreateError("add position feature disabled in your region"),this.scope.checkOwner();let f=this.createTxBuilder(),b=null,g=null,w=n.useSOLBalance&&e.mintA.address===j.toString(),A=n.useSOLBalance&&e.mintB.address===j.toString(),[k,I]=s==="MintA"?[a,u]:[u,a],{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new ie(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:w||k.isZero()?{payer:this.scope.ownerPubKey,amount:k}:void 0,skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:w?!1:c,checkCreateATAOwner:l});T&&(b=T),f.addInstruction(S||{});let{account:x,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new ie(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:A||I.isZero()?{payer:this.scope.ownerPubKey,amount:I}:void 0,skipCloseAccount:!A,notUseTokenAccount:A,associatedOnly:A?!1:c,checkCreateATAOwner:l});x&&(g=x),f.addInstruction(R||{}),(!b||!g)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",{ownerTokenAccountA:b==null?void 0:b.toBase58(),ownerTokenAccountB:g==null?void 0:g.toBase58()});let B=t||await this.getClmmPoolKeys(e.id),M=await Se.openPositionFromBaseInstructions({poolInfo:e,poolKeys:B,ownerInfo:E(C({},n),{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g}),tickLower:r,tickUpper:i,base:s,baseAmount:a,otherAmountMax:u,withMetadata:m,getEphemeralSigners:d});return f.addInstruction(M),f.addCustomComputeBudget(p),f.versionBuild({txVersion:y,extInfo:C({},M.address)})}async openPositionFromLiquidity({poolInfo:e,poolKeys:t,ownerInfo:n,amountMaxA:r,amountMaxB:i,tickLower:s,tickUpper:a,liquidity:u,associatedOnly:c=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",txVersion:d,getEphemeralSigners:p}){this.scope.availability.createConcentratedPosition===!1&&this.logAndCreateError("open position feature disabled in your region");let y=this.createTxBuilder(),f=null,b=null,g=n.useSOLBalance&&e.mintA.address===j.toBase58(),w=n.useSOLBalance&&e.mintB.address===j.toBase58(),{account:A,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new ie(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:g||r.isZero()?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!g,notUseTokenAccount:g,associatedOnly:g?!1:c,checkCreateATAOwner:l});A&&(f=A),y.addInstruction(k||{});let{account:I,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new ie(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:w||i.isZero()?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:w?!1:c,checkCreateATAOwner:l});I&&(b=I),y.addInstruction(T||{}),(f===void 0||b===void 0)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let S=t||await this.getClmmPoolKeys(e.id),x=await Se.openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:S,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:b},tickLower:s,tickUpper:a,liquidity:u,amountMaxA:r,amountMaxB:i,withMetadata:m,getEphemeralSigners:p});return y.addInstruction(x),y.versionBuild({txVersion:d,extInfo:{address:x.address}})}async increasePositionFromLiquidity(e){let{poolInfo:t,poolKeys:n,ownerPosition:r,amountMaxA:i,amountMaxB:s,liquidity:a,ownerInfo:u,associatedOnly:c=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txVersion:d}=e,p=this.createTxBuilder(),y,f,b=u.useSOLBalance&&t.mintA.address===j.toString(),g=u.useSOLBalance&&t.mintB.address===j.toString(),{account:w,instructionParams:A}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new ie(t.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:b||i.isZero()?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!b,associatedOnly:b?!1:c,checkCreateATAOwner:l});w&&(y=w),p.addInstruction(A||{});let{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new ie(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:g||s.isZero()?{payer:this.scope.ownerPubKey,amount:s}:void 0,notUseTokenAccount:g,skipCloseAccount:!g,associatedOnly:g?!1:c,checkCreateATAOwner:l});k&&(f=k),p.addInstruction(I||{}),!y&&!f&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let T=n!=null?n:await this.getClmmPoolKeys(t.id),S=Se.increasePositionFromLiquidityInstructions({poolInfo:t,poolKeys:T,ownerPosition:r,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:y,tokenAccountB:f},liquidity:a,amountMaxA:i,amountMaxB:s});return p.addInstruction(S),p.addCustomComputeBudget(m),p.versionBuild({txVersion:d,extInfo:{address:S.address}})}async increasePositionFromBase(e){let{poolInfo:t,ownerPosition:n,base:r,baseAmount:i,otherAmountMax:s,ownerInfo:a,associatedOnly:u=!0,checkCreateATAOwner:c=!1,computeBudgetConfig:l,txVersion:m}=e,d=this.createTxBuilder(),p,y,f=a.useSOLBalance&&t.mintA.address===j.toString(),b=a.useSOLBalance&&t.mintB.address===j.toString(),{account:g,instructionParams:w}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new ie(t.mintA.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,createInfo:f||(r==="MintA"?i:s).isZero()?{payer:this.scope.ownerPubKey,amount:r==="MintA"?i:s}:void 0,skipCloseAccount:!f,associatedOnly:f?!1:u,checkCreateATAOwner:c});g&&(p=g),d.addInstruction(w||{});let{account:A,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new ie(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:b||(r==="MintA"?s:i).isZero()?{payer:this.scope.ownerPubKey,amount:r==="MintA"?s:i}:void 0,notUseTokenAccount:b,skipCloseAccount:!b,associatedOnly:b?!1:u,checkCreateATAOwner:c});A&&(y=A),d.addInstruction(k||{}),!p&&!y&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let I=await this.getClmmPoolKeys(t.id),T=Se.increasePositionFromBaseInstructions({poolInfo:t,poolKeys:I,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:p,tokenAccountB:y},base:r,baseAmount:i,otherAmountMax:s});return d.addInstruction(T),d.addCustomComputeBudget(l),d.versionBuild({txVersion:m,extInfo:{address:T.address}})}async decreaseLiquidity(e){let{poolInfo:t,poolKeys:n,ownerPosition:r,ownerInfo:i,amountMinA:s,amountMinB:a,liquidity:u,associatedOnly:c=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txVersion:d}=e;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let p=this.createTxBuilder(),y=i.useSOLBalance&&t.mintA.address===j.toString(),f=i.useSOLBalance&&t.mintB.address===j.toString(),b,g,{account:w,instructionParams:A}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new ie(t.mintA.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!y,associatedOnly:y?!1:c,checkCreateATAOwner:l});b=w,A&&p.addInstruction(A);let{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new ie(t.mintB.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!f,associatedOnly:f?!1:c,checkCreateATAOwner:l});g=k,I&&p.addInstruction(I);let T=[];for(let B of t.rewardDefaultInfos){let M=i.useSOLBalance&&B.mint.address===j.toString(),D;if(B.mint.address===t.mintA.address)D=b;else if(B.mint.address===t.mintB.address)D=g;else{let{account:F,instructionParams:Z}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(B.mint.programId),mint:new ie(B.mint.address),notUseTokenAccount:M,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!M,associatedOnly:M?!1:c,checkCreateATAOwner:l});D=F,Z&&p.addInstruction(Z)}T.push(D)}!b&&!g&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccountRawInfos);let S=n!=null?n:await this.getClmmPoolKeys(t.id),x=await Se.decreaseLiquidityInstructions({poolInfo:t,poolKeys:S,ownerPosition:r,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g,rewardAccounts:T},liquidity:u,amountMinA:s,amountMinB:a});p.addInstruction({instructions:x.instructions,instructionTypes:[V.ClmmDecreasePosition]});let R=C({},x.address);if(i.closePosition){let B=await Se.closePositionInstructions({poolInfo:t,poolKeys:S,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:r});p.addInstruction({endInstructions:B.instructions,endInstructionTypes:B.instructionTypes}),R=C(C({},R),B.address)}return p.addCustomComputeBudget(m),p.versionBuild({txVersion:d,extInfo:{address:R}})}async closePosition({poolInfo:e,poolKeys:t,ownerPosition:n,txVersion:r}){this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let i=this.createTxBuilder(),s=t!=null?t:await this.getClmmPoolKeys(e.id),a=Se.closePositionInstructions({poolInfo:e,poolKeys:s,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:n});return i.addInstruction(a).versionBuild({txVersion:r,extInfo:{address:a.address}})}async initReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:r=!0,checkCreateATAOwner:i=!1,computeBudgetConfig:s,txVersion:a}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(),c=t.useSOLBalance&&n.mint.address.toString()===j.toString(),l=n.perSecond.mul(n.endTime-n.openTime),{account:m,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(n.mint.address),mint:new ie(n.mint.address),notUseTokenAccount:!!c,skipCloseAccount:!c,owner:this.scope.ownerPubKey,createInfo:c?{payer:t.feePayer||this.scope.ownerPubKey,amount:new dt(new O(l.toFixed(0)).gte(l)?l.toFixed(0):l.add(1).toFixed(0))}:void 0,associatedOnly:c?!1:r,checkCreateATAOwner:i});d&&u.addInstruction(d),m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let p=await this.getClmmPoolKeys(e.id),y=Se.initRewardInstructions({poolInfo:e,poolKeys:p,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardInfo:{programId:new ie(n.mint.programId),mint:new ie(n.mint.address),openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ne.decimalToX64(n.perSecond)}});return u.addInstruction(y),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:y.address}})}async initRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:r,associatedOnly:i=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txVersion:u}){for(let m of r)m.endTime<=m.openTime&&this.logAndCreateError("reward time error","rewardInfo",m);let c=this.createTxBuilder(),l={};for(let m of r){let d=n.useSOLBalance&&m.mint.address===j.toString(),p=m.perSecond.mul(m.endTime-m.openTime),{account:y,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(m.mint.programId),mint:new ie(m.mint.address),notUseTokenAccount:!!d,skipCloseAccount:!d,owner:this.scope.ownerPubKey,createInfo:d?{payer:n.feePayer||this.scope.ownerPubKey,amount:new dt(new O(p.toFixed(0)).gte(p)?p.toFixed(0):p.add(1).toFixed(0))}:void 0,associatedOnly:d?!1:i,checkCreateATAOwner:s});f&&c.addInstruction(f),y||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let b=t!=null?t:await this.getClmmPoolKeys(e.id),g=Se.initRewardInstructions({poolInfo:e,poolKeys:b,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:y},rewardInfo:{programId:new ie(m.mint.programId),mint:new ie(m.mint.address),openTime:m.openTime,endTime:m.endTime,emissionsPerSecondX64:ne.decimalToX64(m.perSecond)}});l=C(C({},l),g.address),c.addInstruction(g)}return c.addCustomComputeBudget(a),c.versionBuild({txVersion:u,extInfo:{address:l}})}async setReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:r=!0,checkCreateATAOwner:i=!1,computeBudgetConfig:s,txVersion:a}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(),c=t.useSOLBalance&&n.mint.equals(j),{account:l,instructionParams:m}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n.programId,mint:n.mint,notUseTokenAccount:c,owner:this.scope.ownerPubKey,createInfo:c?{payer:t.feePayer||this.scope.ownerPubKey,amount:new dt(new O(n.perSecond.sub(n.endTime-n.openTime).toFixed(0)).gte(n.perSecond.sub(n.endTime-n.openTime))?n.perSecond.sub(n.endTime-n.openTime).toFixed(0):n.perSecond.sub(n.endTime-n.openTime).add(1).toFixed(0))}:void 0,associatedOnly:c?!1:r,checkCreateATAOwner:i});m&&u.addInstruction(m),l||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let d=await this.getClmmPoolKeys(e.id),p=Se.setRewardInstructions({poolInfo:e,poolKeys:d,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:l},rewardInfo:{mint:n.mint,openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ne.decimalToX64(n.perSecond)}});return u.addInstruction(p),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:p.address}})}async setRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:r,associatedOnly:i=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txVersion:u}){let c=this.createTxBuilder(),l={};for(let m of r){m.endTime<=m.openTime&&this.logAndCreateError("reward time error","rewardInfo",m);let d=n.useSOLBalance&&m.mint.address===j.toString(),{account:p,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(m.mint.programId),mint:new ie(m.mint.address),notUseTokenAccount:d,owner:this.scope.ownerPubKey,createInfo:d?{payer:n.feePayer||this.scope.ownerPubKey,amount:new dt(new O(m.perSecond.sub(m.endTime-m.openTime).toFixed(0)).gte(m.perSecond.sub(m.endTime-m.openTime))?m.perSecond.sub(m.endTime-m.openTime).toFixed(0):m.perSecond.sub(m.endTime-m.openTime).add(1).toFixed(0))}:void 0,associatedOnly:d?!1:i,checkCreateATAOwner:s});y&&c.addInstruction(y),p||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=t!=null?t:await this.getClmmPoolKeys(e.id),b=Se.setRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:p},rewardInfo:{mint:new ie(m.mint.address),openTime:m.openTime,endTime:m.endTime,emissionsPerSecondX64:ne.decimalToX64(m.perSecond)}});c.addInstruction(b),l=C(C({},l),b.address)}return c.addCustomComputeBudget(a),c.versionBuild({txVersion:u,extInfo:{address:l}})}async collectReward({poolInfo:e,ownerInfo:t,rewardMint:n,associatedOnly:r=!0,checkCreateATAOwner:i=!1}){let s=e.rewardDefaultInfos.find(p=>p.mint.address===n.toString());s||this.logAndCreateError("reward mint error","not found reward mint",n);let a=this.createTxBuilder(),u=t.useSOLBalance&&n.equals(j),{account:c,instructionParams:l}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(s.mint.programId),mint:n,notUseTokenAccount:u,owner:this.scope.ownerPubKey,skipCloseAccount:!u,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:u?!1:r,checkCreateATAOwner:i});l&&a.addInstruction(l),c||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let m=await this.getClmmPoolKeys(e.id),d=Se.collectRewardInstructions({poolInfo:e,poolKeys:m,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:c},rewardMint:n});return a.addInstruction(d),a.build({address:d.address})}async collectRewards({poolInfo:e,ownerInfo:t,rewardMints:n,associatedOnly:r=!0,checkCreateATAOwner:i=!1}){let s=this.createTxBuilder(),a={};for(let u of n){let c=e.rewardDefaultInfos.find(f=>f.mint.address===u.toString());if(!c){this.logAndCreateError("reward mint error","not found reward mint",u);continue}let l=t.useSOLBalance&&u.equals(j),{account:m,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(c.mint.programId),mint:u,notUseTokenAccount:l,owner:this.scope.ownerPubKey,skipCloseAccount:!l,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:l?!1:r,checkCreateATAOwner:i});m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos),d&&s.addInstruction(d);let p=await this.getClmmPoolKeys(e.id),y=Se.collectRewardInstructions({poolInfo:e,poolKeys:p,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardMint:u});s.addInstruction(y),a=C(C({},a),y.address)}return s.build({address:a})}async swap({poolInfo:e,poolKeys:t,inputMint:n,amountIn:r,amountOutMin:i,priceLimit:s,observationId:a,ownerInfo:u,remainingAccounts:c,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p}){let y=this.createTxBuilder(),f=n.toString()===e.mintA.address,b=u.useSOLBalance&&e.mintA.address===j.toBase58(),g=u.useSOLBalance&&e.mintB.address===j.toBase58(),w;!s||s.equals(new O(0))?w=f?Pt.add(new dt(1)):ht.sub(new dt(1)):w=ee.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let A;if(!A){let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new ie(e.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,skipCloseAccount:!b,createInfo:b||!f?{payer:u.feePayer||this.scope.ownerPubKey,amount:f?r:0}:void 0,associatedOnly:b?!1:l,checkCreateATAOwner:m});A=T,S&&y.addInstruction(S)}let k;if(!k){let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new ie(e.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,skipCloseAccount:!g,createInfo:g||f?{payer:u.feePayer||this.scope.ownerPubKey,amount:f?0:r}:void 0,associatedOnly:g?!1:l,checkCreateATAOwner:m});k=T,S&&y.addInstruction(S)}(!A||!k)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:A,ownerTokenAccountB:k,mintAUseSOLBalance:b,mintBUseSOLBalance:g,associatedOnly:l});let I=t!=null?t:await this.getClmmPoolKeys(e.id);return y.addInstruction(Se.makeSwapBaseInInstructions({poolInfo:e,poolKeys:I,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:A,tokenAccountB:k},inputMint:new ie(n),amountIn:r,amountOutMin:i,sqrtPriceLimitX64:w,remainingAccounts:c})),y.addCustomComputeBudget(p),y.versionBuild({txVersion:d})}async swapBaseOut({poolInfo:e,poolKeys:t,outputMint:n,amountOut:r,amountInMax:i,priceLimit:s,observationId:a,ownerInfo:u,remainingAccounts:c,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p}){let y=this.createTxBuilder(),f=n.toString()===e.mintB.address,b=u.useSOLBalance&&e.mintA.address===j.toBase58(),g=u.useSOLBalance&&e.mintB.address===j.toBase58(),w;!s||s.equals(new O(0))?w=n.toString()===e.mintB.address?Pt.add(new dt(1)):ht.sub(new dt(1)):w=ee.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let A;if(!A){let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new ie(e.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,skipCloseAccount:!b,createInfo:b||!f?{payer:u.feePayer||this.scope.ownerPubKey,amount:f?i:0}:void 0,associatedOnly:b?!1:l,checkCreateATAOwner:m});A=T,S&&y.addInstruction(S)}let k;if(!k){let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new ie(e.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,skipCloseAccount:!g,createInfo:g||f?{payer:u.feePayer||this.scope.ownerPubKey,amount:f?0:i}:void 0,associatedOnly:g?!1:l,checkCreateATAOwner:m});k=T,S&&y.addInstruction(S)}(!A||!k)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:A,ownerTokenAccountB:k,mintAUseSOLBalance:b,mintBUseSOLBalance:g,associatedOnly:l});let I=t!=null?t:await this.getClmmPoolKeys(e.id);return y.addInstruction(Se.makeSwapBaseOutInstructions({poolInfo:e,poolKeys:I,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:A,tokenAccountB:k},outputMint:new ie(n),amountOut:r,amountInMax:i,sqrtPriceLimitX64:w,remainingAccounts:c})),y.addCustomComputeBudget(p),y.versionBuild({txVersion:d})}async harvestAllRewards({allPoolInfo:e,allPositions:t,ownerInfo:n,associatedOnly:r=!0,checkCreateATAOwner:i=!1,programId:s,txVersion:a,computeBudgetConfig:u}){let c={};for(let m of this.scope.account.tokenAccountRawInfos)r?we(this.scope.ownerPubKey,m.accountInfo.mint,s).publicKey.equals(m.pubkey)&&(c[m.accountInfo.mint.toString()]=m.pubkey):c[m.accountInfo.mint.toString()]=m.pubkey;let l=this.createTxBuilder();for(let m of Object.values(e)){if(t[m.id]===void 0||!t[m.id].find(A=>!A.liquidity.isZero()||A.rewardInfos.find(k=>!k.rewardAmountOwed.isZero())))continue;let d=m,p=n.useSOLBalance&&d.mintA.address===j.toString(),y=n.useSOLBalance&&d.mintB.address===j.toString(),f=c[d.mintA.address];if(!f){let{account:A,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:d.mintA.programId,mint:new ie(d.mintA.address),notUseTokenAccount:p,owner:this.scope.ownerPubKey,skipCloseAccount:!p,createInfo:{payer:n.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:p?!1:r,checkCreateATAOwner:i});f=A,k&&l.addInstruction(k)}let b=c[d.mintB.address];if(!b){let{account:A,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:d.mintB.programId,mint:new ie(d.mintB.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,skipCloseAccount:!y,createInfo:{payer:n.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:y?!1:r,checkCreateATAOwner:i});b=A,k&&l.addInstruction(k)}c[d.mintA.address]=f,c[d.mintB.address]=b;let g=[];for(let A of d.rewardDefaultInfos){let k=n.useSOLBalance&&A.mint.address===j.toString(),I=c[A.mint.address];if(!I){let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(A.mint.programId),mint:new ie(A.mint.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,skipCloseAccount:!k,createInfo:{payer:n.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:k?!1:r});I=T,S&&l.addInstruction(S)}c[A.mint.address]=I,g.push(I)}let w=await this.getClmmPoolKeys(d.id);for(let A of t[m.id]){let k=Se.decreaseLiquidityInstructions({poolInfo:d,poolKeys:w,ownerPosition:A,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:b,rewardAccounts:g},liquidity:new dt(0),amountMinA:new dt(0),amountMinB:new dt(0)});l.addInstruction(k)}}return a===0?l.sizeCheckBuildV0({computeBudgetConfig:u}):l.sizeCheckBuild({computeBudgetConfig:u})}async getWhiteListMint({programId:e}){let t=await this.scope.connection.getAccountInfo(Co(e).publicKey);return t?ec.decode(t.data).whitelistMints.filter(r=>!r.equals(ie.default)):[]}async getOwnerPositionInfo({programId:e}){await this.scope.account.fetchWalletTokenAccounts();let n=this.scope.account.tokenAccountRawInfos.filter(s=>s.accountInfo.amount.eq(new dt(1))).map(s=>At(new ie(e),s.accountInfo.mint).publicKey),r=await this.scope.connection.getMultipleAccountsInfo(n),i=[];return r.forEach(s=>{if(!s)return;let a=Fr.decode(s.data);i.push(a)}),i}async getRpcClmmPoolInfo({poolId:e}){return(await this.getRpcClmmPoolInfos({poolIds:[e]}))[String(e)]}async getRpcClmmPoolInfos({poolIds:e,config:t}){let n=await We(this.scope.connection,e.map(i=>({pubkey:new ie(i)})),t),r={};for(let i=0;i<e.length;i++){let s=n[i];if(s===null||!s.accountInfo)throw Error("fetch pool info error: "+String(e[i]));let a=In.decode(s.accountInfo.data),u=ee.sqrtPriceX64ToPrice(a.sqrtPriceX64,a.mintDecimalsA,a.mintDecimalsB).toNumber();r[String(e[i])]=E(C({},a),{currentPrice:u,programId:s.accountInfo.owner})}return r}async getComputeClmmPoolInfos({clmmPoolsRpcInfo:e,mintInfos:t}){let n=new Set(Object.keys(e).map(u=>e[u].ammConfig.toBase58())),r=await We(this.scope.connection,Array.from(n).map(u=>({pubkey:new ie(u)}))),i={};r.forEach(u=>{!u.accountInfo||(i[u.pubkey.toBase58()]=$u.decode(u.accountInfo.data))});let s=await Ce.fetchComputeMultipleClmmInfo({connection:this.scope.connection,rpcDataMap:e,poolList:Object.keys(e).map(u=>{var m,d,p,y;let[c,l]=[e[u].mintA.toBase58(),e[u].mintB.toBase58()];return{id:u,programId:e[u].programId.toBase58(),mintA:it({address:c,decimals:e[u].mintDecimalsA,programId:t[c].programId.toBase58()||cc.toBase58(),extensions:{feeConfig:(m=t[c])!=null&&m.feeConfig?cn((d=t[c])==null?void 0:d.feeConfig):void 0}}),mintB:it({address:l,decimals:e[u].mintDecimalsB,programId:t[l].programId.toBase58()||cc.toBase58(),extensions:{feeConfig:(p=t[l])!=null&&p.feeConfig?cn((y=t[l])==null?void 0:y.feeConfig):void 0}}),price:e[u].currentPrice,config:E(C({},i[e[u].ammConfig.toBase58()]),{id:e[u].ammConfig.toBase58(),fundFeeRate:0,description:"",defaultRange:0,defaultRangePoint:[]})}})}),a=await Ce.fetchMultiplePoolTickArrays({connection:this.scope.connection,poolKeys:Object.values(s)});return{computeClmmPoolInfo:s,computePoolTickData:a}}async getPoolInfoFromRpc(e){var l;let t=await this.getRpcClmmPoolInfo({poolId:e}),n=new Set([t.mintA.toBase58(),t.mintB.toBase58()]),r=await Fn({connection:this.scope.connection,mints:Array.from(n).map(m=>new ie(m))}),{computeClmmPoolInfo:i,computePoolTickData:s}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:{[e]:t},mintInfos:r}),a=await We(this.scope.connection,[{pubkey:t.vaultA},{pubkey:t.vaultB}]),u=Hu(i[e]);if(!a[0].accountInfo||!a[1].accountInfo)throw new Error("pool vault data not found");u.mintAmountA=Number(uc.decode(a[0].accountInfo.data).amount.toString()),u.mintAmountB=Number(uc.decode((l=a[1].accountInfo)==null?void 0:l.data).amount.toString());let c=E(C({},i[e]),{id:e,programId:t.programId.toBase58(),openTime:t.startTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},rewardInfos:[],config:u.config});return{poolInfo:u,poolKeys:c,computePoolInfo:i[e],tickData:s}}};import{PublicKey as z}from"@solana/web3.js";import{NATIVE_MINT as jr,TOKEN_PROGRAM_ID as Yt,AccountLayout as sf}from"@solana/spl-token";import Ns from"bn.js";import mc from"bn.js";var Ls=new mc(1e6);function zp(o,e,t){return o.mul(e).add(t).sub(new mc(1)).div(t)}function lc(o,e,t){return o.mul(e).div(t)}var Wr=class{static tradingFee(e,t){return zp(e,t,Ls)}static protocolFee(e,t){return lc(e,t,Ls)}static fundFee(e,t){return lc(e,t,Ls)}};import Vo from"bn.js";function qr(o,e){if(e.isZero())throw Error("divisor is zero");return o.mod(e)}function Qp(o,e){if(e.isZero())throw Error("rhs is zero");let t=o.div(e);if(t.isZero())throw Error("quotient is zero");let n=qr(o,e);return n.gt(Yn)&&(t=t.add(new Vo(1)),e=o.div(t),n=qr(o,t),n.gt(Yn)&&(e=e.add(new Vo(1)))),[t,e]}var Yn=new Vo(0),Ur=class{static swapWithoutFees(e,t,n){let r=t.mul(n),i=t.add(e),[s,a]=Qp(r,i),u=a.sub(t),c=n.sub(s);if(c.isZero())throw Error("destinationAmountSwapped is zero");return{sourceAmountSwapped:u,destinationAmountSwapped:c}}static lpTokensToTradingTokens(e,t,n,r,i){let s=e.mul(n).div(t),a=e.mul(r).div(t);if(i===0)return{tokenAmount0:s,tokenAmount1:a};if(i===1)return qr(e.mul(n),t).gt(Yn)&&s.gt(Yn)&&(s=s.add(new Vo(1))),qr(e.mul(r),t).gt(Yn)&&a.gt(Yn)&&(a=a.add(new Vo(1))),{tokenAmount0:s,tokenAmount1:a};throw Error("roundDirection value error")}};import Gr from"decimal.js-light";var dc=(t=>(t[t.Floor=0]="Floor",t[t.Ceiling=1]="Ceiling",t))(dc||{}),Xr=class{static validate_supply(e,t){if(e.isZero())throw Error("tokenAmount0 is zero");if(t.isZero())throw Error("tokenAmount1 is zero")}static swap(e,t,n,r){let i=Wr.tradingFee(e,r),s=e.sub(i),{sourceAmountSwapped:a,destinationAmountSwapped:u}=Ur.swapWithoutFees(s,t,n),c=a.add(i);return{newSwapSourceAmount:t.add(c),newSwapDestinationAmount:n.sub(u),sourceAmountSwapped:c,destinationAmountSwapped:u,tradeFee:i}}static swapBaseOut({poolMintA:e,poolMintB:t,tradeFeeRate:n,baseReserve:r,quoteReserve:i,outputMint:s,outputAmount:a}){let[u,c,l,m,d]=t.address===s.toString()?[r,i,e.decimals,t.decimals,e.address]:[i,r,t.decimals,e.decimals,t.address],p=new Gr(c.toString()).div(10**m).div(new Gr(u.toString()).div(10**l)),y=a.gte(c)?c.sub(new Ns(1)):a,f=c.sub(y),b=St(u.mul(y),f),g=St(b.mul(new Ns(1e6)),new Ns(1e6).sub(n)),w=g.sub(b),A=new Gr(y.toString()).div(10**m).div(new Gr(g.toString()).div(10**l)),k=p.isZero()?0:A.sub(p).div(p).abs().toNumber();return{amountRealOut:y,amountIn:g,amountInWithoutFee:b,tradeFee:w,priceImpact:k}}};var Yp=Buffer.from("vault_and_lp_mint_auth_seed","utf8"),jp=Buffer.from("amm_config","utf8"),Hp=Buffer.from("pool","utf8"),Zp=Buffer.from("pool_lp_mint","utf8"),$p=Buffer.from("pool_vault","utf8"),Jp=Buffer.from("observation","utf8");function jn(o){return ue([Yp],o)}function jB(o,e){return ue([jp,nf(e)],o)}function ef(o,e,t,n){return ue([Hp,e.toBuffer(),t.toBuffer(),n.toBuffer()],o)}function tf(o,e){return ue([Zp,e.toBuffer()],o)}function pc(o,e,t){return ue([$p,e.toBuffer(),t.toBuffer()],o)}function zr(o,e){return ue([Jp,e.toBuffer()],o)}function nf(o){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,o,!1),new Uint8Array(e)}function fc({programId:o,configId:e,mintA:t,mintB:n}){let r=jn(o).publicKey,i=ef(o,e,t,n).publicKey,s=tf(o,i).publicKey,a=pc(o,i,t).publicKey,u=pc(o,i,n).publicKey,c=zr(o,i).publicKey;return{poolId:i,configId:e,authority:r,lpMint:s,vaultA:a,vaultB:u,observationId:c}}import{TransactionInstruction as Eo}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ms,TOKEN_2022_PROGRAM_ID as yc,ASSOCIATED_TOKEN_PROGRAM_ID as of}from"@solana/spl-token";var rf=ce("Raydium_cpmm"),Do={initialize:[175,175,109,31,13,152,155,237],deposit:[242,35,198,137,82,225,242,182],withdraw:[183,18,70,156,148,109,161,34],swapBaseInput:[143,190,90,218,196,30,51,222],swapBaseOutput:[55,217,98,86,163,74,180,173]};function bc(o,e,t,n,r,i,s,a,u,c,l,m,d,p,y,f,b,g,w,A){let k=v([h("amountMaxA"),h("amountMaxB"),h("openTime")]),I=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:Ms,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:of,isSigner:!1,isWritable:!1},{pubkey:sr,isSigner:!1,isWritable:!1},{pubkey:ut,isSigner:!1,isWritable:!1}],T=Buffer.alloc(k.span);return k.encode({amountMaxA:g,amountMaxB:w,openTime:A},T),new Eo({keys:I,programId:o,data:Buffer.from([...Do.initialize,...T])})}function gc(o,e,t,n,r,i,s,a,u,c,l,m,d,p,y){let f=v([h("lpAmount"),h("amountMaxA"),h("amountMaxB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:Ms,isSigner:!1,isWritable:!1},{pubkey:yc,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0}],g=Buffer.alloc(f.span);return rf.debug("cpmm deposit data",{lpAmount:d.toString(),amountMaxA:p.toString(),amountMaxB:y.toString()}),f.encode({lpAmount:d,amountMaxA:p,amountMaxB:y},g),new Eo({keys:b,programId:o,data:Buffer.from([...Do.deposit,...g])})}function Ac(o,e,t,n,r,i,s,a,u,c,l,m,d,p,y){let f=v([h("lpAmount"),h("amountMinA"),h("amountMinB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:Ms,isSigner:!1,isWritable:!1},{pubkey:yc,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:rr,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);return f.encode({lpAmount:d,amountMinA:p,amountMinB:y},g),new Eo({keys:b,programId:o,data:Buffer.from([...Do.withdraw,...g])})}function Qr(o,e,t,n,r,i,s,a,u,c,l,m,d,p,y,f){let b=v([h("amountIn"),h("amounOutMin")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],w=Buffer.alloc(b.span);return b.encode({amountIn:y,amounOutMin:f},w),new Eo({keys:g,programId:o,data:Buffer.from([...Do.swapBaseInput,...w])})}function wc(o,e,t,n,r,i,s,a,u,c,l,m,d,p,y,f){let b=v([h("amountInMax"),h("amountOut")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],w=Buffer.alloc(b.span);return b.encode({amountInMax:y,amountOut:f},w),new Eo({keys:g,programId:o,data:Buffer.from([...Do.swapBaseOutput,...w])})}import _e from"bn.js";var Pc=v([ge(8),W("bump"),je("disableCreatePool"),qt("index"),h("tradeFeeRate"),h("protocolFeeRate"),h("fundFeeRate"),h("createPoolFee"),K("protocolOwner"),K("fundOwner"),X(h(),16)]),Yr=v([ge(8),K("configId"),K("poolCreator"),K("vaultA"),K("vaultB"),K("mintLp"),K("mintA"),K("mintB"),K("mintProgramA"),K("mintProgramB"),K("observationId"),W("bump"),W("status"),W("lpDecimals"),W("mintDecimalA"),W("mintDecimalB"),h("lpAmount"),h("protocolFeesMintA"),h("protocolFeesMintB"),h("fundFeesMintA"),h("fundFeesMintB"),h("openTime"),X(h(),32)]);var Wo=class extends Ke{constructor(e){super(e)}async load(){this.checkDisabled()}async getCpmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async getRpcPoolInfo(e,t){return(await this.getRpcPoolInfos([e],t))[e]}async getRpcPoolInfos(e,t){let n=await We(this.scope.connection,e.map(m=>({pubkey:new z(m)}))),r={},i=new Set,s=[];for(let m=0;m<e.length;m++){let d=n[m];if(d.accountInfo===null)throw Error("fetch pool info error: "+String(e[m]));let p=Yr.decode(d.accountInfo.data);r[String(e[m])]=E(C({},p),{programId:d.accountInfo.owner}),i.add(String(p.configId)),s.push(p.vaultA,p.vaultB)}let a={};if(t){let m=[...i],d=await We(this.scope.connection,m.map(p=>({pubkey:new z(p)})));for(let p=0;p<m.length;p++){let y=d[p].accountInfo;if(y===null)throw Error("fetch pool config error: "+m[p]);a[m[p]]=Pc.decode(y.data)}}let u={},c=await We(this.scope.connection,s.map(m=>({pubkey:new z(m)})));for(let m=0;m<s.length;m++){let d=c[m].accountInfo;if(d===null)throw Error("fetch vault info error: "+s[m]);u[String(s[m])]=new _e(sf.decode(d.data).amount.toString())}let l={};for(let[m,d]of Object.entries(r)){let p=u[d.vaultA.toString()].sub(d.protocolFeesMintA).sub(d.fundFeesMintA),y=u[d.vaultB.toString()].sub(d.protocolFeesMintB).sub(d.fundFeesMintB);l[m]=E(C({},d),{baseReserve:p,quoteReserve:y,vaultAAmount:u[d.vaultA.toString()],vaultBAmount:u[d.vaultB.toString()],configInfo:a[d.configId.toString()],poolPrice:new O(y.toString()).div(new O(10).pow(d.mintDecimalB)).div(new O(p.toString()).div(new O(10).pow(d.mintDecimalA)))})}return l}toComputePoolInfos({pools:e,mintInfos:t}){return Object.keys(e).reduce((n,r)=>{var u,c,l,m;let i=e[r],[s,a]=[i.mintA.toBase58(),i.mintB.toBase58()];return E(C({},n),{[r]:E(C({},i),{id:new z(r),configInfo:i.configInfo,version:7,authority:jn(i.programId).publicKey,mintA:it({address:s,decimals:i.mintDecimalA,programId:i.mintProgramA.toBase58(),extensions:{feeConfig:(u=t[s])!=null&&u.feeConfig?cn((c=t[s])==null?void 0:c.feeConfig):void 0}}),mintB:it({address:a,decimals:i.mintDecimalB,programId:i.mintProgramB.toBase58(),extensions:{feeConfig:(l=t[a])!=null&&l.feeConfig?cn((m=t[a])==null?void 0:m.feeConfig):void 0}})})})},{})}async getPoolInfoFromRpc(e){let t=await this.getRpcPoolInfo(e,!0),n=await Fn({connection:this.scope.connection,mints:[t.mintA,t.mintB]}),r=it({address:t.mintA.toBase58(),decimals:t.mintDecimalA,programId:t.mintProgramA.toBase58(),extensions:{feeConfig:n[t.mintA.toBase58()].feeConfig?cn(n[t.mintA.toBase58()].feeConfig):void 0}}),i=it({address:t.mintB.toBase58(),decimals:t.mintDecimalB,programId:t.mintProgramB.toBase58(),extensions:{feeConfig:n[t.mintB.toBase58()].feeConfig?cn(n[t.mintB.toBase58()].feeConfig):void 0}}),s=it({address:t.mintLp.toBase58(),decimals:t.lpDecimals,programId:Yt.toBase58()}),a={id:t.configId.toBase58(),index:t.configInfo.index,protocolFeeRate:t.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:t.configInfo.tradeFeeRate.toNumber(),fundFeeRate:t.configInfo.fundFeeRate.toNumber(),createPoolFee:t.configInfo.createPoolFee.toString()},u={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};return{poolInfo:{programId:t.programId.toBase58(),id:e,type:"Standard",lpMint:s,lpPrice:0,lpAmount:t.lpAmount.toNumber(),config:a,mintA:r,mintB:i,rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:t.poolPrice.toNumber(),mintAmountA:new O(t.vaultAAmount.toString()).div(10**r.decimals).toNumber(),mintAmountB:new O(t.vaultBAmount.toString()).div(10**i.decimals).toNumber(),feeRate:t.configInfo.tradeFeeRate.toNumber(),openTime:t.openTime.toString(),tvl:0,day:u,week:u,month:u,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0},poolKeys:{programId:t.programId.toBase58(),id:e,mintA:r,mintB:i,openTime:t.openTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},authority:jn(t.programId).publicKey.toBase58(),mintLp:s,config:a},rpcData:t}}async createPool(m){var d=m,{programId:e,poolFeeAccount:t,startTime:n,ownerInfo:r,associatedOnly:i=!1,checkCreateATAOwner:s=!1,txVersion:a,feeConfig:u,computeBudgetConfig:c}=d,l=Oe(d,["programId","poolFeeAccount","startTime","ownerInfo","associatedOnly","checkCreateATAOwner","txVersion","feeConfig","computeBudgetConfig"]);var F,Z,G;let p=r.feePayer||((F=this.scope.owner)==null?void 0:F.publicKey),y=new _e(new z(l.mintA.address).toBuffer()).lte(new _e(new z(l.mintB.address).toBuffer())),[f,b]=y?[l.mintA,l.mintB]:[l.mintB,l.mintA],[g,w]=y?[l.mintAAmount,l.mintBAmount]:[l.mintBAmount,l.mintAAmount],A=r.useSOLBalance&&f.address===jr.toBase58(),k=r.useSOLBalance&&b.address===jr.toBase58(),[I,T]=[new z(f.address),new z(b.address)],S=this.createTxBuilder(),{account:x,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({mint:I,tokenProgram:f.programId,owner:this.scope.ownerPubKey,createInfo:A?{payer:p,amount:g}:void 0,notUseTokenAccount:A,skipCloseAccount:!A,associatedOnly:A?!1:i,checkCreateATAOwner:s});S.addInstruction(R||{});let{account:B,instructionParams:M}=await this.scope.account.getOrCreateTokenAccount({mint:new z(b.address),tokenProgram:b.programId,owner:this.scope.ownerPubKey,createInfo:k?{payer:p,amount:w}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:i,checkCreateATAOwner:s});if(S.addInstruction(M||{}),x===void 0||B===void 0)throw Error("you don't has some token account");let D=fc({programId:e,configId:new z(u.id),mintA:I,mintB:T});return S.addInstruction({instructions:[bc(e,this.scope.ownerPubKey,new z(u.id),D.authority,D.poolId,I,T,D.lpMint,x,B,we(this.scope.ownerPubKey,D.lpMint).publicKey,D.vaultA,D.vaultB,t,new z((Z=f.programId)!=null?Z:Yt),new z((G=b.programId)!=null?G:Yt),D.observationId,g,w,n)],instructionTypes:[V.CpmmCreatePool]}),S.addCustomComputeBudget(c),S.versionBuild({txVersion:a,extInfo:{address:E(C({},D),{mintA:f,mintB:b,programId:e,poolFeeAccount:t,feeConfig:u})}})}async addLiquidity(e){let{poolInfo:t,poolKeys:n,inputAmount:r,baseIn:i,slippage:s,computeResult:a,computeBudgetConfig:u,config:c,txVersion:l}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),r.isZero()&&this.logAndCreateError("amounts must greater than zero","amountInA",{amountInA:r.toString()});let{account:m}=this.scope,{bypassAssociatedCheck:d,checkCreateATAOwner:p}=C({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},c),y=a?void 0:await this.getRpcPoolInfo(t.id),{liquidity:f,inputAmountFee:b,anotherAmount:g}=a||this.computePairAmount({poolInfo:E(C({},t),{lpAmount:new O(y.lpAmount.toString()).div(10**t.lpMint.decimals).toNumber()}),baseReserve:y.baseReserve,quoteReserve:y.quoteReserve,slippage:new Me(0),baseIn:i,epochInfo:await this.scope.fetchEpochInfo(),amount:new O(r.toString()).div(10**(i?t.mintA.decimals:t.mintB.decimals))}),w=g.amount,A=t.mintA.address===jr.toString(),k=t.mintB.address===jr.toString(),I=this.createTxBuilder(),[T,S]=[new z(t.mintA.address),new z(t.mintB.address)],{account:x,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:A||(i?r:w).isZero()?{payer:this.scope.ownerPubKey,amount:i?r:w}:void 0,skipCloseAccount:!A,notUseTokenAccount:A,associatedOnly:!1,checkCreateATAOwner:p});I.addInstruction(R||{});let{account:B,instructionParams:M}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:k||(i?w:r).isZero()?{payer:this.scope.ownerPubKey,amount:i?w:r}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:!1,checkCreateATAOwner:p});I.addInstruction(M||{}),!x&&!B&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",m.tokenAccounts);let D=await m.getCreatedTokenAccount({mint:new z(t.lpMint.address)}),ot=await m.handleTokenAccount({side:"out",amount:0,mint:new z(t.lpMint.address),tokenAccount:D,bypassAssociatedCheck:d,checkCreateATAOwner:p}),{tokenAccount:F}=ot,Z=Oe(ot,["tokenAccount"]);I.addInstruction(Z);let G=n!=null?n:await this.getCpmmPoolKeys(t.id),q=new Me(new _e(1)).sub(s);return I.addInstruction({instructions:[gc(new z(t.programId),this.scope.ownerPubKey,new z(G.authority),new z(t.id),F,x,B,new z(G.vault.A),new z(G.vault.B),T,S,new z(t.lpMint.address),a?a==null?void 0:a.liquidity:q.mul(f).quotient,i?b.amount:w,i?w:b.amount)],instructionTypes:[V.CpmmAddLiquidity],lookupTableAddress:G.lookupTableAccount?[G.lookupTableAccount]:[]}),I.addCustomComputeBudget(u),I.versionBuild({txVersion:l})}async withdrawLiquidity(e){var F,Z;let{poolInfo:t,poolKeys:n,lpAmount:r,slippage:i,computeBudgetConfig:s,txVersion:a}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region");let u=new Me(new _e(1)).sub(i),c=await this.getRpcPoolInfo(t.id),[l,m]=[u.mul(r.mul(c.baseReserve).div(c.lpAmount)).quotient,u.mul(r.mul(c.quoteReserve).div(c.lpAmount)).quotient],d=await this.scope.fetchEpochInfo(),[p,y]=[be(l,t.mintA.extensions.feeConfig,d,!1),be(m,t.mintB.extensions.feeConfig,d,!1)],{account:f}=this.scope,b=this.createTxBuilder(),[g,w]=[new z(t.mintA.address),new z(t.mintB.address)],A=g.equals(j),k=w.equals(j),I,T,{account:S,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:A,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!A,associatedOnly:!A,checkCreateATAOwner:!1});I=S,x&&b.addInstruction(x);let{account:R,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!k,associatedOnly:!k,checkCreateATAOwner:!1});T=R,B&&b.addInstruction(B),(!I||!T)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",f.tokenAccounts);let M=await f.getCreatedTokenAccount({mint:new z(t.lpMint.address)});M||this.logAndCreateError("cannot found lp token account","tokenAccounts",f.tokenAccounts);let D=n!=null?n:await this.getCpmmPoolKeys(t.id);return b.addInstruction({instructions:[Ac(new z(t.programId),this.scope.ownerPubKey,new z(D.authority),new z(t.id),M,I,T,new z(D.vault.A),new z(D.vault.B),g,w,new z(t.lpMint.address),r,l.sub((F=p.fee)!=null?F:new _e(0)),m.sub((Z=y.fee)!=null?Z:new _e(0)))],instructionTypes:[V.CpmmWithdrawLiquidity],lookupTableAddress:D.lookupTableAccount?[D.lookupTableAccount]:[]}),b.addCustomComputeBudget(s),b.versionBuild({txVersion:a})}async swap(e){var R,B,M,D,F,Z;let{poolInfo:t,poolKeys:n,baseIn:r,fixedOut:i,inputAmount:s,swapResult:a,slippage:u=0,config:c,computeBudgetConfig:l,txVersion:m}=e,{bypassAssociatedCheck:d,checkCreateATAOwner:p,associatedOnly:y}=C({bypassAssociatedCheck:!1,checkCreateATAOwner:!1,associatedOnly:!0},c),f=this.createTxBuilder(),[b,g]=[new z(t.mintA.address),new z(t.mintB.address)];i?a.sourceAmountSwapped=a.sourceAmountSwapped.mul(new _e((1+u)*1e4)).div(new _e(1e4)):a.destinationAmountSwapped=a.destinationAmountSwapped.mul(new _e((1-u)*1e4)).div(new _e(1e4));let w=t.mintA.address===j.toBase58(),A=t.mintB.address===j.toBase58(),{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({mint:b,tokenProgram:new z((R=t.mintA.programId)!=null?R:Yt),owner:this.scope.ownerPubKey,createInfo:w||!r?{payer:this.scope.ownerPubKey,amount:r?a.sourceAmountSwapped:0}:void 0,notUseTokenAccount:w,skipCloseAccount:!w,associatedOnly:w?!1:y,checkCreateATAOwner:p});I&&f.addInstruction(I);let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:g,tokenProgram:new z((B=t.mintB.programId)!=null?B:Yt),owner:this.scope.ownerPubKey,createInfo:A||r?{payer:this.scope.ownerPubKey,amount:r?0:a.sourceAmountSwapped}:void 0,notUseTokenAccount:A,skipCloseAccount:!A,associatedOnly:A?!1:y,checkCreateATAOwner:p});S&&f.addInstruction(S),(!k||!T)&&this.logAndCreateError("user do not have token account",{mintA:t.mintA.symbol||t.mintA.address,mintB:t.mintB.symbol||t.mintB.address,mintATokenAcc:k,mintBTokenAcc:T,mintAUseSOLBalance:w,mintBUseSOLBalance:A,associatedOnly:y});let x=n!=null?n:await this.getCpmmPoolKeys(t.id);return f.addInstruction({instructions:[i?wc(new z(t.programId),this.scope.ownerPubKey,new z(x.authority),new z(x.config.id),new z(t.id),r?k:T,r?T:k,new z(x.vault[r?"A":"B"]),new z(x.vault[r?"B":"A"]),new z((F=t[r?"mintA":"mintB"].programId)!=null?F:Yt),new z((Z=t[r?"mintB":"mintA"].programId)!=null?Z:Yt),r?b:g,r?g:b,zr(new z(t.programId),new z(t.id)).publicKey,a.sourceAmountSwapped,a.destinationAmountSwapped):Qr(new z(t.programId),this.scope.ownerPubKey,new z(x.authority),new z(x.config.id),new z(t.id),r?k:T,r?T:k,new z(x.vault[r?"A":"B"]),new z(x.vault[r?"B":"A"]),new z((M=t[r?"mintA":"mintB"].programId)!=null?M:Yt),new z((D=t[r?"mintB":"mintA"].programId)!=null?D:Yt),r?b:g,r?g:b,zr(new z(t.programId),new z(t.id)).publicKey,s,a.destinationAmountSwapped)],instructionTypes:[i?V.CpmmSwapBaseOut:V.ClmmSwapBaseIn]}),f.addCustomComputeBudget(l),f.versionBuild({txVersion:m})}computeSwapAmount({pool:e,amountIn:t,outputMint:n,slippage:r}){let i=n.toString()===e.mintB.address,s=Xr.swap(t,i?e.baseReserve:e.quoteReserve,i?e.quoteReserve:e.baseReserve,e.configInfo.tradeFeeRate),a=new O(s.destinationAmountSwapped.toString()).div(s.sourceAmountSwapped.toString()),u=s.destinationAmountSwapped.mul(new _e((1-r)*1e4)).div(new _e(1e4));return{allTrade:s.sourceAmountSwapped.eq(t),amountIn:t,amountOut:s.destinationAmountSwapped,minAmountOut:u,executionPrice:a,fee:s.tradeFee,priceImpact:e.poolPrice.sub(a).div(e.poolPrice)}}computePairAmount({poolInfo:e,baseReserve:t,quoteReserve:n,amount:r,slippage:i,epochInfo:s,baseIn:a}){var w,A,k,I,T,S,x,R;let u=1-Number(i.toSignificant())/100,c=new _e(new O(r).mul(10**e[a?"mintA":"mintB"].decimals).mul(u).toFixed(0)),l=be(c,e[a?"mintA":"mintB"].extensions.feeConfig,s,!1),m=c.sub((w=l.fee)!=null?w:new _e(0)),d=new _e(new O(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,O.ROUND_DOWN));this.logDebug("baseReserve:",t.toString(),"quoteReserve:",n.toString()),this.logDebug("tokenIn:",a?e.mintA.symbol:e.mintB.symbol,"amountIn:",c.toString(),"amountInFee:",(k=(A=l.fee)==null?void 0:A.toString())!=null?k:0,"anotherToken:",a?e.mintB.symbol:e.mintA.symbol,"slippage:",`${i.toSignificant()}%`);let p=a?"base":"quote";this.logDebug("input side:",p);let y=m.mul(d).div(p==="base"?t:n),f={amount:De,fee:void 0,expirationTime:void 0};if(!m.isZero()){let B=af(y,t,n,d);this.logDebug("lpAmountData:",{amountA:B.amountA.toString(),amountB:B.amountB.toString()}),f=be(B[a?"amountB":"amountA"],e[a?"mintB":"mintA"].extensions.feeConfig,s,!0)}let b=new Me(new _e(1)).add(i),g=be(b.mul(f.amount.sub((I=f.fee)!=null?I:new _e(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0);return this.logDebug("anotherAmount:",f.amount.toString(),"anotherAmountFee:",(S=(T=f.fee)==null?void 0:T.toString())!=null?S:0,"maxAnotherAmount:",g.amount.toString(),"maxAnotherAmountFee:",(R=(x=g.fee)==null?void 0:x.toString())!=null?R:0),{inputAmountFee:l,anotherAmount:f,maxAnotherAmount:g,liquidity:y}}};function af(o,e,t,n){let r=o.mul(e).div(n);!r.isZero()&&!o.mul(e).mod(n).isZero()&&(r=r.add(new _e(1)));let i=o.mul(t).div(n);return!i.isZero()&&!o.mul(t).mod(n).isZero()&&(i=i.add(new _e(1))),{amountA:r,amountB:i}}import{PublicKey as Kn}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Re,TOKEN_2022_PROGRAM_ID as $r,createTransferInstruction as xc}from"@solana/spl-token";import Jr from"bn.js";import{TOKEN_PROGRAM_ID as vs,TOKEN_2022_PROGRAM_ID as uf,ASSOCIATED_TOKEN_PROGRAM_ID as cf}from"@solana/spl-token";import{PublicKey as Q,TransactionInstruction as _s,SystemProgram as Fs}from"@solana/web3.js";import Sn from"bn.js";function $x(o,e,t,n,r,i,s,a,u,c,l,m){let d=v([W("instruction"),h("amountIn"),h("amountOut")]),p=[{pubkey:Fs.programId,isSigner:!1,isWritable:!1},{pubkey:vs,isSigner:!1,isWritable:!1},{pubkey:new Q(t.programId),isSigner:!1,isWritable:!1},{pubkey:new Q(t.id),isSigner:!1,isWritable:!0},{pubkey:new Q(n.id),isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let f=Ie(t);p.push({pubkey:f.config.id,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(u)?f.vault.A:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(u)?f.vault.B:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},...m.map(b=>({pubkey:b,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let f=Ie(t);p.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:new Q("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0})}else{let f=Ie(t);p.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},...f.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:f.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:f.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0}])}let y=Buffer.alloc(d.span);return d.encode({instruction:4,amountIn:c,amountOut:l},y),new _s({keys:p,programId:o,data:y})}function Jx(o,e,t,n,r,i,s,a,u,c){let l=v([W("instruction")]),m=[{pubkey:Fs.programId,isSigner:!1,isWritable:!1},{pubkey:vs,isSigner:!1,isWritable:!1},{pubkey:new Q(String(n.programId)),isSigner:!1,isWritable:!1},{pubkey:new Q(String(n.id)),isSigner:!1,isWritable:!0},{pubkey:new Q(String(t.id)),isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let p=Ie(n);m.push({pubkey:p.config.id,isSigner:!1,isWritable:!1},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.mintA.address.equals(u)?p.vault.A:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.mintA.address.equals(u)?p.vault.B:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0},...c.map(y=>({pubkey:y,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let p=Ie(n);m.push({pubkey:p.authority,isSigner:!1,isWritable:!1},{pubkey:p.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:new Q("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:p.openOrders,isSigner:!1,isWritable:!0},{pubkey:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.marketId,isSigner:!1,isWritable:!0},{pubkey:p.marketBids,isSigner:!1,isWritable:!0},{pubkey:p.marketAsks,isSigner:!1,isWritable:!0},{pubkey:p.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0})}else{let p=Ie(n);m.push({pubkey:p.authority,isSigner:!1,isWritable:!1},{pubkey:p.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:p.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:p.openOrders,isSigner:!1,isWritable:!0},{pubkey:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.marketId,isSigner:!1,isWritable:!0},{pubkey:p.marketBids,isSigner:!1,isWritable:!0},{pubkey:p.marketAsks,isSigner:!1,isWritable:!0},{pubkey:p.marketEventQueue,isSigner:!1,isWritable:!0},...p.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:p.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:p.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0}])}let d=Buffer.alloc(l.span);return l.encode({instruction:5},d),new _s({keys:m,programId:o,data:d})}function lf(o,e,t,n,r,i,s,a,u,c,l,m,d,p,y){var T;let f=[],b=[P({pubkey:vs,isWritable:!1}),P({pubkey:uf,isWritable:!1}),P({pubkey:cf,isWritable:!1}),P({pubkey:Fs.programId,isWritable:!1}),P({pubkey:e,isSigner:!0})];b.push(P({pubkey:t})),b.push(P({pubkey:r}));let g=[u,c],w=[l,m],A=[i,s,a];for(let S=0;S<g.length;S++){let x=g[S],R=A[S]===x.mintA.address;if(b.push(P({pubkey:new Q(x.programId),isWritable:!1})),S===g.length-1?b.push(P({pubkey:r})):b.push(P({pubkey:n})),b.push(P({pubkey:new Q(A[S])})),b.push(P({pubkey:new Q(A[S+1])})),x.version===6){let B=w[S];b.push(P({pubkey:new Q(B.config.id)})),b.push(P({pubkey:new Q(B.id)})),b.push(P({pubkey:new Q(R?B.vault.A:B.vault.B)})),b.push(P({pubkey:new Q(R?B.vault.B:B.vault.A)})),b.push(P({pubkey:new Q(x.observationId)})),b.push(P({pubkey:rr})),b.push(P({pubkey:mt(new Q(x.programId),new Q(x.id)).publicKey})),f.push(mf(x.sqrtPriceX64.toString(),R));for(let M of(T=y[S])!=null?T:[])b.push(P({pubkey:new Q(M)}))}else if(x.version===5){let B=w[S];b.push(P({pubkey:new Q(B.id)})),b.push(P({pubkey:new Q(B.authority),isWritable:!1})),b.push(P({pubkey:new Q(B.marketProgramId)})),b.push(P({pubkey:new Q(B.marketAuthority)})),b.push(P({pubkey:Fa,isWritable:!1})),b.push(P({pubkey:new Q(B.openOrders)})),b.push(P({pubkey:new Q(B.vault.A)})),b.push(P({pubkey:new Q(B.vault.B)})),b.push(P({pubkey:new Q(B.id)})),b.push(P({pubkey:new Q(B.id)})),b.push(P({pubkey:new Q(B.id)})),b.push(P({pubkey:new Q(B.id)})),b.push(P({pubkey:new Q(B.id)})),b.push(P({pubkey:new Q(B.id)})),b.push(P({pubkey:new Q(B.marketId)})),b.push(P({pubkey:new Q(B.marketBids)})),b.push(P({pubkey:new Q(B.marketAsks)})),b.push(P({pubkey:new Q(B.marketEventQueue)})),b.push(P({pubkey:new Q(B.marketBaseVault)})),b.push(P({pubkey:new Q(B.marketQuoteVault)}))}else if(x.version===4){let B=w[S],M=x.status!==1;b.push(P({pubkey:new Q(B.id)})),b.push(P({pubkey:new Q(B.authority),isWritable:!1})),b.push(P({pubkey:new Q(M?B.id:B.marketProgramId)})),b.push(P({pubkey:new Q(M?B.id:B.marketAuthority)})),b.push(P({pubkey:new Q(M?B.id:B.openOrders)})),b.push(P({pubkey:new Q(B.vault.A)})),b.push(P({pubkey:new Q(B.vault.B)})),b.push(P({pubkey:new Q(M?B.id:B.marketId)})),b.push(P({pubkey:new Q(M?B.id:B.marketBids)})),b.push(P({pubkey:new Q(M?B.id:B.marketAsks)})),b.push(P({pubkey:new Q(M?B.id:B.marketEventQueue)})),b.push(P({pubkey:new Q(M?B.id:B.marketBaseVault)})),b.push(P({pubkey:new Q(M?B.id:B.marketQuoteVault)}))}else if(x.version===7){let B=w[S];b.push(P({pubkey:new Q(B.authority)})),b.push(P({pubkey:new Q(B.config.id)})),b.push(P({pubkey:new Q(B.id)})),b.push(P({pubkey:new Q(R?B.vault.A:B.vault.B)})),b.push(P({pubkey:new Q(R?B.vault.B:B.vault.A)})),b.push(P({pubkey:new Q(x.observationId)}))}else throw Error("pool type error")}let k=v([W("insId"),h("amountIn"),h("amountOut"),X(J(),f.length,"clmmPriceLimit")]),I=Buffer.alloc(k.span);return k.encode({insId:0,amountIn:d,amountOut:p,clmmPriceLimit:f},I),new _s({keys:b,programId:o,data:I})}function mf(o,e){if(o)if(e){let t=new Sn(o).div(new Sn(25));return t.gt(Mr)?t:Mr}else{let t=new Sn(o).mul(new Sn(25));return t.lt(vr)?t:vr}else return e?Mr:vr}function hc({routeProgram:o,ownerInfo:e,inputMint:t,swapInfo:n}){var r,i,s,a,u,c,l;if(n.routeType==="amm")if(n.poolInfo[0].version===6){let m=n.poolKey[0],d=Ie(m),p=t.equals(d.mintA.address)?Pt.add(yt):ht.sub(yt);return Se.makeSwapBaseInInstructions({poolInfo:m,poolKeys:m,observationId:n.poolInfo[0].observationId,ownerInfo:{wallet:e.wallet,tokenAccountA:d.mintA.address.equals(t)?e.sourceToken:e.destinationToken,tokenAccountB:d.mintA.address.equals(t)?e.destinationToken:e.sourceToken},inputMint:t,amountIn:n.amountIn.amount.raw,amountOutMin:n.minAmountOut.amount.raw.sub((i=(r=n.minAmountOut.fee)==null?void 0:r.raw)!=null?i:new Sn(0)),sqrtPriceLimitX64:p,remainingAccounts:(s=n.remainingAccounts[0])!=null?s:[]})}else if(n.poolInfo[0].version===7){let m=n.poolInfo[0],d=t.toString()===n.poolInfo[0].mintA.address;return{signers:[],instructions:[Qr(m.programId,e.wallet,m.authority,m.configId,m.id,e.sourceToken,e.destinationToken,d?m.vaultA:m.vaultB,d?m.vaultB:m.vaultA,d?m.mintProgramA:m.mintProgramB,d?m.mintProgramB:m.mintProgramA,new Q(m[d?"mintA":"mintB"].address),new Q(m[d?"mintB":"mintA"].address),m.observationId,n.amountIn.amount.raw,n.minAmountOut.amount.raw)],lookupTableAddress:[],instructionTypes:[d?V.CpmmSwapBaseIn:V.CpmmSwapBaseOut],address:{}}}else{let m=n.poolKey[0];return{signers:[],instructions:[Rr({poolKeys:m,version:n.poolInfo[0].pooltype.includes("StablePool")?5:4,userKeys:{tokenAccountIn:e.sourceToken,tokenAccountOut:e.destinationToken,owner:e.wallet},amountIn:n.amountIn.amount.raw,amountOut:n.minAmountOut.amount.raw.sub((u=(a=n.minAmountOut.fee)==null?void 0:a.raw)!=null?u:new Sn(0)),fixedSide:"in"})],lookupTableAddress:m.lookupTableAccount?[m.lookupTableAccount]:[],instructionTypes:[n.poolInfo[0].pooltype.includes("StablePool")?V.AmmV5SwapBaseIn:V.AmmV4SwapBaseIn],address:{}}}else if(n.routeType==="route"){let m=n.poolInfo[0],d=n.poolInfo[1],p=n.poolKey[0],y=n.poolKey[1];if(e.routeToken===void 0)throw Error("owner route token account check error");return{signers:[],instructions:[lf(o,e.wallet,e.sourceToken,e.routeToken,e.destinationToken,t.toString(),n.middleToken.mint.toString(),n.outputMint.toString(),m,d,p,y,n.amountIn.amount.raw,n.minAmountOut.amount.raw.sub((l=(c=n.minAmountOut.fee)==null?void 0:c.raw)!=null?l:new Sn(0)),n.remainingAccounts)],instructionTypes:[V.RouteSwap],lookupTableAddress:[p.lookupTableAccount,y.lookupTableAccount].filter(f=>f!==void 0),address:{}}}else throw Error("route type error")}var kc={[Ar.toBase58()]:3},Tc={3:Ar};var Vs=v([ge(5),ge(8),K("ownAddress"),h("vaultSignerNonce"),K("baseMint"),K("quoteMint"),K("baseVault"),h("baseDepositsTotal"),h("baseFeesAccrued"),K("quoteVault"),h("quoteDepositsTotal"),h("quoteFeesAccrued"),h("quoteDustThreshold"),K("requestQueue"),K("eventQueue"),K("bids"),K("asks"),h("baseLotSize"),h("quoteLotSize"),h("feeRateBps"),h("referrerRebatesAccrued"),ge(7)]),Ic={3:Vs};import{PublicKey as Bc}from"@solana/web3.js";var Hr=ce("Serum"),Zr=class{static getProgramId(e){let t=Tc[e];return t||Hr.logWithError("invalid version","version",e),t}static getVersion(e){let t=e.toBase58(),n=kc[t];return n||Hr.logWithError("invalid program id","programId",t),n}static getStateLayout(e){let t=Ic[e];return t||Hr.logWithError(!!t,"invalid version","version",e),t}static getLayouts(e){return{state:this.getStateLayout(e)}}static getAssociatedAuthority({programId:e,marketId:t}){let n=[t.toBuffer()],r=0,i;for(;r<100;){try{let s=n.concat(Buffer.from([r]),Buffer.alloc(7));i=Bc.createProgramAddressSync(s,e)}catch(s){if(s instanceof TypeError)throw s;r++;continue}return{publicKey:i,nonce:r}}return Hr.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),{publicKey:Bc.default,nonce:r}}};var jt=new Jr(0),qo=class extends Ke{constructor(e){super(e)}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals(j));return e.sort((t,n)=>t.isAssociated?1:n.isAssociated||t.amount.lt(n.amount)?-1:1),e}async unWrapWSol(e){let{amount:t,tokenProgram:n,txVersion:r=1}=e,i=await this.getWSolAccounts(),s=this.createTxBuilder();s.addCustomComputeBudget(e.computeBudgetConfig);let a=await Gt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:0});s.addInstruction(a);let u=Y(t);for(let c=0;c<i.length;c++)u.gte(i[c].amount)?(s.addInstruction({instructions:[_t({tokenAccount:i[c].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),u.sub(i[c].amount)):(s.addInstruction({instructions:[_t({tokenAccount:i[c].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),po({destination:a.addresses.newAccount,source:i[c].publicKey,amount:u,owner:this.scope.ownerPubKey,tokenProgram:n}));return s.versionBuild({txVersion:r})}async wrapWSol(e,t,n){let r=await this.getWSolAccounts(),i=this.createTxBuilder(),s=await Gt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return i.addInstruction(s),r.length&&i.addInstruction({instructions:[po({destination:r[0].publicKey,source:s.addresses.newAccount,amount:e,owner:this.scope.ownerPubKey,tokenProgram:t})],endInstructions:[_t({tokenAccount:s.addresses.newAccount,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:t})]}),i.versionBuild({txVersion:n!=null?n:1})}async swap({swapInfo:e,swapPoolKeys:t,ownerInfo:n,computeBudgetConfig:r,routeProgram:i,txVersion:s}){let a=this.createTxBuilder(),u=e.amountIn,c=e.amountOut,l=u.amount.token.mint.equals(j),m=c.amount.token.mint.equals(j),d=u.amount.token.mint,p=c.amount.token.mint,{account:y,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.amount.token.isToken2022?$r:Re,mint:d,notUseTokenAccount:l,owner:this.scope.ownerPubKey,skipCloseAccount:!l,createInfo:l?{payer:this.scope.ownerPubKey,amount:u.amount.raw}:void 0,associatedOnly:l?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});if(f&&a.addInstruction(f),y===void 0)throw Error("input account check error");let b;if(e.routeType==="route")b=this.scope.account.getAssociatedTokenAccount(p,c.amount.token.isToken2022?$r:Re);else{let{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:c.amount.token.isToken2022?$r:Re,mint:p,notUseTokenAccount:m,owner:this.scope.ownerPubKey,skipCloseAccount:!0,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:m?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});b=k,I&&a.addInstruction(I)}m&&a.addInstruction({endInstructions:[_t({owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,tokenAccount:b,programId:Re})],endInstructionTypes:[V.CloseAccount]});let g;if(e.routeType==="route"){let k=e.middleToken;g=this.scope.account.getAssociatedTokenAccount(k.mint,k.isToken2022?$r:Re)}let w=t||await this.computePoolToPoolKeys({pools:e.poolInfoList}),A=hc({routeProgram:i,inputMint:d,swapInfo:E(C({},e),{poolInfo:[...e.poolInfoList],poolKey:w,outputMint:p}),ownerInfo:{wallet:this.scope.ownerPubKey,sourceToken:y,routeToken:g,destinationToken:b}});if(e.feeConfig!==void 0){let k=this.createTxBuilder();k.addInstruction({instructions:[xc(y,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[V.TransferAmount]}),k.addInstruction(A);let{transactions:I}=s===0?await k.sizeCheckBuildV0():await k.sizeCheckBuild();I.length<2&&a.addInstruction({instructions:[xc(y,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[V.TransferAmount]})}return a.addInstruction(A),s===0?a.sizeCheckBuildV0({computeBudgetConfig:r,address:A.address}):a.sizeCheckBuild({computeBudgetConfig:r,address:A.address})}async fetchRoutePoolBasicInfo(e){let{amm:t=Oi,clmm:n=Li,cpmm:r=Ni}=e||{},i=await this.scope.connection.getProgramAccounts(t,{dataSlice:{offset:So.offsetOf("baseMint"),length:64}}),s=v([K("baseMint"),K("quoteMint")]),a=i.map(p=>({id:p.pubkey,version:4,mintA:s.decode(p.account.data).baseMint,mintB:s.decode(p.account.data).quoteMint})),u=v([K("mintA"),K("mintB")]),l=(await this.scope.connection.getProgramAccounts(n,{filters:[{dataSize:In.span}],dataSlice:{offset:In.offsetOf("mintA"),length:64}})).map(p=>{let y=u.decode(p.account.data);return{id:p.pubkey,version:6,mintA:y.mintA,mintB:y.mintB}}),d=(await this.scope.connection.getProgramAccounts(r,{dataSlice:{offset:Yr.offsetOf("mintA"),length:64}})).map(p=>{let y=u.decode(p.account.data);return{id:p.pubkey,version:7,mintA:y.mintA,mintB:y.mintB}});return{clmmPools:l,ammPools:a,cpmmPools:d}}getAllRoute({inputMint:e,outputMint:t,clmmPools:n,ammPools:r,cpmmPools:i}){e=e.toString()===Kn.default.toString()?j:e,t=t.toString()===Kn.default.toString()?j:t;let s={},a={},u={},c=[],l={};for(let d of n!=null?n:[]){if((d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(c.push(d),a[d.id.toString()]=d),d.mintA.equals(e)){let p=d.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[p].in.push(d)}if(d.mintB.equals(e)){let p=d.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[p].in.push(d)}if(d.mintA.equals(t)){let p=d.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[p].out.push(d)}if(d.mintB.equals(t)){let p=d.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[p].out.push(d)}}let m=[];for(let d of r)(d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(c.push(d),s[d.id.toBase58()]=d,m.push(d)),d.mintA.equals(e)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].in.push(d)),d.mintB.equals(e)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].in.push(d)),d.mintA.equals(t)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].out.push(d)),d.mintB.equals(t)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].out.push(d));for(let d of i)(d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(c.push(d),u[d.id.toBase58()]=d),d.mintA.equals(e)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].in.push(d)),d.mintB.equals(e)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].in.push(d)),d.mintA.equals(t)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].out.push(d)),d.mintB.equals(t)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].out.push(d));for(let d of Object.keys(l)){if(l[d].in.length===1&&l[d].out.length===1&&l[d].in[0].id.equals(l[d].out[0].id)){delete l[d];continue}if(l[d].in.length===0||l[d].out.length===0){delete l[d];continue}let p=l[d];for(let y of p.in)for(let f of p.out)y.version===6&&a[y.id.toString()]===void 0?a[y.id.toString()]=y:y.version===7&&u[y.id.toString()]===void 0?u[y.id.toString()]=y:(y.version===4||y.version===5)&&s[y.id.toString()]===void 0&&(s[y.id.toString()]=y),f.version===6&&a[f.id.toString()]===void 0?a[f.id.toString()]=f:f.version===7&&u[f.id.toString()]===void 0?u[f.id.toString()]=f:(f.version===4||f.version===5)&&s[f.id.toString()]===void 0&&(s[f.id.toString()]=f)}return{directPath:c,addLiquidityPools:m,routePathDict:l,needSimulate:Object.values(s),needTickArray:Object.values(a),cpmmPoolList:Object.values(u)}}async fetchSwapRoutesData({routes:e,inputMint:t,outputMint:n}){let r=new Set([...e.needTickArray.map(f=>[f.mintA.toBase58(),f.mintB.toBase58()]).flat(),t.toString(),n.toString()]);console.log("fetching amm pools info, total: ",e.needSimulate.length);let i=await this.scope.liquidity.getRpcPoolInfos(e.needSimulate.map(f=>f.id)),s=Dr(i),a={};Object.values(s).forEach(f=>{r.delete(f.mintA.address),a[f.mintA.address]={address:new Kn(f.mintA.address),programId:Re,mintAuthority:null,supply:BigInt(0),decimals:f.mintA.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0},r.delete(f.mintB.address),a[f.mintB.address]={address:new Kn(f.mintB.address),programId:Re,mintAuthority:null,supply:BigInt(0),decimals:f.mintB.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}}),console.log("fetching cpmm pools info, total: ",e.cpmmPoolList.length);let u=await this.scope.cpmm.getRpcPoolInfos(e.cpmmPoolList.map(f=>f.id.toBase58()),!0);Object.values(u).forEach(f=>{let[b,g]=[f.mintA.toBase58(),f.mintB.toBase58()];f.mintProgramA.equals(Re)?(r.delete(b),a[b]={address:f.mintA,programId:f.mintProgramA,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalA,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):r.add(b),f.mintProgramB.equals(Re)?(r.delete(g),a[g]={address:f.mintB,programId:f.mintProgramB,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalB,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):r.add(g)}),console.log("fetching mints info, total: ",r.size);let c=await Fn({connection:this.scope.connection,mints:Array.from(r).map(f=>new Kn(f))});a=C(C({},a),c);let l=this.scope.cpmm.toComputePoolInfos({pools:u,mintInfos:a});console.log("fetching clmm pools info, total:",e.needTickArray.length);let m=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:e.needTickArray.map(f=>f.id)}),{computeClmmPoolInfo:d,computePoolTickData:p}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:m,mintInfos:a}),y=Object.keys(e.routePathDict).reduce((f,b)=>E(C({},f),{[b]:E(C({},e.routePathDict[b]),{mintProgram:a[b].programId,mDecimals:a[b].decimals,in:e.routePathDict[b].in.map(g=>s[g.id.toBase58()]||d[g.id.toBase58()]||l[g.id.toBase58()]),out:e.routePathDict[b].out.map(g=>s[g.id.toBase58()]||d[g.id.toBase58()]||l[g.id.toBase58()])})}),{});return{mintInfos:a,ammPoolsRpcInfo:i,ammSimulateCache:s,clmmPoolsRpcInfo:m,computeClmmPoolInfo:d,computePoolTickData:p,computeCpmmData:l,routePathDict:y}}getAllRouteComputeAmountOut({inputTokenAmount:e,outputToken:t,directPath:n,routePathDict:r,simulateCache:i,tickCache:s,slippage:a,chainTime:u,epochInfo:c,feeConfig:l}){var g,w,A,k,I,T,S,x,R;let m=l===void 0?new Jr(0):e.raw.mul(new Jr(l.feeBps.toNumber())).div(new Jr(1e4)),d=e.raw.sub(m),p=new fe(e.token,d),y=l===void 0?void 0:{feeAmount:m,feeAccount:l.feeAccount},f=E(C({},t),{address:pt(t.address).toString()}),b=[];for(let B of n)try{b.push(E(C({},this.computeAmountOut({itemPool:B,tickCache:s,simulateCache:i,chainTime:u,epochInfo:c,slippage:a,outputToken:f,amountIn:p})),{feeConfig:y}))}catch(M){this.logDebug("direct error",B.version,B.id.toString(),M.message)}this.logDebug("direct done");for(let[B,M]of Object.entries(r)){let D={chainId:101,address:B,programId:M.mintProgram.toBase58(),logoURI:"",symbol:"",name:"",decimals:M.mDecimals,tags:[],extensions:{}},F=M.in.map(G=>{try{return{pool:G,data:this.computeAmountOut({itemPool:G,tickCache:s,simulateCache:i,chainTime:u,epochInfo:c,slippage:a,outputToken:D,amountIn:p})}}catch(q){this.logDebug("route in error",G.version,G.id.toString(),q.message);return}}).sort((G,q)=>{var mn,Ht,On,Vt;let ot=G===void 0?jt:G.data.amountOut.amount.raw.sub((Ht=(mn=G.data.amountOut.fee)==null?void 0:mn.raw)!=null?Ht:jt),Rn=q===void 0?jt:q.data.amountOut.amount.raw.sub((Vt=(On=q.data.amountOut.fee)==null?void 0:On.raw)!=null?Vt:jt);return ot.lt(Rn)?1:-1})[0];if(F===void 0)continue;let Z=new fe(Cr(D),F.data.amountOut.amount.raw.sub((w=(g=F.data.amountOut.fee)==null?void 0:g.raw)!=null?w:jt));for(let G of M.out)try{let q=this.computeAmountOut({itemPool:G,tickCache:s,simulateCache:i,chainTime:u,epochInfo:c,slippage:a,outputToken:f,amountIn:Z});b.push(E(C({},q),{allTrade:!!(F.data.allTrade&&q.allTrade),amountIn:F.data.amountIn,amountOut:q.amountOut,minAmountOut:q.minAmountOut,currentPrice:void 0,executionPrice:new O(new Ue({baseToken:F.data.amountIn.amount.token,denominator:F.data.amountIn.amount.raw,quoteToken:q.amountOut.amount.token,numerator:q.amountOut.amount.raw.sub((k=(A=q.amountOut.fee)==null?void 0:A.raw)!=null?k:jt)}).toFixed()),priceImpact:new O(F.data.priceImpact.add(q.priceImpact).toFixed()),fee:[F.data.fee[0],q.fee[0]],routeType:"route",poolInfoList:[F.pool,G],remainingAccounts:[F.data.remainingAccounts[0],q.remainingAccounts[0]],minMiddleAmountFee:(I=q.amountOut.fee)!=null&&I.raw?new fe(F.data.amountOut.amount.token,((S=(T=F.data.amountOut.fee)==null?void 0:T.raw)!=null?S:jt).add((R=(x=q.amountOut.fee)==null?void 0:x.raw)!=null?R:jt)):void 0,middleToken:F.data.amountOut.amount.token,poolReady:F.data.poolReady&&q.poolReady,poolType:[F.data.poolType,q.poolType],feeConfig:y,expirationTime:Kt(F.data.expirationTime,q.expirationTime)}))}catch(q){this.logDebug("route out error",G.version,G.id.toString(),q.message)}}return b.filter(B=>(B.allTrade||this.logDebug(`pool ${B.poolInfoList.map(M=>M.id.toString()).join(",")} filter out since not all trade`),B.allTrade)).sort((B,M)=>B.amountOut.amount.raw.sub(M.amountOut.amount.raw).gt(jt)?-1:1)}computeAmountOut({itemPool:e,tickCache:t,simulateCache:n,chainTime:r,epochInfo:i,slippage:s,outputToken:a,amountIn:u}){if(e.version===6){let{allTrade:c,realAmountIn:l,amountOut:m,minAmountOut:d,expirationTime:p,currentPrice:y,executionPrice:f,priceImpact:b,fee:g,remainingAccounts:w,executionPriceX64:A}=Ce.computeAmountOutFormat({poolInfo:e,tickArrayCache:t[e.id.toString()],amountIn:u.raw,tokenOut:a,slippage:s,epochInfo:i,catchLiquidityInsufficient:!0});return{allTrade:c,amountIn:l,amountOut:m,minAmountOut:d,currentPrice:new O(y.toFixed()),executionPrice:new O(f.toFixed()),priceImpact:new O(b.toFixed()),fee:[g],remainingAccounts:[w],routeType:"amm",poolInfoList:[e],poolReady:e.startTime<r,poolType:"CLMM",slippage:s,clmmExPriceX64:[A],expirationTime:Kt(l.expirationTime,p)}}else if(e.version===7){let{allTrade:c,executionPrice:l,amountOut:m,minAmountOut:d,priceImpact:p,fee:y}=this.scope.cpmm.computeSwapAmount({pool:e,outputMint:a.address,amountIn:u.raw,slippage:s});return{allTrade:c,amountIn:{amount:u,fee:void 0,expirationTime:void 0},amountOut:{amount:xo(E(C({},a),{amount:m})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:xo(E(C({},a),{amount:d})),fee:void 0,expirationTime:void 0},currentPrice:e.poolPrice,executionPrice:l,priceImpact:p,fee:[new fe(u.token,y)],remainingAccounts:[],routeType:"amm",poolInfoList:[e],poolReady:e.openTime.toNumber()<r,poolType:"CPMM",slippage:s,clmmExPriceX64:[void 0],expirationTime:void 0}}else{if(![1,6,7].includes(n[e.id.toString()].status))throw Error("swap error");let{amountOut:c,minAmountOut:l,currentPrice:m,executionPrice:d,priceImpact:p,fee:y}=this.scope.liquidity.computeAmountOut({poolInfo:n[e.id.toString()],amountIn:u.raw,mintIn:u.token.mint,mintOut:a.address,slippage:s});return{amountIn:{amount:u,fee:void 0,expirationTime:void 0},amountOut:{amount:xo(E(C({},a),{amount:c})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:xo(E(C({},a),{amount:l})),fee:void 0,expirationTime:void 0},currentPrice:m,executionPrice:d,priceImpact:p,fee:[new fe(u.token,y)],routeType:"amm",poolInfoList:[e],remainingAccounts:[],poolReady:Number(n[e.id].openTime)<r,poolType:e.version===5?"STABLE":void 0,expirationTime:void 0,allTrade:!0,slippage:s,clmmExPriceX64:[void 0]}}}async computePoolToPoolKeys({pools:e,clmmRpcData:t={},ammRpcData:n={}}){let r=new Set(e.filter(c=>c.version===6&&!t[c.id.toString()]).map(c=>c.id.toString()));if(r.size>0){let c=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:Array.from(r)});Object.keys(c).forEach(l=>{t[l]=c[l]})}if(new Set(e.filter(c=>c.version===4&&!n[c.id.toString()]).map(c=>c.id.toString())).size>0){let c=await this.scope.liquidity.getRpcPoolInfos(Array.from(r));Object.keys(c).forEach(l=>{n[l]=c[l]})}let s=new Set(e.filter(c=>c.version===4).map(c=>c.marketId)),a={};s.size>0&&(await We(this.scope.connection,Array.from(s).map(l=>({pubkey:new Kn(l)})))).forEach(l=>{if(!l.accountInfo)return;let m=Vs.decode(l.accountInfo.data);a[l.pubkey.toBase58()]={marketId:l.pubkey.toString(),marketProgramId:l.accountInfo.owner.toString(),marketAuthority:Zr.getAssociatedAuthority({programId:l.accountInfo.owner,marketId:l.pubkey}).publicKey.toString(),marketBaseVault:m.baseVault.toString(),marketQuoteVault:m.quoteVault.toString(),marketBids:m.bids.toString(),marketAsks:m.asks.toString(),marketEventQueue:m.eventQueue.toString()}});let u=[];return e.forEach(c=>{if(c.version===6){let l=t[c.id.toString()],m={programId:c.programId.toBase58(),id:c.id.toBase58(),mintA:c.mintA,mintB:c.mintB,openTime:String(c.startTime),vault:{A:l.vaultA.toBase58(),B:l.vaultB.toBase58()},config:E(C({},c.ammConfig),{id:c.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]}),rewardInfos:[]};u.push(m)}else if(c.version===4){let l=n[c.id.toString()],m=C({programId:c.programId,id:c.id,mintA:c.mintA,mintB:c.mintB,openTime:String(c.openTime),vault:{A:l.baseVault.toBase58(),B:l.quoteVault.toBase58()},authority:Os({programId:new Kn(c.programId)}).publicKey.toString(),openOrders:l.openOrders.toBase58(),targetOrders:l.targetOrders.toBase58(),mintLp:c.lpMint},a[c.marketId]);u.push(m)}else c.version===7&&u.push({programId:c.programId.toBase58(),id:c.id.toBase58(),mintA:c.mintA,mintB:c.mintB,openTime:String(c.openTime),authority:jn(c.programId).publicKey.toBase58(),vault:{A:c.vaultA.toBase58(),B:c.vaultB.toBase58()},mintLp:it({address:c.mintLp.toBase58(),programId:Re.toBase58(),decimals:c.lpDecimals}),config:E(C({id:c.configId.toBase58()},c.configInfo),{protocolFeeRate:c.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:c.configInfo.tradeFeeRate.toNumber(),fundFeeRate:c.configInfo.fundFeeRate.toNumber(),createPoolFee:c.configInfo.createPoolFee.toString()})})}),u}};import{TOKEN_PROGRAM_ID as df}from"@solana/spl-token";import{PublicKey as pf,Transaction as Es,TransactionInstruction as ff}from"@solana/web3.js";import Sc from"bn.js";var nt=class extends Ke{static getPdaPoolId(e,t){return ue([nt.SEED_CONFIG.pool.id,t.toBuffer()],e)}static getPdaOwnerId(e,t,n,r){return ue([nt.SEED_CONFIG.owner.id,t.toBuffer(),n.toBuffer(),Buffer.from(new Sc(r).toArray())],e)}static async getAllInfo({connection:e,programId:t,poolIds:n,wallet:r,chainTime:i}){if(n.length===0)return[];let s=n.map(l=>nt.getPdaPoolId(t,l).publicKey),a=[];for(let l=0;l<nt.VERSION_PROJECT.length;l++)a.push(...s.map(m=>nt.getPdaOwnerId(t,m,r,l).publicKey));let u=await Bt(e,[...s,...a]),c=[];for(let l=0;l<u.length;l++){let m=Math.floor(l/n.length),d=l%n.length,p=s[d],y=a[l],f=u[d],b=u[n.length+l];if(!(f&&b)||f.data.length!==nt.POOL_LAYOUT.span||b.data.length!==nt.OWNER_LAYOUT.span)continue;let g=nt.POOL_LAYOUT.decode(f.data),w=nt.OWNER_LAYOUT.decode(b.data),A=g.openTime.toNumber(),k=g.endTime.toNumber(),I=w.tokenInfo.map(x=>x.debtAmount.gt(new Sc(0))).filter(x=>!x).length!==3,T=i>A&&i<k&&g.status===1,S=I&&T;c.push({programId:t,poolId:p,ammId:g.ammId,ownerAccountId:y,snapshotLpAmount:w.lpAmount,project:nt.VERSION_PROJECT[m],openTime:A,endTime:k,canClaim:S,canClaimErrorType:I?T?void 0:"outOfOperationalTime":"alreadyClaimIt",tokenInfo:g.tokenInfo.map((x,R)=>({mintAddress:x.mintAddress,mintVault:x.mintVault,mintDecimals:x.mintDecimals,perLpLoss:x.perLpLoss,debtAmount:w.tokenInfo[R].debtAmount.add(w.tokenInfo[R].claimedAmount)}))})}return c}async makeClaimTransaction({poolInfo:e,ownerInfo:t}){t.wallet||this.scope.checkOwner();let n=this.createTxBuilder(),r=t.wallet||this.scope.ownerPubKey,i=[];for(let u of e.tokenInfo){let{account:c,instructionParams:l}=await this.scope.account.getOrCreateTokenAccount({mint:u.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:u.mintAddress.equals(ye.WSOL.mint),createInfo:{payer:r,amount:0},skipCloseAccount:!u.mintAddress.equals(ye.WSOL.mint),associatedOnly:u.mintAddress.equals(ye.WSOL.mint)?!1:t.associatedOnly});l&&n.addInstruction(l),i.push(c)}n.addInstruction({instructions:[nt.makeClaimInstruction({programId:e.programId,poolInfo:e,ownerInfo:{wallet:r,ownerPda:e.ownerAccountId,claimAddress:i}})]});let{transaction:s,signers:a}=n.build();return[{transaction:s,signer:a}]}async makeClaimAllTransaction({poolInfos:e,ownerInfo:t}){let n=this.createTxBuilder(),r=t.wallet||this.scope.ownerPubKey,i={};for(let c of e){let l=[];for(let m of c.tokenInfo){let{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({mint:m.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:m.mintAddress.equals(ye.WSOL.mint),createInfo:{payer:r,amount:0},skipCloseAccount:!m.mintAddress.equals(ye.WSOL.mint),associatedOnly:m.mintAddress.equals(ye.WSOL.mint)?!1:t.associatedOnly});p&&n.addInstruction(p),d&&(i[m.mintAddress.toString()]=d,l.push(d))}n.addInstruction({instructions:[nt.makeClaimInstruction({programId:c.programId,poolInfo:c,ownerInfo:{wallet:r,ownerPda:c.ownerAccountId,claimAddress:l}})]})}let{transaction:s,signers:a}=n.build(),u=n.allInstructions;return fr(u,[r,...a.map(c=>c.publicKey)])?[{transaction:s,signer:a}]:[{transaction:new Es().add(...u.slice(0,n.AllTxData.instructions.length-1)),signer:a},{transaction:new Es().add(...u.slice(n.AllTxData.instructions.length-1)),signer:[]},{transaction:new Es().add(...n.AllTxData.endInstructions),signer:[]}]}static makeClaimInstruction({programId:e,poolInfo:t,ownerInfo:n}){let r=v([]),i=[{pubkey:n.wallet,isSigner:!0,isWritable:!0},{pubkey:t.poolId,isSigner:!1,isWritable:!0},{pubkey:n.ownerPda,isSigner:!1,isWritable:!0},...n.claimAddress.map(u=>({pubkey:u,isSigner:!1,isWritable:!0})),...t.tokenInfo.map(({mintVault:u})=>({pubkey:u,isSigner:!1,isWritable:!0})),{pubkey:df,isSigner:!1,isWritable:!1}],s=Buffer.alloc(r.span);r.encode({},s);let a=Buffer.from([10,66,208,184,161,6,191,98,...s]);return new ff({keys:i,programId:e,data:a})}},kt=nt;kt.CLAIMED_NUM=3,kt.POOL_LAYOUT=v([ge(8),W("bump"),W("status"),h("openTime"),h("endTime"),K("ammId"),X(v([W("mintDecimals"),K("mintAddress"),K("mintVault"),h("perLpLoss"),h("totalClaimedAmount")]),nt.CLAIMED_NUM,"tokenInfo"),X(h(),10,"padding")]),kt.OWNER_LAYOUT=v([ge(8),W("bump"),W("version"),K("poolId"),K("owner"),h("lpAmount"),X(v([K("mintAddress"),h("debtAmount"),h("claimedAmount")]),nt.CLAIMED_NUM,"tokenInfo"),X(h(),4,"padding")]),kt.DEFAULT_POOL_ID=["58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2","6UmmUiYoBjSrhakAobJw8BvkmJtDVxaeBtbt7rxWo1mg","AVs9TA4nWDzfPJE9gGVNJMVhcQy3V9PGazuz33BfG2RA","DVa7Qmb5ct9RCpaU7UTpSaf3GVMYz17vNVU67XpdCRut","7XawhbbxtsRcQA8KTkHT9f9nc6d69UwqCDh6U5EEbEmX","6a1CsrpeZubDjEJE9s1CMVheB6HWM5d7m1cj2jkhyXhj","EoNrn8iUhwgJySD1pHu8Qxm5gSQqLK3za4m8xzD2RuEb","AceAyRTWt4PyB2pHqf2qhDgNZDtKVNaxgL8Ru3V4aN1P","6tmFJbMk5yVHFcFy7X2K8RwHjKLr6KVFLYXpgpBNeAxB"].map(e=>new pf(e)),kt.SEED_CONFIG={pool:{id:Buffer.from("pool_seed","utf8")},owner:{id:Buffer.from("user_claim_seed","utf8")}},kt.VERSION_PROJECT=[void 0,"Francium","Tulip","Larix"];import{PublicKey as Uo}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Lc}from"@solana/spl-token";import Go from"bn.js";import{TransactionInstruction as bf,SYSVAR_RENT_PUBKEY as gf}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Kc}from"@solana/spl-token";import{createInitializeAccountInstruction as Cc}from"@solana/spl-token";import{SystemProgram as Cn,Transaction as Rc}from"@solana/web3.js";function yf(o="accountFlags"){let e=new Tr(o);return e.addBoolean("initialized"),e.addBoolean("market"),e.addBoolean("openOrders"),e.addBoolean("requestQueue"),e.addBoolean("eventQueue"),e.addBoolean("bids"),e.addBoolean("asks"),e}var Ds=v([ge(5),yf("accountFlags"),K("ownAddress"),h("vaultSignerNonce"),K("baseMint"),K("quoteMint"),K("baseVault"),h("baseDepositsTotal"),h("baseFeesAccrued"),K("quoteVault"),h("quoteDepositsTotal"),h("quoteFeesAccrued"),h("quoteDustThreshold"),K("requestQueue"),K("eventQueue"),K("bids"),K("asks"),h("baseLotSize"),h("quoteLotSize"),h("feeRateBps"),h("referrerRebatesAccrued"),ge(7)]);function Af({programId:o,marketInfo:e}){let t=v([W("version"),Ye("instruction"),h("baseLotSize"),h("quoteLotSize"),qt("feeRateBps"),h("vaultSignerNonce"),h("quoteDustThreshold")]),n=[{pubkey:e.id,isSigner:!1,isWritable:!0},{pubkey:e.requestQueue,isSigner:!1,isWritable:!0},{pubkey:e.eventQueue,isSigner:!1,isWritable:!0},{pubkey:e.bids,isSigner:!1,isWritable:!0},{pubkey:e.asks,isSigner:!1,isWritable:!0},{pubkey:e.baseVault,isSigner:!1,isWritable:!0},{pubkey:e.quoteVault,isSigner:!1,isWritable:!0},{pubkey:e.baseMint,isSigner:!1,isWritable:!1},{pubkey:e.quoteMint,isSigner:!1,isWritable:!1},{pubkey:e.authority?e.quoteMint:gf,isSigner:!1,isWritable:!1}].concat(e.authority?{pubkey:e.authority,isSigner:!1,isWritable:!1}:[]).concat(e.authority&&e.pruneAuthority?{pubkey:e.pruneAuthority,isSigner:!1,isWritable:!1}:[]),r=Buffer.alloc(t.span);return t.encode({version:0,instruction:0,baseLotSize:e.baseLotSize,quoteLotSize:e.quoteLotSize,feeRateBps:e.feeRateBps,vaultSignerNonce:e.vaultSignerNonce,quoteDustThreshold:e.quoteDustThreshold},r),new bf({keys:n,programId:o,data:r})}async function Oc({connection:o,wallet:e,marketInfo:t}){var s,a,u,c,l,m,d,p;let n=new Rc,r=await o.getMinimumBalanceForRentExemption(165);n.add(Cn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.baseVault.seed,newAccountPubkey:t.baseVault.publicKey,lamports:r,space:165,programId:Kc}),Cn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.quoteVault.seed,newAccountPubkey:t.quoteVault.publicKey,lamports:r,space:165,programId:Kc}),Cc(t.baseVault.publicKey,t.baseMint,t.vaultOwner),Cc(t.quoteVault.publicKey,t.quoteMint,t.vaultOwner));let i=new Rc;return i.add(Cn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.id.seed,newAccountPubkey:t.id.publicKey,lamports:await o.getMinimumBalanceForRentExemption(Ds.span),space:Ds.span,programId:t.programId}),Cn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.requestQueue.seed,newAccountPubkey:t.requestQueue.publicKey,lamports:await o.getMinimumBalanceForRentExemption((s=t.requestQueueSpace)!=null?s:5120+12),space:(a=t.requestQueueSpace)!=null?a:5120+12,programId:t.programId}),Cn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.eventQueue.seed,newAccountPubkey:t.eventQueue.publicKey,lamports:await o.getMinimumBalanceForRentExemption((u=t.eventQueueSpace)!=null?u:262144+12),space:(c=t.eventQueueSpace)!=null?c:262144+12,programId:t.programId}),Cn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.bids.seed,newAccountPubkey:t.bids.publicKey,lamports:await o.getMinimumBalanceForRentExemption((l=t.orderbookQueueSpace)!=null?l:65536+12),space:(m=t.orderbookQueueSpace)!=null?m:65536+12,programId:t.programId}),Cn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.asks.seed,newAccountPubkey:t.asks.publicKey,lamports:await o.getMinimumBalanceForRentExemption((d=t.orderbookQueueSpace)!=null?d:65536+12),space:(p=t.orderbookQueueSpace)!=null?p:65536+12,programId:t.programId}),Af({programId:t.programId,marketInfo:{id:t.id.publicKey,requestQueue:t.requestQueue.publicKey,eventQueue:t.eventQueue.publicKey,bids:t.bids.publicKey,asks:t.asks.publicKey,baseVault:t.baseVault.publicKey,quoteVault:t.quoteVault.publicKey,baseMint:t.baseMint,quoteMint:t.quoteMint,baseLotSize:t.baseLotSize,quoteLotSize:t.quoteLotSize,feeRateBps:t.feeRateBps,vaultSignerNonce:t.vaultSignerNonce,quoteDustThreshold:t.quoteDustThreshold}})),[{transaction:n,signer:[],instructionTypes:[V.CreateAccount,V.CreateAccount,V.InitAccount,V.InitAccount]},{transaction:i,signer:[],instructionTypes:[V.CreateAccount,V.CreateAccount,V.CreateAccount,V.CreateAccount,V.CreateAccount,V.InitMarket]}]}var Hn=class extends Ke{async create({baseInfo:e,quoteInfo:t,lotSize:n,tickSize:r,dexProgramId:i,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:u,txVersion:c,computeBudgetConfig:l}){let m=this.scope.ownerPubKey,d=ct({fromPublicKey:m,programId:i}),p=ct({fromPublicKey:m,programId:i}),y=ct({fromPublicKey:m,programId:i}),f=ct({fromPublicKey:m,programId:i}),b=ct({fromPublicKey:m,programId:i}),g=ct({fromPublicKey:m,programId:Lc}),w=ct({fromPublicKey:m,programId:Lc}),A=0,k=new Go(100);function I(){let D=new Go(0);for(;;)try{return{vaultOwner:Uo.createProgramAddressSync([d.publicKey.toBuffer(),D.toArrayLike(Buffer,"le",8)],i),vaultSignerNonce:D}}catch{if(D.iaddn(1),D.gt(new Go(25555)))throw Error("find vault owner error")}}let{vaultOwner:T,vaultSignerNonce:S}=I(),x=new Go(Math.round(10**e.decimals*n)),R=new Go(Math.round(n*10**t.decimals*r));if(x.eq(De))throw Error("lot size is too small");if(R.eq(De))throw Error("tick size or lot size is too small");let B=await Oc({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:i,id:d,baseMint:e.mint,quoteMint:t.mint,baseVault:g,quoteVault:w,vaultOwner:T,requestQueue:p,eventQueue:y,bids:f,asks:b,feeRateBps:A,quoteDustThreshold:k,vaultSignerNonce:S,baseLotSize:x,quoteLotSize:R,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:u}}),M=this.createTxBuilder();M.addInstruction({instructions:B[0].transaction.instructions,signers:B[0].signer});for await(let D of B.slice(1,B.length))M.addInstruction({instructions:D.transaction.instructions,signers:D.signer,instructionTypes:D.instructionTypes});return c===0?M.sizeCheckBuildV0({computeBudgetConfig:l,address:{marketId:d.publicKey,requestQueue:p.publicKey,eventQueue:y.publicKey,bids:f.publicKey,asks:b.publicKey,baseVault:g.publicKey,quoteVault:w.publicKey,baseMint:new Uo(e.mint),quoteMin:new Uo(t.mint)}}):M.sizeCheckBuild({computeBudgetConfig:l,address:{marketId:d.publicKey,requestQueue:p.publicKey,eventQueue:y.publicKey,bids:f.publicKey,asks:b.publicKey,baseVault:g.publicKey,quoteVault:w.publicKey,baseMint:new Uo(e.mint),quoteMin:new Uo(t.mint)}})}};import{PublicKey as zo}from"@solana/web3.js";import{TransactionInstruction as qs,SYSVAR_CLOCK_PUBKEY as wf}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Us}from"@solana/spl-token";var Ws=v([W("instruction"),za("amount")]),Xo=v([W("instruction")]);function _0({programId:o,amount:e,instructionKeys:t}){let n=[{pubkey:sr,isSigner:!1,isWritable:!1},{pubkey:Us,isSigner:!1,isWritable:!1},{pubkey:ut,isSigner:!1,isWritable:!1},{pubkey:yi,isSigner:!1,isWritable:!1},...Object.entries(t).map(([i,s])=>({pubkey:s,isSigner:i==="userOwner",isWritable:!["authority","userOwner","userIdoCheck","userStakeInfo"].includes(i)}))],r=Buffer.alloc(Ws.span);return Ws.encode({instruction:1,amount:Number(e)},r),new qs({keys:n,programId:o,data:r})}function ei({programId:o},e){let t=[{pubkey:Us,isSigner:!1,isWritable:!1},{pubkey:yi,isSigner:!1,isWritable:!1},...Object.entries(e).map(([r,i])=>({pubkey:i,isSigner:r==="userOwner",isWritable:!["authority","userOwner"].includes(r)}))],n=Buffer.alloc(Xo.span);return Xo.encode({instruction:2},n),new qs({keys:t,programId:o,data:n})}function Gs(o){let{poolConfig:e,userKeys:t,side:n}=o,r=n==="base"?t.baseTokenAccount:t.quoteTokenAccount,i=n==="base"?e.baseVault:e.quoteVault,s=Buffer.alloc(Xo.span);Xo.encode({instruction:2},s);let a=[{pubkey:Us,isWritable:!1,isSigner:!1},{pubkey:wf,isWritable:!1,isSigner:!1},{pubkey:e.id,isWritable:!0,isSigner:!1},{pubkey:e.authority,isWritable:!1,isSigner:!1},{pubkey:i,isWritable:!0,isSigner:!1},{pubkey:r,isWritable:!0,isSigner:!1},{pubkey:t.ledgerAccount,isWritable:!0,isSigner:!1},{pubkey:t.owner,isWritable:!1,isSigner:!0}];return new qs({programId:e.programId,keys:a,data:s})}import Nc from"bn.js";var Pf={[co.IDO_PROGRAM_ID_V1.toString()]:1,[co.IDO_PROGRAM_ID_V2.toString()]:2,[co.IDO_PROGRAM_ID_V3.toString()]:3,[co.IDO_PROGRAM_ID_V4.toString()]:4},Zn=class extends Ke{async claim({ownerInfo:e,idoKeys:t,associatedOnly:n=!0,checkCreateATAOwner:r=!1,txVersion:i}){let s=this.createTxBuilder(),a=Pf[t.programId];a||this.logAndCreateError("invalid version",a);let u=Ie(t),[c,l]=[!new Nc(e.coin).isZero(),!new Nc(e.pc).isZero()],m=u.projectInfo.mint.address.equals(j),{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.projectInfo.mint.programId,mint:u.projectInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!m,notUseTokenAccount:m,associatedOnly:m?!1:n,checkCreateATAOwner:r});!d&&c&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),c&&p&&s.addInstruction(p);let y=u.buyInfo.mint.address.equals(j),{account:f,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.buyInfo.mint.programId,mint:u.buyInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!y,notUseTokenAccount:y,associatedOnly:y?!1:n,checkCreateATAOwner:r});if(!d&&l&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),l&&b&&s.addInstruction(b),(!d||!f)&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address,t.buyInfo.mint.address),a===3)return s.addInstruction({instructions:[...c?[ei({programId:u.programId},{idoId:u.id,authority:u.authority,poolTokenAccount:u.projectInfo.vault,userTokenAccount:d,userIdoInfo:new zo(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[],...l?[ei({programId:new zo(t.programId)},{idoId:u.id,authority:u.authority,poolTokenAccount:u.buyInfo.vault,userTokenAccount:f,userIdoInfo:new zo(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[]]}).versionBuild({txVersion:i});if(a<3)return!c&&!l&&this.logAndCreateError("no claimable rewards"),s.addInstruction({instructions:[ei({programId:u.programId},{idoId:u.id,authority:u.authority,poolQuoteTokenAccount:u.buyInfo.vault,poolBaseTokenAccount:u.projectInfo.vault,userQuoteTokenAccount:f,userBaseTokenAccount:d,userIdoInfo:new zo(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]}).versionBuild({txVersion:i});let g={poolConfig:{id:u.id,programId:u.programId,authority:u.authority,baseVault:u.projectInfo.vault,quoteVault:u.buyInfo.vault,baseToken:t.projectInfo.mint,quoteToken:t.buyInfo.mint},userKeys:{baseTokenAccount:d,quoteTokenAccount:f,ledgerAccount:new zo(e.userIdoInfo),owner:this.scope.ownerPubKey}};return s.addInstruction({instructions:[...c?[Gs(E(C({},g),{side:"base"}))]:[],...l?[Gs(E(C({},g),{side:"quote"}))]:[]]}).versionBuild({txVersion:i})}};import{PublicKey as hf}from"@solana/web3.js";import{MintLayout as kf,TOKEN_2022_PROGRAM_ID as Xs,TOKEN_PROGRAM_ID as zs}from"@solana/spl-token";var Qo=class extends Ke{constructor(t){super(t);this._tokenList=[];this._tokenMap=new Map;this._blackTokenMap=new Map;this._mintGroup={official:new Set,jup:new Set,extra:new Set};this._whiteMap=new Set;this._extraTokenList=[]}async load(t){this.checkDisabled();let{forceUpdate:n=!1,type:r="strict"}=t||{},{mintList:i,blacklist:s,whiteList:a}=await this.scope.fetchV3TokenList(n),u=await this.scope.fetchJupTokenList(n);this._tokenList=[],this._tokenMap=new Map,this._blackTokenMap=new Map,this._mintGroup={official:new Set,jup:new Set,extra:new Set},this._whiteMap=new Set(a),this._tokenMap.set(Mt.address,Mt),this._mintGroup.official.add(Mt.address),s.forEach(c=>{this._blackTokenMap.set(c.address,E(C({},c),{priority:-1}))}),i.forEach(c=>{var l;this._blackTokenMap.has(c.address)||(this._tokenMap.set(c.address,E(C({},c),{type:"raydium",priority:2,programId:(l=c.programId)!=null?l:c.tags.includes("token-2022")?Xs.toBase58():zs.toBase58()})),this._mintGroup.official.add(c.address))}),u.forEach(c=>{var l;this._blackTokenMap.has(c.address)||this._tokenMap.has(c.address)||(this._tokenMap.set(c.address,E(C({},c),{type:"jupiter",priority:1,programId:(l=c.programId)!=null?l:c.tags.includes("token-2022")?Xs.toBase58():zs.toBase58()})),this._mintGroup.jup.add(c.address))}),this._extraTokenList.forEach(c=>{this._blackTokenMap.has(c.address)||this._tokenMap.has(c.address)||(this._tokenMap.set(c.address,E(C({},c),{type:"extra",priority:1,programId:c.programId||c.tags.includes("token-2022")?Xs.toBase58():zs.toBase58()})),this._mintGroup.extra.add(c.address))}),this._tokenList=Array.from(this._tokenMap).map(c=>c[1])}get tokenList(){return this._tokenList}get tokenMap(){return this._tokenMap}get blackTokenMap(){return this._blackTokenMap}get mintGroup(){return this._mintGroup}get whiteListMap(){return this._whiteMap}async getTokenInfo(t){if(!t)throw new Error("please input mint");let n=t.toString(),r=this._tokenMap.get(n);if(r)return r;if(n.toLocaleUpperCase()==="SOL")return Mt;let i=(await this.scope.api.getTokenInfo([n]))[0];if(i)return this._mintGroup.extra.add(n),this._tokenMap.set(n,E(C({},i),{priority:2})),i;let s=await this.scope.connection.getAccountInfo(new hf(n));if(!s)throw new Error(`mint address not found: ${n}`);let a=kf.decode(s.data),u=n.toString().substring(0,6),c={chainId:101,address:n,programId:s.owner.toBase58(),logoURI:"",symbol:u,name:u,decimals:a.decimals,tags:[],extensions:{},priority:0,type:"unknown"};return this._mintGroup.extra.add(n),this._tokenMap.set(n,c),c}};var ti=class{constructor(e){this.rawBalances=new Map;let{connection:t,cluster:n,owner:r,api:i,defaultChainTime:s,defaultChainTimeOffset:a,apiCacheTime:u,blockhashCommitment:c="confirmed"}=e;this._connection=t,this.cluster=n||"mainnet",this._owner=r?new xt(r):void 0,this._signAllTransactions=e.signAllTransactions,this.blockhashCommitment=c,this.api=i,this._apiCacheTime=u||5*60*1e3,this.logger=ce("Raydium"),this.farm=new Bo({scope:this,moduleName:"Raydium_Farm"}),this.account=new fo({scope:this,moduleName:"Raydium_Account",tokenAccounts:e.tokenAccounts,tokenAccountRawInfos:e.tokenAccountRawInfos}),this.liquidity=new _o({scope:this,moduleName:"Raydium_LiquidityV2"}),this.token=new Qo({scope:this,moduleName:"Raydium_tokenV2"}),this.tradeV2=new qo({scope:this,moduleName:"Raydium_tradeV2"}),this.clmm=new Fo({scope:this,moduleName:"Raydium_clmm"}),this.cpmm=new Wo({scope:this,moduleName:"Raydium_cpmm"}),this.utils1216=new kt({scope:this,moduleName:"Raydium_utils1216"}),this.marketV2=new Hn({scope:this,moduleName:"Raydium_marketV2"}),this.ido=new Zn({scope:this,moduleName:"Raydium_ido"}),this.availability={};let l=new Date().getTime();this.apiData={},a&&(this._chainTime={fetched:l,value:{chainTime:s||Date.now()-a,offset:a}})}static async load(e){var l;let t=Tf({cluster:"mainnet",owner:null,apiRequestInterval:3e5,apiRequestTimeout:1e4},e),{cluster:n,apiRequestTimeout:r,logCount:i,logRequests:s,urlConfigs:a}=t,u=new Pr({cluster:n,timeout:r,urlConfigs:a,logCount:i,logRequests:s}),c=new ti(E(C({},t),{api:u}));return await c.fetchAvailabilityStatus((l=e.disableFeatureCheck)!=null?l:!0),e.disableLoadToken||await c.token.load({type:e.jupTokenType}),c}get owner(){return this._owner}get ownerPubKey(){if(!this._owner)throw new Error(hr);return this._owner.publicKey}setOwner(e){return this._owner=e?new xt(e):void 0,this.account.resetTokenAccounts(),this}get connection(){if(!this._connection)throw new Error(qa);return this._connection}setConnection(e){return this._connection=e,this}get signAllTransactions(){return this._signAllTransactions}setSignAllTransactions(e){return this._signAllTransactions=e,this}checkOwner(){if(!this.owner)throw this.logger.error(hr),new Error(hr)}isCacheInvalidate(e){return new Date().getTime()-e>this._apiCacheTime}async fetchChainTime(){try{let e=await this.api.getChainTimeOffset();this._chainTime={fetched:Date.now(),value:{chainTime:Date.now()+e.offset*1e3,offset:e.offset*1e3}}}catch{this._chainTime=void 0}}async fetchV3TokenList(e){if(this.apiData.tokenList&&!this.isCacheInvalidate(this.apiData.tokenList.fetched)&&!e)return this.apiData.tokenList.data;try{let t=await this.api.getTokenList(),n={fetched:Date.now(),data:t};return this.apiData.tokenList=n,n.data}catch(t){return console.error(t),{mintList:[],blacklist:[],whiteList:[]}}}async fetchJupTokenList(e){let t=this.apiData.jupTokenList;if(t&&!this.isCacheInvalidate(t.fetched)&&!e)return t.data;try{let n=await this.api.getJupTokenList();return this.apiData.jupTokenList={fetched:Date.now(),data:n},this.apiData.jupTokenList.data}catch(n){return console.error(n),[]}}get chainTimeData(){var e;return(e=this._chainTime)==null?void 0:e.value}async chainTimeOffset(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.offset:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.offset)||0)}async currentBlockChainTime(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.chainTime:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.chainTime)||Date.now())}async fetchEpochInfo(){return this._epochInfo&&Date.now()-this._epochInfo.fetched<=1e3*30?this._epochInfo.value:(this._epochInfo={fetched:Date.now(),value:await this.connection.getEpochInfo()},this._epochInfo.value)}async fetchAvailabilityStatus(e){if(e)return{};try{let t=await this.api.fetchAvailabilityStatus(),n=t.all===!1;return this.availability={all:t.all,swap:n?!1:t.swap,createConcentratedPosition:n?!1:t.createConcentratedPosition,addConcentratedPosition:n?!1:t.addConcentratedPosition,addStandardPosition:n?!1:t.addStandardPosition,removeConcentratedPosition:n?!1:t.removeConcentratedPosition,removeStandardPosition:n?!1:t.removeStandardPosition,addFarm:n?!1:t.addFarm,removeFarm:n?!1:t.removeFarm},t}catch{return{}}}};var VK=o=>o;export{zb as ACCOUNT_TYPE_SIZE,Ag as ALL_PROGRAM_ID,Tp as AMM_CONFIG_SEED,mm as AMM_STABLE,Oi as AMM_V4,Wf as ANAMint,Ne as API_URLS,sm as AccountType,Pr as Api,Gu as BIT_PRECISION,St as BNDivCeil,gn as BNLayout,jy as BN_100,Hy as BN_1000,Zy as BN_10000,Yy as BN_FIVE,Pa as BN_ONE,pn as BN_TEN,Qy as BN_THREE,zy as BN_TWO,De as BN_ZERO,SA as BitStructure,Xa as Blob,Li as CLMM_PROGRAM_ID,yi as CLOCK_PROGRAM_ID,gm as CREATE_CPMM_POOL_AUTH,Am as CREATE_CPMM_POOL_FEE_ACC,Ni as CREATE_CPMM_POOL_PROGRAM,Fo as Clmm,$u as ClmmConfigLayout,Se as ClmmInstrument,Ur as ConstantProductCurve,Pc as CpmmConfigInfoLayout,Wr as CpmmFee,Yr as CpmmPoolInfoLayout,no as Currency,fn as CurrencyAmount,Xr as CurveCalculator,wg as DEVNET_PROGRAM_ID,zg as DEV_API_URLS,Pm as DEV_CREATE_CPMM_POOL_AUTH,hm as DEV_CREATE_CPMM_POOL_FEE_ACC,wm as DEV_CREATE_CPMM_POOL_PROGRAM,up as DataElement,qf as ETHMint,Is as EXTENSION_TICKARRAY_BITMAP_SIZE,pu as FARM_LOCK_MINT,fu as FARM_LOCK_VAULT,Ci as FARM_PROGRAM_ID_V3,Ri as FARM_PROGRAM_ID_V5,Vn as FARM_PROGRAM_ID_V6,gt as FARM_PROGRAM_TO_VERSION,bu as FARM_VERSION_TO_LEDGER_LAYOUT,yu as FARM_VERSION_TO_STATE_LAYOUT,gg as FEE_DESTINATION_ID,_r as FEE_RATE_DENOMINATOR,Ls as FEE_RATE_DENOMINATOR_VALUE,Lp as FETCH_TICKARRAY_COUNT,Op as Fee,re as Fraction,co as IDO_ALL_PROGRAM,pm as IDO_PROGRAM_ID_V1,fm as IDO_PROGRAM_ID_V2,ym as IDO_PROGRAM_ID_V3,bm as IDO_PROGRAM_ID_V4,ir as INSTRUCTION_PROGRAM_ID,V as InstructionType,Va as JupTokenType,Vr as LIQUIDITY_FEES_DENOMINATOR,Ks as LIQUIDITY_FEES_NUMERATOR,Fa as LIQUIDITY_POOL_PROGRAM_ID_V5_MODEL,Ep as LIQUIDITY_VERSION_TO_SERUM_VERSION,rk as LIQUIDITY_VERSION_TO_STATE_LAYOUT,Xu as LOG_B_2_X32,zu as LOG_B_P_ERR_MARGIN_LOWER_X64,Qu as LOG_B_P_ERR_MARGIN_UPPER_X64,br as LOOKUP_TABLE_CACHE,lo as Layout,le as LiquidityMath,Vc as LogLevel,ri as Logger,Ds as MARKET_STATE_LAYOUT_V2,Vs as MARKET_STATE_LAYOUT_V3,Ic as MARKET_VERSION_TO_STATE_LAYOUT,Sa as MAX_BASE64_SIZE,ht as MAX_SQRT_PRICE_X64,vr as MAX_SQRT_PRICE_X64_SUB_ONE,st as MAX_TICK,or as MEMO_PROGRAM_ID,rr as MEMO_PROGRAM_ID2,vn as METADATA_PROGRAM_ID,Pt as MIN_SQRT_PRICE_X64,Mr as MIN_SQRT_PRICE_X64_ADD_ONE,et as MIN_TICK,Xn as MODEL_DATA_PUBKEY,Zr as Market,ne as MathUtil,Ts as MaxU64,Uu as MaxUint128,zt as NEGATIVE_ONE,Df as NRVMint,Rp as OBSERVATION_SEED,yt as ONE,lm as OPEN_BOOK_PROGRAM,Kp as OPERATION_SEED,Ju as ObservationInfoLayout,vp as ObservationLayout,ec as OperationLayout,Di as OptionLayout,xt as Owner,Nf as PAIMint,xp as POOL_REWARD_VAULT_SEED,Ip as POOL_SEED,Cp as POOL_TICK_ARRAY_BITMAP_SEED,Bp as POOL_VAULT_SEED,Eu as POSITION_SEED,Me as Percent,Ea as PoolFetchType,In as PoolInfoLayout,Ce as PoolUtils,Fr as PositionInfoLayout,Fp as PositionRewardInfoLayout,No as PositionUtils,Ue as Price,qT as ProtocolPositionLayout,Nr as Q128,bt as Q64,Lf as RAYMint,ut as RENT_PROGRAM_ID,ti as Raydium,_p as RewardInfo,dc as RoundDirection,wi as Rounding,dm as Router,kc as SERUM_PROGRAMID_TO_VERSION,Ar as SERUM_PROGRAM_ID_V3,Tc as SERUM_VERSION_TO_PROGRAMID,Da as SESSION_KEY,Ve as SOLMint,Mt as SOL_INFO,Lh as SPL_MINT_LAYOUT,Mf as SRMMint,Mi as STORAGE_KEY,sr as SYSTEM_PROGRAM_ID,ee as SqrtPriceMath,Gn as StableLayout,Wi as Structure,Tn as SwapMath,kn as TICK_ARRAY_BITMAP_SIZE,Sp as TICK_ARRAY_SEED,qe as TICK_ARRAY_SIZE,Ok as TICK_SPACINGS,Ee as TOKEN_WSOL,Qt as TickArrayBitmap,Zu as TickArrayBitmapExtensionLayout,Lo as TickArrayBitmapExtensionUtils,Oo as TickArrayLayout,Vp as TickLayout,Bn as TickMath,me as TickQuery,H as TickUtils,ye as Token,fe as TokenAmount,gr as TxBuilder,yn as TxVersion,Ro as U64Resolution,Nk as U64_IGNORE_RANGE,Fi as UInt,vf as USDCMint,Ef as USDHMint,_f as USDTMint,cm as UTIL1216,qi as Union,mu as Voter,Ud as VoterDepositEntry,qd as VoterLockup,lu as VoterRegistrar,Wd as VoterVotingMintConfig,j as WSOLMint,Tr as WideBits,Ut as WrappedLayout,pe as ZERO,ba as _100_PERCENT,P as accountMeta,Ny as add,pr as addComputeBudget,bs as addLiquidityLayout,dw as array,Hi as associatedLedgerAccountLayout,Vi as bits,ge as blob,je as bool,cs as calFarmRewardAmount,zp as ceilDiv,oo as checkLegacyTxSize,ro as checkV0TxSize,xi as chunkArray,Xo as claimLayout,Hu as clmmComputeInfoToApiInfo,_t as closeAccountInstruction,di as commonSystemAccountMeta,ho as createAssociatedLedgerAccountInstruction,ce as createLogger,Bu as createPoolFeeLayout,Mu as createPoolV4InstructionV2,ok as createPoolV4Layout,Gt as createWSolAccountInstructions,tw as cstr,gy as currencyEquals,Ql as decimalToFraction,gd as decodeBool,Cy as div,cr as divCeil,rt as dwLayout,Ad as encodeBool,pA as endlessRetry,Gl as eq,HA as f32,ZA as f32be,$A as f64,JA as f64be,es as farmAddRewardLayout,gP as farmLedgerLayoutV3_1,bo as farmLedgerLayoutV3_2,AP as farmLedgerLayoutV5_1,uu as farmLedgerLayoutV5_2,cu as farmLedgerLayoutV6_1,Au as farmRewardInfoToConfig,$i as farmRewardLayout,Ji as farmRewardRestartLayout,Dd as farmRewardTimeInfoLayout,su as farmStateV3Layout,au as farmStateV5Layout,yo as farmStateV6Layout,UP as fetchMultipleFarmInfoAndUpdate,wI as fetchMultipleInfo,Fn as fetchMultipleMintInfos,ue as findProgramAddress,ps as fixedSwapInLayout,fs as fixedSwapOutLayout,lc as floorDiv,fr as forecastTransactionSize,Ap as formatLayout,ct as generatePubKey,we as getATAAddress,gu as getAssociatedAuthority,Er as getAssociatedConfigId,Je as getAssociatedLedgerAccount,Ao as getAssociatedLedgerPoolAccount,Gp as getAssociatedOpenOrders,sc as getAssociatedPoolKeys,jB as getCpmmPdaAmmConfigId,ef as getCpmmPdaPoolId,fc as getCreatePoolKeys,Ma as getDate,ls as getDepositEntryIndex,Cu as getDxByDyBaseIn,Ku as getDyByDxBaseIn,_b as getEpochInfo,Un as getFarmLedgerLayout,Gd as getFarmStateLayout,Os as getLiquidityAssociatedAuthority,xn as getLiquidityAssociatedId,AT as getLiquidityFromAmounts,Ly as getMax,Bt as getMultipleAccountsInfo,We as getMultipleAccountsInfoWithCustomFlags,Si as getMultipleLookupTableInfo,Kk as getPdaAmmConfigId,mt as getPdaExBitmapAccount,tf as getPdaLpMint,Lr as getPdaMetadataKey,qu as getPdaObservationAccount,zr as getPdaObservationId,Co as getPdaOperationAccount,At as getPdaPersonalPositionAddress,jn as getPdaPoolAuthority,Du as getPdaPoolId,Wu as getPdaPoolRewardVaulId,ks as getPdaPoolVaultId,hn as getPdaProtocolPositionAddress,he as getPdaTickArrayAddress,pc as getPdaVault,_n as getRecentBlockHash,os as getRegistrarAddress,Im as getSessionKey,Ru as getStablePrice,um as getTime,Ib as getTimestamp,us as getTokenOwnerRecordAddress,xg as getTransferAmountFee,be as getTransferAmountFeeV2,ss as getVoterAddress,as as getVoterWeightRecordAddress,is as getVotingMintAuthority,rs as getVotingTokenMint,Jd as governanceCreateTokenOwnerRecord,KA as greedy,Ul as gt,Ky as gte,$a as i128,Tk as i16ToBytes,Or as i32ToBytes,Dn as i64,Za as i8,ys as initPoolLayout,Yi as initTokenAccountInstruction,Af as initializeMarket,lg as intersection,_a as isDateAfter,va as isDateBefore,Yl as isDecimal,Oy as isMeaningfulNumber,Na as isNumber,ts as isValidFarmVersion,Ko as isZero,Ie as jsonInfo2PoolKeys,GP as judgeFarmType,Ps as leadingZeros,Vu as leastSignificantBit,So as liquidityStateV4Layout,sp as liquidityStateV5Layout,xy as lt,Sy as lte,Ff as mSOLMint,Rr as makeAMMSwapInstruction,Nu as makeAddLiquidityInstruction,ds as makeAddNewRewardInstruction,ei as makeClaimInstruction,Gs as makeClaimInstructionV4,bc as makeCreateCpmmPoolInInstruction,wu as makeCreateFarmInstruction,Oc as makeCreateMarketInstruction,Pu as makeCreatorWithdrawFarmRewardInstruction,gc as makeDepositCpmmInInstruction,hu as makeDepositInstructionV3,ku as makeDepositInstructionV5,Tu as makeDepositInstructionV6,ah as makeDepositTokenInstruction,ch as makeDepositWithdrawInstruction,hk as makeInitPoolInstructionV4,_0 as makePurchaseInstruction,ms as makeRestartRewardInstruction,vu as makeSimulatePoolInfoInstruction,Qr as makeSwapCpmmBaseInInInstruction,wc as makeSwapCpmmBaseOutInInstruction,hp as makeSwapFixedInInstruction,kp as makeSwapFixedOutInstruction,hc as makeSwapInstruction,po as makeTransferInstruction,Ac as makeWithdrawCpmmInInstruction,Io as makeWithdrawInstructionV3,To as makeWithdrawInstructionV5,ko as makeWithdrawInstructionV6,uh as makeWithdrawTokenInstruction,Kt as minExpirationTime,Lk as mockCreatePoolInfo,Yu as mockV3CreatePoolInfo,cp as modelDataInfoLayout,Fu as mostSignificantBit,ki as mul,Ti as notInnerObject,UA as ns64,jA as ns64be,za as nu64,FA as nu64be,Ei as offset,fg as offsetDateTime,aw as option,Y as parseBigNumberish,dn as parseNumberInfo,Ca as parseSimulateLogToJson,Wt as parseSimulateValue,iu as parseTokenAccountResp,qh as parseTokenInfo,un as poolTypeV6,bn as printSimulate,K as publicKey,Ws as purchaseLayout,Fd as realFarmStateV3Layout,Vd as realFarmStateV5Layout,Ed as realFarmV6Layout,wa as recursivelyDecimalToFraction,ws as removeLiquidityInstruction,gs as removeLiquidityLayout,$x as route1Instruction,Jx as route2Instruction,lf as routeInstruction,mw as rustEnum,EA as s16,GA as s16be,DA as s24,XA as s24be,Qe as s32,zA as s32be,WA as s40,QA as s40be,qA as s48,YA as s48be,VA as s8,X as seq,xf as setLoggerLevel,Xl as shakeFractionDecimal,Ka as simulateMultipleInstruction,Pk as simulatePoolInfoInstruction,tm as simulateTransaction,Ta as sleep,pt as solToWSol,Gh as solToWSolToken,on as splAccountLayout,ka as splitNumber,Vf as stSOLMint,lw as str,v as struct,Ry as sub,cw as tagged,Pi as tenExponential,Dr as toAmmComputePoolInfo,it as toApiV3Token,zl as toBN,Ra as toBuffer,cn as toFeeConfig,ha as toFraction,By as toFractionWithDecimals,$y as toPercent,Cr as toToken,xo as toTokenAmount,Uh as toTokenInfo,Jy as toTokenPrice,eb as toTotalPrice,Aa as toUsdCurrency,hs as trailingZeros,Fb as transformTxToBase64,fi as tryParsePublicKey,J as u128,qt as u16,_u as u16ToBytes,LA as u16be,CA as u24,NA as u24be,Ye as u32,Ik as u32ToBytes,MA as u32be,RA as u40,vA as u40be,OA as u48,_A as u48be,h as u64,W as u8,pw as union,VK as unionArr,ew as unionLayoutDiscriminator,dg as uniq,Xd as updateFarmPoolInfo,wr as updateReqHistory,nw as utf8,pi as validateAndParsePublicKey,ns as validateFarmRewards,uw as vec,wd as vecU8,tp as voterStakeRegistryCreateDepositEntry,ep as voterStakeRegistryCreateVoter,Hd as voterStakeRegistryDeposit,Zd as voterStakeRegistryUpdateVoterWeightRecord,$d as voterStakeRegistryWithdraw,Xh as wSolToSolToken,Zi as withdrawRewardLayout,mg as xor,fw as zeros};
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=index.mjs.map