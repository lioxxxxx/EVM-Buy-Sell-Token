var ur=Object.defineProperty,lr=Object.defineProperties;var mr=Object.getOwnPropertyDescriptors;var Ut=Object.getOwnPropertySymbols;var $n=Object.prototype.hasOwnProperty,ei=Object.prototype.propertyIsEnumerable;var Jn=(i,e,t)=>e in i?ur(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,S=(i,e)=>{for(var t in e||(e={}))$n.call(e,t)&&Jn(i,t,e[t]);if(Ut)for(var t of Ut(e))ei.call(e,t)&&Jn(i,t,e[t]);return i},G=(i,e)=>lr(i,mr(e));var gt=(i,e)=>{var t={};for(var n in i)$n.call(i,n)&&e.indexOf(n)<0&&(t[n]=i[n]);if(i!=null&&Ut)for(var n of Ut(i))e.indexOf(n)<0&&ei.call(i,n)&&(t[n]=i[n]);return t};import{PublicKey as q}from"@solana/web3.js";var bt=9e15,it=1e9,gn="0123456789abcdef",zt="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",Ht="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",bn={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-bt,maxE:bt,crypto:!1},ri,Ye,v=!0,jt="[DecimalError] ",nt=jt+"Invalid argument: ",oi=jt+"Precision limit exceeded",si=jt+"crypto unavailable",ai="[object Decimal]",ke=Math.floor,de=Math.pow,dr=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,pr=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,fr=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,ci=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,Ee=1e7,O=7,gr=9007199254740991,br=zt.length-1,yn=Ht.length-1,T={toStringTag:ai};T.absoluteValue=T.abs=function(){var i=new this.constructor(this);return i.s<0&&(i.s=1),N(i)};T.ceil=function(){return N(new this.constructor(this),this.e+1,2)};T.clampedTo=T.clamp=function(i,e){var t,n=this,r=n.constructor;if(i=new r(i),e=new r(e),!i.s||!e.s)return new r(NaN);if(i.gt(e))throw Error(nt+e);return t=n.cmp(i),t<0?i:n.cmp(e)>0?e:new r(n)};T.comparedTo=T.cmp=function(i){var e,t,n,r,o=this,s=o.d,a=(i=new o.constructor(i)).d,c=o.s,u=i.s;if(!s||!a)return!c||!u?NaN:c!==u?c:s===a?0:!s^c<0?1:-1;if(!s[0]||!a[0])return s[0]?c:a[0]?-u:0;if(c!==u)return c;if(o.e!==i.e)return o.e>i.e^c<0?1:-1;for(n=s.length,r=a.length,e=0,t=n<r?n:r;e<t;++e)if(s[e]!==a[e])return s[e]>a[e]^c<0?1:-1;return n===r?0:n>r^c<0?1:-1};T.cosine=T.cos=function(){var i,e,t=this,n=t.constructor;return t.d?t.d[0]?(i=n.precision,e=n.rounding,n.precision=i+Math.max(t.e,t.sd())+O,n.rounding=1,t=yr(n,pi(n,t)),n.precision=i,n.rounding=e,N(Ye==2||Ye==3?t.neg():t,i,e,!0)):new n(1):new n(NaN)};T.cubeRoot=T.cbrt=function(){var i,e,t,n,r,o,s,a,c,u,l=this,m=l.constructor;if(!l.isFinite()||l.isZero())return new m(l);for(v=!1,o=l.s*de(l.s*l,1/3),!o||Math.abs(o)==1/0?(t=ye(l.d),i=l.e,(o=(i-t.length+1)%3)&&(t+=o==1||o==-2?"0":"00"),o=de(t,1/3),i=ke((i+1)/3)-(i%3==(i<0?-1:2)),o==1/0?t="5e"+i:(t=o.toExponential(),t=t.slice(0,t.indexOf("e")+1)+i),n=new m(t),n.s=l.s):n=new m(o.toString()),s=(i=m.precision)+3;;)if(a=n,c=a.times(a).times(a),u=c.plus(l),n=ee(u.plus(l).times(a),u.plus(c),s+2,1),ye(a.d).slice(0,s)===(t=ye(n.d)).slice(0,s))if(t=t.slice(s-3,s+1),t=="9999"||!r&&t=="4999"){if(!r&&(N(a,i+1,0),a.times(a).times(a).eq(l))){n=a;break}s+=4,r=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&(N(n,i+1,1),e=!n.times(n).times(n).eq(l));break}return v=!0,N(n,i,m.rounding,e)};T.decimalPlaces=T.dp=function(){var i,e=this.d,t=NaN;if(e){if(i=e.length-1,t=(i-ke(this.e/O))*O,i=e[i],i)for(;i%10==0;i/=10)t--;t<0&&(t=0)}return t};T.dividedBy=T.div=function(i){return ee(this,new this.constructor(i))};T.dividedToIntegerBy=T.divToInt=function(i){var e=this,t=e.constructor;return N(ee(e,new t(i),0,1,1),t.precision,t.rounding)};T.equals=T.eq=function(i){return this.cmp(i)===0};T.floor=function(){return N(new this.constructor(this),this.e+1,3)};T.greaterThan=T.gt=function(i){return this.cmp(i)>0};T.greaterThanOrEqualTo=T.gte=function(i){var e=this.cmp(i);return e==1||e===0};T.hyperbolicCosine=T.cosh=function(){var i,e,t,n,r,o=this,s=o.constructor,a=new s(1);if(!o.isFinite())return new s(o.s?1/0:NaN);if(o.isZero())return a;t=s.precision,n=s.rounding,s.precision=t+Math.max(o.e,o.sd())+4,s.rounding=1,r=o.d.length,r<32?(i=Math.ceil(r/3),e=(1/Qt(4,i)).toString()):(i=16,e="2.3283064365386962890625e-10"),o=yt(s,1,o.times(e),new s(1),!0);for(var c,u=i,l=new s(8);u--;)c=o.times(o),o=a.minus(c.times(l.minus(c.times(l))));return N(o,s.precision=t,s.rounding=n,!0)};T.hyperbolicSine=T.sinh=function(){var i,e,t,n,r=this,o=r.constructor;if(!r.isFinite()||r.isZero())return new o(r);if(e=o.precision,t=o.rounding,o.precision=e+Math.max(r.e,r.sd())+4,o.rounding=1,n=r.d.length,n<3)r=yt(o,2,r,r,!0);else{i=1.4*Math.sqrt(n),i=i>16?16:i|0,r=r.times(1/Qt(5,i)),r=yt(o,2,r,r,!0);for(var s,a=new o(5),c=new o(16),u=new o(20);i--;)s=r.times(r),r=r.times(a.plus(s.times(c.times(s).plus(u))))}return o.precision=e,o.rounding=t,N(r,e,t,!0)};T.hyperbolicTangent=T.tanh=function(){var i,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(i=n.precision,e=n.rounding,n.precision=i+7,n.rounding=1,ee(t.sinh(),t.cosh(),n.precision=i,n.rounding=e)):new n(t.s)};T.inverseCosine=T.acos=function(){var i,e=this,t=e.constructor,n=e.abs().cmp(1),r=t.precision,o=t.rounding;return n!==-1?n===0?e.isNeg()?Oe(t,r,o):new t(0):new t(NaN):e.isZero()?Oe(t,r+4,o).times(.5):(t.precision=r+6,t.rounding=1,e=e.asin(),i=Oe(t,r+4,o).times(.5),t.precision=r,t.rounding=o,i.minus(e))};T.inverseHyperbolicCosine=T.acosh=function(){var i,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(i=n.precision,e=n.rounding,n.precision=i+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,v=!1,t=t.times(t).minus(1).sqrt().plus(t),v=!0,n.precision=i,n.rounding=e,t.ln()):new n(t)};T.inverseHyperbolicSine=T.asinh=function(){var i,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(i=n.precision,e=n.rounding,n.precision=i+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,v=!1,t=t.times(t).plus(1).sqrt().plus(t),v=!0,n.precision=i,n.rounding=e,t.ln())};T.inverseHyperbolicTangent=T.atanh=function(){var i,e,t,n,r=this,o=r.constructor;return r.isFinite()?r.e>=0?new o(r.abs().eq(1)?r.s/0:r.isZero()?r:NaN):(i=o.precision,e=o.rounding,n=r.sd(),Math.max(n,i)<2*-r.e-1?N(new o(r),i,e,!0):(o.precision=t=n-r.e,r=ee(r.plus(1),new o(1).minus(r),t+i,1),o.precision=i+4,o.rounding=1,r=r.ln(),o.precision=i,o.rounding=e,r.times(.5))):new o(NaN)};T.inverseSine=T.asin=function(){var i,e,t,n,r=this,o=r.constructor;return r.isZero()?new o(r):(e=r.abs().cmp(1),t=o.precision,n=o.rounding,e!==-1?e===0?(i=Oe(o,t+4,n).times(.5),i.s=r.s,i):new o(NaN):(o.precision=t+6,o.rounding=1,r=r.div(new o(1).minus(r.times(r)).sqrt().plus(1)).atan(),o.precision=t,o.rounding=n,r.times(2)))};T.inverseTangent=T.atan=function(){var i,e,t,n,r,o,s,a,c,u=this,l=u.constructor,m=l.precision,d=l.rounding;if(u.isFinite()){if(u.isZero())return new l(u);if(u.abs().eq(1)&&m+4<=yn)return s=Oe(l,m+4,d).times(.25),s.s=u.s,s}else{if(!u.s)return new l(NaN);if(m+4<=yn)return s=Oe(l,m+4,d).times(.5),s.s=u.s,s}for(l.precision=a=m+10,l.rounding=1,t=Math.min(28,a/O+2|0),i=t;i;--i)u=u.div(u.times(u).plus(1).sqrt().plus(1));for(v=!1,e=Math.ceil(a/O),n=1,c=u.times(u),s=new l(u),r=u;i!==-1;)if(r=r.times(c),o=s.minus(r.div(n+=2)),r=r.times(c),s=o.plus(r.div(n+=2)),s.d[e]!==void 0)for(i=e;s.d[i]===o.d[i]&&i--;);return t&&(s=s.times(2<<t-1)),v=!0,N(s,l.precision=m,l.rounding=d,!0)};T.isFinite=function(){return!!this.d};T.isInteger=T.isInt=function(){return!!this.d&&ke(this.e/O)>this.d.length-2};T.isNaN=function(){return!this.s};T.isNegative=T.isNeg=function(){return this.s<0};T.isPositive=T.isPos=function(){return this.s>0};T.isZero=function(){return!!this.d&&this.d[0]===0};T.lessThan=T.lt=function(i){return this.cmp(i)<0};T.lessThanOrEqualTo=T.lte=function(i){return this.cmp(i)<1};T.logarithm=T.log=function(i){var e,t,n,r,o,s,a,c,u=this,l=u.constructor,m=l.precision,d=l.rounding,p=5;if(i==null)i=new l(10),e=!0;else{if(i=new l(i),t=i.d,i.s<0||!t||!t[0]||i.eq(1))return new l(NaN);e=i.eq(10)}if(t=u.d,u.s<0||!t||!t[0]||u.eq(1))return new l(t&&!t[0]?-1/0:u.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)o=!0;else{for(r=t[0];r%10===0;)r/=10;o=r!==1}if(v=!1,a=m+p,s=tt(u,a),n=e?Zt(l,a+10):tt(i,a),c=ee(s,n,a,1),Tt(c.d,r=m,d))do if(a+=10,s=tt(u,a),n=e?Zt(l,a+10):tt(i,a),c=ee(s,n,a,1),!o){+ye(c.d).slice(r+1,r+15)+1==1e14&&(c=N(c,m+1,0));break}while(Tt(c.d,r+=10,d));return v=!0,N(c,m,d)};T.minus=T.sub=function(i){var e,t,n,r,o,s,a,c,u,l,m,d,p=this,g=p.constructor;if(i=new g(i),!p.d||!i.d)return!p.s||!i.s?i=new g(NaN):p.d?i.s=-i.s:i=new g(i.d||p.s!==i.s?p:NaN),i;if(p.s!=i.s)return i.s=-i.s,p.plus(i);if(u=p.d,d=i.d,a=g.precision,c=g.rounding,!u[0]||!d[0]){if(d[0])i.s=-i.s;else if(u[0])i=new g(p);else return new g(c===3?-0:0);return v?N(i,a,c):i}if(t=ke(i.e/O),l=ke(p.e/O),u=u.slice(),o=l-t,o){for(m=o<0,m?(e=u,o=-o,s=d.length):(e=d,t=l,s=u.length),n=Math.max(Math.ceil(a/O),s)+2,o>n&&(o=n,e.length=1),e.reverse(),n=o;n--;)e.push(0);e.reverse()}else{for(n=u.length,s=d.length,m=n<s,m&&(s=n),n=0;n<s;n++)if(u[n]!=d[n]){m=u[n]<d[n];break}o=0}for(m&&(e=u,u=d,d=e,i.s=-i.s),s=u.length,n=d.length-s;n>0;--n)u[s++]=0;for(n=d.length;n>o;){if(u[--n]<d[n]){for(r=n;r&&u[--r]===0;)u[r]=Ee-1;--u[r],u[n]+=Ee}u[n]-=d[n]}for(;u[--s]===0;)u.pop();for(;u[0]===0;u.shift())--t;return u[0]?(i.d=u,i.e=Yt(u,t),v?N(i,a,c):i):new g(c===3?-0:0)};T.modulo=T.mod=function(i){var e,t=this,n=t.constructor;return i=new n(i),!t.d||!i.s||i.d&&!i.d[0]?new n(NaN):!i.d||t.d&&!t.d[0]?N(new n(t),n.precision,n.rounding):(v=!1,n.modulo==9?(e=ee(t,i.abs(),0,3,1),e.s*=i.s):e=ee(t,i,0,n.modulo,1),e=e.times(i),v=!0,t.minus(e))};T.naturalExponential=T.exp=function(){return wn(this)};T.naturalLogarithm=T.ln=function(){return tt(this)};T.negated=T.neg=function(){var i=new this.constructor(this);return i.s=-i.s,N(i)};T.plus=T.add=function(i){var e,t,n,r,o,s,a,c,u,l,m=this,d=m.constructor;if(i=new d(i),!m.d||!i.d)return!m.s||!i.s?i=new d(NaN):m.d||(i=new d(i.d||m.s===i.s?m:NaN)),i;if(m.s!=i.s)return i.s=-i.s,m.minus(i);if(u=m.d,l=i.d,a=d.precision,c=d.rounding,!u[0]||!l[0])return l[0]||(i=new d(m)),v?N(i,a,c):i;if(o=ke(m.e/O),n=ke(i.e/O),u=u.slice(),r=o-n,r){for(r<0?(t=u,r=-r,s=l.length):(t=l,n=o,s=u.length),o=Math.ceil(a/O),s=o>s?o+1:s+1,r>s&&(r=s,t.length=1),t.reverse();r--;)t.push(0);t.reverse()}for(s=u.length,r=l.length,s-r<0&&(r=s,t=l,l=u,u=t),e=0;r;)e=(u[--r]=u[r]+l[r]+e)/Ee|0,u[r]%=Ee;for(e&&(u.unshift(e),++n),s=u.length;u[--s]==0;)u.pop();return i.d=u,i.e=Yt(u,n),v?N(i,a,c):i};T.precision=T.sd=function(i){var e,t=this;if(i!==void 0&&i!==!!i&&i!==1&&i!==0)throw Error(nt+i);return t.d?(e=ui(t.d),i&&t.e+1>e&&(e=t.e+1)):e=NaN,e};T.round=function(){var i=this,e=i.constructor;return N(new e(i),i.e+1,e.rounding)};T.sine=T.sin=function(){var i,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(i=n.precision,e=n.rounding,n.precision=i+Math.max(t.e,t.sd())+O,n.rounding=1,t=hr(n,pi(n,t)),n.precision=i,n.rounding=e,N(Ye>2?t.neg():t,i,e,!0)):new n(NaN)};T.squareRoot=T.sqrt=function(){var i,e,t,n,r,o,s=this,a=s.d,c=s.e,u=s.s,l=s.constructor;if(u!==1||!a||!a[0])return new l(!u||u<0&&(!a||a[0])?NaN:a?s:1/0);for(v=!1,u=Math.sqrt(+s),u==0||u==1/0?(e=ye(a),(e.length+c)%2==0&&(e+="0"),u=Math.sqrt(e),c=ke((c+1)/2)-(c<0||c%2),u==1/0?e="5e"+c:(e=u.toExponential(),e=e.slice(0,e.indexOf("e")+1)+c),n=new l(e)):n=new l(u.toString()),t=(c=l.precision)+3;;)if(o=n,n=o.plus(ee(s,o,t+2,1)).times(.5),ye(o.d).slice(0,t)===(e=ye(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!r&&e=="4999"){if(!r&&(N(o,c+1,0),o.times(o).eq(s))){n=o;break}t+=4,r=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&(N(n,c+1,1),i=!n.times(n).eq(s));break}return v=!0,N(n,c,l.rounding,i)};T.tangent=T.tan=function(){var i,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(i=n.precision,e=n.rounding,n.precision=i+10,n.rounding=1,t=t.sin(),t.s=1,t=ee(t,new n(1).minus(t.times(t)).sqrt(),i+10,0),n.precision=i,n.rounding=e,N(Ye==2||Ye==4?t.neg():t,i,e,!0)):new n(NaN)};T.times=T.mul=function(i){var e,t,n,r,o,s,a,c,u,l=this,m=l.constructor,d=l.d,p=(i=new m(i)).d;if(i.s*=l.s,!d||!d[0]||!p||!p[0])return new m(!i.s||d&&!d[0]&&!p||p&&!p[0]&&!d?NaN:!d||!p?i.s/0:i.s*0);for(t=ke(l.e/O)+ke(i.e/O),c=d.length,u=p.length,c<u&&(o=d,d=p,p=o,s=c,c=u,u=s),o=[],s=c+u,n=s;n--;)o.push(0);for(n=u;--n>=0;){for(e=0,r=c+n;r>n;)a=o[r]+p[n]*d[r-n-1]+e,o[r--]=a%Ee|0,e=a/Ee|0;o[r]=(o[r]+e)%Ee|0}for(;!o[--s];)o.pop();return e?++t:o.shift(),i.d=o,i.e=Yt(o,t),v?N(i,m.precision,m.rounding):i};T.toBinary=function(i,e){return An(this,2,i,e)};T.toDecimalPlaces=T.toDP=function(i,e){var t=this,n=t.constructor;return t=new n(t),i===void 0?t:(Ie(i,0,it),e===void 0?e=n.rounding:Ie(e,0,8),N(t,i+t.e+1,e))};T.toExponential=function(i,e){var t,n=this,r=n.constructor;return i===void 0?t=We(n,!0):(Ie(i,0,it),e===void 0?e=r.rounding:Ie(e,0,8),n=N(new r(n),i+1,e),t=We(n,!0,i+1)),n.isNeg()&&!n.isZero()?"-"+t:t};T.toFixed=function(i,e){var t,n,r=this,o=r.constructor;return i===void 0?t=We(r):(Ie(i,0,it),e===void 0?e=o.rounding:Ie(e,0,8),n=N(new o(r),i+r.e+1,e),t=We(n,!1,i+n.e+1)),r.isNeg()&&!r.isZero()?"-"+t:t};T.toFraction=function(i){var e,t,n,r,o,s,a,c,u,l,m,d,p=this,g=p.d,f=p.constructor;if(!g)return new f(p);if(u=t=new f(1),n=c=new f(0),e=new f(n),o=e.e=ui(g)-p.e-1,s=o%O,e.d[0]=de(10,s<0?O+s:s),i==null)i=o>0?e:u;else{if(a=new f(i),!a.isInt()||a.lt(u))throw Error(nt+a);i=a.gt(e)?o>0?e:u:a}for(v=!1,a=new f(ye(g)),l=f.precision,f.precision=o=g.length*O*2;m=ee(a,e,0,1,1),r=t.plus(m.times(n)),r.cmp(i)!=1;)t=n,n=r,r=u,u=c.plus(m.times(r)),c=r,r=e,e=a.minus(m.times(r)),a=r;return r=ee(i.minus(t),n,0,1,1),c=c.plus(r.times(u)),t=t.plus(r.times(n)),c.s=u.s=p.s,d=ee(u,n,o,1).minus(p).abs().cmp(ee(c,t,o,1).minus(p).abs())<1?[u,n]:[c,t],f.precision=l,v=!0,d};T.toHexadecimal=T.toHex=function(i,e){return An(this,16,i,e)};T.toNearest=function(i,e){var t=this,n=t.constructor;if(t=new n(t),i==null){if(!t.d)return t;i=new n(1),e=n.rounding}else{if(i=new n(i),e===void 0?e=n.rounding:Ie(e,0,8),!t.d)return i.s?t:i;if(!i.d)return i.s&&(i.s=t.s),i}return i.d[0]?(v=!1,t=ee(t,i,0,e,1).times(i),v=!0,N(t)):(i.s=t.s,t=i),t};T.toNumber=function(){return+this};T.toOctal=function(i,e){return An(this,8,i,e)};T.toPower=T.pow=function(i){var e,t,n,r,o,s,a=this,c=a.constructor,u=+(i=new c(i));if(!a.d||!i.d||!a.d[0]||!i.d[0])return new c(de(+a,u));if(a=new c(a),a.eq(1))return a;if(n=c.precision,o=c.rounding,i.eq(1))return N(a,n,o);if(e=ke(i.e/O),e>=i.d.length-1&&(t=u<0?-u:u)<=gr)return r=li(c,a,t,n),i.s<0?new c(1).div(r):N(r,n,o);if(s=a.s,s<0){if(e<i.d.length-1)return new c(NaN);if((i.d[e]&1)==0&&(s=1),a.e==0&&a.d[0]==1&&a.d.length==1)return a.s=s,a}return t=de(+a,u),e=t==0||!isFinite(t)?ke(u*(Math.log("0."+ye(a.d))/Math.LN10+a.e+1)):new c(t+"").e,e>c.maxE+1||e<c.minE-1?new c(e>0?s/0:0):(v=!1,c.rounding=a.s=1,t=Math.min(12,(e+"").length),r=wn(i.times(tt(a,n+t)),n),r.d&&(r=N(r,n+5,1),Tt(r.d,n,o)&&(e=n+10,r=N(wn(i.times(tt(a,e+t)),e),e+5,1),+ye(r.d).slice(n+1,n+15)+1==1e14&&(r=N(r,n+1,0)))),r.s=s,v=!0,c.rounding=o,N(r,n,o))};T.toPrecision=function(i,e){var t,n=this,r=n.constructor;return i===void 0?t=We(n,n.e<=r.toExpNeg||n.e>=r.toExpPos):(Ie(i,1,it),e===void 0?e=r.rounding:Ie(e,0,8),n=N(new r(n),i,e),t=We(n,i<=n.e||n.e<=r.toExpNeg,i)),n.isNeg()&&!n.isZero()?"-"+t:t};T.toSignificantDigits=T.toSD=function(i,e){var t=this,n=t.constructor;return i===void 0?(i=n.precision,e=n.rounding):(Ie(i,1,it),e===void 0?e=n.rounding:Ie(e,0,8)),N(new n(t),i,e)};T.toString=function(){var i=this,e=i.constructor,t=We(i,i.e<=e.toExpNeg||i.e>=e.toExpPos);return i.isNeg()&&!i.isZero()?"-"+t:t};T.truncated=T.trunc=function(){return N(new this.constructor(this),this.e+1,1)};T.valueOf=T.toJSON=function(){var i=this,e=i.constructor,t=We(i,i.e<=e.toExpNeg||i.e>=e.toExpPos);return i.isNeg()?"-"+t:t};function ye(i){var e,t,n,r=i.length-1,o="",s=i[0];if(r>0){for(o+=s,e=1;e<r;e++)n=i[e]+"",t=O-n.length,t&&(o+=et(t)),o+=n;s=i[e],n=s+"",t=O-n.length,t&&(o+=et(t))}else if(s===0)return"0";for(;s%10===0;)s/=10;return o+s}function Ie(i,e,t){if(i!==~~i||i<e||i>t)throw Error(nt+i)}function Tt(i,e,t,n){var r,o,s,a;for(o=i[0];o>=10;o/=10)--e;return--e<0?(e+=O,r=0):(r=Math.ceil((e+1)/O),e%=O),o=de(10,O-e),a=i[r]%o|0,n==null?e<3?(e==0?a=a/100|0:e==1&&(a=a/10|0),s=t<4&&a==99999||t>3&&a==49999||a==5e4||a==0):s=(t<4&&a+1==o||t>3&&a+1==o/2)&&(i[r+1]/o/100|0)==de(10,e-2)-1||(a==o/2||a==0)&&(i[r+1]/o/100|0)==0:e<4?(e==0?a=a/1e3|0:e==1?a=a/100|0:e==2&&(a=a/10|0),s=(n||t<4)&&a==9999||!n&&t>3&&a==4999):s=((n||t<4)&&a+1==o||!n&&t>3&&a+1==o/2)&&(i[r+1]/o/1e3|0)==de(10,e-3)-1,s}function Xt(i,e,t){for(var n,r=[0],o,s=0,a=i.length;s<a;){for(o=r.length;o--;)r[o]*=e;for(r[0]+=gn.indexOf(i.charAt(s++)),n=0;n<r.length;n++)r[n]>t-1&&(r[n+1]===void 0&&(r[n+1]=0),r[n+1]+=r[n]/t|0,r[n]%=t)}return r.reverse()}function yr(i,e){var t,n,r;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),r=(1/Qt(4,t)).toString()):(t=16,r="2.3283064365386962890625e-10"),i.precision+=t,e=yt(i,1,e.times(r),new i(1));for(var o=t;o--;){var s=e.times(e);e=s.times(s).minus(s).times(8).plus(1)}return i.precision-=t,e}var ee=function(){function i(n,r,o){var s,a=0,c=n.length;for(n=n.slice();c--;)s=n[c]*r+a,n[c]=s%o|0,a=s/o|0;return a&&n.unshift(a),n}function e(n,r,o,s){var a,c;if(o!=s)c=o>s?1:-1;else for(a=c=0;a<o;a++)if(n[a]!=r[a]){c=n[a]>r[a]?1:-1;break}return c}function t(n,r,o,s){for(var a=0;o--;)n[o]-=a,a=n[o]<r[o]?1:0,n[o]=a*s+n[o]-r[o];for(;!n[0]&&n.length>1;)n.shift()}return function(n,r,o,s,a,c){var u,l,m,d,p,g,f,y,b,h,w,A,k,P,x,B,F,L,R,j,te=n.constructor,ce=n.s==r.s?1:-1,ne=n.d,Q=r.d;if(!ne||!ne[0]||!Q||!Q[0])return new te(!n.s||!r.s||(ne?Q&&ne[0]==Q[0]:!Q)?NaN:ne&&ne[0]==0||!Q?ce*0:ce/0);for(c?(p=1,l=n.e-r.e):(c=Ee,p=O,l=ke(n.e/p)-ke(r.e/p)),R=Q.length,F=ne.length,b=new te(ce),h=b.d=[],m=0;Q[m]==(ne[m]||0);m++);if(Q[m]>(ne[m]||0)&&l--,o==null?(P=o=te.precision,s=te.rounding):a?P=o+(n.e-r.e)+1:P=o,P<0)h.push(1),g=!0;else{if(P=P/p+2|0,m=0,R==1){for(d=0,Q=Q[0],P++;(m<F||d)&&P--;m++)x=d*c+(ne[m]||0),h[m]=x/Q|0,d=x%Q|0;g=d||m<F}else{for(d=c/(Q[0]+1)|0,d>1&&(Q=i(Q,d,c),ne=i(ne,d,c),R=Q.length,F=ne.length),B=R,w=ne.slice(0,R),A=w.length;A<R;)w[A++]=0;j=Q.slice(),j.unshift(0),L=Q[0],Q[1]>=c/2&&++L;do d=0,u=e(Q,w,R,A),u<0?(k=w[0],R!=A&&(k=k*c+(w[1]||0)),d=k/L|0,d>1?(d>=c&&(d=c-1),f=i(Q,d,c),y=f.length,A=w.length,u=e(f,w,y,A),u==1&&(d--,t(f,R<y?j:Q,y,c))):(d==0&&(u=d=1),f=Q.slice()),y=f.length,y<A&&f.unshift(0),t(w,f,A,c),u==-1&&(A=w.length,u=e(Q,w,R,A),u<1&&(d++,t(w,R<A?j:Q,A,c))),A=w.length):u===0&&(d++,w=[0]),h[m++]=d,u&&w[0]?w[A++]=ne[B]||0:(w=[ne[B]],A=1);while((B++<F||w[0]!==void 0)&&P--);g=w[0]!==void 0}h[0]||h.shift()}if(p==1)b.e=l,ri=g;else{for(m=1,d=h[0];d>=10;d/=10)m++;b.e=m+l*p-1,N(b,a?o+b.e+1:o,s,g)}return b}}();function N(i,e,t,n){var r,o,s,a,c,u,l,m,d,p=i.constructor;e:if(e!=null){if(m=i.d,!m)return i;for(r=1,a=m[0];a>=10;a/=10)r++;if(o=e-r,o<0)o+=O,s=e,l=m[d=0],c=l/de(10,r-s-1)%10|0;else if(d=Math.ceil((o+1)/O),a=m.length,d>=a)if(n){for(;a++<=d;)m.push(0);l=c=0,r=1,o%=O,s=o-O+1}else break e;else{for(l=a=m[d],r=1;a>=10;a/=10)r++;o%=O,s=o-O+r,c=s<0?0:l/de(10,r-s-1)%10|0}if(n=n||e<0||m[d+1]!==void 0||(s<0?l:l%de(10,r-s-1)),u=t<4?(c||n)&&(t==0||t==(i.s<0?3:2)):c>5||c==5&&(t==4||n||t==6&&(o>0?s>0?l/de(10,r-s):0:m[d-1])%10&1||t==(i.s<0?8:7)),e<1||!m[0])return m.length=0,u?(e-=i.e+1,m[0]=de(10,(O-e%O)%O),i.e=-e||0):m[0]=i.e=0,i;if(o==0?(m.length=d,a=1,d--):(m.length=d+1,a=de(10,O-o),m[d]=s>0?(l/de(10,r-s)%de(10,s)|0)*a:0),u)for(;;)if(d==0){for(o=1,s=m[0];s>=10;s/=10)o++;for(s=m[0]+=a,a=1;s>=10;s/=10)a++;o!=a&&(i.e++,m[0]==Ee&&(m[0]=1));break}else{if(m[d]+=a,m[d]!=Ee)break;m[d--]=0,a=1}for(o=m.length;m[--o]===0;)m.pop()}return v&&(i.e>p.maxE?(i.d=null,i.e=NaN):i.e<p.minE&&(i.e=0,i.d=[0])),i}function We(i,e,t){if(!i.isFinite())return di(i);var n,r=i.e,o=ye(i.d),s=o.length;return e?(t&&(n=t-s)>0?o=o.charAt(0)+"."+o.slice(1)+et(n):s>1&&(o=o.charAt(0)+"."+o.slice(1)),o=o+(i.e<0?"e":"e+")+i.e):r<0?(o="0."+et(-r-1)+o,t&&(n=t-s)>0&&(o+=et(n))):r>=s?(o+=et(r+1-s),t&&(n=t-r-1)>0&&(o=o+"."+et(n))):((n=r+1)<s&&(o=o.slice(0,n)+"."+o.slice(n)),t&&(n=t-s)>0&&(r+1===s&&(o+="."),o+=et(n))),o}function Yt(i,e){var t=i[0];for(e*=O;t>=10;t/=10)e++;return e}function Zt(i,e,t){if(e>br)throw v=!0,t&&(i.precision=t),Error(oi);return N(new i(zt),e,1,!0)}function Oe(i,e,t){if(e>yn)throw Error(oi);return N(new i(Ht),e,t,!0)}function ui(i){var e=i.length-1,t=e*O+1;if(e=i[e],e){for(;e%10==0;e/=10)t--;for(e=i[0];e>=10;e/=10)t++}return t}function et(i){for(var e="";i--;)e+="0";return e}function li(i,e,t,n){var r,o=new i(1),s=Math.ceil(n/O+4);for(v=!1;;){if(t%2&&(o=o.times(e),ni(o.d,s)&&(r=!0)),t=ke(t/2),t===0){t=o.d.length-1,r&&o.d[t]===0&&++o.d[t];break}e=e.times(e),ni(e.d,s)}return v=!0,o}function ti(i){return i.d[i.d.length-1]&1}function mi(i,e,t){for(var n,r=new i(e[0]),o=0;++o<e.length;)if(n=new i(e[o]),n.s)r[t](n)&&(r=n);else{r=n;break}return r}function wn(i,e){var t,n,r,o,s,a,c,u=0,l=0,m=0,d=i.constructor,p=d.rounding,g=d.precision;if(!i.d||!i.d[0]||i.e>17)return new d(i.d?i.d[0]?i.s<0?0:1/0:1:i.s?i.s<0?0:i:0/0);for(e==null?(v=!1,c=g):c=e,a=new d(.03125);i.e>-2;)i=i.times(a),m+=5;for(n=Math.log(de(2,m))/Math.LN10*2+5|0,c+=n,t=o=s=new d(1),d.precision=c;;){if(o=N(o.times(i),c,1),t=t.times(++l),a=s.plus(ee(o,t,c,1)),ye(a.d).slice(0,c)===ye(s.d).slice(0,c)){for(r=m;r--;)s=N(s.times(s),c,1);if(e==null)if(u<3&&Tt(s.d,c-n,p,u))d.precision=c+=10,t=o=a=new d(1),l=0,u++;else return N(s,d.precision=g,p,v=!0);else return d.precision=g,s}s=a}}function tt(i,e){var t,n,r,o,s,a,c,u,l,m,d,p=1,g=10,f=i,y=f.d,b=f.constructor,h=b.rounding,w=b.precision;if(f.s<0||!y||!y[0]||!f.e&&y[0]==1&&y.length==1)return new b(y&&!y[0]?-1/0:f.s!=1?NaN:y?0:f);if(e==null?(v=!1,l=w):l=e,b.precision=l+=g,t=ye(y),n=t.charAt(0),Math.abs(o=f.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)f=f.times(i),t=ye(f.d),n=t.charAt(0),p++;o=f.e,n>1?(f=new b("0."+t),o++):f=new b(n+"."+t.slice(1))}else return u=Zt(b,l+2,w).times(o+""),f=tt(new b(n+"."+t.slice(1)),l-g).plus(u),b.precision=w,e==null?N(f,w,h,v=!0):f;for(m=f,c=s=f=ee(f.minus(1),f.plus(1),l,1),d=N(f.times(f),l,1),r=3;;){if(s=N(s.times(d),l,1),u=c.plus(ee(s,new b(r),l,1)),ye(u.d).slice(0,l)===ye(c.d).slice(0,l))if(c=c.times(2),o!==0&&(c=c.plus(Zt(b,l+2,w).times(o+""))),c=ee(c,new b(p),l,1),e==null)if(Tt(c.d,l-g,h,a))b.precision=l+=g,u=s=f=ee(m.minus(1),m.plus(1),l,1),d=N(f.times(f),l,1),r=a=1;else return N(c,b.precision=w,h,v=!0);else return b.precision=w,c;c=u,r+=2}}function di(i){return String(i.s*i.s/0)}function hn(i,e){var t,n,r;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(r=e.length;e.charCodeAt(r-1)===48;--r);if(e=e.slice(n,r),e){if(r-=n,i.e=t=t-n-1,i.d=[],n=(t+1)%O,t<0&&(n+=O),n<r){for(n&&i.d.push(+e.slice(0,n)),r-=O;n<r;)i.d.push(+e.slice(n,n+=O));e=e.slice(n),n=O-e.length}else n-=r;for(;n--;)e+="0";i.d.push(+e),v&&(i.e>i.constructor.maxE?(i.d=null,i.e=NaN):i.e<i.constructor.minE&&(i.e=0,i.d=[0]))}else i.e=0,i.d=[0];return i}function wr(i,e){var t,n,r,o,s,a,c,u,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),ci.test(e))return hn(i,e)}else if(e==="Infinity"||e==="NaN")return+e||(i.s=NaN),i.e=NaN,i.d=null,i;if(pr.test(e))t=16,e=e.toLowerCase();else if(dr.test(e))t=2;else if(fr.test(e))t=8;else throw Error(nt+e);for(o=e.search(/p/i),o>0?(c=+e.slice(o+1),e=e.substring(2,o)):e=e.slice(2),o=e.indexOf("."),s=o>=0,n=i.constructor,s&&(e=e.replace(".",""),a=e.length,o=a-o,r=li(n,new n(t),o,o*2)),u=Xt(e,t,Ee),l=u.length-1,o=l;u[o]===0;--o)u.pop();return o<0?new n(i.s*0):(i.e=Yt(u,l),i.d=u,v=!1,s&&(i=ee(i,r,a*4)),c&&(i=i.times(Math.abs(c)<54?de(2,c):kt.pow(2,c))),v=!0,i)}function hr(i,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:yt(i,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/Qt(5,t)),e=yt(i,2,e,e);for(var r,o=new i(5),s=new i(16),a=new i(20);t--;)r=e.times(e),e=e.times(o.plus(r.times(s.times(r).minus(a))));return e}function yt(i,e,t,n,r){var o,s,a,c,u=1,l=i.precision,m=Math.ceil(l/O);for(v=!1,c=t.times(t),a=new i(n);;){if(s=ee(a.times(c),new i(e++*e++),l,1),a=r?n.plus(s):n.minus(s),n=ee(s.times(c),new i(e++*e++),l,1),s=a.plus(n),s.d[m]!==void 0){for(o=m;s.d[o]===a.d[o]&&o--;);if(o==-1)break}o=a,a=n,n=s,s=o,u++}return v=!0,s.d.length=m+1,s}function Qt(i,e){for(var t=i;--e;)t*=i;return t}function pi(i,e){var t,n=e.s<0,r=Oe(i,i.precision,1),o=r.times(.5);if(e=e.abs(),e.lte(o))return Ye=n?4:1,e;if(t=e.divToInt(r),t.isZero())Ye=n?3:2;else{if(e=e.minus(t.times(r)),e.lte(o))return Ye=ti(t)?n?2:3:n?4:1,e;Ye=ti(t)?n?1:4:n?3:2}return e.minus(r).abs()}function An(i,e,t,n){var r,o,s,a,c,u,l,m,d,p=i.constructor,g=t!==void 0;if(g?(Ie(t,1,it),n===void 0?n=p.rounding:Ie(n,0,8)):(t=p.precision,n=p.rounding),!i.isFinite())l=di(i);else{for(l=We(i),s=l.indexOf("."),g?(r=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):r=e,s>=0&&(l=l.replace(".",""),d=new p(1),d.e=l.length-s,d.d=Xt(We(d),10,r),d.e=d.d.length),m=Xt(l,10,r),o=c=m.length;m[--c]==0;)m.pop();if(!m[0])l=g?"0p+0":"0";else{if(s<0?o--:(i=new p(i),i.d=m,i.e=o,i=ee(i,d,t,n,0,r),m=i.d,o=i.e,u=ri),s=m[t],a=r/2,u=u||m[t+1]!==void 0,u=n<4?(s!==void 0||u)&&(n===0||n===(i.s<0?3:2)):s>a||s===a&&(n===4||u||n===6&&m[t-1]&1||n===(i.s<0?8:7)),m.length=t,u)for(;++m[--t]>r-1;)m[t]=0,t||(++o,m.unshift(1));for(c=m.length;!m[c-1];--c);for(s=0,l="";s<c;s++)l+=gn.charAt(m[s]);if(g){if(c>1)if(e==16||e==8){for(s=e==16?4:3,--c;c%s;c++)l+="0";for(m=Xt(l,r,e),c=m.length;!m[c-1];--c);for(s=1,l="1.";s<c;s++)l+=gn.charAt(m[s])}else l=l.charAt(0)+"."+l.slice(1);l=l+(o<0?"p":"p+")+o}else if(o<0){for(;++o;)l="0"+l;l="0."+l}else if(++o>c)for(o-=c;o--;)l+="0";else o<c&&(l=l.slice(0,o)+"."+l.slice(o))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return i.s<0?"-"+l:l}function ni(i,e){if(i.length>e)return i.length=e,!0}function Ar(i){return new this(i).abs()}function Pr(i){return new this(i).acos()}function Tr(i){return new this(i).acosh()}function kr(i,e){return new this(i).plus(e)}function xr(i){return new this(i).asin()}function Br(i){return new this(i).asinh()}function Ir(i){return new this(i).atan()}function Cr(i){return new this(i).atanh()}function Sr(i,e){i=new this(i),e=new this(e);var t,n=this.precision,r=this.rounding,o=n+4;return!i.s||!e.s?t=new this(NaN):!i.d&&!e.d?(t=Oe(this,o,1).times(e.s>0?.25:.75),t.s=i.s):!e.d||i.isZero()?(t=e.s<0?Oe(this,n,r):new this(0),t.s=i.s):!i.d||e.isZero()?(t=Oe(this,o,1).times(.5),t.s=i.s):e.s<0?(this.precision=o,this.rounding=1,t=this.atan(ee(i,e,o,1)),e=Oe(this,o,1),this.precision=n,this.rounding=r,t=i.s<0?t.minus(e):t.plus(e)):t=this.atan(ee(i,e,o,1)),t}function Kr(i){return new this(i).cbrt()}function Nr(i){return N(i=new this(i),i.e+1,2)}function Rr(i,e,t){return new this(i).clamp(e,t)}function Lr(i){if(!i||typeof i!="object")throw Error(jt+"Object expected");var e,t,n,r=i.defaults===!0,o=["precision",1,it,"rounding",0,8,"toExpNeg",-bt,0,"toExpPos",0,bt,"maxE",0,bt,"minE",-bt,0,"modulo",0,9];for(e=0;e<o.length;e+=3)if(t=o[e],r&&(this[t]=bn[t]),(n=i[t])!==void 0)if(ke(n)===n&&n>=o[e+1]&&n<=o[e+2])this[t]=n;else throw Error(nt+t+": "+n);if(t="crypto",r&&(this[t]=bn[t]),(n=i[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(si);else this[t]=!1;else throw Error(nt+t+": "+n);return this}function Mr(i){return new this(i).cos()}function Fr(i){return new this(i).cosh()}function fi(i){var e,t,n;function r(o){var s,a,c,u=this;if(!(u instanceof r))return new r(o);if(u.constructor=r,ii(o)){u.s=o.s,v?!o.d||o.e>r.maxE?(u.e=NaN,u.d=null):o.e<r.minE?(u.e=0,u.d=[0]):(u.e=o.e,u.d=o.d.slice()):(u.e=o.e,u.d=o.d?o.d.slice():o.d);return}if(c=typeof o,c==="number"){if(o===0){u.s=1/o<0?-1:1,u.e=0,u.d=[0];return}if(o<0?(o=-o,u.s=-1):u.s=1,o===~~o&&o<1e7){for(s=0,a=o;a>=10;a/=10)s++;v?s>r.maxE?(u.e=NaN,u.d=null):s<r.minE?(u.e=0,u.d=[0]):(u.e=s,u.d=[o]):(u.e=s,u.d=[o]);return}else if(o*0!==0){o||(u.s=NaN),u.e=NaN,u.d=null;return}return hn(u,o.toString())}else if(c!=="string")throw Error(nt+o);return(a=o.charCodeAt(0))===45?(o=o.slice(1),u.s=-1):(a===43&&(o=o.slice(1)),u.s=1),ci.test(o)?hn(u,o):wr(u,o)}if(r.prototype=T,r.ROUND_UP=0,r.ROUND_DOWN=1,r.ROUND_CEIL=2,r.ROUND_FLOOR=3,r.ROUND_HALF_UP=4,r.ROUND_HALF_DOWN=5,r.ROUND_HALF_EVEN=6,r.ROUND_HALF_CEIL=7,r.ROUND_HALF_FLOOR=8,r.EUCLID=9,r.config=r.set=Lr,r.clone=fi,r.isDecimal=ii,r.abs=Ar,r.acos=Pr,r.acosh=Tr,r.add=kr,r.asin=xr,r.asinh=Br,r.atan=Ir,r.atanh=Cr,r.atan2=Sr,r.cbrt=Kr,r.ceil=Nr,r.clamp=Rr,r.cos=Mr,r.cosh=Fr,r.div=Or,r.exp=Er,r.floor=Dr,r.hypot=vr,r.ln=_r,r.log=Vr,r.log10=Wr,r.log2=qr,r.max=Gr,r.min=Ur,r.mod=Xr,r.mul=zr,r.pow=Hr,r.random=Zr,r.round=jr,r.sign=Yr,r.sin=Qr,r.sinh=Jr,r.sqrt=$r,r.sub=eo,r.sum=to,r.tan=no,r.tanh=io,r.trunc=ro,i===void 0&&(i={}),i&&i.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)i.hasOwnProperty(t=n[e++])||(i[t]=this[t]);return r.config(i),r}function Or(i,e){return new this(i).div(e)}function Er(i){return new this(i).exp()}function Dr(i){return N(i=new this(i),i.e+1,3)}function vr(){var i,e,t=new this(0);for(v=!1,i=0;i<arguments.length;)if(e=new this(arguments[i++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return v=!0,new this(1/0);t=e}return v=!0,t.sqrt()}function ii(i){return i instanceof kt||i&&i.toStringTag===ai||!1}function _r(i){return new this(i).ln()}function Vr(i,e){return new this(i).log(e)}function qr(i){return new this(i).log(2)}function Wr(i){return new this(i).log(10)}function Gr(){return mi(this,arguments,"lt")}function Ur(){return mi(this,arguments,"gt")}function Xr(i,e){return new this(i).mod(e)}function zr(i,e){return new this(i).mul(e)}function Hr(i,e){return new this(i).pow(e)}function Zr(i){var e,t,n,r,o=0,s=new this(1),a=[];if(i===void 0?i=this.precision:Ie(i,1,it),n=Math.ceil(i/O),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));o<n;)r=e[o],r>=429e7?e[o]=crypto.getRandomValues(new Uint32Array(1))[0]:a[o++]=r%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);o<n;)r=e[o]+(e[o+1]<<8)+(e[o+2]<<16)+((e[o+3]&127)<<24),r>=214e7?crypto.randomBytes(4).copy(e,o):(a.push(r%1e7),o+=4);o=n/4}else throw Error(si);else for(;o<n;)a[o++]=Math.random()*1e7|0;for(n=a[--o],i%=O,n&&i&&(r=de(10,O-i),a[o]=(n/r|0)*r);a[o]===0;o--)a.pop();if(o<0)t=0,a=[0];else{for(t=-1;a[0]===0;t-=O)a.shift();for(n=1,r=a[0];r>=10;r/=10)n++;n<O&&(t-=O-n)}return s.e=t,s.d=a,s}function jr(i){return N(i=new this(i),i.e+1,this.rounding)}function Yr(i){return i=new this(i),i.d?i.d[0]?i.s:0*i.s:i.s||NaN}function Qr(i){return new this(i).sin()}function Jr(i){return new this(i).sinh()}function $r(i){return new this(i).sqrt()}function eo(i,e){return new this(i).sub(e)}function to(){var i=0,e=arguments,t=new this(e[i]);for(v=!1;t.s&&++i<e.length;)t=t.plus(e[i]);return v=!0,N(t,this.precision,this.rounding)}function no(i){return new this(i).tan()}function io(i){return new this(i).tanh()}function ro(i){return N(i=new this(i),i.e+1,1)}T[Symbol.for("nodejs.util.inspect.custom")]=T.toString;T[Symbol.toStringTag]="Decimal";var kt=T.constructor=fi(bn);zt=new kt(zt);Ht=new kt(Ht);var C=kt;import{get as gi,set as oo}from"lodash";var Pn=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},bi={},so={};function we(i){let e=gi(bi,i);if(!e){let t=gi(so,i);e=new Pn({name:i,logLevel:t}),oo(bi,i,e)}return e}import{PublicKey as sc}from"@solana/web3.js";import cc from"bn.js";import Po from"big.js";import nn from"bn.js";import Ce from"bn.js";import{PublicKey as Bn}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ao}from"@solana/spl-token";import{PublicKey as oe,SystemProgram as yi,SYSVAR_RENT_PUBKEY as co}from"@solana/web3.js";function Tn({pubkey:i,isSigner:e=!1,isWritable:t=!0}){return{pubkey:i,isWritable:t,isSigner:e}}var As=[Tn({pubkey:ao,isWritable:!1}),Tn({pubkey:yi.programId,isWritable:!1}),Tn({pubkey:co,isWritable:!1})];function kn({publicKey:i,transformSol:e}){let t=wi(i.toString());if(t instanceof oe)return e&&t.equals(xt)?J:t;if(e&&t.toString()===xt.toBase58())return J;if(typeof t=="string"){if(t===oe.default.toBase58())return oe.default;try{return new oe(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function wi(i){try{return new oe(i)}catch{return i}}var Jt=new oe("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),Ps=new oe("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),Bt=new oe("SysvarRent111111111111111111111111111111111"),Ts=new oe("SysvarC1ock11111111111111111111111111111111"),wt=new oe("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),ks=new oe("Sysvar1nstructions1111111111111111111111111"),xs=yi.programId,Bs=new oe("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Is=new oe("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),Cs=new oe("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),Ss=new oe("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),Ks=new oe("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),Ns=new oe("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),Rs=new oe("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),Ls=new oe("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),Ms=new oe("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),Fs=new oe("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),Os=new oe("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),J=new oe("So11111111111111111111111111111111111111112"),xt=oe.default;function ut(i){return kn({publicKey:i,transformSol:!0})}import{PublicKey as uo}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as hi}from"@solana/spl-token";var xn={chainId:101,address:uo.default.toBase58(),programId:hi.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},rt={chainId:101,address:"So11111111111111111111111111111111111111112",programId:hi.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};var In=class{constructor({mint:e,decimals:t,symbol:n,name:r,skipMint:o=!1,isToken2022:s=!1}){if(e===xt.toBase58()||e instanceof Bn&&xt.equals(e)){this.decimals=rt.decimals,this.symbol=rt.symbol,this.name=rt.name,this.mint=new Bn(rt.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=r||e.toString().substring(0,6),this.mint=o?Bn.default:kn({publicKey:e}),this.isToken2022=s}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Ge=In;Ge.WSOL=new In(G(S({},rt),{mint:rt.address}));import en from"big.js";import po from"bn.js";import fo from"decimal.js-light";import lo from"toformat";var mo=lo,It=mo;var $t=we("module/fraction"),Cn=It(en),Ct=It(fo),go={[0]:Ct.ROUND_DOWN,[1]:Ct.ROUND_HALF_UP,[2]:Ct.ROUND_UP},bo={[0]:en.roundDown,[1]:en.roundHalfUp,[2]:en.roundUp},Y=class{constructor(e,t=new po(1)){this.numerator=he(e),this.denominator=he(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new Y(this.denominator,this.numerator)}add(e){let t=e instanceof Y?e:new Y(he(e));return this.denominator.eq(t.denominator)?new Y(this.numerator.add(t.numerator),this.denominator):new Y(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof Y?e:new Y(he(e));return this.denominator.eq(t.denominator)?new Y(this.numerator.sub(t.numerator),this.denominator):new Y(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof Y?e:new Y(he(e));return new Y(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof Y?e:new Y(he(e));return new Y(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||$t.logWithError(`${e} is not an integer.`),e<=0&&$t.logWithError(`${e} is not positive.`),Ct.set({precision:e+1,rounding:go[n]});let r=new Ct(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return r.toFormat(r.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||$t.logWithError(`${e} is not an integer.`),e<0&&$t.logWithError(`${e} is negative.`),Cn.DP=e,Cn.RM=bo[n]||1,new Cn(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var wo=we("Raydium_price"),De=class extends Y{constructor(t){let{baseToken:n,quoteToken:r,numerator:o,denominator:s}=t;super(o,s);this.baseToken=n,this.quoteToken=r,this.scalar=new Y(Sn(n.decimals),Sn(r.decimals))}get raw(){return new Y(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new De({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&wo.logWithError("mul token not equals");let n=super.mul(t);return new De({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(t=this.quoteToken.decimals,n,r){return this.adjusted.toSignificant(t,n,r)}toFixed(t=this.quoteToken.decimals,n,r){return this.adjusted.toFixed(t,n,r)}};var Kn=class{constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},tn=Kn;tn.SOL=new Kn(xn);import ho from"bn.js";var Ai=new Y(new ho(100)),ot=class extends Y{toSignificant(e=5,t,n){return this.mul(Ai).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(Ai).toFixed(e,t,n)}};var Ao=new Ce(0),Ra=new Ce(1),La=new Ce(2),Ma=new Ce(3),Fa=new Ce(5),Nn=new Ce(10),Oa=new Ce(100),Ea=new Ce(1e3),Da=new Ce(1e4),Pi=9007199254740991;function he(i){let e=we("Raydium_parseBigNumberish");if(i instanceof Ce)return i;if(typeof i=="string"){if(i.match(/^-?[0-9]+$/))return new Ce(i);e.logWithError(`invalid BigNumberish string: ${i}`)}return typeof i=="number"?(i%1&&e.logWithError(`BigNumberish number underflow: ${i}`),(i>=Pi||i<=-Pi)&&e.logWithError(`BigNumberish number overflow: ${i}`),new Ce(String(i))):typeof i=="bigint"?new Ce(i.toString()):(e.error(`invalid BigNumberish value: ${i}`),new Ce(0))}function Sn(i){return Nn.pow(he(i))}var To=we("Raydium_amount"),Ti=It(Po);function ko(i,e){let t="0",n="0";if(i.includes(".")){let r=i.split(".");r.length===2?([t,n]=r,n=n.padEnd(e,"0")):To.logWithError(`invalid number string, num: ${i}`)}else t=i;return[t,n.slice(0,e)||n]}var Ae=class extends Y{constructor(t,n,r=!0,o){let s=new nn(0),a=Nn.pow(new nn(t.decimals));if(r)s=he(n);else{let c=new nn(0),u=new nn(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,m]=ko(n.toString(),t.decimals);c=he(l),u=he(m)}c=c.mul(a),s=c.add(u)}super(s,a);this.logger=we(o||"TokenAmount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new Ae(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new Ae(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,n,r=0){return super.toSignificant(t,n,r)}toFixed(t=this.token.decimals,n,r=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,r)}toExact(t={groupSeparator:""}){return Ti.DP=this.token.decimals,new Ti(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};import{PublicKey as Nt,sendAndConfirmTransaction as Fn,Transaction as Rt,TransactionMessage as Lt,VersionedTransaction as Mt}from"@solana/web3.js";import Fo from"axios";var ue={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut"};import{PublicKey as xo,ComputeBudgetProgram as ki,Transaction as Bi,TransactionMessage as Bo,Keypair as Ii,VersionedTransaction as Ci}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Io}from"@solana/spl-token";var xi=we("Raydium_txUtil"),Si=1644;function rn(i){let e=[],t=[];return i.microLamports&&(e.push(ki.setComputeUnitPrice({microLamports:i.microLamports})),t.push(ue.SetComputeUnitPrice)),i.units&&(e.push(ki.setComputeUnitLimit({units:i.units})),t.push(ue.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function ht(i,e){var n,r;let t=e!=null?e:"confirmed";try{return((r=await((n=i.getLatestBlockhash)==null?void 0:n.call(i,{commitment:t})))==null?void 0:r.blockhash)||(await i.getRecentBlockhash(t)).blockhash}catch{return(await i.getRecentBlockhash(t)).blockhash}}function Co(i,e){i.length<1&&xi.logWithError(`no instructions provided: ${i.toString()}`),e.length<1&&xi.logWithError(`no signers provided:, ${e.toString()}`);let t=new Bi;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...i);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<Si}catch{return!1}}function Se(i,e){let[t,n]=xo.findProgramAddressSync(i,e);return{publicKey:t,nonce:n}}function St({instructions:i,payer:e,signers:t}){return Co(i,[e,...t])}function Kt({instructions:i,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=Ii.generate().publicKey.toString()}){let o=new Bo({payerKey:e,recentBlockhash:n,instructions:i}).compileToV0Message(Object.values(t!=null?t:{}));try{return Buffer.from(new Ci(o).serialize()).toString("base64").length<Si}catch{return!1}}var So=i=>Buffer.isBuffer(i)?i:i instanceof Uint8Array?Buffer.from(i.buffer,i.byteOffset,i.byteLength):Buffer.from(i);function lt(i){let e=[];return i.forEach(t=>{t instanceof Bi&&(t.recentBlockhash||(t.recentBlockhash=Io.toBase58()),t.feePayer||(t.feePayer=Ii.generate().publicKey));let n=t.serialize({requireAllSignatures:!1,verifySignatures:!1});t instanceof Ci&&(n=So(n));let r=n.toString("base64");e.push(r)}),console.log("simulate tx string:",e),e}import{PublicKey as Ri,AddressLookupTableAccount as on}from"@solana/web3.js";import{PublicKey as Ki}from"@solana/web3.js";import{MINT_SIZE as Ko,TOKEN_PROGRAM_ID as No,getTransferFeeConfig as Ro,unpackMint as Lo}from"@solana/spl-token";var Rn=we("Raydium_accountInfo_util");async function Qe(i,e,t){let{batchRequest:n,commitment:r="confirmed",chunkCount:o=100}=S({batchRequest:!1},t),s=Ln(e,o),a=new Array(s.length).fill([]);if(n){let c=s.map(m=>{let d=i._buildArgs([m.map(p=>p.toBase58())],r,"base64");return{methodName:"getMultipleAccounts",args:d}}),u=Ln(c,10);a=(await(await Promise.all(u.map(async m=>await i._rpcBatchRequest(m)))).flat()).map(m=>(m.error&&Rn.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${m.error.message}`),m.result.value.map(d=>{if(d){let{data:p,executable:g,lamports:f,owner:y,rentEpoch:b}=d;return p.length!==2&&p[1]!=="base64"&&Rn.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(p[0],"base64"),executable:g,lamports:f,owner:new Ki(y),rentEpoch:b}}return null})))}else try{a=await Promise.all(s.map(c=>i.getMultipleAccountsInfo(c,r)))}catch(c){c instanceof Error&&Rn.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${c.message}`)}return a.flat()}async function st(i,e,t){let n=await Qe(i,e.map(r=>r.pubkey),t);return e.map((r,o)=>G(S({},r),{accountInfo:n[o]}))}async function Ni({connection:i,mints:e,config:t}){var o,s,a;if(e.length===0)return{};let n=await st(i,e.map(c=>({pubkey:ut(c)})),t),r={};for(let c of n){if(!c.accountInfo||c.accountInfo.data.length<Ko){console.log("invalid mint account",c.pubkey.toBase58());continue}let u=Lo(c.pubkey,c.accountInfo,(o=c.accountInfo)==null?void 0:o.owner);r[c.pubkey.toString()]=G(S({},u),{programId:((s=c.accountInfo)==null?void 0:s.owner)||No,feeConfig:(a=Ro(u))!=null?a:void 0})}return r[Ki.default.toBase58()]=r[J.toBase58()],r}async function Mn({connection:i,address:e}){let t=await Qe(i,[...new Set(e.map(r=>r.toString()))].map(r=>new Ri(r))),n={};for(let r=0;r<e.length;r++){let o=t[r],s=e[r];if(!o)continue;let a=new on({key:s,state:on.deserialize(o.data)});n[s.toString()]=a,sn[s.toString()]=a}return n}var sn={"2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17":new on({key:new Ri("2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17"),state:on.deserialize(Buffer.from("AQAAAP//////////d49+DAAAAAAAAQZMWvw7GUNJdaccNBVnb57OKakxL2BHLYvhRwVILRsgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMGRm/lIRcy/+ytunLDm+e8jOW7xfcSayxDmzpAAAAABt324ddloZPZy+FGzut5rBy0he1fWzeROoz1hX7/AKkG3fbh7nWP3hhCXbzkbM3athr8TYO5DSf+vfko2KGL/AVKU1D4XciC1hSlVnJ4iilt3x6rq9CmBniISTL07vagBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvDQdRqCgtphMF/imcN7mY5YRx2xE1A3MQ+L4QRaYK9u4GRfZP3LsAd00a+IkCpA22UNQMKdq5BFbJuwuOLqc8zxCTDlqxBG8J0HcxtfogQHDK06ukzfaXiNDKAob1MqBHS9lJxDYCwz8gd5DtFqNSTKG5l1zxIaKpDP/sffi2is1H9aKveyXSu5StXElYRl9SD5As0DHE4N0GLnf84/siiKXVyp4Ez121kLcUui/jLLFZEz/BwZK3Ilf9B9OcsEAeDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu9N9LMnrw/JNO0hqMVB4rk/2ou4AB1loQ7FZoPwut2o4KZB+0p9xnbrQKw038qjpHar+PyDwvxBRcu5hpHw3dguezeWv+IwvgW5icu8EGkhGa9AkFPPJT7VMSFb8xowveU=","base64"))})};var an=class{constructor(e){this.instructions=[];this.endInstructions=[];this.lookupTableAddress=[];this.signers=[];this.instructionTypes=[];this.endInstructionTypes=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster,this.blockhashCommitment=e.blockhashCommitment,this.api=e.api}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){var n;let e=(await Fo.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=(n=e==null?void 0:e[15])!=null?n:{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=rn(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:r=[],endInstructionTypes:o=[],lookupTableAddress:s=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...r),this.endInstructionTypes.push(...o),this.lookupTableAddress.push(...s.filter(a=>a!==Nt.default.toString())),this}async versionBuild({txVersion:e,extInfo:t}){return e===0?await this.buildV0(S({},t||{})):this.build(t)}build(e){var n;let t=new Rt;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,((n=this.owner)==null?void 0:n.signer)&&!this.signers.some(r=>r.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer),{builder:this,transaction:t,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async r=>{var u;let{recentBlockHash:o,skipPreflight:s=!0,sendAndConfirm:a}=r||{},c=o!=null?o:await ht(this.connection,this.blockhashCommitment);if(t.recentBlockhash=c,this.signers.length&&t.sign(...this.signers),lt([t]),(u=this.owner)!=null&&u.isKeyPair)return{txId:a?await Fn(this.connection,t,this.signers.find(m=>m.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:s}):await this.connection.sendRawTransaction(t.serialize(),{skipPreflight:s}),signedTx:t};if(this.signAllTransactions){let l=await this.signAllTransactions([t]);return{txId:await this.connection.sendRawTransaction(l[0].serialize(),{skipPreflight:s}),signedTx:l[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){var u;let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:r}=this.build(n),o=t.filter(l=>l.transaction.instructions.length>0),s=[r,...o.map(l=>l.transaction)],a=[this.signers,...o.map(l=>l.signers)],c=[...this.instructionTypes,...o.map(l=>l.instructionTypes).flat()];return(u=this.owner)!=null&&u.signer&&a.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),{builder:this,transactions:s,signers:a,instructionTypes:c,execute:async l=>{var y;let{sequentially:m,onTxUpdate:d,recentBlockHash:p,skipPreflight:g=!0}=l||{},f=p!=null?p:await ht(this.connection,this.blockhashCommitment);if((y=this.owner)!=null&&y.isKeyPair){if(m){let b=[];for(let h of s){let w=await Fn(this.connection,h,this.signers.find(A=>A.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:g});b.push(w)}return{txIds:b,signedTxs:s}}return{txIds:await await Promise.all(s.map(async b=>(b.recentBlockhash=f,await this.connection.sendRawTransaction(b.serialize(),{skipPreflight:g})))),signedTxs:s}}if(this.signAllTransactions){let b=s.map((w,A)=>(w.recentBlockhash=f,a[A].length&&w.sign(...a[A]),w));lt(b);let h=await this.signAllTransactions(b);if(m){let w=0,A=[],k=async()=>{if(!h[w])return;let P=await this.connection.sendRawTransaction(h[w].serialize(),{skipPreflight:g});A.push({txId:P,status:"sent",signedTx:h[w]}),d==null||d([...A]),w++,this.connection.onSignature(P,x=>{let B=A.findIndex(F=>F.txId===P);B>-1&&(A[B].status=x.err?"error":"success"),d==null||d([...A]),x.err||k()},"processed"),this.connection.getSignatureStatus(P)};return await k(),{txIds:A.map(P=>P.txId),signedTxs:h}}else{let w=[];for(let A=0;A<h.length;A+=1){let k=await this.connection.sendRawTransaction(h[A].serialize(),{skipPreflight:g});w.push(k)}return{txIds:w,signedTxs:h}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e){var f;let g=e||{},{lookupTableCache:t={},lookupTableAddress:n=[],forerunCreate:r,recentBlockhash:o}=g,s=gt(g,["lookupTableCache","lookupTableAddress","forerunCreate","recentBlockhash"]),a=S(S({},this.cluster==="devnet"?{}:sn),t),c=Array.from(new Set([...n,...this.lookupTableAddress])),u=[];for(let y of c)a[y]===void 0&&u.push(new Nt(y));let l=await Mn({connection:this.connection,address:u});for(let[y,b]of Object.entries(l))a[y]=b;let m=r?Nt.default.toBase58():o!=null?o:await ht(this.connection,this.blockhashCommitment),d=new Lt({payerKey:this.feePayer,recentBlockhash:m,instructions:[...this.allInstructions]}).compileToV0Message(Object.values(a));((f=this.owner)==null?void 0:f.signer)&&!this.signers.some(y=>y.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer);let p=new Mt(d);return p.sign(this.signers),{builder:this,transaction:p,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async y=>{var w;let{skipPreflight:b=!0,sendAndConfirm:h}=y||{};if(lt([p]),(w=this.owner)!=null&&w.isKeyPair){let A=await this.connection.sendTransaction(p,{skipPreflight:b});if(h){let{lastValidBlockHeight:k,blockhash:P}=await this.connection.getLatestBlockhash({commitment:this.blockhashCommitment});await this.connection.confirmTransaction({blockhash:P,lastValidBlockHeight:k,signature:A},"confirmed")}return{txId:A,signedTx:p}}if(this.signAllTransactions){let A=await this.signAllTransactions([p]);return{txId:await this.connection.sendTransaction(A[0],{skipPreflight:b}),signedTx:A[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}async buildV0MultiTx(e){var u;let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:r}=await this.buildV0(n),o=t.filter(l=>l.builder.instructions.length>0),s=[r,...o.map(l=>l.transaction)],a=[this.signers,...o.map(l=>l.signers)],c=[...this.instructionTypes,...o.map(l=>l.instructionTypes).flat()];return(u=this.owner)!=null&&u.signer&&a.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),s.forEach(async(l,m)=>{l.sign(a[m])}),{builder:this,transactions:s,signers:a,instructionTypes:c,buildProps:n,execute:async l=>{var f;let{sequentially:m,onTxUpdate:d,recentBlockHash:p,skipPreflight:g=!0}=l||{};if(p&&s.forEach(y=>y.message.recentBlockhash=p),lt(s),(f=this.owner)!=null&&f.isKeyPair){if(m){let y=[];for(let b of s){let h=await this.connection.sendTransaction(b,{skipPreflight:g}),{lastValidBlockHeight:w,blockhash:A}=await this.connection.getLatestBlockhash({commitment:this.blockhashCommitment});await this.connection.confirmTransaction({blockhash:A,lastValidBlockHeight:w,signature:h},"confirmed"),y.push(h)}return{txIds:y,signedTxs:s}}return{txIds:await Promise.all(s.map(async y=>await this.connection.sendTransaction(y,{skipPreflight:g}))),signedTxs:s}}if(this.signAllTransactions){let y=await this.signAllTransactions(s);if(m){let b=0,h=[],w=async()=>{if(!y[b])return;let A=await this.connection.sendTransaction(y[b],{skipPreflight:g});h.push({txId:A,status:"sent",signedTx:y[b]}),d==null||d([...h]),b++,this.connection.onSignature(A,k=>{let P=h.findIndex(x=>x.txId===A);P>-1&&(h[P].status=k.err?"error":"success"),d==null||d([...h]),k.err||w()},"processed"),this.connection.getSignatureStatus(A)};return w(),{txIds:[],signedTxs:y}}else{let b=[];for(let h=0;h<y.length;h+=1){let w=await this.connection.sendTransaction(y[h],{skipPreflight:g});b.push(w)}return{txIds:b,signedTxs:y}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){var l;let u=e||{},{computeBudgetConfig:t}=u,n=gt(u,["computeBudgetConfig"]),r=t?rn(t):{instructions:[],instructionTypes:[]},o=this.signers.reduce((m,d)=>G(S({},m),{[d.publicKey.toBase58()]:d}),{}),s=[],a=[],c=[];if(this.allInstructions.forEach(m=>{let d=[...c,m],p=t?[...r.instructions,...d]:d,f=[...new Set(d.map(y=>y.keys.filter(b=>b.isSigner).map(b=>b.pubkey.toString())).flat()).values()].map(y=>new Nt(y));if(c.length<12&&St({instructions:p,payer:this.feePayer,signers:f})||St({instructions:d,payer:this.feePayer,signers:f}))c.push(m);else{if(c.length===0)throw Error("item ins too big");St({instructions:t?[...r.instructions,...c]:[...c],payer:this.feePayer,signers:f})?s.push(new Rt().add(...r.instructions,...c)):s.push(new Rt().add(...c)),a.push(Array.from(new Set(c.map(y=>y.keys.filter(b=>b.isSigner).map(b=>b.pubkey.toString())).flat())).map(y=>o[y]).filter(y=>y!==void 0)),c=[m]}}),c.length>0){let d=[...new Set(c.map(p=>p.keys.filter(g=>g.isSigner).map(g=>g.pubkey.toString())).flat()).values()].map(p=>o[p]).filter(p=>p!==void 0);St({instructions:t?[...r.instructions,...c]:[...c],payer:this.feePayer,signers:d.map(p=>p.publicKey)})?s.push(new Rt().add(...r.instructions,...c)):s.push(new Rt().add(...c)),a.push(d)}return s.forEach(m=>m.feePayer=this.feePayer),(l=this.owner)!=null&&l.signer&&a.forEach(m=>{m.some(d=>d.publicKey.equals(this.owner.publicKey))||m.push(this.owner.signer)}),{builder:this,transactions:s,signers:a,instructionTypes:this.instructionTypes,execute:async m=>{var b;let{sequentially:d,onTxUpdate:p,recentBlockHash:g,skipPreflight:f=!0}=m||{},y=g!=null?g:await ht(this.connection,this.blockhashCommitment);if(s.forEach(async(h,w)=>{h.recentBlockhash=y,a[w].length&&h.sign(...a[w])}),lt(s),(b=this.owner)!=null&&b.isKeyPair){if(d){let h=[];for(let w of s){let A=await Fn(this.connection,w,this.signers.find(k=>k.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:f});h.push(A)}return{txIds:h,signedTxs:s}}return{txIds:await Promise.all(s.map(async h=>await this.connection.sendRawTransaction(h.serialize(),{skipPreflight:f}))),signedTxs:s}}if(this.signAllTransactions){let h=await this.signAllTransactions(s);if(d){let w=0,A=[],k=async()=>{if(!h[w])return;let P=await this.connection.sendRawTransaction(h[w].serialize(),{skipPreflight:f});A.push({txId:P,status:"sent",signedTx:h[w]}),p==null||p([...A]),w++,this.connection.onSignature(P,x=>{let B=A.findIndex(F=>F.txId===P);B>-1&&(A[B].status=x.err?"error":"success"),p==null||p([...A]),x.err||k()},"processed"),this.connection.getSignatureStatus(P)};return await k(),{txIds:A.map(P=>P.txId),signedTxs:h}}else{let w=[];for(let A=0;A<h.length;A+=1){let k=await this.connection.sendRawTransaction(h[A].serialize(),{skipPreflight:f});w.push(k)}return{txIds:w,signedTxs:h}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuildV0(e){var b;let y=e||{},{computeBudgetConfig:t,lookupTableCache:n={},lookupTableAddress:r=[]}=y,o=gt(y,["computeBudgetConfig","lookupTableCache","lookupTableAddress"]),s=S(S({},this.cluster==="devnet"?{}:sn),n),a=Array.from(new Set([...this.lookupTableAddress,...r])),c=[];for(let h of a)s[h]===void 0&&c.push(new Nt(h));let u=await Mn({connection:this.connection,address:c});for(let[h,w]of Object.entries(u))s[h]=w;let l=t?rn(t):{instructions:[],instructionTypes:[]},m=await ht(this.connection,this.blockhashCommitment),d=this.signers.reduce((h,w)=>G(S({},h),{[w.publicKey.toBase58()]:w}),{}),p=[],g=[],f=[];if(this.allInstructions.forEach(h=>{let w=[...f,h],A=t?[...l.instructions,...w]:w;if(f.length<12&&Kt({instructions:A,payer:this.feePayer,lookupTableAddressAccount:s})||Kt({instructions:w,payer:this.feePayer,lookupTableAddressAccount:s}))f.push(h);else{if(f.length===0)throw Error("item ins too big");let k={};for(let P of[...new Set(a)])s[P]!==void 0&&(k[P]=s[P]);if(t&&Kt({instructions:[...l.instructions,...f],payer:this.feePayer,lookupTableAddressAccount:s,recentBlockhash:m})){let P=new Lt({payerKey:this.feePayer,recentBlockhash:m,instructions:[...l.instructions,...f]}).compileToV0Message(Object.values(s));p.push(new Mt(P))}else{let P=new Lt({payerKey:this.feePayer,recentBlockhash:m,instructions:[...f]}).compileToV0Message(Object.values(s));p.push(new Mt(P))}g.push(Array.from(new Set(f.map(P=>P.keys.filter(x=>x.isSigner).map(x=>x.pubkey.toString())).flat())).map(P=>d[P]).filter(P=>P!==void 0)),f=[h]}}),f.length>0){let w=[...new Set(f.map(A=>A.keys.filter(k=>k.isSigner).map(k=>k.pubkey.toString())).flat()).values()].map(A=>d[A]).filter(A=>A!==void 0);if(t&&Kt({instructions:[...l.instructions,...f],payer:this.feePayer,lookupTableAddressAccount:s,recentBlockhash:m})){let A=new Lt({payerKey:this.feePayer,recentBlockhash:m,instructions:[...l.instructions,...f]}).compileToV0Message(Object.values(s));p.push(new Mt(A))}else{let A=new Lt({payerKey:this.feePayer,recentBlockhash:m,instructions:[...f]}).compileToV0Message(Object.values(s));p.push(new Mt(A))}g.push(w)}return(b=this.owner)!=null&&b.signer&&g.forEach(h=>{h.some(w=>w.publicKey.equals(this.owner.publicKey))||h.push(this.owner.signer)}),{builder:this,transactions:p,buildProps:e,signers:g,instructionTypes:this.instructionTypes,execute:async h=>{var x;let{sequentially:w,onTxUpdate:A,recentBlockHash:k,skipPreflight:P=!0}=h||{};if(p.map(async(B,F)=>{g[F].length&&B.sign(g[F]),k&&(B.message.recentBlockhash=k)}),lt(p),(x=this.owner)!=null&&x.isKeyPair){if(w){let B=[];for(let F of p){let L=await this.connection.sendTransaction(F,{skipPreflight:P}),{lastValidBlockHeight:R,blockhash:j}=await this.connection.getLatestBlockhash({commitment:this.blockhashCommitment});await this.connection.confirmTransaction({blockhash:j,lastValidBlockHeight:R,signature:L},"confirmed"),B.push(L)}return{txIds:B,signedTxs:p}}return{txIds:await Promise.all(p.map(async B=>await this.connection.sendTransaction(B,{skipPreflight:P}))),signedTxs:p}}if(this.signAllTransactions){let B=await this.signAllTransactions(p);if(w){let F=0,L=[],R=async()=>{if(!B[F])return;let j=await this.connection.sendTransaction(B[F],{skipPreflight:P});L.push({txId:j,status:"sent",signedTx:B[F]}),A==null||A([...L]),F++,this.connection.onSignature(j,te=>{let ce=L.findIndex(ne=>ne.txId===j);ce>-1&&(L[ce].status=te.err?"error":"success"),A==null||A([...L]),te.err||R()},"processed"),this.connection.getSignatureStatus(j)};return R(),{txIds:[],signedTxs:B}}else{let F=[];for(let L=0;L<B.length;L+=1){let R=await this.connection.sendTransaction(B[L],{skipPreflight:P});F.push(R)}return{txIds:F,signedTxs:B}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:o||{}}}};function Ln(i,e=1,t=[]){let n=[...i];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}import{PublicKey as z}from"@solana/web3.js";var Yc=new z("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),Qc=new z("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),Jc=new z("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),$c=new z("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),eu=new z("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),tu=new z("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),nu=new z("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),iu=new z("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),ru=new z("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),ou=new z("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),su=new z("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),au=new z("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),cu=new z("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),uu=new z("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),lu=new z("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),mu=new z("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),du=new z("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),pu=new z("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),fu=new z("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),Oo=new z("CPMDWBwJDtYax9qW7AyRuVC19Cc4L4Vcy4n2BHAbHkCW"),Eo=new z("7rQ1QFNosMkUCuh7Z7fPbTHvh73b68sQYdirycEzJVuw"),Do=new z("G11FKBRaAkHAKuLCgLM6K6NUc9rTjPAznRCjZifrTQe2");var gu={SERUM_MARKET:z.default,OPENBOOK_MARKET:new z("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),UTIL1216:z.default,FarmV3:new z("85BFyr98MbCUU9MVTEgzx1nbhWACbJqLzho6zd6DZcWL"),FarmV5:new z("EcLzTrNg9V7qhcdyXDe2qjtPkiGzDM2UbdRaeaadU5r2"),FarmV6:new z("Farm2hJLcqPtPg8M4rR6DMrsRNc5TPm5Cs4bVQrMe2T7"),AmmV4:new z("HWy1jotHpo6UqeQxx49dpYYdQB8wj9Qk9MdxwjLvDHB8"),AmmStable:new z("DDg4VmQaJV9ogWce7LpcjBA9bv22wRp5uaTPa5pGjijF"),CLMM:new z("devi51mZmdwUJGU9hjN27vEz64Gps7uUefqxg27EAtH"),Router:new z("BVChZ3XFEwTMUk1o9i3HAf91H6mFxSwa5X2wFAWhYPhU"),CREATE_CPMM_POOL_PROGRAM:Oo,CREATE_CPMM_POOL_AUTH:Eo,CREATE_CPMM_POOL_FEE_ACC:Do,FEE_DESTINATION_ID:new z("3XMrhbv989VxAMi3DErLV9eJht1pHppW5LbKxe9fkEFR")};import{PublicKey as vo}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as _o}from"@solana/spl-token";function Ue(i,e,t){return Se([i.toBuffer(),(t!=null?t:_o).toBuffer(),e.toBuffer()],new vo("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import ve from"bn.js";var Ft=1e4;function se(i,e,t,n){if(e===void 0)return{amount:i,fee:void 0,expirationTime:void 0};let r=G(S({},e),{olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}}),o=t.epoch<r.newerTransferFee.epoch?r.olderTransferFee:r.newerTransferFee,s=new ve(o.maximumFee.toString()),a=t.epoch<r.newerTransferFee.epoch?(Number(r.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(o.transferFeeBasisPoints===Ft){let c=new ve(o.maximumFee.toString());return{amount:i.add(c),fee:c,expirationTime:a}}else{let c=On(i.mul(new ve(Ft)),new ve(Ft-o.transferFeeBasisPoints)),u=new ve(o.maximumFee.toString()),l=c.sub(i).gt(u)?i.add(u):c,m=On(l.mul(new ve(o.transferFeeBasisPoints)),new ve(Ft)),d=m.gt(s)?s:m;return{amount:l,fee:d,expirationTime:a}}else{let c=On(i.mul(new ve(o.transferFeeBasisPoints)),new ve(Ft)),u=c.gt(s)?s:c;return{amount:i,fee:u,expirationTime:a}}}function at(i,e){return i===void 0?e:e===void 0?i:Math.min(i,e)}function On(i,e){let{div:t,mod:n}=i.divmod(e);return n.gt(new ve(0))?t.add(new ve(1)):t}import{PublicKey as Wu}from"@solana/web3.js";import{MintLayout as Uu,TOKEN_PROGRAM_ID as zu}from"@solana/spl-token";var En=r=>{var o=r,{address:i,programId:e,decimals:t}=o,n=gt(o,["address","programId","decimals"]);return S({chainId:101,address:ut(i).toBase58(),programId:e,logoURI:"",symbol:"",name:"",decimals:t,tags:[],extensions:n.extensions||{}},n)},Dn=i=>i?G(S({},i),{transferFeeConfigAuthority:i.transferFeeConfigAuthority.toBase58(),withdrawWithheldAuthority:i.withdrawWithheldAuthority.toBase58(),withheldAmount:i.withheldAmount.toString(),olderTransferFee:G(S({},i.olderTransferFee),{epoch:i.olderTransferFee.epoch.toString(),maximumFee:i.olderTransferFee.maximumFee.toString()}),newerTransferFee:G(S({},i.newerTransferFee),{epoch:i.newerTransferFee.epoch.toString(),maximumFee:i.newerTransferFee.maximumFee.toString()})}):void 0;var vn=(...i)=>i.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Ot=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=we(t)}createTxBuilder(e){return this.scope.checkOwner(),new an({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,blockhashCommitment:this.scope.blockhashCommitment,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(vn(e))}logInfo(...e){this.logger.info(vn(e))}logAndCreateError(...e){let t=vn(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import Re from"bn.js";var H=new Re(0),Xe=new Re(1),Je=new Re(-1),Ne=new Re(1).shln(64),cn=new Re(1).shln(128),_n=Ne.sub(Xe),Et=64,Li=cn.subn(1),xe=-443636,Be=-xe,ze=new Re("4295048016"),He=new Re("79226673521066979257578248091"),il=new Re("4295048017"),rl=new Re("79226673521066979257578248090"),Mi=16,Fi="59543866431248",Oi="184467440737095516",Ei="15793534762490258745",un=new Re(10).pow(new Re(6)),Vo=(n=>(n[n.rate_500=500]="rate_500",n[n.rate_3000=3e3]="rate_3000",n[n.rate_10000=1e4]="rate_10000",n))(Vo||{}),ol={[500]:10,[3e3]:60,[1e4]:200},sl={version:6,liquidity:H,tickCurrent:0,feeGrowthGlobalX64A:H,feeGrowthGlobalX64B:H,protocolFeesTokenA:H,protocolFeesTokenB:H,swapInAmountTokenA:H,swapOutAmountTokenB:H,swapInAmountTokenB:H,swapOutAmountTokenA:H,tickArrayBitmap:[],rewardInfos:[],day:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},week:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},month:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},tvl:0},Di={tvl:0,volumeQuote:0,mintAmountA:0,mintAmountB:0,rewardDefaultInfos:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,day:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},week:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},month:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},pooltype:[]},al=new Re("18446744073700000000");import W from"bn.js";function vi(i){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,i,!1),new Uint8Array(e)}function ul(i){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,i,!1),new Uint8Array(e)}function ll(i){let e=new ArrayBuffer(4);return new DataView(e).setUint32(0,i,!1),new Uint8Array(e)}function ln(i){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,i,!1),new Uint8Array(e)}function Vn(i,e){let t=0;for(let n=i-1;n>=0&&!e.testn(n);n--)t++;return t}function qn(i,e){let t=0;for(let n=0;n<i&&!e.testn(n);n++)t++;return t}function Dt(i,e){for(let t=0;t<i;t++)if(e.testn(t))return!1;return!0}function _i(i,e){return Dt(i,e)?null:Vn(i,e)}function Vi(i,e){return Dt(i,e)?null:qn(i,e)}var qo=Buffer.from("amm_config","utf8"),Wo=Buffer.from("pool","utf8"),Go=Buffer.from("pool_vault","utf8"),Uo=Buffer.from("pool_reward_vault","utf8"),qi=Buffer.from("position","utf8"),Xo=Buffer.from("tick_array","utf8"),zo=Buffer.from("operation","utf8"),Ho=Buffer.from("pool_tick_array_bitmap_extension","utf8"),Zo=Buffer.from("observation","utf8");function fl(i,e){return Se([qo,vi(e)],i)}function Wi(i,e,t,n){return Se([Wo,e.toBuffer(),t.toBuffer(),n.toBuffer()],i)}function Wn(i,e,t){return Se([Go,e.toBuffer(),t.toBuffer()],i)}function Gi(i,e,t){return Se([Uo,e.toBuffer(),t.toBuffer()],i)}function $(i,e,t){return Se([Xo,e.toBuffer(),ln(t)],i)}function mt(i,e,t,n){return Se([qi,e.toBuffer(),ln(t),ln(n)],i)}function Le(i,e){return Se([qi,e.toBuffer()],i)}function mn(i){return Se([Buffer.from("metadata","utf8"),wt.toBuffer(),i.toBuffer()],wt)}function vt(i){return Se([zo],i)}function Me(i,e){return Se([Ho,e.toBuffer()],i)}function Ui(i,e){return Se([Zo,e.toBuffer()],i)}import{PublicKey as _e}from"@solana/web3.js";import re from"bn.js";import ms from"bn.js";import{PublicKey as is}from"@solana/web3.js";import Zi,{isBN as ji}from"bn.js";import{bits as yl,BitStructure as wl,blob as jo,Blob as hl,cstr as Al,f32 as Pl,f32be as Tl,f64 as kl,f64be as xl,greedy as Bl,Layout as Yo,ns64 as Il,ns64be as Cl,nu64 as Sl,nu64be as Kl,offset as Nl,s16 as Rl,s16be as Ll,s24 as Ml,s24be as Fl,s32 as Qo,s32be as Ol,s40 as El,s40be as Dl,s48 as vl,s48be as _l,s8 as Vl,seq as Jo,struct as ql,Structure as $o,u16 as es,u16be as Wl,u24 as Gl,u24be as Ul,u32 as Xl,u32be as zl,u40 as Hl,u40be as Zl,u48 as jl,u48be as Yl,u8 as ts,UInt as ns,union as Ql,Union as Jl,unionLayoutDiscriminator as $l,utf8 as em}from"@solana/buffer-layout";var Gn=Yo,Xi=$o;var Un=ns;var zi=ts,_t=es;var Pe=Qo;var Hi=Jo;var Fe=jo;var At=class extends Gn{constructor(t,n,r){super(t,r);this.blob=Fe(t),this.signed=n}decode(t,n=0){let r=new Zi(this.blob.decode(t,n),10,"le");return this.signed?r.fromTwos(this.span*8).clone():r}encode(t,n,r=0){return typeof t=="number"&&(t=new Zi(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),n,r)}};function pe(i){return new Un(1,i)}function Pt(i){return new Un(4,i)}function E(i){return new At(8,!1,i)}function Z(i){return new At(16,!1,i)}function Yi(i){return new At(8,!0,i)}function Qi(i){return new At(16,!0,i)}var dn=class extends Gn{constructor(t,n,r,o){super(t.span,o);this.layout=t,this.decoder=n,this.encoder=r}decode(t,n){return this.decoder(this.layout.decode(t,n))}encode(t,n,r){return this.layout.encode(this.encoder(t),n,r)}getSpan(t,n){return this.layout.getSpan(t,n)}};function fe(i){return new dn(Fe(32),e=>new is(e),e=>e.toBuffer(),i)}function Ze(i){return new dn(zi(),rs,os,i)}function rs(i){if(i===0)return!1;if(i===1)return!0;throw new Error("Invalid bool: "+i)}function os(i){return i?1:0}var Xn=class extends Xi{decode(e,t){return super.decode(e,t)}};function ie(i,e,t){return new Xn(i,e,t)}function ae(i,e,t){let n,r=typeof e=="number"?e:ji(e)?e.toNumber():new Proxy(e,{get(o,s){if(!n){let a=Reflect.get(o,"count");n=ji(a)?a.toNumber():a,Reflect.set(o,"count",n)}return Reflect.get(o,s)},set(o,s,a){return s==="count"&&(n=a),Reflect.set(o,s,a)}});return Hi(i,r,t)}var zn=14,$e=class{static maxTickInTickarrayBitmap(e){return e*ge*dt}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),r=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(r+=1);let o=n*r;return e<0?{minValue:-o,maxValue:-o+n}:{minValue:o,maxValue:o+n}}static nextInitializedTickArrayStartIndex(e,t,n,r){if(!X.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let o=this.maxTickInTickarrayBitmap(n),s=r?t-X.tickCount(n):t+X.tickCount(n);if(s<-o||s>=o)return{isInit:!1,tickIndex:t};let a=n*ge,c=s/a+512;s<0&&s%a!=0&&c--;let u=Math.abs(c);if(r){let l=e.shln(1024-u-1),m=_i(1024,l);if(m!==null){let d=(u-m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:-o}}else{let l=e.shrn(u),m=Vi(1024,l);if(m!==null){let d=(u+m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:o-X.tickCount(n)}}}},Vt=class{static getBitmapOffset(e,t){if(!X.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=$e.maxTickInTickarrayBitmap(t),r=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&r--,r}static getBitmap(e,t,n){let r=this.getBitmapOffset(e,t);return e<0?{offset:r,tickarrayBitmap:n.negativeTickArrayBitmap[r]}:{offset:r,tickarrayBitmap:n.positiveTickArrayBitmap[r]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:r}=this.extensionTickBoundary(t);if(e>=r&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=$e.maxTickInTickarrayBitmap(e),n=-t;if(Be<=t)throw Error(`extensionTickBoundary check error: ${Be}, ${t}`);if(n<=xe)throw Error(`extensionTickBoundary check error: ${n}, ${xe}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:r}=this.getBitmap(e,t,n),o=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:K.mergeTickArrayBitmap(r).testn(o),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,r){let o=X.tickCount(t),s=n?e-o:e+o,{tickarrayBitmap:a}=this.getBitmap(s,t,r);return this.nextInitializedTickArrayInBitmap(a,s,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,r){let{minValue:o,maxValue:s}=$e.getBitmapTickBoundary(t,n),a=this.tickArrayOffsetInBitmap(t,n);if(r){let c=K.mergeTickArrayBitmap(e).shln(dt-1-a),u=Dt(512,c)?null:Vn(512,c);if(u!==null){let l=t-u*X.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:o}}else{let c=K.mergeTickArrayBitmap(e).shrn(a),u=Dt(512,c)?null:qn(512,c);if(u!==null){let l=t+u*X.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-X.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%$e.maxTickInTickarrayBitmap(t),r=Math.floor(n/X.tickCount(t));return e<0&&n!=0&&(r=dt-r),r}};var Ji=ie([Fe(8),pe("bump"),_t("index"),fe(""),Pt("protocolFeeRate"),Pt("tradeFeeRate"),_t("tickSpacing"),ae(E(),8,"")]),ss=ie([Pt("blockTimestamp"),Yi("tickCumulative"),ae(E(),4)]),$i=ie([Fe(8),Ze("initialized"),E("recentEpoch"),_t("observationIndex"),fe("poolId"),ae(ss,100,"observations"),ae(E(),4)]),as=ie([pe("rewardState"),E("openTime"),E("endTime"),E("lastUpdateTime"),Z("emissionsPerSecondX64"),E("rewardTotalEmissioned"),E("rewardClaimed"),fe("tokenMint"),fe("tokenVault"),fe("creator"),Z("rewardGrowthGlobalX64")]),pn=ie([Fe(8),pe("bump"),fe("ammConfig"),fe("creator"),fe("mintA"),fe("mintB"),fe("vaultA"),fe("vaultB"),fe("observationId"),pe("mintDecimalsA"),pe("mintDecimalsB"),_t("tickSpacing"),Z("liquidity"),Z("sqrtPriceX64"),Pe("tickCurrent"),Pt(),Z("feeGrowthGlobalX64A"),Z("feeGrowthGlobalX64B"),E("protocolFeesTokenA"),E("protocolFeesTokenB"),Z("swapInAmountTokenA"),Z("swapOutAmountTokenB"),Z("swapInAmountTokenB"),Z("swapOutAmountTokenA"),pe("status"),ae(pe(),7,""),ae(as,3,"rewardInfos"),ae(E(),16,"tickArrayBitmap"),E("totalFeesTokenA"),E("totalFeesClaimedTokenA"),E("totalFeesTokenB"),E("totalFeesClaimedTokenB"),E("fundFeesTokenA"),E("fundFeesTokenB"),E("startTime"),ae(E(),15*4-3,"padding")]),cs=ie([Z("growthInsideLastX64"),E("rewardAmountOwed")]),fn=ie([Fe(8),pe("bump"),fe("nftMint"),fe("poolId"),Pe("tickLower"),Pe("tickUpper"),Z("liquidity"),Z("feeGrowthInsideLastX64A"),Z("feeGrowthInsideLastX64B"),E("tokenFeesOwedA"),E("tokenFeesOwedB"),ae(cs,3,"rewardInfos"),ae(E(),8,"")]),Pm=ie([Fe(8),pe("bump"),fe("poolId"),Pe("tickLowerIndex"),Pe("tickUpperIndex"),Z("liquidity"),Z("feeGrowthInsideLastX64A"),Z("feeGrowthInsideLastX64B"),E("tokenFeesOwedA"),E("tokenFeesOwedB"),ae(Z(),3,"rewardGrowthInside"),ae(E(),8,"")]),us=ie([Pe("tick"),Qi("liquidityNet"),Z("liquidityGross"),Z("feeGrowthOutsideX64A"),Z("feeGrowthOutsideX64B"),ae(Z(),3,"rewardGrowthsOutsideX64"),ae(Pt(),13,"")]),qt=ie([Fe(8),fe("poolId"),Pe("startTickIndex"),ae(us,ge,"ticks"),pe("initializedTickCount"),ae(pe(),115,"")]),er=ie([Fe(329),ae(fe(),100,"whitelistMints")]),tr=ie([Fe(8),fe("poolId"),ae(ae(E(),8),zn,"positiveTickArrayBitmap"),ae(ae(E(),8),zn,"negativeTickArrayBitmap")]);var ls=15,X=class{static async getTickArrays(e,t,n,r,o,s,a){let c=[],u=K.getTickArrayStartIndexByTick(r,o),l=K.getInitializedTickArrayInRange(s,a,o,u,Math.floor(ls/2));for(let p=0;p<l.length;p++){let{publicKey:g}=$(t,n,l[p]);c.push(g)}let m=(await Qe(e,c)).map(p=>p!==null?qt.decode(p.data):null),d={};for(let p=0;p<c.length;p++){let g=m[p];g!==null&&(d[g.startTickIndex]=G(S({},g),{address:c[p]}))}return d}static nextInitializedTick(e,t,n,r,o,s){let{initializedTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}=this.nextInitializedTickInOneArray(e,t,n,r,o,s);for(;a==null||a.liquidityGross.lten(0);){if(u=K.getNextTickArrayStartIndex(u,o,s),this.checkIsValidStartIndex(u,o))throw new Error("No enough initialized tickArray");let l=n[u];if(l===void 0)continue;let{nextTick:m,tickArrayAddress:d,tickArrayStartTickIndex:p}=this.firstInitializedTickInOneArray(e,t,l,s);[a,c,u]=[m,d,p]}if(a==null)throw new Error("No invaild tickArray cache");return{nextTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}}static nextInitializedTickArray(e,t,n,r,o){let s=Math.floor(e/X.tickCount(t)),a=n?K.searchLowBitFromStart(r,o,s-1,1,t):K.searchHightBitFromStart(r,o,s+1,1,t);return a.length>0?{isExist:!0,nextStartIndex:a[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,r){let o;if(r){let a=ge-1;for(;a>=0;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){o=c;break}a=a-1}}else{let a=0;for(;a<ge;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){o=c;break}a=a+1}}let{publicKey:s}=$(e,t,n.startTickIndex);return{nextTick:o,tickArrayAddress:s,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,r,o,s){let a=K.getTickArrayStartIndexByTick(r,o),c=Math.floor((r-a)/o),u=n[a];if(u==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:a};let l;if(s)for(;c>=0;){let d=u.ticks[c];if(d.liquidityGross.gtn(0)){l=d;break}c=c-1}else for(c=c+1;c<ge;){let d=u.ticks[c];if(d.liquidityGross.gtn(0)){l=d;break}c=c+1}let{publicKey:m}=$(e,t,a);return{initializedTick:l,tickArrayAddress:m,tickArrayStartTickIndex:u.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(K.checkIsOutOfBoundary(e)){if(e>Be)return!1;let n=K.getTickArrayStartIndexByTick(xe,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return ge*e}};var ge=60,dt=512,K=class{static getTickArrayAddressByTick(e,t,n,r){let o=K.getTickArrayStartIndexByTick(n,r),{publicKey:s}=$(e,t,o);return s}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=K.getTickArrayStartIndexByTick(e,t),r=Math.floor((e-n)/t);if(r<0||r>=ge)throw new Error("tick offset in array overflow");return r}static getTickArrayBitIndex(e,t){let n=X.tickCount(t),r=e/n;return e<0&&e%n!=0?r=Math.ceil(r)-1:r=Math.floor(r),r}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*X.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*ge,r=Math.floor(e/n)+512;return Math.abs(r)}static checkTickArrayIsInitialized(e,t,n){let r=n*ge,o=Math.floor(t/r)+512,s=Math.abs(o);return{isInitialized:e.testn(s),startIndex:(s-512)*r}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*ge:e+t*ge}static mergeTickArrayBitmap(e){let t=new ms(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,r,o){let s=Math.floor(r/(n*ge));return[...K.searchLowBitFromStart(e,t,s-1,o,n),...K.searchHightBitFromStart(e,t,s,o,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return K.searchHightBitFromStart(e,t,0,dt,n)}static getAllInitializedTickArrayInfo(e,t,n,r,o){let s=[],a=K.getAllInitializedTickArrayStartIndex(n,r,o);for(let c of a){let{publicKey:u}=$(e,t,c);s.push({tickArrayStartIndex:c,tickArrayAddress:u})}return s}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,r,o){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>K.mergeTickArrayBitmap(u)),a=[];for(;n>=-7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n--,a.length===r)break}let c=X.tickCount(o);return a.map(u=>u*c)}static searchHightBitFromStart(e,t,n,r,o){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>K.mergeTickArrayBitmap(u)),a=[];for(;n<7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n++,a.length===r)break}let c=X.tickCount(o);return a.map(u=>u*c)}static checkIsOutOfBoundary(e){return e<xe||e>Be}static nextInitTick(e,t,n,r,o){if(X.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let a=Math.floor((t-e.startTickIndex)/n);if(r)for(;a>=0;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a-1}else for(o||(a=a+1);a<ge;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a+1}return null}static firstInitializedTick(e,t){if(t){let n=ge-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<ge;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let r=M.getSqrtPriceX64FromTick(t),o=M.sqrtPriceX64ToPrice(r,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:o,tickSqrtPriceX64:r}:{tick:t,price:new C(1).div(o),tickSqrtPriceX64:r}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let r=n?t:new C(1).div(t),o=pt.getTickWithPriceAndTickspacing(r,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=M.getSqrtPriceX64FromTick(o),a=M.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:o,price:a}:{tick:o,price:new C(1).div(a)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let r=M.getSqrtPriceX64FromTick(t),o=M.sqrtPriceX64ToPrice(r,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:o,tickSqrtPriceX64:r}:{tick:t,price:new C(1).div(o),tickSqrtPriceX64:r}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let r=n?t:new C(1).div(t),o=pt.getTickWithPriceAndTickspacing(r,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=M.getSqrtPriceX64FromTick(o),a=M.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:o,price:a}:{tick:o,price:new C(1).div(a)}}};import je from"bn.js";var Wt=class{static getfeeGrowthInside(e,t,n){let r=new je(0),o=new je(0);e.tickCurrent>=t.tick?(r=t.feeGrowthOutsideX64A,o=t.feeGrowthOutsideX64B):(r=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),o=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let s=new je(0),a=new je(0);e.tickCurrent<n.tick?(s=n.feeGrowthOutsideX64A,a=n.feeGrowthOutsideX64B):(s=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),a=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let c=D.wrappingSubU128(D.wrappingSubU128(e.feeGrowthGlobalX64A,r),s),u=D.wrappingSubU128(D.wrappingSubU128(e.feeGrowthGlobalX64B,o),a);return{feeGrowthInsideX64A:c,feeGrowthInsideBX64:u}}static GetPositionFees(e,t,n,r){let{feeGrowthInsideX64A:o,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,r),a=D.mulDivFloor(D.wrappingSubU128(o,t.feeGrowthInsideLastX64A),t.liquidity,Ne),c=t.tokenFeesOwedA.add(a),u=D.mulDivFloor(D.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,Ne),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,r){let{feeGrowthInsideX64A:o,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,r),a=D.mulDivFloor(D.wrappingSubU128(o,t.feeGrowthInsideLastX64A),t.liquidity,Ne),c=t.tokenFeesOwedA.add(a),u=D.mulDivFloor(D.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,Ne),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,r){let o=[],s=this.getRewardGrowthInsideV2(e.tickCurrent,n,r,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=D.wrappingSubU128(c,u.growthInsideLastX64),m=D.mulDivFloor(l,t.liquidity,Ne),d=u.rewardAmountOwed.add(m);o.push(d)}return o}static GetPositionRewards(e,t,n,r){let o=[],s=this.getRewardGrowthInside(e.tickCurrent,n,r,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=D.wrappingSubU128(c,u.growthInsideLastX64),m=D.mulDivFloor(l,t.liquidity,Ne),d=u.rewardAmountOwed.add(m);o.push(d)}return o}static getRewardGrowthInside(e,t,n,r){let o=[];for(let s=0;s<r.length;s++){let a=new je(0);t.liquidityGross.eqn(0)?a=r[s].rewardGrowthGlobalX64:e<t.tick?a=r[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new je(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=r[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),o.push(D.wrappingSubU128(D.wrappingSubU128(r[s].rewardGrowthGlobalX64,a),c))}return o}static getRewardGrowthInsideV2(e,t,n,r){let o=[];for(let s=0;s<r.length;s++){let a=new je(0);t.liquidityGross.eqn(0)?a=r[s].rewardGrowthGlobalX64:e<t.tick?a=r[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new je(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=r[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),o.push(D.wrappingSubU128(D.wrappingSubU128(r[s].rewardGrowthGlobalX64,a),c))}return o}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:r,add:o,epochInfo:s}){var y,b,h,w;let a=M.priceToSqrtPriceX64(new C(e.price),e.mintA.decimals,e.mintB.decimals),c=M.getSqrtPriceX64FromTick(t.tickLower),u=M.getSqrtPriceX64FromTick(t.tickUpper),l=o?1+r:1-r,m=U.getAmountsFromLiquidity(a,c,u,n,o),[d,p]=[se(m.amountA,(y=e.mintA.extensions)==null?void 0:y.feeConfig,s,!0),se(m.amountB,(b=e.mintB.extensions)==null?void 0:b.feeConfig,s,!0)],[g,f]=[se(new je(new C(m.amountA.toString()).mul(l).toFixed(0)),(h=e.mintA.extensions)==null?void 0:h.feeConfig,s,!0),se(new je(new C(m.amountB.toString()).mul(l).toFixed(0)),(w=e.mintB.extensions)==null?void 0:w.feeConfig,s,!0)];return{liquidity:n,amountA:d,amountB:p,amountSlippageA:g,amountSlippageB:f,expirationTime:at(d.expirationTime,p.expirationTime)}}};import{TOKEN_2022_PROGRAM_ID as nr}from"@solana/spl-token";var le=class{static getOutputAmountAndRemainAccounts(e,t,n,r,o,s=!1){let a=n.toBase58()===e.mintA.address,c=[],{isExist:u,startIndex:l,nextAccountMeta:m}=this.getFirstInitializedTickArray(e,a);if(!u||l===void 0||!m)throw new Error("Invalid tick array");c.push(m);let{allTrade:d,amountCalculated:p,accounts:g,sqrtPriceX64:f,feeAmount:y}=ft.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,a,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,r,l,o,s);return c.push(...g),{allTrade:d,expectedAmountOut:p.mul(Je),remainingAccounts:c,executionPrice:f,feeAmount:y}}static getInputAmountAndRemainAccounts(e,t,n,r,o){let s=n.toBase58()===e.mintB.address,a=[],{isExist:c,startIndex:u,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!c||u===void 0||!l)throw new Error("Invalid tick array");try{let f=this.preInitializedTickArrayStartIndex(e,s);if(f.isExist){let{publicKey:y}=$(e.programId,e.id,f.nextStartIndex);a.push(y)}}catch{}a.push(l);let{amountCalculated:m,accounts:d,sqrtPriceX64:p,feeAmount:g}=ft.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,r.mul(Je),u,o);return a.push(...d),{expectedAmountIn:m,remainingAccounts:a,executionPrice:p,feeAmount:g}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:r}=le.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?Vt.checkTickArrayIsInit(X.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):K.checkTickArrayIsInitialized(K.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:a}=$(e.programId,e.id,r);return{isExist:!0,startIndex:r,nextAccountMeta:a}}let{isExist:o,nextStartIndex:s}=this.nextInitializedTickArrayStartIndex(e,X.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(o){let{publicKey:a}=$(e.programId,e.id,s);return{isExist:!0,startIndex:s,nextAccountMeta:a}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/X.tickCount(e.tickSpacing)),r=t?K.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):K.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return r.length>0?{isExist:!0,nextStartIndex:r[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=X.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:r,tickIndex:o}=$e.nextInitializedTickArrayStartIndex(K.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(r)return{isExist:!0,nextStartIndex:o};t=o;let{isInit:s,tickIndex:a}=Vt.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(s)return{isExist:!0,nextStartIndex:a};if(t=a,t<xe||t>Be)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:r,rewardInfos:o}){var a,c,u;let s=[];for(let l=0;l<o.length;l++){let m=o[l],d=(u=(a=t.rewardDefaultInfos[l])==null?void 0:a.mint.programId)!=null?u:(c=await e.getAccountInfo(m.tokenMint))==null?void 0:c.owner;if(d===void 0)throw Error("get new reward mint info error");let p=G(S({},m),{perSecond:D.x64ToDecimal(m.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new _e(d)});if(p.tokenMint.equals(_e.default))continue;if(n<=p.openTime.toNumber()||r.eq(H)){s.push(p);continue}let g=new re(Math.min(p.endTime.toNumber(),n)),f=g.sub(p.lastUpdateTime),y=D.mulDivFloor(f,p.emissionsPerSecondX64,r),b=p.rewardGrowthGlobalX64.add(y),h=D.mulDivFloor(f,p.emissionsPerSecondX64,Ne),w=p.rewardTotalEmissioned.add(h);s.push(G(S({},p),{rewardGrowthGlobalX64:b,rewardTotalEmissioned:w,lastUpdateTime:g}))}return s}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:r}=this.tickRange(e);for(let o of t){let s=K.getTickArrayStartIndexByTick(o,e);if(s>=n||s<r)return!0}return!1}static tickRange(e){let t=$e.maxTickInTickarrayBitmap(e),n=-t;return t>Be&&(t=X.getArrayStartIndex(Be,e)+X.tickCount(e)),n<xe&&(n=X.getArrayStartIndex(xe,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!X.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/X.tickCount(t)*dt}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let r=await st(e,t.map(s=>({pubkey:s})),{batchRequest:n}),o={};for(let s of r)s.accountInfo!==null&&(o[s.pubkey.toString()]=tr.decode(s.accountInfo.data));return o}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let r={},o=[];for(let c of t){let u=K.getTickArrayStartIndexByTick(c.tickCurrent,c.tickSpacing),l=K.getInitializedTickArrayInRange(c.tickArrayBitmap,c.exBitmapInfo,c.tickSpacing,u,7);for(let m of l){let{publicKey:d}=$(c.programId,c.id,m);o.push({pubkey:d}),r[d.toString()]=c.id}}let s=await st(e,o,{batchRequest:n}),a={};for(let c of s){if(!c.accountInfo)continue;let u=r[c.pubkey.toString()];if(!u)continue;a[u.toString()]===void 0&&(a[u.toString()]={});let l=qt.decode(c.accountInfo.data);a[u.toString()][l.startTickIndex]=G(S({},l),{address:c.pubkey})}return a}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:r=!1,updateOwnerRewardAndFee:o=!0}){var a;let s=[];for(let c=0;c<e.length;c++){let u=e[c];u!==null&&(s.find(l=>l.equals(u.state.programId))||s.push(u.state.programId))}if(n){let c=n.tokenAccounts.map(d=>d.accountInfo.mint),u=[];for(let d of c)for(let p of s)u.push(Le(p,d).publicKey);let l=await Qe(t,u,{batchRequest:r}),m={};for(let d of l){if(d===null)continue;let p=fn.decode(d.data),g=p.poolId.toString(),f=e.find(B=>B.state.id.toBase58()===g);if(f===void 0)continue;let y=f.state,b=K._getTickPriceLegacy({poolInfo:y,tick:p.tickLower,baseIn:!0}),h=K._getTickPriceLegacy({poolInfo:y,tick:p.tickUpper,baseIn:!0}),{amountA:w,amountB:A}=U.getAmountsFromLiquidity(y.sqrtPriceX64,b.tickSqrtPriceX64,h.tickSqrtPriceX64,p.liquidity,!1),k=1/(1-Math.sqrt(Math.sqrt(b.price.div(h.price).toNumber())));f.positionAccount=[...(a=f.positionAccount)!=null?a:[],{poolId:p.poolId,nftMint:p.nftMint,priceLower:b.price,priceUpper:h.price,amountA:w,amountB:A,tickLower:p.tickLower,tickUpper:p.tickUpper,liquidity:p.liquidity,feeGrowthInsideLastX64A:p.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:p.feeGrowthInsideLastX64B,tokenFeesOwedA:p.tokenFeesOwedA,tokenFeesOwedB:p.tokenFeesOwedB,rewardInfos:p.rewardInfos.map(B=>G(S({},B),{pendingReward:new re(0)})),leverage:k,tokenFeeAmountA:new re(0),tokenFeeAmountB:new re(0)}];let P=await K.getTickArrayAddressByTick(f.state.programId,p.poolId,p.tickLower,f.state.tickSpacing),x=await K.getTickArrayAddressByTick(f.state.programId,p.poolId,p.tickUpper,f.state.tickSpacing);m[`${f.state.programId.toString()}-${p.poolId.toString()}-${p.tickLower}`]=P,m[`${f.state.programId.toString()}-${p.poolId.toString()}-${p.tickUpper}`]=x}if(o){let d=Object.values(m),p=await Qe(t,d,{batchRequest:r}),g={};for(let f=0;f<d.length;f++){let y=p[f];if(y===null)continue;let b=d[f].toString();g[b]=qt.decode(y.data)}for(let{state:f,positionAccount:y}of e)if(!!y)for(let b of y){let h=`${f.programId.toString()}-${f.id.toString()}-${b.tickLower}`,w=`${f.programId.toString()}-${f.id.toString()}-${b.tickUpper}`,A=g[m[h].toString()],k=g[m[w].toString()],P=A.ticks[K.getTickOffsetInArray(b.tickLower,f.tickSpacing)],x=k.ticks[K.getTickOffsetInArray(b.tickUpper,f.tickSpacing)],{tokenFeeAmountA:B,tokenFeeAmountB:F}=await Wt.GetPositionFees(f,b,P,x),L=await Wt.GetPositionRewards(f,b,P,x);b.tokenFeeAmountA=B.gte(new re(0))?B:new re(0),b.tokenFeeAmountB=F.gte(new re(0))?F:new re(0);for(let R=0;R<L.length;R++)b.rewardInfos[R].pendingReward=L[R].gte(new re(0))?L[R]:new re(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:r,amountIn:o,slippage:s,priceLimit:a=new C(0),catchLiquidityInsufficient:c=!1}){var j;let u,l=n.toBase58()===e.mintA.address,[m,d]=l?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];a.equals(new C(0))?u=l?ze.add(new re(1)):He.sub(new re(1)):u=M.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let p=se(o,m,r,!1),{allTrade:g,expectedAmountOut:f,remainingAccounts:y,executionPrice:b,feeAmount:h}=le.getOutputAmountAndRemainAccounts(e,t,n,p.amount.sub((j=p.fee)!=null?j:H),u,c),w=se(f,d,r,!1),A=M.sqrtPriceX64ToPrice(b,e.mintA.decimals,e.mintB.decimals),k=l?A:new C(1).div(A),P=f.mul(new re(Math.floor((1-s)*1e10))).div(new re(1e10)),x=se(P,d,r,!1),B=l?e.currentPrice:new C(1).div(e.currentPrice),F=new C(k).sub(B).abs(),L=B,R=new ot(new C(F).mul(10**15).toFixed(0),new C(L).mul(10**15).toFixed(0));return{allTrade:g,realAmountIn:p,amountOut:w,minAmountOut:x,expirationTime:at(p.expirationTime,w.expirationTime),currentPrice:e.currentPrice,executionPrice:k,priceImpact:R,fee:h,remainingAccounts:y,executionPriceX64:b}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:r,slippage:o,epochInfo:s,catchLiquidityInsufficient:a=!1}){let c=r.address===e.mintB.address,[u,l]=c?[e.mintA,e.mintB]:[e.mintB,e.mintA],[m,d]=[new Ge(G(S({},u),{mint:u.address,isToken2022:u.programId===nr.toBase58()})),new Ge(G(S({},l),{mint:l.address,isToken2022:l.programId===nr.toBase58()}))],{allTrade:p,realAmountIn:g,amountOut:f,minAmountOut:y,expirationTime:b,currentPrice:h,executionPrice:w,priceImpact:A,fee:k,remainingAccounts:P,executionPriceX64:x}=le.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new _e(u.address),amountIn:n,slippage:o,epochInfo:s,catchLiquidityInsufficient:a}),B=G(S({},g),{amount:new Ae(m,g.amount),fee:g.fee===void 0?void 0:new Ae(m,g.fee)}),F=G(S({},f),{amount:new Ae(d,f.amount),fee:f.fee===void 0?void 0:new Ae(d,f.fee)}),L=G(S({},y),{amount:new Ae(d,y.amount),fee:y.fee===void 0?void 0:new Ae(d,y.fee)}),R=new De({baseToken:m,denominator:new re(10).pow(new re(20+m.decimals)),quoteToken:d,numerator:h.mul(new C(10**(20+d.decimals))).toFixed(0)}),j=new De({baseToken:m,denominator:new re(10).pow(new re(20+m.decimals)),quoteToken:d,numerator:w.mul(new C(10**(20+d.decimals))).toFixed(0)}),te=new Ae(m,k);return{allTrade:p,realAmountIn:B,amountOut:F,minAmountOut:L,expirationTime:b,currentPrice:R,executionPrice:j,priceImpact:A,fee:te,remainingAccounts:P,executionPriceX64:x}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:r,amountOut:o,slippage:s,priceLimit:a=new C(0)}){var L;let c=n.toBase58()===e.mintA.address,u={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},l;a.equals(new C(0))?l=c?He.sub(new re(1)):ze.add(new re(1)):l=M.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let m=se(o,u[n.toString()],r,!0),{expectedAmountIn:d,remainingAccounts:p,executionPrice:g,feeAmount:f}=le.getInputAmountAndRemainAccounts(e,t,n,m.amount.sub((L=m.fee)!=null?L:H),l),y=c?e.mintB.address:e.mintA.address,b=se(d,u[y],r,!1),h=M.sqrtPriceX64ToPrice(g,e.mintA.decimals,e.mintB.decimals),w=c?h:new C(1).div(h),A=d.mul(new re(Math.floor((1+s)*1e10))).div(new re(1e10)),k=se(A,u[y],r,!0),P=c?e.currentPrice:new C(1).div(e.currentPrice),x=new C(w).sub(P).abs(),B=P,F=new ot(new C(x).mul(10**15).toFixed(0),new C(B).mul(10**15).toFixed(0));return{amountIn:b,maxAmountIn:k,realAmountOut:m,expirationTime:at(b.expirationTime,m.expirationTime),currentPrice:e.currentPrice,executionPrice:w,priceImpact:F,fee:f,remainingAccounts:p}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:r}){var g,f,y;let o=e[t],s=K.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),a=K.getTickPrice({poolInfo:e,tick:r,baseIn:!0}).price.toNumber(),c=Math.max(s,o.priceMin),l=Math.min(a,o.priceMax)-c,m=a-s,d=o.priceMax-o.priceMin,p;return l<=0?p=0:m===l?p=d/l:d===l?p=l/m:p=l/d*(l/m),{feeApr:o.feeApr*p,rewardsApr:[((g=o.rewardApr[0])!=null?g:0)*p,((f=o.rewardApr[1])!=null?f:0)*p,((y=o.rewardApr[2])!=null?y:0)*p],apr:o.apr*p}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:r,liquidity:o,positionTickLowerIndex:s,positionTickUpperIndex:a,chainTime:c}){let u=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],m=r[ut(e.mintA.address).toString()],d=r[ut(e.mintB.address).toString()],p=e.mintA.decimals,g=e.mintB.decimals;if(!l||!m||!d)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let f=M.priceToSqrtPriceX64(new C(e.price),e.mintA.decimals,e.mintB.decimals),y=M.getSqrtPriceX64FromTick(s),b=M.getSqrtPriceX64FromTick(a),{amountSlippageA:h,amountSlippageB:w}=U.getAmountsFromLiquidityWithSlippage(f,y,b,t,!1,!1,0),{amountSlippageA:A,amountSlippageB:k}=U.getAmountsFromLiquidityWithSlippage(f,y,b,o,!1,!1,0),P=new C(h.toString()).div(new C(10).pow(p)).mul(m.value).add(new C(w.toString()).div(new C(10).pow(g)).mul(d.value)),x=new C(A.toString()).div(new C(10).pow(p)).mul(m.value).add(new C(k.toString()).div(new C(10).pow(g)).mul(d.value)),B=new C(1).div(P.add(x)),L=new C(l.volumeFee).mul(365).div(u).mul(B).mul(100).toNumber(),R=3600*24*365,j=e.rewardDefaultInfos.map(te=>{var Q,Qn;let ce=te.mint.decimals,ne=r[te.mint.address];return c<((Q=te.startTime)!=null?Q:0)||c>((Qn=te.endTime)!=null?Qn:0)||!te.perSecond||!ne||ce===void 0?0:new C(ne.value).mul(new C(te.perSecond).mul(R)).div(new C(10).pow(ce)).mul(B).mul(100).toNumber()});return{feeApr:L,rewardsApr:j,apr:L+j.reduce((te,ce)=>te+ce,0)}}static getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:r,amount:o,slippage:s,add:a,epochInfo:c,amountHasFee:u}){var b,h;let l=M.priceToSqrtPriceX64(new C(e.price),e.mintA.decimals,e.mintB.decimals),m=M.getSqrtPriceX64FromTick(n),d=M.getSqrtPriceX64FromTick(r),p=a?1-s:1+s,g=se(o,(b=e[t?"mintA":"mintB"].extensions)==null?void 0:b.feeConfig,c,!u),f=new re(new C(g.amount.sub((h=g.fee)!=null?h:H).toString()).mul(p).toFixed(0)),y;if(l.lte(m))y=t?U.getLiquidityFromTokenAmountA(m,d,f,!a):new re(0);else if(l.lte(d)){let w=U.getLiquidityFromTokenAmountA(l,d,f,!a),A=U.getLiquidityFromTokenAmountB(m,l,f);y=t?w:A}else y=t?new re(0):U.getLiquidityFromTokenAmountB(m,d,f);return le.getAmountsFromLiquidity({epochInfo:c,poolInfo:e,tickLower:n,tickUpper:r,liquidity:y,slippage:s,add:a})}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:r,liquidity:o,slippage:s,add:a}){var y,b,h,w;let c=M.getSqrtPriceX64FromTick(n),u=M.getSqrtPriceX64FromTick(r),l=a?1+s:1-s,m=U.getAmountsFromLiquidity(M.priceToSqrtPriceX64(new C(t.price),t.mintA.decimals,t.mintB.decimals),c,u,o,a),[d,p]=[se(m.amountA,(y=t.mintA.extensions)==null?void 0:y.feeConfig,e,!0),se(m.amountB,(b=t.mintB.extensions)==null?void 0:b.feeConfig,e,!0)],[g,f]=[se(m.amountA.muln(l),(h=t.mintA.extensions)==null?void 0:h.feeConfig,e,!0),se(m.amountB.muln(l),(w=t.mintB.extensions)==null?void 0:w.feeConfig,e,!0)];return{liquidity:o,amountA:d,amountB:p,amountSlippageA:g,amountSlippageB:f,expirationTime:at(d.expirationTime,p.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let r=t.filter(c=>!n[c.id]).map(c=>new _e(c.id));(await Qe(e,r)).forEach((c,u)=>{!c||(n[r[u].toBase58()]=pn.decode(c.data))});let s=t.map(c=>Me(new _e(c.programId),new _e(c.id)).publicKey),a=await le.fetchExBitmaps({connection:e,exBitmapAddress:s,batchRequest:!1});return t.reduce((c,u)=>G(S({},c),{[u.id]:G(S({},n[u.id]),{id:new _e(u.id),version:6,programId:new _e(u.programId),mintA:u.mintA,mintB:u.mintB,ammConfig:G(S({},u.config),{id:new _e(u.config.id),fundOwner:""}),currentPrice:new C(u.price),exBitmapInfo:a[Me(new _e(u.programId),new _e(u.id)).publicKey.toBase58()],startTime:n[u.id].startTime.toNumber()})}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};function cd({poolInfo:i,tickLower:e,tickUpper:t,amountA:n,amountB:r,slippage:o,add:s,epochInfo:a,amountHasFee:c}){var w,A,k,P;let[u,l,m,d]=e<t?[e,t,n,r]:[t,e,r,n],p=M.priceToSqrtPriceX64(new C(i.price),i.mintA.decimals,i.mintB.decimals),g=M.getSqrtPriceX64FromTick(u),f=M.getSqrtPriceX64FromTick(l),[y,b]=[se(m,(w=i.mintA.extensions)==null?void 0:w.feeConfig,a,!c),se(d,(A=i.mintB.extensions)==null?void 0:A.feeConfig,a,!c)],h=U.getLiquidityFromTokenAmounts(p,g,f,y.amount.sub((k=y.fee)!=null?k:H),b.amount.sub((P=b.fee)!=null?P:H));return U.getAmountsOutFromLiquidity({poolInfo:i,tickLower:e,tickUpper:t,liquidity:h,slippage:o,add:s,epochInfo:a,amountAddFee:!c})}var Hn={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};function ir(i){return G(S({},i),{type:"Concentrated",programId:i.programId.toString(),id:i.id.toString(),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Clmm",price:i.currentPrice.toNumber(),mintAmountA:0,mintAmountB:0,feeRate:i.ammConfig.tradeFeeRate,openTime:i.startTime.toString(),tvl:0,day:Hn,week:Hn,month:Hn,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,config:G(S({},i.ammConfig),{id:i.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]})})}var D=class{static mulDivRoundingUp(e,t,n){let r=e.mul(t),o=r.div(n);return r.mod(n).eq(H)||(o=o.add(Xe)),o}static mulDivFloor(e,t,n){if(n.eq(H))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(H))throw new Error("division by 0");return e.mul(t).add(n.sub(Xe)).div(n)}static x64ToDecimal(e,t){return new C(e.toString()).div(C.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new W(e.mul(C.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(cn).sub(t).mod(cn)}};function be(i,e){return Zn(i.mul(e),64,256)}function ds(i,e,t){let n=i.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function Zn(i,e,t){let n=i.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var M=class{static sqrtPriceX64ToPrice(e,t,n){return D.x64ToDecimal(e).pow(2).mul(C.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return D.decimalToX64(e.mul(C.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,r){if(!e.gt(H))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(H))throw new Error("liquidity must greater than 0");return r?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,r){if(!e.gt(H))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(H))throw new Error("liquidity must greater than 0");return r?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,r){if(n.eq(H))return e;let o=t.shln(Et);if(r){let s=o,a=o.add(n.mul(e));return a.gte(s)?D.mulDivCeil(s,e,a):D.mulDivRoundingUp(s,Xe,s.div(e).add(n))}else{let s=n.mul(e);if(!o.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let a=o.sub(s);return D.mulDivCeil(o,e,a)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,r){let o=n.shln(Et);if(r)return e.add(o.div(t));{let s=D.mulDivRoundingUp(o,Xe,t);if(!e.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(s)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<xe||e>Be)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new W("18445821805675395072"):new W("18446744073709551616");return(t&2)!=0&&(n=be(n,new W("18444899583751176192"))),(t&4)!=0&&(n=be(n,new W("18443055278223355904"))),(t&8)!=0&&(n=be(n,new W("18439367220385607680"))),(t&16)!=0&&(n=be(n,new W("18431993317065453568"))),(t&32)!=0&&(n=be(n,new W("18417254355718170624"))),(t&64)!=0&&(n=be(n,new W("18387811781193609216"))),(t&128)!=0&&(n=be(n,new W("18329067761203558400"))),(t&256)!=0&&(n=be(n,new W("18212142134806163456"))),(t&512)!=0&&(n=be(n,new W("17980523815641700352"))),(t&1024)!=0&&(n=be(n,new W("17526086738831433728"))),(t&2048)!=0&&(n=be(n,new W("16651378430235570176"))),(t&4096)!=0&&(n=be(n,new W("15030750278694412288"))),(t&8192)!=0&&(n=be(n,new W("12247334978884435968"))),(t&16384)!=0&&(n=be(n,new W("8131365268886854656"))),(t&32768)!=0&&(n=be(n,new W("3584323654725218816"))),(t&65536)!=0&&(n=be(n,new W("696457651848324352"))),(t&131072)!=0&&(n=be(n,new W("26294789957507116"))),(t&262144)!=0&&(n=be(n,new W("37481735321082"))),e>0&&(n=Li.div(n)),n}static getTickFromPrice(e,t,n){return M.getTickFromSqrtPriceX64(M.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(He)||e.lt(ze))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new W(t-64),r=ds(n,32,128),o=new W("8000000000000000","hex"),s=0,a=new W(0),c=t>=64?e.shrn(t-63):e.shln(63-t);for(;o.gt(new W(0))&&s<Mi;){c=c.mul(c);let g=c.shrn(127);c=c.shrn(63+g.toNumber()),a=a.add(o.mul(g)),o=o.shrn(1),s+=1}let u=a.shrn(32),m=r.add(u).mul(new W(Fi)),d=Zn(m.sub(new W(Oi)),64,128).toNumber(),p=Zn(m.add(new W(Ei)),64,128).toNumber();return d==p?d:M.getSqrtPriceX64FromTick(p).lte(e)?p:d}},pt=class{static getTickWithPriceAndTickspacing(e,t,n,r){let s=M.getTickFromSqrtPriceX64(M.priceToSqrtPriceX64(e,n,r))/t;return s<0?s=Math.floor(s):s=Math.ceil(s),s*t}static roundPriceWithTickspacing(e,t,n,r){let o=pt.getTickWithPriceAndTickspacing(e,t,n,r),s=M.getSqrtPriceX64FromTick(o);return M.sqrtPriceX64ToPrice(s,n,r)}},U=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,r){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(H))throw new Error("sqrtPriceX64A must greater than 0");let o=n.ushln(Et),s=t.sub(e);return r?D.mulDivRoundingUp(D.mulDivCeil(o,s,t),Xe,e):D.mulDivFloor(o,s,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,r){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(H))throw new Error("sqrtPriceX64A must greater than 0");return r?D.mulDivCeil(n,t.sub(e),Ne):D.mulDivFloor(n,t.sub(e),Ne)}static getLiquidityFromTokenAmountA(e,t,n,r){e.gt(t)&&([e,t]=[t,e]);let o=n.mul(e).mul(t),s=t.sub(e),a=o.div(s);return r?D.mulDivRoundingUp(a,Xe,_n):a.shrn(Et)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),D.mulDivFloor(n,_n,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,r,o){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return U.getLiquidityFromTokenAmountA(t,n,r,!1);if(e.lt(n)){let s=U.getLiquidityFromTokenAmountA(e,n,r,!1),a=U.getLiquidityFromTokenAmountB(t,e,o);return s.lt(a)?s:a}else return U.getLiquidityFromTokenAmountB(t,n,o)}static getAmountsFromLiquidity(e,t,n,r,o){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:U.getTokenAmountAFromLiquidity(t,n,r,o),amountB:new W(0)};if(e.lt(n)){let s=U.getTokenAmountAFromLiquidity(e,n,r,o),a=U.getTokenAmountBFromLiquidity(t,e,r,o);return{amountA:s,amountB:a}}else return{amountA:new W(0),amountB:U.getTokenAmountBFromLiquidity(t,n,r,o)}}static getAmountsFromLiquidityWithSlippage(e,t,n,r,o,s,a){let{amountA:c,amountB:u}=U.getAmountsFromLiquidity(e,t,n,r,s),l=o?1+a:1-a,m=new W(new C(c.toString()).mul(l).toFixed(0)),d=new W(new C(u.toString()).mul(l).toFixed(0));return{amountSlippageA:m,amountSlippageB:d}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:r,slippage:o,add:s,epochInfo:a,amountAddFee:c}){var h,w,A,k;let u=M.priceToSqrtPriceX64(new C(e.price),e.mintA.decimals,e.mintB.decimals),l=M.getSqrtPriceX64FromTick(t),m=M.getSqrtPriceX64FromTick(n),d=s?1+o:1-o,p=U.getAmountsFromLiquidity(u,l,m,r,s),[g,f]=[se(p.amountA,(h=e.mintA.extensions)==null?void 0:h.feeConfig,a,c),se(p.amountB,(w=e.mintB.extensions)==null?void 0:w.feeConfig,a,c)],[y,b]=[se(new W(new C(p.amountA.toString()).mul(d).toFixed(0)),(A=e.mintA.extensions)==null?void 0:A.feeConfig,a,c),se(new W(new C(p.amountB.toString()).mul(d).toFixed(0)),(k=e.mintB.extensions)==null?void 0:k.feeConfig,a,c)];return{liquidity:r,amountA:g,amountB:f,amountSlippageA:y,amountSlippageB:b,expirationTime:at(g.expirationTime,f.expirationTime)}}},ft=class{static swapCompute(e,t,n,r,o,s,a,c,u,l,m,d,p,g,f=!1){if(d.eq(H))throw new Error("amountSpecified must not be 0");if(g||(g=s?ze.add(Xe):He.sub(Xe)),s){if(g.lt(ze))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(g.gte(m))throw new Error("sqrtPriceX64 must smaller than current")}else{if(g.gt(He))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(g.lte(m))throw new Error("sqrtPriceX64 must greater than current")}let y=d.gt(H),b={amountSpecifiedRemaining:d,amountCalculated:H,sqrtPriceX64:m,tick:u>p?Math.min(p+X.tickCount(l)-1,u):p,accounts:[],liquidity:c,feeAmount:new W(0)},h=p,w=n[p],A=0,k=!s&&w.startTickIndex===b.tick;for(;!b.amountSpecifiedRemaining.eq(H)&&!b.sqrtPriceX64.eq(g);){A>10;let P={};P.sqrtPriceStartX64=b.sqrtPriceX64;let x=K.nextInitTick(w,b.tick,l,s,k),B=x||null,F=null;if(!(B!=null&&B.liquidityGross.gtn(0))){let R=le.nextInitializedTickArrayStartIndex({tickCurrent:b.tick,tickSpacing:l,tickArrayBitmap:r,exBitmapInfo:o},h,s);if(!R.isExist){if(f)return{allTrade:!1,amountSpecifiedRemaining:b.amountSpecifiedRemaining,amountCalculated:b.amountCalculated,feeAmount:b.feeAmount,sqrtPriceX64:b.sqrtPriceX64,liquidity:b.liquidity,tickCurrent:b.tick,accounts:b.accounts};throw Error("swapCompute LiquidityInsufficient")}h=R.nextStartIndex;let{publicKey:j}=$(e,t,h);F=j,w=n[h];try{B=K.firstInitializedTick(w,s)}catch{throw Error("not found next tick info")}}P.tickNext=B.tick,P.initialized=B.liquidityGross.gtn(0),p!==h&&F&&(b.accounts.push(F),p=h),P.tickNext<xe?P.tickNext=xe:P.tickNext>Be&&(P.tickNext=Be),P.sqrtPriceNextX64=M.getSqrtPriceX64FromTick(P.tickNext);let L;if(s&&P.sqrtPriceNextX64.lt(g)||!s&&P.sqrtPriceNextX64.gt(g)?L=g:L=P.sqrtPriceNextX64,[b.sqrtPriceX64,P.amountIn,P.amountOut,P.feeAmount]=ft.swapStepCompute(b.sqrtPriceX64,L,b.liquidity,b.amountSpecifiedRemaining,a),b.feeAmount=b.feeAmount.add(P.feeAmount),y?(b.amountSpecifiedRemaining=b.amountSpecifiedRemaining.sub(P.amountIn.add(P.feeAmount)),b.amountCalculated=b.amountCalculated.sub(P.amountOut)):(b.amountSpecifiedRemaining=b.amountSpecifiedRemaining.add(P.amountOut),b.amountCalculated=b.amountCalculated.add(P.amountIn.add(P.feeAmount))),b.sqrtPriceX64.eq(P.sqrtPriceNextX64)){if(P.initialized){let R=B.liquidityNet;s&&(R=R.mul(Je)),b.liquidity=U.addDelta(b.liquidity,R)}k=P.tickNext!=b.tick&&!s&&w.startTickIndex===P.tickNext,b.tick=s?P.tickNext-1:P.tickNext}else if(b.sqrtPriceX64!=P.sqrtPriceStartX64){let R=M.getTickFromSqrtPriceX64(b.sqrtPriceX64);k=R!=b.tick&&!s&&w.startTickIndex===R,b.tick=R}++A}try{let{nextStartIndex:P,isExist:x}=X.nextInitializedTickArray(b.tick,l,s,r,o);x&&p!==P&&(b.accounts.push($(e,t,P).publicKey),p=P)}catch{}return{allTrade:!0,amountSpecifiedRemaining:H,amountCalculated:b.amountCalculated,feeAmount:b.feeAmount,sqrtPriceX64:b.sqrtPriceX64,liquidity:b.liquidity,tickCurrent:b.tick,accounts:b.accounts}}static swapStepCompute(e,t,n,r,o){let s={sqrtPriceX64Next:new W(0),amountIn:new W(0),amountOut:new W(0),feeAmount:new W(0)},a=e.gte(t),c=r.gte(H);if(c){let l=D.mulDivFloor(r,un.sub(new W(o.toString())),un);s.amountIn=a?U.getTokenAmountAFromLiquidity(t,e,n,!0):U.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(s.amountIn)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=M.getNextSqrtPriceX64FromInput(e,n,l,a)}else s.amountOut=a?U.getTokenAmountBFromLiquidity(t,e,n,!1):U.getTokenAmountAFromLiquidity(e,t,n,!1),r.mul(Je).gte(s.amountOut)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=M.getNextSqrtPriceX64FromOutput(e,n,r.mul(Je),a);let u=t.eq(s.sqrtPriceX64Next);return a?(u&&c||(s.amountIn=U.getTokenAmountAFromLiquidity(s.sqrtPriceX64Next,e,n,!0)),u&&!c||(s.amountOut=U.getTokenAmountBFromLiquidity(s.sqrtPriceX64Next,e,n,!1))):(s.amountIn=u&&c?s.amountIn:U.getTokenAmountBFromLiquidity(e,s.sqrtPriceX64Next,n,!0),s.amountOut=u&&!c?s.amountOut:U.getTokenAmountAFromLiquidity(e,s.sqrtPriceX64Next,n,!1)),!c&&s.amountOut.gt(r.mul(Je))&&(s.amountOut=r.mul(Je)),c&&!s.sqrtPriceX64Next.eq(t)?s.feeAmount=r.sub(s.amountIn):s.feeAmount=D.mulDivCeil(s.amountIn,new W(o),un.sub(new W(o))),[s.sqrtPriceX64Next,s.amountIn,s.amountOut,s.feeAmount]}};import{ASSOCIATED_TOKEN_PROGRAM_ID as rr,TOKEN_2022_PROGRAM_ID as ct,TOKEN_PROGRAM_ID as Te}from"@solana/spl-token";import{Keypair as jn,PublicKey as I,SystemProgram as Gt,TransactionInstruction as Ve}from"@solana/web3.js";import or from"bn.js";$i.span;var sr=we("Raydium_Clmm"),qe={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},me=class{static createPoolInstruction(e,t,n,r,o,s,a,c,u,l,m,d,p,g){let f=ie([Z("sqrtPriceX64"),E("startTime")]),y=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:Gt.programId,isSigner:!1,isWritable:!1},{pubkey:Bt,isSigner:!1,isWritable:!1}],b=Buffer.alloc(f.span);f.encode({sqrtPriceX64:p,startTime:g},b);let h=Buffer.from([...qe.createPool,...b]);return new Ve({keys:y,programId:e,data:h})}static async createPoolInstructions(e){let{programId:t,owner:n,mintA:r,mintB:o,ammConfigId:s,initialPriceX64:a,startTime:c}=e,[u,l]=[new I(r.address),new I(o.address)],{publicKey:m}=Wi(t,s,u,l),{publicKey:d}=Ui(t,m),{publicKey:p}=Wn(t,m,u),{publicKey:g}=Wn(t,m,l),f=[this.createPoolInstruction(t,m,n,s,d,u,p,new I(r.programId||Te),l,g,new I(o.programId||Te),Me(t,m).publicKey,a,c)];return{signers:[],instructions:f,instructionTypes:[ue.CreateAccount,ue.ClmmCreatePool],address:{poolId:m,observationId:d,mintAVault:p,mintBVault:g},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,r,o,s,a,c,u,l,m,d,p,g,f,y,b,h,w,A,k,P,x,B,F,L){let R=ie([Pe("tickLowerIndex"),Pe("tickUpperIndex"),Pe("tickArrayLowerStartIndex"),Pe("tickArrayUpperStartIndex"),Z("liquidity"),E("amountMaxA"),E("amountMaxB"),Ze("withMetadata"),pe("optionBaseFlag"),Ze("baseFlag")]),j=[...L?[{pubkey:L,isSigner:!1,isWritable:!0}]:[]],te=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:Bt,isSigner:!1,isWritable:!1},{pubkey:Gt.programId,isSigner:!1,isWritable:!1},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:rr,isSigner:!1,isWritable:!1},{pubkey:wt,isSigner:!1,isWritable:!1},{pubkey:ct,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...j],ce=Buffer.alloc(R.span);R.encode({tickLowerIndex:h,tickUpperIndex:w,tickArrayLowerStartIndex:A,tickArrayUpperStartIndex:k,liquidity:P,amountMaxA:x,amountMaxB:B,withMetadata:F==="create",baseFlag:!1,optionBaseFlag:0},ce);let ne=Buffer.from([...qe.openPosition,...ce]);return new Ve({keys:te,programId:e,data:ne})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:r,tickUpper:o,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l}){let m=[],[d,p]=[new I(e.programId),new I(e.id)],g;if(l)g=new I((await l(1))[0]);else{let B=jn.generate();m.push(B),g=B.publicKey}let f=K.getTickArrayStartIndexByTick(r,e.config.tickSpacing),y=K.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:b}=$(d,p,f),{publicKey:h}=$(d,p,y),{publicKey:w}=Ue(n.wallet,g,Te),{publicKey:A}=mn(g),{publicKey:k}=Le(d,g),{publicKey:P}=mt(d,p,r,o),x=this.openPositionFromLiquidityInstruction(d,n.feePayer,p,n.wallet,g,w,A,P,b,h,k,n.tokenAccountA,n.tokenAccountB,new I(t.vault.A),new I(t.vault.B),new I(e.mintA.address),new I(e.mintB.address),r,o,f,y,s,a,c,u);return{signers:m,instructions:[x],instructionTypes:[ue.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:g,tickArrayLower:b,tickArrayUpper:h,positionNftAccount:w,metadataAccount:A,personalPosition:k,protocolPosition:P}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:r,tickUpper:o,base:s,baseAmount:a,otherAmountMax:c,withMetadata:u,getEphemeralSigners:l}){let m=[],[d,p]=[new I(e.programId),new I(e.id)],g;if(l)g=new I((await l(1))[0]);else{let B=jn.generate();m.push(B),g=B.publicKey}let f=K.getTickArrayStartIndexByTick(r,e.config.tickSpacing),y=K.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:b}=$(d,p,f),{publicKey:h}=$(d,p,y),{publicKey:w}=Ue(n.wallet,g,Te),{publicKey:A}=mn(g),{publicKey:k}=Le(d,g),{publicKey:P}=mt(d,p,r,o),x=this.openPositionFromBaseInstruction(d,n.feePayer,p,n.wallet,g,w,A,P,b,h,k,n.tokenAccountA,n.tokenAccountB,new I(t.vault.A),new I(t.vault.B),new I(e.mintA.address),new I(e.mintB.address),r,o,f,y,u,s,a,c,le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[f,y])?Me(d,p).publicKey:void 0);return{address:{nftMint:g,tickArrayLower:b,tickArrayUpper:h,positionNftAccount:w,metadataAccount:A,personalPosition:k,protocolPosition:P},instructions:[x],signers:m,instructionTypes:[ue.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,r,o,s,a,c,u,l,m,d,p,g,f,y,b,h,w,A,k,P,x,B,F,L){let R=ie([Pe("tickLowerIndex"),Pe("tickUpperIndex"),Pe("tickArrayLowerStartIndex"),Pe("tickArrayUpperStartIndex"),Z("liquidity"),E("amountMaxA"),E("amountMaxB"),Ze("withMetadata"),pe("optionBaseFlag"),Ze("baseFlag")]),j=[...L?[{pubkey:L,isSigner:!1,isWritable:!0}]:[]],te=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:Bt,isSigner:!1,isWritable:!1},{pubkey:Gt.programId,isSigner:!1,isWritable:!1},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:rr,isSigner:!1,isWritable:!1},{pubkey:wt,isSigner:!1,isWritable:!1},{pubkey:ct,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...j],ce=Buffer.alloc(R.span);R.encode({tickLowerIndex:h,tickUpperIndex:w,tickArrayLowerStartIndex:A,tickArrayUpperStartIndex:k,liquidity:new or(0),amountMaxA:x==="MintA"?B:F,amountMaxB:x==="MintA"?F:B,withMetadata:P==="create",baseFlag:x==="MintA",optionBaseFlag:1},ce);let ne=Buffer.from([...qe.openPosition,...ce]);return new Ve({keys:te,programId:e,data:ne})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:r,tickUpper:o,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l}){let m,d=[];if(l)m=new I((await l(1))[0]);else{let B=jn.generate();d.push(B),m=B.publicKey}let[p,g]=[new I(e.programId),new I(e.id)],f=K.getTickArrayStartIndexByTick(r,e.config.tickSpacing),y=K.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:b}=$(p,g,f),{publicKey:h}=$(p,g,y),{publicKey:w}=Ue(n.wallet,m,Te),{publicKey:A}=mn(m),{publicKey:k}=Le(p,m),{publicKey:P}=mt(p,g,r,o),x=this.openPositionFromLiquidityInstruction(p,n.wallet,g,n.wallet,m,w,A,P,b,h,k,n.tokenAccountA,n.tokenAccountB,new I(t.vault.A),new I(t.vault.B),new I(t.mintA.address),new I(t.mintB.address),r,o,f,y,s,a,c,u,le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[f,y])?Me(p,g).publicKey:void 0);return{address:{nftMint:m,tickArrayLower:b,tickArrayUpper:h,positionNftAccount:w,metadataAccount:A,personalPosition:k,protocolPosition:P},instructions:[x],signers:d,instructionTypes:[ue.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,r,o){let s=ie([]),a=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:Gt.programId,isSigner:!1,isWritable:!1},{pubkey:Te,isSigner:!1,isWritable:!1}],c=Buffer.alloc(s.span);s.encode({},c);let u=Buffer.from([...qe.closePosition,...c]);return new Ve({keys:a,programId:e,data:u})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:r}){let o=new I(e.programId),{publicKey:s}=Ue(n.wallet,r.nftMint,Te),{publicKey:a}=Le(o,r.nftMint),c=[];return c.push(this.closePositionInstruction(o,n.wallet,r.nftMint,s,a)),{address:{positionNftAccount:s,personalPosition:a},signers:[],instructions:c,instructionTypes:[ue.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,r,o,s,a,c,u,l,m,d,p,g,f,y,b,h){let w=ie([Z("liquidity"),E("amountMaxA"),E("amountMaxB"),pe("optionBaseFlag"),Ze("baseFlag")]),A=[...h?[{pubkey:h,isSigner:!1,isWritable:!0}]:[]],k=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:ct,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...A],P=Buffer.alloc(w.span);w.encode({liquidity:f,amountMaxA:y,amountMaxB:b,optionBaseFlag:0,baseFlag:!1},P);let x=Buffer.from([...qe.increaseLiquidity,...P]);return new Ve({keys:k,programId:e,data:x})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:r,liquidity:o,amountMaxA:s,amountMaxB:a}){let[c,u]=[new I(e.programId),new I(e.id)],l=K.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=K.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:d}=$(c,u,l),{publicKey:p}=$(c,u,m),{publicKey:g}=Ue(r.wallet,n.nftMint,Te),{publicKey:f}=Le(c,n.nftMint),{publicKey:y}=mt(c,u,n.tickLower,n.tickUpper),b=this.increasePositionFromLiquidityInstruction(c,r.wallet,g,f,u,y,d,p,r.tokenAccountA,r.tokenAccountB,new I(t.vault.A),new I(t.vault.B),new I(e.mintA.address),new I(e.mintB.address),o,s,a,le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[l,m])?Me(c,u).publicKey:void 0);return{address:{tickArrayLower:d,tickArrayUpper:p,positionNftAccount:g,personalPosition:f,protocolPosition:y},signers:[],instructions:[b],instructionTypes:[ue.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:r,base:o,baseAmount:s,otherAmountMax:a}){let[c,u]=[new I(e.programId),new I(e.id)],l=K.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=K.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:d}=$(c,u,l),{publicKey:p}=$(c,u,m),{publicKey:g}=Ue(r.wallet,n.nftMint,Te),{publicKey:f}=Le(c,n.nftMint),{publicKey:y}=mt(c,u,n.tickLower,n.tickUpper);return{address:{tickArrayLower:d,tickArrayUpper:p,positionNftAccount:g,personalPosition:f,protocolPosition:y},instructions:[this.increasePositionFromBaseInstruction(c,r.wallet,g,f,u,y,d,p,r.tokenAccountA,r.tokenAccountB,new I(t.vault.A),new I(t.vault.B),new I(e.mintA.address),new I(e.mintB.address),o,s,a,le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[l,m])?Me(c,u).publicKey:void 0)],signers:[],instructionTypes:[ue.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,r,o,s,a,c,u,l,m,d,p,g,f,y,b,h){let w=ie([Z("liquidity"),E("amountMaxA"),E("amountMaxB"),pe("optionBaseFlag"),Ze("baseFlag")]),A=[...h?[{pubkey:h,isSigner:!1,isWritable:!0}]:[]],k=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:ct,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...A],P=Buffer.alloc(w.span);w.encode({liquidity:new or(0),amountMaxA:f==="MintA"?y:b,amountMaxB:f==="MintA"?b:y,baseFlag:f==="MintA",optionBaseFlag:1},P);let x=Buffer.from([...qe.increaseLiquidity,...P]);return new Ve({keys:k,programId:e,data:x})}static decreaseLiquidityInstruction(e,t,n,r,o,s,a,c,u,l,m,d,p,g,f,y,b,h,w){let A=ie([Z("liquidity"),E("amountMinA"),E("amountMinB")]),k=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[],...f.map(F=>[{pubkey:F.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:F.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:F.rewardMint,isSigner:!1,isWritable:!1}]).flat()],P=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:ct,isSigner:!1,isWritable:!1},{pubkey:Jt,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...k],x=Buffer.alloc(A.span);A.encode({liquidity:y,amountMinA:b,amountMinB:h},x);let B=Buffer.from([...qe.decreaseLiquidity,...x]);return new Ve({keys:P,programId:e,data:B})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:r,liquidity:o,amountMinA:s,amountMinB:a,programId:c}){let[u,l]=[new I(e.programId),new I(e.id)],m=K.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=K.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=$(u,l,m),{publicKey:g}=$(u,l,d),{publicKey:f}=Ue(r.wallet,n.nftMint,c),{publicKey:y}=Le(u,n.nftMint),{publicKey:b}=mt(u,l,n.tickLower,n.tickUpper),h=[];for(let A=0;A<e.rewardDefaultInfos.length;A++)h.push({poolRewardVault:new I(t.rewardInfos[A].vault),ownerRewardVault:r.rewardAccounts[A],rewardMint:new I(e.rewardDefaultInfos[A].mint.address)});let w=[];return w.push(this.decreaseLiquidityInstruction(u,r.wallet,f,y,l,b,p,g,r.tokenAccountA,r.tokenAccountB,new I(t.vault.A),new I(t.vault.B),new I(e.mintA.address),new I(e.mintB.address),h,o,s,a,le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,d])?Me(u,l).publicKey:void 0)),{address:{tickArrayLower:p,tickArrayUpper:g,positionNftAccount:f,personalPosition:y,protocolPosition:b},signers:[],instructions:w,instructionTypes:[ue.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,r,o,s,a,c,u,l,m,d,p,g,f,y,b){let h=ie([E("amount"),E("otherAmountThreshold"),Z("sqrtPriceLimitX64"),Ze("isBaseInput")]),w=[...b?[{pubkey:b,isSigner:!1,isWritable:!0}]:[],...m.map(x=>({pubkey:x,isSigner:!1,isWritable:!0}))],A=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:ct,isSigner:!1,isWritable:!1},{pubkey:Jt,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},...w],k=Buffer.alloc(h.span);h.encode({amount:p,otherAmountThreshold:g,sqrtPriceLimitX64:f,isBaseInput:y},k);let P=Buffer.from([...qe.swap,...k]);return new Ve({keys:A,programId:e,data:P})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:r,inputMint:o,amountIn:s,amountOutMin:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,m]=[new I(e.programId),new I(e.id)],[d,p]=[new I(t.vault.A),new I(t.vault.B)],[g,f]=[new I(e.mintA.address),new I(e.mintB.address)],y=e.mintA.address===o.toString(),b=[this.swapInstruction(l,r.wallet,m,new I(e.config.id),y?r.tokenAccountA:r.tokenAccountB,y?r.tokenAccountB:r.tokenAccountA,y?d:p,y?p:d,y?g:f,y?f:g,u,n,s,a,c,!0,Me(l,m).publicKey)];return{signers:[],instructions:b,instructionTypes:[ue.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static makeSwapBaseOutInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:r,outputMint:o,amountOut:s,amountInMax:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,m]=[new I(e.programId),new I(e.id)],[d,p]=[new I(t.vault.A),new I(t.vault.B)],[g,f]=[new I(e.mintA.address),new I(e.mintB.address)],y=e.mintA.address===o.toBase58(),b=[this.swapInstruction(l,r.wallet,m,new I(e.config.id),y?r.tokenAccountB:r.tokenAccountA,y?r.tokenAccountA:r.tokenAccountB,y?p:d,y?d:p,y?f:g,y?g:f,u,n,s,a,c,!1,Me(l,m).publicKey)];return{signers:[],instructions:b,instructionTypes:[ue.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,r,o,s,a,c,u,l,m,d){let p=ie([E("openTime"),E("endTime"),Z("emissionsPerSecondX64")]),g=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:Gt.programId,isSigner:!1,isWritable:!1},{pubkey:Bt,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({openTime:he(l),endTime:he(m),emissionsPerSecondX64:d},f);let y=Buffer.from([...qe.initReward,...f]);return new Ve({keys:g,programId:e,data:y})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:r}){let[o,s]=[new I(e.programId),new I(e.id)],a=Gi(o,s,r.mint).publicKey,c=vt(o).publicKey,u=[this.initRewardInstruction(o,n.wallet,s,c,new I(e.config.id),n.tokenAccount,r.programId,r.mint,a,r.openTime,r.endTime,r.emissionsPerSecondX64)];return{address:{poolRewardVault:a,operationId:c},signers:[],instructions:u,instructionTypes:[ue.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,r,o,s,a,c,u,l,m,d){let p=ie([pe("rewardIndex"),Z("emissionsPerSecondX64"),E("openTime"),E("endTime")]),g=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:ct,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0}],f=Buffer.alloc(p.span);p.encode({rewardIndex:u,emissionsPerSecondX64:d,openTime:he(l),endTime:he(m)},f);let y=Buffer.from([...qe.setRewardEmissions,...f]);return new Ve({keys:g,programId:e,data:y})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:r}){let[o,s]=[new I(e.programId),new I(e.id)],a,c,u;for(let d=0;d<e.rewardDefaultInfos.length;d++)e.rewardDefaultInfos[d].mint.address===r.mint.toString()&&(a=d,c=new I(t.rewardInfos[d].vault),u=new I(t.rewardInfos[d].mint.address));(a===void 0||c===void 0)&&sr.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let l=vt(o).publicKey,m=[this.setRewardInstruction(o,n.wallet,s,l,new I(e.config.id),n.tokenAccount,c,u,a,r.openTime,r.endTime,r.emissionsPerSecondX64)];return{address:{rewardVault:c,operationId:l},signers:[],instructions:m,instructionTypes:[ue.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,r,o,s,a){let c=ie([pe("rewardIndex")]),u=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:ct,isSigner:!1,isWritable:!1},{pubkey:Jt,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({rewardIndex:a},l);let m=Buffer.from([...qe.collectReward,...l]);return new Ve({keys:u,programId:e,data:m})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:r}){let[o,s]=[new I(e.programId),new I(e.id)],a,c;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===r.toString()&&(a=l,c=new I(t.rewardInfos[l].vault));(a===void 0||c===void 0)&&sr.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let u=[this.collectRewardInstruction(o,n.wallet,s,n.tokenAccount,c,r,a)];return{address:{rewardVault:c},signers:[],instructions:u,instructionTypes:[ue.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}};import Ke from"bn.js";import{AccountLayout as ar,TOKEN_PROGRAM_ID as cr}from"@solana/spl-token";var Yn=class extends Ot{constructor(e){super(e)}async getClmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async createPool(e){var w;let{programId:t,owner:n=((w=this.scope.owner)==null?void 0:w.publicKey)||q.default,mint1:r,mint2:o,ammConfig:s,initialPrice:a,startTime:c,computeBudgetConfig:u,forerunCreate:l,getObserveState:m,txVersion:d}=e,p=this.createTxBuilder(),[g,f,y]=new Ke(new q(r.address).toBuffer()).gt(new Ke(new q(o.address).toBuffer()))?[o,r,new C(1).div(a)]:[r,o,a],b=M.priceToSqrtPriceX64(y,g.decimals,f.decimals),h=await me.createPoolInstructions({connection:this.scope.connection,programId:t,owner:n,mintA:g,mintB:f,ammConfigId:s.id,initialPriceX64:b,startTime:c,forerunCreate:!m&&l});return p.addInstruction(h),p.addCustomComputeBudget(u),p.versionBuild({txVersion:d,extInfo:{address:G(S({},h.address),{programId:t.toString(),id:h.address.poolId.toString(),mintA:g,mintB:f,openTime:c.toString(),vault:{A:h.address.mintAVault.toString(),B:h.address.mintBVault.toString()},rewardInfos:[],config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}}),mockPoolInfo:S({type:"Concentrated",rewardDefaultPoolInfos:"Clmm",id:h.address.poolId.toString(),mintA:g,mintB:f,feeRate:s.tradeFeeRate,openTime:c.toString(),programId:t.toString(),price:y.toNumber(),config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}},Di),forerunCreate:l}})}async openPositionFromBase({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:r,tickUpper:o,base:s,baseAmount:a,otherAmountMax:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",getEphemeralSigners:d,computeBudgetConfig:p,txVersion:g}){this.scope.availability.addConcentratedPosition===!1&&this.logAndCreateError("add position feature disabled in your region"),this.scope.checkOwner();let f=this.createTxBuilder(),y=null,b=null,h=n.useSOLBalance&&e.mintA.address===J.toString(),w=n.useSOLBalance&&e.mintB.address===J.toString(),[A,k]=s==="MintA"?[a,c]:[c,a],{account:P,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new q(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:h||A.isZero()?{payer:this.scope.ownerPubKey,amount:A}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:h?!1:u,checkCreateATAOwner:l});P&&(y=P),f.addInstruction(x||{});let{account:B,instructionParams:F}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new q(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:w||k.isZero()?{payer:this.scope.ownerPubKey,amount:k}:void 0,skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:w?!1:u,checkCreateATAOwner:l});B&&(b=B),f.addInstruction(F||{}),(!y||!b)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",{ownerTokenAccountA:y==null?void 0:y.toBase58(),ownerTokenAccountB:b==null?void 0:b.toBase58()});let L=t||await this.getClmmPoolKeys(e.id),R=await me.openPositionFromBaseInstructions({poolInfo:e,poolKeys:L,ownerInfo:G(S({},n),{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:y,tokenAccountB:b}),tickLower:r,tickUpper:o,base:s,baseAmount:a,otherAmountMax:c,withMetadata:m,getEphemeralSigners:d});return f.addInstruction(R),f.addCustomComputeBudget(p),f.versionBuild({txVersion:g,extInfo:S({},R.address)})}async openPositionFromLiquidity({poolInfo:e,poolKeys:t,ownerInfo:n,amountMaxA:r,amountMaxB:o,tickLower:s,tickUpper:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",txVersion:d,getEphemeralSigners:p}){this.scope.availability.createConcentratedPosition===!1&&this.logAndCreateError("open position feature disabled in your region");let g=this.createTxBuilder(),f=null,y=null,b=n.useSOLBalance&&e.mintA.address===J.toBase58(),h=n.useSOLBalance&&e.mintB.address===J.toBase58(),{account:w,instructionParams:A}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new q(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:b||r.isZero()?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!b,notUseTokenAccount:b,associatedOnly:b?!1:u,checkCreateATAOwner:l});w&&(f=w),g.addInstruction(A||{});let{account:k,instructionParams:P}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new q(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:h||o.isZero()?{payer:this.scope.ownerPubKey,amount:o}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:h?!1:u,checkCreateATAOwner:l});k&&(y=k),g.addInstruction(P||{}),(f===void 0||y===void 0)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let x=t||await this.getClmmPoolKeys(e.id),B=await me.openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:x,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:y},tickLower:s,tickUpper:a,liquidity:c,amountMaxA:r,amountMaxB:o,withMetadata:m,getEphemeralSigners:p});return g.addInstruction(B),g.versionBuild({txVersion:d,extInfo:{address:B.address}})}async increasePositionFromLiquidity(e){let{poolInfo:t,poolKeys:n,ownerPosition:r,amountMaxA:o,amountMaxB:s,liquidity:a,ownerInfo:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txVersion:d}=e,p=this.createTxBuilder(),g,f,y=c.useSOLBalance&&t.mintA.address===J.toString(),b=c.useSOLBalance&&t.mintB.address===J.toString(),{account:h,instructionParams:w}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new q(t.mintA.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:y||o.isZero()?{payer:this.scope.ownerPubKey,amount:o}:void 0,skipCloseAccount:!y,associatedOnly:y?!1:u,checkCreateATAOwner:l});h&&(g=h),p.addInstruction(w||{});let{account:A,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new q(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:b||s.isZero()?{payer:this.scope.ownerPubKey,amount:s}:void 0,notUseTokenAccount:b,skipCloseAccount:!b,associatedOnly:b?!1:u,checkCreateATAOwner:l});A&&(f=A),p.addInstruction(k||{}),!g&&!f&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let P=n!=null?n:await this.getClmmPoolKeys(t.id),x=me.increasePositionFromLiquidityInstructions({poolInfo:t,poolKeys:P,ownerPosition:r,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:g,tokenAccountB:f},liquidity:a,amountMaxA:o,amountMaxB:s});return p.addInstruction(x),p.addCustomComputeBudget(m),p.versionBuild({txVersion:d,extInfo:{address:x.address}})}async increasePositionFromBase(e){let{poolInfo:t,ownerPosition:n,base:r,baseAmount:o,otherAmountMax:s,ownerInfo:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txVersion:m}=e,d=this.createTxBuilder(),p,g,f=a.useSOLBalance&&t.mintA.address===J.toString(),y=a.useSOLBalance&&t.mintB.address===J.toString(),{account:b,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new q(t.mintA.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,createInfo:f||(r==="MintA"?o:s).isZero()?{payer:this.scope.ownerPubKey,amount:r==="MintA"?o:s}:void 0,skipCloseAccount:!f,associatedOnly:f?!1:c,checkCreateATAOwner:u});b&&(p=b),d.addInstruction(h||{});let{account:w,instructionParams:A}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new q(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:y||(r==="MintA"?s:o).isZero()?{payer:this.scope.ownerPubKey,amount:r==="MintA"?s:o}:void 0,notUseTokenAccount:y,skipCloseAccount:!y,associatedOnly:y?!1:c,checkCreateATAOwner:u});w&&(g=w),d.addInstruction(A||{}),!p&&!g&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let k=await this.getClmmPoolKeys(t.id),P=me.increasePositionFromBaseInstructions({poolInfo:t,poolKeys:k,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:p,tokenAccountB:g},base:r,baseAmount:o,otherAmountMax:s});return d.addInstruction(P),d.addCustomComputeBudget(l),d.versionBuild({txVersion:m,extInfo:{address:P.address}})}async decreaseLiquidity(e){let{poolInfo:t,poolKeys:n,ownerPosition:r,ownerInfo:o,amountMinA:s,amountMinB:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txVersion:d}=e;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let p=this.createTxBuilder(),g=o.useSOLBalance&&t.mintA.address===J.toString(),f=o.useSOLBalance&&t.mintB.address===J.toString(),y,b,{account:h,instructionParams:w}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new q(t.mintA.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!g,associatedOnly:g?!1:u,checkCreateATAOwner:l});y=h,w&&p.addInstruction(w);let{account:A,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new q(t.mintB.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!f,associatedOnly:f?!1:u,checkCreateATAOwner:l});b=A,k&&p.addInstruction(k);let P=[];for(let L of t.rewardDefaultInfos){let R=o.useSOLBalance&&L.mint.address===J.toString(),j;if(L.mint.address===t.mintA.address)j=y;else if(L.mint.address===t.mintB.address)j=b;else{let{account:te,instructionParams:ce}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new q(L.mint.programId),mint:new q(L.mint.address),notUseTokenAccount:R,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!R,associatedOnly:R?!1:u,checkCreateATAOwner:l});j=te,ce&&p.addInstruction(ce)}P.push(j)}!y&&!b&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccountRawInfos);let x=n!=null?n:await this.getClmmPoolKeys(t.id),B=await me.decreaseLiquidityInstructions({poolInfo:t,poolKeys:x,ownerPosition:r,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:y,tokenAccountB:b,rewardAccounts:P},liquidity:c,amountMinA:s,amountMinB:a});p.addInstruction({instructions:B.instructions,instructionTypes:[ue.ClmmDecreasePosition]});let F=S({},B.address);if(o.closePosition){let L=await me.closePositionInstructions({poolInfo:t,poolKeys:x,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:r});p.addInstruction({endInstructions:L.instructions,endInstructionTypes:L.instructionTypes}),F=S(S({},F),L.address)}return p.addCustomComputeBudget(m),p.versionBuild({txVersion:d,extInfo:{address:F}})}async closePosition({poolInfo:e,poolKeys:t,ownerPosition:n,txVersion:r}){this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let o=this.createTxBuilder(),s=t!=null?t:await this.getClmmPoolKeys(e.id),a=me.closePositionInstructions({poolInfo:e,poolKeys:s,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:n});return o.addInstruction(a).versionBuild({txVersion:r,extInfo:{address:a.address}})}async initReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:r=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txVersion:a}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let c=this.createTxBuilder(),u=t.useSOLBalance&&n.mint.address.toString()===J.toString(),l=n.perSecond.mul(n.endTime-n.openTime),{account:m,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new q(n.mint.address),mint:new q(n.mint.address),notUseTokenAccount:!!u,skipCloseAccount:!u,owner:this.scope.ownerPubKey,createInfo:u?{payer:t.feePayer||this.scope.ownerPubKey,amount:new Ke(new C(l.toFixed(0)).gte(l)?l.toFixed(0):l.add(1).toFixed(0))}:void 0,associatedOnly:u?!1:r,checkCreateATAOwner:o});d&&c.addInstruction(d),m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let p=await this.getClmmPoolKeys(e.id),g=me.initRewardInstructions({poolInfo:e,poolKeys:p,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardInfo:{programId:new q(n.mint.programId),mint:new q(n.mint.address),openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:D.decimalToX64(n.perSecond)}});return c.addInstruction(g),c.addCustomComputeBudget(s),c.versionBuild({txVersion:a,extInfo:{address:g.address}})}async initRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:r,associatedOnly:o=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txVersion:c}){for(let m of r)m.endTime<=m.openTime&&this.logAndCreateError("reward time error","rewardInfo",m);let u=this.createTxBuilder(),l={};for(let m of r){let d=n.useSOLBalance&&m.mint.address===J.toString(),p=m.perSecond.mul(m.endTime-m.openTime),{account:g,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new q(m.mint.programId),mint:new q(m.mint.address),notUseTokenAccount:!!d,skipCloseAccount:!d,owner:this.scope.ownerPubKey,createInfo:d?{payer:n.feePayer||this.scope.ownerPubKey,amount:new Ke(new C(p.toFixed(0)).gte(p)?p.toFixed(0):p.add(1).toFixed(0))}:void 0,associatedOnly:d?!1:o,checkCreateATAOwner:s});f&&u.addInstruction(f),g||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let y=t!=null?t:await this.getClmmPoolKeys(e.id),b=me.initRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:g},rewardInfo:{programId:new q(m.mint.programId),mint:new q(m.mint.address),openTime:m.openTime,endTime:m.endTime,emissionsPerSecondX64:D.decimalToX64(m.perSecond)}});l=S(S({},l),b.address),u.addInstruction(b)}return u.addCustomComputeBudget(a),u.versionBuild({txVersion:c,extInfo:{address:l}})}async setReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:r=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txVersion:a}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let c=this.createTxBuilder(),u=t.useSOLBalance&&n.mint.equals(J),{account:l,instructionParams:m}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n.programId,mint:n.mint,notUseTokenAccount:u,owner:this.scope.ownerPubKey,createInfo:u?{payer:t.feePayer||this.scope.ownerPubKey,amount:new Ke(new C(n.perSecond.sub(n.endTime-n.openTime).toFixed(0)).gte(n.perSecond.sub(n.endTime-n.openTime))?n.perSecond.sub(n.endTime-n.openTime).toFixed(0):n.perSecond.sub(n.endTime-n.openTime).add(1).toFixed(0))}:void 0,associatedOnly:u?!1:r,checkCreateATAOwner:o});m&&c.addInstruction(m),l||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let d=await this.getClmmPoolKeys(e.id),p=me.setRewardInstructions({poolInfo:e,poolKeys:d,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:l},rewardInfo:{mint:n.mint,openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:D.decimalToX64(n.perSecond)}});return c.addInstruction(p),c.addCustomComputeBudget(s),c.versionBuild({txVersion:a,extInfo:{address:p.address}})}async setRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:r,associatedOnly:o=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txVersion:c}){let u=this.createTxBuilder(),l={};for(let m of r){m.endTime<=m.openTime&&this.logAndCreateError("reward time error","rewardInfo",m);let d=n.useSOLBalance&&m.mint.address===J.toString(),{account:p,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new q(m.mint.programId),mint:new q(m.mint.address),notUseTokenAccount:d,owner:this.scope.ownerPubKey,createInfo:d?{payer:n.feePayer||this.scope.ownerPubKey,amount:new Ke(new C(m.perSecond.sub(m.endTime-m.openTime).toFixed(0)).gte(m.perSecond.sub(m.endTime-m.openTime))?m.perSecond.sub(m.endTime-m.openTime).toFixed(0):m.perSecond.sub(m.endTime-m.openTime).add(1).toFixed(0))}:void 0,associatedOnly:d?!1:o,checkCreateATAOwner:s});g&&u.addInstruction(g),p||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=t!=null?t:await this.getClmmPoolKeys(e.id),y=me.setRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:p},rewardInfo:{mint:new q(m.mint.address),openTime:m.openTime,endTime:m.endTime,emissionsPerSecondX64:D.decimalToX64(m.perSecond)}});u.addInstruction(y),l=S(S({},l),y.address)}return u.addCustomComputeBudget(a),u.versionBuild({txVersion:c,extInfo:{address:l}})}async collectReward({poolInfo:e,ownerInfo:t,rewardMint:n,associatedOnly:r=!0,checkCreateATAOwner:o=!1}){let s=e.rewardDefaultInfos.find(p=>p.mint.address===n.toString());s||this.logAndCreateError("reward mint error","not found reward mint",n);let a=this.createTxBuilder(),c=t.useSOLBalance&&n.equals(J),{account:u,instructionParams:l}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new q(s.mint.programId),mint:n,notUseTokenAccount:c,owner:this.scope.ownerPubKey,skipCloseAccount:!c,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:c?!1:r,checkCreateATAOwner:o});l&&a.addInstruction(l),u||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let m=await this.getClmmPoolKeys(e.id),d=me.collectRewardInstructions({poolInfo:e,poolKeys:m,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:u},rewardMint:n});return a.addInstruction(d),a.build({address:d.address})}async collectRewards({poolInfo:e,ownerInfo:t,rewardMints:n,associatedOnly:r=!0,checkCreateATAOwner:o=!1}){let s=this.createTxBuilder(),a={};for(let c of n){let u=e.rewardDefaultInfos.find(f=>f.mint.address===c.toString());if(!u){this.logAndCreateError("reward mint error","not found reward mint",c);continue}let l=t.useSOLBalance&&c.equals(J),{account:m,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new q(u.mint.programId),mint:c,notUseTokenAccount:l,owner:this.scope.ownerPubKey,skipCloseAccount:!l,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:l?!1:r,checkCreateATAOwner:o});m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos),d&&s.addInstruction(d);let p=await this.getClmmPoolKeys(e.id),g=me.collectRewardInstructions({poolInfo:e,poolKeys:p,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardMint:c});s.addInstruction(g),a=S(S({},a),g.address)}return s.build({address:a})}async swap({poolInfo:e,poolKeys:t,inputMint:n,amountIn:r,amountOutMin:o,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p}){let g=this.createTxBuilder(),f=n.toString()===e.mintA.address,y=c.useSOLBalance&&e.mintA.address===J.toBase58(),b=c.useSOLBalance&&e.mintB.address===J.toBase58(),h;!s||s.equals(new C(0))?h=f?ze.add(new Ke(1)):He.sub(new Ke(1)):h=M.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let w;if(!w){let{account:P,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new q(e.mintA.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,skipCloseAccount:!y,createInfo:y||!f?{payer:c.feePayer||this.scope.ownerPubKey,amount:f?r:0}:void 0,associatedOnly:y?!1:l,checkCreateATAOwner:m});w=P,x&&g.addInstruction(x)}let A;if(!A){let{account:P,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new q(e.mintB.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,skipCloseAccount:!b,createInfo:b||f?{payer:c.feePayer||this.scope.ownerPubKey,amount:f?0:r}:void 0,associatedOnly:b?!1:l,checkCreateATAOwner:m});A=P,x&&g.addInstruction(x)}(!w||!A)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:w,ownerTokenAccountB:A,mintAUseSOLBalance:y,mintBUseSOLBalance:b,associatedOnly:l});let k=t!=null?t:await this.getClmmPoolKeys(e.id);return g.addInstruction(me.makeSwapBaseInInstructions({poolInfo:e,poolKeys:k,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:w,tokenAccountB:A},inputMint:new q(n),amountIn:r,amountOutMin:o,sqrtPriceLimitX64:h,remainingAccounts:u})),g.addCustomComputeBudget(p),g.versionBuild({txVersion:d})}async swapBaseOut({poolInfo:e,poolKeys:t,outputMint:n,amountOut:r,amountInMax:o,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p}){let g=this.createTxBuilder(),f=n.toString()===e.mintB.address,y=c.useSOLBalance&&e.mintA.address===J.toBase58(),b=c.useSOLBalance&&e.mintB.address===J.toBase58(),h;!s||s.equals(new C(0))?h=n.toString()===e.mintB.address?ze.add(new Ke(1)):He.sub(new Ke(1)):h=M.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let w;if(!w){let{account:P,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new q(e.mintA.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,skipCloseAccount:!y,createInfo:y||!f?{payer:c.feePayer||this.scope.ownerPubKey,amount:f?o:0}:void 0,associatedOnly:y?!1:l,checkCreateATAOwner:m});w=P,x&&g.addInstruction(x)}let A;if(!A){let{account:P,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new q(e.mintB.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,skipCloseAccount:!b,createInfo:b||f?{payer:c.feePayer||this.scope.ownerPubKey,amount:f?0:o}:void 0,associatedOnly:b?!1:l,checkCreateATAOwner:m});A=P,x&&g.addInstruction(x)}(!w||!A)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:w,ownerTokenAccountB:A,mintAUseSOLBalance:y,mintBUseSOLBalance:b,associatedOnly:l});let k=t!=null?t:await this.getClmmPoolKeys(e.id);return g.addInstruction(me.makeSwapBaseOutInstructions({poolInfo:e,poolKeys:k,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:w,tokenAccountB:A},outputMint:new q(n),amountOut:r,amountInMax:o,sqrtPriceLimitX64:h,remainingAccounts:u})),g.addCustomComputeBudget(p),g.versionBuild({txVersion:d})}async harvestAllRewards({allPoolInfo:e,allPositions:t,ownerInfo:n,associatedOnly:r=!0,checkCreateATAOwner:o=!1,programId:s,txVersion:a,computeBudgetConfig:c}){let u={};for(let m of this.scope.account.tokenAccountRawInfos)r?Ue(this.scope.ownerPubKey,m.accountInfo.mint,s).publicKey.equals(m.pubkey)&&(u[m.accountInfo.mint.toString()]=m.pubkey):u[m.accountInfo.mint.toString()]=m.pubkey;let l=this.createTxBuilder();for(let m of Object.values(e)){if(t[m.id]===void 0||!t[m.id].find(w=>!w.liquidity.isZero()||w.rewardInfos.find(A=>!A.rewardAmountOwed.isZero())))continue;let d=m,p=n.useSOLBalance&&d.mintA.address===J.toString(),g=n.useSOLBalance&&d.mintB.address===J.toString(),f=u[d.mintA.address];if(!f){let{account:w,instructionParams:A}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:d.mintA.programId,mint:new q(d.mintA.address),notUseTokenAccount:p,owner:this.scope.ownerPubKey,skipCloseAccount:!p,createInfo:{payer:n.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:p?!1:r,checkCreateATAOwner:o});f=w,A&&l.addInstruction(A)}let y=u[d.mintB.address];if(!y){let{account:w,instructionParams:A}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:d.mintB.programId,mint:new q(d.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,skipCloseAccount:!g,createInfo:{payer:n.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:g?!1:r,checkCreateATAOwner:o});y=w,A&&l.addInstruction(A)}u[d.mintA.address]=f,u[d.mintB.address]=y;let b=[];for(let w of d.rewardDefaultInfos){let A=n.useSOLBalance&&w.mint.address===J.toString(),k=u[w.mint.address];if(!k){let{account:P,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new q(w.mint.programId),mint:new q(w.mint.address),notUseTokenAccount:A,owner:this.scope.ownerPubKey,skipCloseAccount:!A,createInfo:{payer:n.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:A?!1:r});k=P,x&&l.addInstruction(x)}u[w.mint.address]=k,b.push(k)}let h=await this.getClmmPoolKeys(d.id);for(let w of t[m.id]){let A=me.decreaseLiquidityInstructions({poolInfo:d,poolKeys:h,ownerPosition:w,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:y,rewardAccounts:b},liquidity:new Ke(0),amountMinA:new Ke(0),amountMinB:new Ke(0)});l.addInstruction(A)}}return a===0?l.sizeCheckBuildV0({computeBudgetConfig:c}):l.sizeCheckBuild({computeBudgetConfig:c})}async getWhiteListMint({programId:e}){let t=await this.scope.connection.getAccountInfo(vt(e).publicKey);return t?er.decode(t.data).whitelistMints.filter(r=>!r.equals(q.default)):[]}async getOwnerPositionInfo({programId:e}){await this.scope.account.fetchWalletTokenAccounts();let n=this.scope.account.tokenAccountRawInfos.filter(s=>s.accountInfo.amount.eq(new Ke(1))).map(s=>Le(new q(e),s.accountInfo.mint).publicKey),r=await this.scope.connection.getMultipleAccountsInfo(n),o=[];return r.forEach(s=>{if(!s)return;let a=fn.decode(s.data);o.push(a)}),o}async getRpcClmmPoolInfo({poolId:e}){return(await this.getRpcClmmPoolInfos({poolIds:[e]}))[String(e)]}async getRpcClmmPoolInfos({poolIds:e,config:t}){let n=await st(this.scope.connection,e.map(o=>({pubkey:new q(o)})),t),r={};for(let o=0;o<e.length;o++){let s=n[o];if(s===null||!s.accountInfo)throw Error("fetch pool info error: "+String(e[o]));let a=pn.decode(s.accountInfo.data),c=M.sqrtPriceX64ToPrice(a.sqrtPriceX64,a.mintDecimalsA,a.mintDecimalsB).toNumber();r[String(e[o])]=G(S({},a),{currentPrice:c,programId:s.accountInfo.owner})}return r}async getComputeClmmPoolInfos({clmmPoolsRpcInfo:e,mintInfos:t}){let n=new Set(Object.keys(e).map(c=>e[c].ammConfig.toBase58())),r=await st(this.scope.connection,Array.from(n).map(c=>({pubkey:new q(c)}))),o={};r.forEach(c=>{!c.accountInfo||(o[c.pubkey.toBase58()]=Ji.decode(c.accountInfo.data))});let s=await le.fetchComputeMultipleClmmInfo({connection:this.scope.connection,rpcDataMap:e,poolList:Object.keys(e).map(c=>{var m,d,p,g;let[u,l]=[e[c].mintA.toBase58(),e[c].mintB.toBase58()];return{id:c,programId:e[c].programId.toBase58(),mintA:En({address:u,decimals:e[c].mintDecimalsA,programId:t[u].programId.toBase58()||cr.toBase58(),extensions:{feeConfig:(m=t[u])!=null&&m.feeConfig?Dn((d=t[u])==null?void 0:d.feeConfig):void 0}}),mintB:En({address:l,decimals:e[c].mintDecimalsB,programId:t[l].programId.toBase58()||cr.toBase58(),extensions:{feeConfig:(p=t[l])!=null&&p.feeConfig?Dn((g=t[l])==null?void 0:g.feeConfig):void 0}}),price:e[c].currentPrice,config:G(S({},o[e[c].ammConfig.toBase58()]),{id:e[c].ammConfig.toBase58(),fundFeeRate:0,description:"",defaultRange:0,defaultRangePoint:[]})}})}),a=await le.fetchMultiplePoolTickArrays({connection:this.scope.connection,poolKeys:Object.values(s)});return{computeClmmPoolInfo:s,computePoolTickData:a}}async getPoolInfoFromRpc(e){var l;let t=await this.getRpcClmmPoolInfo({poolId:e}),n=new Set([t.mintA.toBase58(),t.mintB.toBase58()]),r=await Ni({connection:this.scope.connection,mints:Array.from(n).map(m=>new q(m))}),{computeClmmPoolInfo:o,computePoolTickData:s}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:{[e]:t},mintInfos:r}),a=await st(this.scope.connection,[{pubkey:t.vaultA},{pubkey:t.vaultB}]),c=ir(o[e]);if(!a[0].accountInfo||!a[1].accountInfo)throw new Error("pool vault data not found");c.mintAmountA=Number(ar.decode(a[0].accountInfo.data).amount.toString()),c.mintAmountB=Number(ar.decode((l=a[1].accountInfo)==null?void 0:l.data).amount.toString());let u=G(S({},o[e]),{id:e,programId:t.programId.toBase58(),openTime:t.startTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},rewardInfos:[],config:c.config});return{poolInfo:c,poolKeys:u,computePoolInfo:o[e],tickData:s}}};export{qo as AMM_CONFIG_SEED,Mi as BIT_PRECISION,Yn as Clmm,Ji as ClmmConfigLayout,me as ClmmInstrument,zn as EXTENSION_TICKARRAY_BITMAP_SIZE,un as FEE_RATE_DENOMINATOR,ls as FETCH_TICKARRAY_COUNT,Vo as Fee,Fi as LOG_B_2_X32,Oi as LOG_B_P_ERR_MARGIN_LOWER_X64,Ei as LOG_B_P_ERR_MARGIN_UPPER_X64,U as LiquidityMath,He as MAX_SQRT_PRICE_X64,rl as MAX_SQRT_PRICE_X64_SUB_ONE,Be as MAX_TICK,ze as MIN_SQRT_PRICE_X64,il as MIN_SQRT_PRICE_X64_ADD_ONE,xe as MIN_TICK,D as MathUtil,_n as MaxU64,Li as MaxUint128,Je as NEGATIVE_ONE,Zo as OBSERVATION_SEED,Xe as ONE,zo as OPERATION_SEED,$i as ObservationInfoLayout,ss as ObservationLayout,er as OperationLayout,Uo as POOL_REWARD_VAULT_SEED,Wo as POOL_SEED,Ho as POOL_TICK_ARRAY_BITMAP_SEED,Go as POOL_VAULT_SEED,qi as POSITION_SEED,pn as PoolInfoLayout,le as PoolUtils,fn as PositionInfoLayout,cs as PositionRewardInfoLayout,Wt as PositionUtils,Pm as ProtocolPositionLayout,cn as Q128,Ne as Q64,as as RewardInfo,M as SqrtPriceMath,ft as SwapMath,dt as TICK_ARRAY_BITMAP_SIZE,Xo as TICK_ARRAY_SEED,ge as TICK_ARRAY_SIZE,ol as TICK_SPACINGS,$e as TickArrayBitmap,tr as TickArrayBitmapExtensionLayout,Vt as TickArrayBitmapExtensionUtils,qt as TickArrayLayout,us as TickLayout,pt as TickMath,X as TickQuery,K as TickUtils,Et as U64Resolution,al as U64_IGNORE_RANGE,H as ZERO,ir as clmmComputeInfoToApiInfo,cd as getLiquidityFromAmounts,fl as getPdaAmmConfigId,Me as getPdaExBitmapAccount,mn as getPdaMetadataKey,Ui as getPdaObservationAccount,vt as getPdaOperationAccount,Le as getPdaPersonalPositionAddress,Wi as getPdaPoolId,Gi as getPdaPoolRewardVaulId,Wn as getPdaPoolVaultId,mt as getPdaProtocolPositionAddress,$ as getPdaTickArrayAddress,ul as i16ToBytes,ln as i32ToBytes,Dt as isZero,Vn as leadingZeros,Vi as leastSignificantBit,sl as mockCreatePoolInfo,Di as mockV3CreatePoolInfo,_i as mostSignificantBit,qn as trailingZeros,vi as u16ToBytes,ll as u32ToBytes};
//# sourceMappingURL=index.mjs.map